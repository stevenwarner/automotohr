<?php defined('BASEPATH') OR exit('No direct script access allowed');

class Expirations_autoresponder extends CI_Controller {
    public function __construct() {
        parent::__construct();
        $this->load->model('expirations_autoresponder_model');
    }

    public function index() {
        $companies = $this->expirations_autoresponder_model->GetAllCompanies();
        $currentDateTimestamp = strtotime(date('Y-m-d H:i:s'));

        if($this->input->is_cli_request()) {
            foreach ($companies as $company) {
                $company_billing_contacts                                       = get_company_billing_contacts($company['sid']);
                $expiry_date                                                    = $company['expiry_date'];
                $company_admins                                                 = get_user_with_admin_access($company['sid']);
                $recurring_payment                                              = get_recurring_payment_detail($company['sid']);
                $emailAddresses                                                 = array(); //Send Company Expiration Notification - Start
                
                if (!empty($company_admins)) {
                    foreach ($company_admins as $company_admin) {
                            $emailAddresses[]                                   = $company_admin['email'];
                    }
                }

                if ($expiry_date != null && $expiry_date != '') {
                    $expiry_timestamp                                           = strtotime($expiry_date);
                    $alert_start                                                = date_subtract_days(date('Y-m-d H:i:s', $expiry_timestamp), 1); // AUTORESPONDER_START_DAYS

                    if ($expiry_timestamp >= $alert_start) {
                        if ($currentDateTimestamp <= $expiry_timestamp && $currentDateTimestamp >= $alert_start) {
                            $emailTemplateData                                  = get_email_template(ACCOUNT_EXPIRATION_AUTO_NOTIFICATION);
                            $dateDiff                                           = $expiry_timestamp - $currentDateTimestamp;
                            $remaining_days                                     = ceil($dateDiff / (60 * 60 * 24));

                            $from                                               = $emailTemplateData['from_email'];
                            $fromName                                           = $emailTemplateData['from_name'];
                            $to                                                 = $company['email'];
                            $subject                                            = $emailTemplateData['subject'];
                            $message                                            = $emailTemplateData['text'];
                            $subject                                            = str_replace('{{company_name}}', $company['CompanyName'], $subject);
                            $subject                                            = str_replace('{{remaining_days}}', $remaining_days, $subject);
                            $message                                            = str_replace('{{company_name}}', $company['CompanyName'], $message);
                            $message                                            = str_replace('{{remaining_days}}', $remaining_days, $message);
                            $message                                            = EMAIL_HEADER . $message . EMAIL_FOOTER;

                            $replacement_array                                  = array();
                            $replacement_array['company_name']                  = $company['CompanyName'];
                            $replacement_array['remaining_days']                = $remaining_days;

                            if(empty($recurring_payment)) {
                                if(empty($company_billing_contacts)) {
                                    if (!empty($emailAddresses)) {
                                        foreach ($emailAddresses as $emailAddress) {
                                            //Email To Company Admin as No Billing Contact is set.
                                            //log_and_send_templated_email(ACCOUNT_EXPIRATION_AUTO_NOTIFICATION, $emailAddress, $replacement_array);
                                        }

                                        $message_custom_header = '';
                                        //$message_custom_header .= '<h2>This Email is Also Sent to Company Administrators</h2>';

                                        //Email to Dev for debug purposes.
                                        //sendMail($from, TO_EMAIL_DEV, $subject, $message_custom_header . $message, $fromName);

                                        //Email to Steven for information
                                        //sendMail($from, TO_EMAIL_STEVEN, $subject, $message_custom_header . $message, $fromName);

                                        //Send Emails Through System Notifications Email - Start
                                        $system_notification_emails = get_system_notification_emails('company_account_expiration_emails');

                                        if(!empty($system_notification_emails)) {
                                            foreach ($system_notification_emails as $system_notification_email) {
                                                sendMail($from, $system_notification_email['email'], $subject, $message_custom_header . $message, $fromName);
                                            }
                                        }
                                        //Send Emails Through System Notifications Email - End
                                    }
                                } else {
                                    foreach($company_billing_contacts as $billing_contact){
                                        $email_address = $billing_contact['email_address'];
                                        //Email to Billing Contact as it is setup against the company
                                        //log_and_send_templated_email(ACCOUNT_EXPIRATION_AUTO_NOTIFICATION, $email_address, $replacement_array);
                                    }

                                    $message_custom_header = '';
                                    //$message_custom_header .= '<h2>This Email is Also Sent to Company Billing Contacts</h2>';
                                    //Email to dev for debug purposes
                                    sendMail($from, TO_EMAIL_DEV, $subject, $message_custom_header . $message, $fromName);

                                    //Email to steven for information
                                    //sendMail($from, TO_EMAIL_STEVEN, $subject, $message_custom_header . $message, $fromName);

                                    //Send Emails Through System Notifications Email - Start
                                    $system_notification_emails = get_system_notification_emails('company_account_expiration_emails');

                                    if(!empty($system_notification_emails)) {
                                        foreach ($system_notification_emails as $system_notification_email) {
                                            sendMail($from, $system_notification_email['email'], $subject, $message_custom_header . $message, $fromName);
                                        }
                                    }
                                    //Send Emails Through System Notifications Email - End
                                }
                            } else {
                                $message_custom_header = '';
                                $message_custom_header .= '<h2>Notification To Admin Only</h2>';
                                $message_custom_header .= '<p>There is a recurring payment set for this company, which will generate a new invoice automatically on the specified day.</p>';

                                //Email to dev for debug purposes
                                sendMail($from, TO_EMAIL_DEV, $subject, $message_custom_header . $message, $fromName);

                                //Email to steven for information
                                //sendMail($from, TO_EMAIL_STEVEN, $subject, $message_custom_header . $message, $fromName);
                                //Send Emails Through System Notifications Email - Start
                                $system_notification_emails = get_system_notification_emails('company_account_expiration_emails');

                                if(!empty($system_notification_emails)) {
                                    foreach ($system_notification_emails as $system_notification_email) {
                                        sendMail($from, $system_notification_email['email'], $subject, $message_custom_header . $message, $fromName);
                                    }
                                }
                                //Send Emails Through System Notifications Email - End
                            }
                        }
                    }
                }

                //Send Company Expiration Notification - End
                //Send Credit Card Expiration Notification - Start
                $company_credit_cards = get_credit_cards($company['sid']);

                if(!empty($company_credit_cards)) {
                    foreach ($company_credit_cards as $credit_card) {
                        $expiration_month = $credit_card['expire_month'];
                        $expiration_year = $credit_card['expire_year'];

                        if (strtolower($expiration_month) != 'xx' && strtolower($expiration_year) != 'xxxx') {
                            $expiration_timestamp = mktime(0, 0, 0, $expiration_month, 1, $expiration_year);
                            //Credit Card Expires on the Last day of the Said Month.
                            $last_day_of_month = date('t', $expiration_timestamp);
                            $actual_expiration_timestamp = mktime(0, 0, 0, $expiration_month, $last_day_of_month, $expiration_year);
                            $alert_start = date_subtract_days(date('Y-m-d H:i:s', $actual_expiration_timestamp), 1); //CREDIT_CARD_EXPIRATION_NOTIFICATION_START_DAYS

                            if ($actual_expiration_timestamp >= $alert_start) {
                                if ($currentDateTimestamp <= $actual_expiration_timestamp && $currentDateTimestamp >= $alert_start) {
                                    if (false) { //Set to false as email should be only to steven.
                                        foreach ($company_billing_contacts as $billing_contact) {
                                            $email_address = $billing_contact['email_address'];
                                            $contact_name = ucwords($billing_contact['contact_name']);
                                            $replacement_array = array();
                                            $replacement_array['billing_contact_name'] = $contact_name;
                                            $replacement_array['company_name'] = ucwords($company['CompanyName']);
                                            $replacement_array['card_number'] = $credit_card['number'];
                                            $replacement_array['name_on_card'] = $credit_card['name_on_card'];
                                            $replacement_array['expiration_month'] = $credit_card['expire_month'];
                                            $replacement_array['expiration_year'] = $credit_card['expire_year'];
                                            log_and_send_templated_email(CREDIT_CARD_EXPIRATION_NOTIFICATION, $email_address, $replacement_array);
                                        }
                                    } else { //Email only to steven.
                                        $replacement_array = array();
                                        $replacement_array['billing_contact_name'] = 'Steven';
                                        $replacement_array['company_name'] = ucwords($company['CompanyName']);
                                        $replacement_array['card_number'] = $credit_card['number'];
                                        $replacement_array['name_on_card'] = $credit_card['name_on_card'];
                                        $replacement_array['expiration_month'] = $credit_card['expire_month'];
                                        $replacement_array['expiration_year'] = $credit_card['expire_year'];
                                        //log_and_send_templated_email(CREDIT_CARD_EXPIRATION_NOTIFICATION, TO_EMAIL_STEVEN, $replacement_array);
                                        //Send Emails Through System Notifications Email - Start
                                        $system_notification_emails = get_system_notification_emails('company_account_expiration_emails');

                                        if(!empty($system_notification_emails)) {
                                            foreach ($system_notification_emails as $system_notification_email) {
                                                log_and_send_templated_email(CREDIT_CARD_EXPIRATION_NOTIFICATION, $system_notification_email['email'], $replacement_array);
                                            }
                                        }
                                        //Send Emails Through System Notifications Email - End
                                        //Email to Steven
                                        //$subject = 'Urgent Issue - Please Add Billing Contacts';
                                        //$message_body = '';
                                        //$message_body .= '<p>' . 'Dear Steven,' . '</p>';
                                        //$message_body .= '<p>' . 'This is an automated email generated by AHR "Credit Card Expiration Notification Module".' . '</p>';
                                        //$message_body .= '<p>' . 'It is to inform you that system could not send email to ' . $company['CompanyName'] . ' as there are no company billing contact details.' . '</p>';
                                        //$message_body .= '<p>' . 'Kindly Add "Company Billing Contacts" from Super Admin.' . '</p>';
                                        //$message_body .= '<p>' . STORE_NAME . '</p>';
                                        //$message_body .= '<p>' . '**This is an automated email please do not reply.**' . '</p>';
                                        //log_and_sendEmail(FROM_EMAIL_DEV, TO_EMAIL_STEVEN, $subject, $message_body, STORE_NAME);
                                    }
                                }
                            }
                        }
                    }
                } //Send Credit Card Expiration Notification - End
            }
        }
    }
}