<?php defined('BASEPATH') OR exit('No direct script access allowed');

class Cron_invoices extends CI_Controller {
    public function __construct() {
        parent::__construct();
        $this->load->model('manage_admin/recurring_payments_model');
    }

    public function index($verification_key = null) {
        $test = '/usr/local/bin/php -q /'.DOC_ROOT.'cron.php /cron_invoices/index/dwwbtPzuoHI9d5TEIKBKDGWwNoGEUlRuSidW8wQ4zSUHIl9gBxRx18Z3Dqk4HV7ZNCbu2ZfkjFVLHWINnY5uzMkUfIiINdZ19NJj';
        $test_email = 'ahassan.egenie@gmail.com';

        mail($test_email, 'AutomtoHr Debug - cron invoices executed ' . date('Y-m-d H:i:s') , $verification_key);

        //if($this->input->is_cli_request()) {
            if($verification_key == 'dwwbtPzuoHI9d5TEIKBKDGWwNoGEUlRuSidW8wQ4zSUHIl9gBxRx18Z3Dqk4HV7ZNCbu2ZfkjFVLHWINnY5uzMkUfIiINdZ19NJj'){
                mail($test_email, 'AutomtoHr Debug - Key Verified', 'Email Generated On : ' . date('Y-m-d H:i:s'));


                //mail($test_email, 'Cron Testing from Invoices Controller', 'Server host : ' . $_SERVER['HTTP_HOST']);
                $recurring_payments = $this->recurring_payments_model->get_all_recurring_payment_records('active');
                $current_day = date('d');

                mail($test_email, 'AutomtoHr Debug - Current Date ' . $current_day, 'This is the day for which invoices has to be generated.');

                if(!empty($recurring_payments)) {
                    mail($test_email, 'AutomtoHr Debug - Recurring Records ' . date('Y-m-d H:i:s'), print_r($recurring_payments, true));

                    foreach ($recurring_payments as $recurring_payment) {
                        $payment_day = $recurring_payment['payment_day'];

                        if (intval($current_day) == intval($payment_day)) {

                            mail($test_email, 'AutomtoHr Debug - Day Check Mached', 'Email Generated On : ' . date('Y-m-d H:i:s'));

                            generate_invoice_for_cron_processing($recurring_payment['sid'], 1);
                        }
                    }
                }
            }
        //}
    }
}