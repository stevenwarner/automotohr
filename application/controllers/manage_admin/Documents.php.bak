<?php defined('BASEPATH') OR exit('No direct script access allowed');

class Documents extends Admin_Controller {
    function __construct() {
        parent::__construct();
        $this->load->library('ion_auth');
        $this->load->library('form_validation');
        $this->load->model('manage_admin/documents_model');
        $this->form_validation->set_error_delimiters('<p class="error_message"><i class="fa fa-exclamation-circle"></i>', '</p>');
        require_once(APPPATH . 'libraries/aws/aws.php');
    }

    public function index($company_sid = null, $company_name = null) {
        $redirect_url = 'manage_admin/';
        $function_name = 'admin_forms_and_documents';
        $admin_id = $this->ion_auth->user()->row()->id;
        $security_details = db_get_admin_access_level_details($admin_id);
        $this->data['security_details'] = $security_details;
        check_access_permissions($security_details, $redirect_url, $function_name); // Param2: Redirect URL, Param3: Function Name

        $company_name = $company_name == null ? 'all' : urldecode($company_name);
        if ($company_sid == null) {
            $companies_documents = $this->documents_model->get_all_companies_and_documents(0, $company_name);
        } else {
            $companies_documents = $this->documents_model->get_all_companies_and_documents($company_sid, $company_name);
            $this->data['company_sid'] = $company_sid;
            $companies_uploaded_documents = $this->documents_model->get_all_forms_documents_uploaded($company_sid);
            $this->data['companies_uploaded_documents'] = $companies_uploaded_documents;
        }
//        echo '<pre>'; print_r($companies_documents); exit;
        $this->form_validation->set_rules('company_sid', 'company sid', 'required');

        $this->data['flag'] = true;
        if ($this->form_validation->run() == false) {
            $this->data['companies_documents'] = $companies_documents;
            $this->render('manage_admin/documents/index', 'admin_master');
        } else {
            $perform_action = $this->input->post('perform_action');
            $company_sid = $this->input->post('company_sid');
            $company_name = $this->input->post('company_name');
            $form_name = $this->input->post('form_to_send');
            $company_admin_email = $this->input->post('company_admin_email');
            $company_admin_full_name = $this->input->post('company_admin_full_name');

            switch ($perform_action) {
                case 'generate_form':
                    if ($form_name == 'eula') {
                        $verification_key = random_key(80);
                        $this->documents_model->insert_document_record('end_user_license_agreement', $company_sid, $verification_key, 'generated');
                    } elseif ($form_name == 'credit_card_authorization') {
                        $verification_key = random_key(80);
                        $this->documents_model->insert_document_record('credit_card_authorization_form', $company_sid, $verification_key, 'generated');
                    } elseif ($form_name == 'company_contacts') {
                        $verification_key = random_key(80);
                        $this->documents_model->insert_document_record('company_contacts', $company_sid, $verification_key, 'generated');
                    }

                    redirect('manage_admin/documents/' . $company_sid, 'refresh');
                    break;
                case 'send_form':
                    $verification_key = $this->input->post('verification_key');

                    if ($form_name == 'eula') { //Send Emails
                        $link = '<a style="' . DEF_EMAIL_BTN_STYLE_DANGER . '" href="' . base_url('form_end_user_license_agreement' . '/' . $verification_key) . '" target="_blank">End User License Agreement</a>';
                        $replacement_array = array();
                        $replacement_array['company_name'] = ucwords($company_name);
                        $replacement_array['company_admin_email'] = ucwords($company_admin_email);
                        $replacement_array['form_link'] = $link;
                        log_and_send_templated_email(END_USER_LICENSE_AGREEMENT_NOTIFICATION_SUPER_ADMIN, TO_EMAIL_DEV, $replacement_array);
                        $replacement_array = array();
                        $replacement_array['company_admin'] = ucwords($company_admin_full_name);
                        $replacement_array['form_link'] = $link;
                        log_and_send_templated_email(END_USER_LICENSE_AGREEMENT_NOTIFICATION_COMPANY_ADMIN, $company_admin_email, $replacement_array);
                        $this->documents_model->update_document_status('end_user_license_agreement', $verification_key, 'sent');
                        $this->session->set_flashdata('message', '<strong>Success</strong> : End User License Agreement Sent!');
                        //redirect('manage_admin/documents/' . $company_sid , 'refresh');
                    } elseif ($form_name == 'credit_card_authorization') { //Send Emails
                        $link = '<a style="' . DEF_EMAIL_BTN_STYLE_PRIMARY . '" href="' . base_url('form_credit_card_authorization' . '/' . $verification_key) . '" target="_blank">Credit Card Authorization</a>';
                        $replacement_array = array();
                        $replacement_array['company_name'] = ucwords($company_name);
                        $replacement_array['company_admin_email'] = ucwords($company_admin_email);
                        $replacement_array['form_link'] = $link;
                        log_and_send_templated_email(CREDIT_CARD_AUTHORIZATION_NOTIFICATION_SUPER_ADMIN, TO_EMAIL_DEV, $replacement_array);
                        $replacement_array = array();
                        $replacement_array['company_admin'] = ucwords($company_admin_full_name);
                        $replacement_array['form_link'] = $link;
                        log_and_send_templated_email(CREDIT_CARD_AUTHORIZATION_NOTIFICATION_COMPANY_ADMIN, $company_admin_email, $replacement_array);
                        $this->documents_model->update_document_status('credit_card_authorization', $verification_key, 'sent');
                        $this->session->set_flashdata('message', '<strong>Success</strong> : Credit Card Authorization Form Sent!');
                        redirect('manage_admin/documents/' . $company_sid, 'refresh');
                    }
                    break;
                case 'upload_document':
                    $verification_key = random_key(80);
                    $company_sid = $this->input->post('company_sid');
                    $document_name = $this->input->post('document_name');
                    $document_short_desc = $this->input->post('document_short_description');
                    $aws_file_name = upload_file_to_aws('document', $company_sid, $document_name, 'by_admin_' . date('Ymd'));
                    $dataToInsert = array();
                    $dataToInsert['company_sid'] = $company_sid;
                    $dataToInsert['admin_upload_date'] = date('Y-m-d H:i:s');
                    $dataToInsert['admin_aws_filename'] = $aws_file_name;
                    $dataToInsert['document_name'] = $document_name;
                    $dataToInsert['document_short_description'] = $document_short_desc;
                    $this->documents_model->insert_document_record('uploaded_document', $company_sid, $verification_key, 'uploaded', $dataToInsert);
                    $this->session->set_flashdata('message', '<strong>Success</strong> : Document Uploaded successfully!');
                    redirect('manage_admin/documents/' . $company_sid, 'refresh');
                    break;
            }
        }
    }

    public function send($company_sid = null) {
        $redirect_url = 'manage_admin/companies';
        $function_name = 'edit_company';
        $admin_id = $this->ion_auth->user()->row()->id;
        $security_details = db_get_admin_access_level_details($admin_id);
        $this->data['security_details'] = $security_details;
        check_access_permissions($security_details, $redirect_url, $function_name); // Param2: Redirect URL, Param3: Function Name

        if ($company_sid != null) {
            $companies_documents = $this->documents_model->get_all_companies_and_documents($company_sid);
            $this->data['company_sid'] = $company_sid;
            $this->form_validation->set_rules('perform_action', 'perform action', 'required|xss_clean|trim');
            $employees = $this->documents_model->get_company_employees($company_sid);

            if ($this->form_validation->run() == false) {
                $this->data['companies_documents'] = $companies_documents;
                $this->data['employees'] = $employees;
                $this->render('manage_admin/documents/send_documents', 'admin_master');
            } else {
                $perform_action = $this->input->post('perform_action');
                $cc_auth = $this->input->post('cc_auth');
                $eula = $this->input->post('eula');
                $contacts = $this->input->post('contacts');
                $uploaded_documents = $this->input->post('documents');
                $message = $this->input->post('message');
                $link_cc_auth = '';
                $link_eula = '';
                $link_contacts = '';

                if (strlen($cc_auth) > 1) {
                    $link_cc_auth = '<a style="' . DEF_EMAIL_BTN_STYLE_PRIMARY . '" target="_blank" href="' . base_url('form_credit_card_authorization/' . $cc_auth) . '">Credit Card Authorization Form</a>';
                    $cc_auth_sid = $this->documents_model->get_document_sid('credit_card_authorization', $cc_auth);
                    $this->documents_model->update_document_status('credit_card_authorization', $cc_auth, 'sent');
                }

                if (strlen($eula) > 1) {
                    $link_eula = '<a style="' . DEF_EMAIL_BTN_STYLE_DANGER . '" target="_blank" href="' . base_url('form_end_user_license_agreement/' . $eula) . '">End User License Agreement</a>';
                    $eula_sid = $this->documents_model->get_document_sid('end_user_license_agreement', $eula);
                    $this->documents_model->update_document_status('end_user_license_agreement', $eula, 'sent');
                }

                if (strlen($contacts) > 1) {
                    $link_contacts = '<a style="' . DEF_EMAIL_BTN_STYLE_SUCCESS . '" target="_blank" href="' . base_url('form_company_contacts/' . $contacts) . '">Company Contacts</a>';
                    $contacts_sid = $this->documents_model->get_document_sid('company_contacts', $contacts);
                    $this->documents_model->update_document_status('company_contacts', $contacts, 'sent');
                }

                $documents_links = '';
                $temp_link = '';

                if (!empty($uploaded_documents)) {
                    foreach ($uploaded_documents as $uploaded_document) {
                        if (strlen($uploaded_document) > 1) {
                            $document_detail = $this->documents_model->get_document_record('uploaded_document', $uploaded_document);
                            $temp_link = '<a target="_blank" href="' . base_url('form_company_agreements/' . $uploaded_document) . '">' . $document_detail['document_name'] . '</a>';
                            $this->documents_model->update_document_status('uploaded_document', $uploaded_document, 'sent');
                            $documents_links .= '<br />';
                            $documents_links .= $temp_link;
                            $documents_links .= '<br />';
                        }
                    }
                }

                $links = '';

                if ($link_eula != '') {
                    $links .= '<br />';
                    $links .= $link_eula;
                    $links .= '<br />';
                }

                if ($link_cc_auth != '') {
                    $links .= '<br />';
                    $links .= $link_cc_auth;
                    $links .= '<br />';
                }

                if ($link_contacts != '') {
                    $links .= '<br />';
                    $links .= $link_contacts;
                    $links .= '<br />';
                }

                if ($documents_links != '') {
                    $links .= $documents_links;
                }

                switch (strtolower($perform_action)) {
                    case 'send_to_single_email':
                        $email_address = $this->input->post('email');
                        $company_name = $this->input->post('company_name');
                        $replacement_array = array();
                        $replacement_array['company_name'] = $company_name;
                        $replacement_array['email_address'] = $email_address;
                        $replacement_array['links'] = $links;
                        $replacement_array['message'] = $message;
                        $system_notification_emails = get_system_notification_emails('documents_management_emails');

                        if (!empty($system_notification_emails)) {
                            foreach ($system_notification_emails as $system_notification_email) {
                                log_and_send_templated_email(FORMS_NOTIFICATION_TO_ADMIN, $system_notification_email['email'], $replacement_array);
                            }
                        }

                        log_and_send_templated_email(FORMS_NOTIFICATION_TO_CLIENT, $email_address, $replacement_array);

                        if (isset($cc_auth_sid) && $cc_auth_sid != 0) {
                            $this->documents_model->insert_document_email_history_record($company_sid, $cc_auth_sid, 'Manual Email', $email_address);
                        }

                        if (isset($eula_sid) && $eula_sid != 0) {
                            $this->documents_model->insert_document_email_history_record($company_sid, $eula_sid, 'Manual Email', $email_address);
                        }

                        if (isset($contacts_sid) && $contacts_sid != 0) {
                            $this->documents_model->insert_document_email_history_record($company_sid, $contacts_sid, 'Manual Email', $email_address);
                        }

                        $this->session->set_flashdata('message', '<b>Success:</b> Documents Successfully Forwarded.');
                        redirect('manage_admin/companies/manage_company/' . $company_sid, 'refresh');
                        break;
                    case 'send_to_company_admin':
                        $send_to = $this->input->post('send_to');
                        $primary_email = $this->input->post('admin_email_address');
                        $alternate_email = $this->input->post('admin_alt_email_address');
                        $company_name = $this->input->post('company_name');

                        if ($send_to == 'primary') {
                            $replacement_array = array();
                            $replacement_array['company_name'] = '<strong>' . ucwords($company_name) . '</strong>';
                            $replacement_array['links'] = $links;
                            $replacement_array['email_address'] = $primary_email;
                            $system_notification_emails = get_system_notification_emails('documents_management_emails');

                            if (!empty($system_notification_emails)) {
                                foreach ($system_notification_emails as $system_notification_email) {
                                    log_and_send_templated_email(FORMS_NOTIFICATION_TO_ADMIN, $system_notification_email['email'], $replacement_array);
                                }
                            }

                            log_and_send_templated_email(FORMS_NOTIFICATION_TO_CLIENT, $primary_email, $replacement_array);

                            if (isset($cc_auth_sid) && $cc_auth_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $cc_auth_sid, 'Company Admin', $primary_email);
                            }

                            if (isset($eula_sid) && $eula_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $eula_sid, 'Company Admin', $primary_email);
                            }

                            if (isset($contacts_sid) && $contacts_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $contacts_sid, 'Company Admin', $primary_email);
                            }

                        } elseif ($send_to == 'alternate') {
                            $replacement_array = array();
                            $replacement_array['company_name'] = '<strong>' . ucwords($company_name) . '</strong>';
                            $replacement_array['links'] = $links;
                            $replacement_array['message'] = $message;
                            $replacement_array['email_address'] = $alternate_email;
                            $system_notification_emails = get_system_notification_emails('documents_management_emails');

                            if (!empty($system_notification_emails)) {
                                foreach ($system_notification_emails as $system_notification_email) {
                                    log_and_send_templated_email(FORMS_NOTIFICATION_TO_ADMIN, $system_notification_email['email'], $replacement_array);
                                }
                            }

                            log_and_send_templated_email(FORMS_NOTIFICATION_TO_CLIENT, $alternate_email, $replacement_array);

                            if (isset($cc_auth_sid) && $cc_auth_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $cc_auth_sid, 'Company Admin', $alternate_email);
                            }

                            if (isset($eula_sid) && $eula_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $eula_sid, 'Company Admin', $alternate_email);
                            }

                            if (isset($contacts_sid) && $contacts_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $contacts_sid, 'Company Admin', $alternate_email);
                            }

                        } elseif ($send_to == 'both') {
                            $replacement_array = array();
                            $replacement_array['company_name'] = '<strong>' . ucwords($company_name) . '</strong>';
                            $replacement_array['links'] = $links;
                            $replacement_array['message'] = $message;
                            $replacement_array['email_address'] = $primary_email . ' and ' . $alternate_email;
                            $system_notification_emails = get_system_notification_emails('documents_management_emails');

                            if (!empty($system_notification_emails)) {
                                foreach ($system_notification_emails as $system_notification_email) {
                                    log_and_send_templated_email(FORMS_NOTIFICATION_TO_ADMIN, $system_notification_email['email'], $replacement_array);
                                }
                            }

                            log_and_send_templated_email(FORMS_NOTIFICATION_TO_CLIENT, $primary_email, $replacement_array);

                            if (isset($cc_auth_sid) && $cc_auth_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $cc_auth_sid, 'Company Admin', $primary_email);
                            }

                            if (isset($eula_sid) && $eula_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $eula_sid, 'Company Admin', $primary_email);
                            }

                            if (isset($contacts_sid) && $contacts_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $contacts_sid, 'Company Admin', $primary_email);
                            }

                            log_and_send_templated_email(FORMS_NOTIFICATION_TO_CLIENT, $alternate_email, $replacement_array);

                            if (isset($cc_auth_sid) && $cc_auth_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $cc_auth_sid, 'Company Admin', $alternate_email);
                            }

                            if (isset($eula_sid) && $eula_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $eula_sid, 'Company Admin', $alternate_email);
                            }

                            if (isset($contacts_sid) && $contacts_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $contacts_sid, 'Company Admin', $alternate_email);
                            }
                        }

                        $this->session->set_flashdata('message', '<b>Success:</b> Documents Successfully Forwarded.');
                        redirect('manage_admin/companies/manage_company/' . $company_sid, 'refresh');
                        break;
                    case 'send_to_employees':
                        $company_name = $this->input->post('company_name');
                        $employee_emails = $this->input->post('employee_emails');

                        foreach ($employee_emails as $email) {
                            $replacement_array = array();
                            $replacement_array['company_name'] = $company_name;
                            $replacement_array['email_address'] = $email;
                            $replacement_array['links'] = $links;
                            $replacement_array['message'] = $message;
                            $system_notification_emails = get_system_notification_emails('documents_management_emails');

                            if (!empty($system_notification_emails)) {
                                foreach ($system_notification_emails as $system_notification_email) {
                                    log_and_send_templated_email(FORMS_NOTIFICATION_TO_ADMIN, $system_notification_email['email'], $replacement_array);
                                }
                            }

                            log_and_send_templated_email(FORMS_NOTIFICATION_TO_CLIENT, $email, $replacement_array);

                            if (isset($cc_auth_sid) && $cc_auth_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $cc_auth_sid, 'Employee', $email);
                            }

                            if (isset($eula_sid) && $eula_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $eula_sid, 'Employee', $email);
                            }

                            if (isset($contacts_sid) && $contacts_sid != 0) {
                                $this->documents_model->insert_document_email_history_record($company_sid, $contacts_sid, 'Employee', $email);
                            }
                        }

                        $this->session->set_flashdata('message', '<b>Success:</b> Documents Successfuly Forwarded.');
                        redirect('manage_admin/companies/manage_company/' . $company_sid, 'refresh');
                        break;
                }
            }
        } else {
            redirect('manage_admin/documents');
        }
    }

    public function check_signed_forms() {
        $companies_documents = $this->documents_model->get_cc_auth();

        foreach ($companies_documents as $key => $value) {
            $sid = $value['sid'];
            $status = $value['status'];
            $processed = $value['processed'];

            if ($processed == 0 && $status = 'signed') {
                echo '<br>SID: ' . $sid;
                $cc_type = encode_string($value['cc_type']);
                $cc_holder_name = encode_string($value['cc_holder_name']);
                $cc_number = encode_string($value['cc_number']);
                $cc_expiration_month = encode_string($value['cc_expiration_month']);
                $cc_expiration_year = encode_string($value['cc_expiration_year']);
                $this->documents_model->update_database($sid, $cc_type, $cc_holder_name, $cc_number, $cc_expiration_month, $cc_expiration_year);
            } else {
                echo 'Nothing to process';
            }
        }
    }

}