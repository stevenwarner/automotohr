<?php defined('BASEPATH') OR exit('No direct script access allowed');

class Groups extends Admin_Controller
{
    function __construct()
    {
        parent::__construct();
    }

    public function index()
    {
        // ** Check Security Permissions Checks - Start ** //
        $redirect_url       = 'manage_admin';
        $function_name      = 'list_admin_groups';

        $admin_id = $this->ion_auth->user()->row()->id;
        $security_details = db_get_admin_access_level_details($admin_id);
        $this->data['security_details'] = $security_details;
        check_access_permissions($security_details, $redirect_url, $function_name); // Param2: Redirect URL, Param3: Function Name
        // ** Check Security Permissions Checks - End ** //

        $this->data['groups'] = $this->ion_auth->groups()->result();
        $this->render('manage_admin/groups/list_groups_view');
    }

    public function create()
    {
        $this->data['page_title'] = 'Add group';
        $admin_id = $this->session->userdata('user_id');
        $security_details = db_get_admin_access_level_details($admin_id);
        $this->data['security_details'] = $security_details;
        check_access_permissions($security_details, 'manage_admin', 'create_admin_groups'); // Param2: Redirect URL, Param3: Function Name 
        $this->load->library('form_validation');
        $this->form_validation->set_rules('group_name', 'Group name', 'trim|required|is_unique[administrator_groups.name]');
        $this->form_validation->set_rules('group_description', 'Group description', 'trim|required');

        if ($this->form_validation->run() === FALSE) {
            $this->load->helper('form');
            $this->render('manage_admin/groups/create_group_view');
        } else {
            $group_name = $this->input->post('group_name');
            $group_description = $this->input->post('group_description');
            $modules = 'a:56:{i:0;a:7:{s:9:"is_header";s:4:"true";s:13:"function_name";s:0:"";s:12:"display_name";s:0:"";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:3:"top";s:11:"module_name";s:16:"Admin Management";}i:1;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:16:"list_admin_users";s:12:"display_name";s:16:"List Admin Users";s:4:"type";s:5:"class";s:13:"Parent_module";s:5:"Users";s:6:"status";s:6:"enable";s:11:"module_name";s:16:"Admin Management";}i:2;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"add_subaccount";s:12:"display_name";s:31:"Add - Edit - Delete Sub-Account";s:4:"type";s:8:"function";s:13:"Parent_module";s:5:"Users";s:6:"status";s:6:"enable";s:11:"module_name";s:16:"Admin Management";}i:3;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"edit_my_account";s:12:"display_name";s:15:"Edit My Profile";s:4:"type";s:8:"function";s:13:"Parent_module";s:5:"Users";s:6:"status";s:6:"enable";s:11:"module_name";s:16:"Admin Management";}i:4;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:17:"list_admin_groups";s:12:"display_name";s:17:"List Admin Groups";s:4:"type";s:5:"class";s:13:"Parent_module";s:6:"Groups";s:6:"status";s:6:"enable";s:11:"module_name";s:16:"Admin Management";}i:5;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:19:"create_admin_groups";s:12:"display_name";s:31:"Add - Edit - Delete Admin Group";s:4:"type";s:8:"function";s:13:"Parent_module";s:6:"Groups";s:6:"status";s:6:"enable";s:11:"module_name";s:16:"Admin Management";}i:6;a:7:{s:9:"is_header";s:4:"true";s:13:"function_name";s:0:"";s:12:"display_name";s:0:"";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:10:"top/bottom";s:11:"module_name";s:21:"Companies & Employers";}i:7;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"list_companies";s:12:"display_name";s:22:"Manage Companies Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:9:"Companies";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:8;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:12:"edit_company";s:12:"display_name";s:20:"Edit Company Account";s:4:"type";s:8:"function";s:13:"Parent_module";s:9:"Companies";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:9;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:29:"show_company_multiple_actions";s:12:"display_name";s:40:"Activate - DeActivate - Delete Companies";s:4:"type";s:8:"function";s:13:"Parent_module";s:9:"Companies";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:10;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"list_employers";s:12:"display_name";s:22:"Manage Employers Panel";s:4:"type";s:8:"function";s:13:"Parent_module";s:9:"Employers";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:11;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"edit_employers";s:12:"display_name";s:21:"Edit Employee Account";s:4:"type";s:8:"function";s:13:"Parent_module";s:9:"Employers";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:12;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:30:"show_employer_multiple_actions";s:12:"display_name";s:39:"Activate - DeActivate - Delete Employee";s:4:"type";s:8:"function";s:13:"Parent_module";s:9:"Employers";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:13;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:13:"employerlogin";s:12:"display_name";s:20:"Allow Employee Login";s:4:"type";s:8:"function";s:13:"Parent_module";s:9:"Employers";s:6:"status";s:6:"enable";s:11:"module_name";s:21:"Companies & Employers";}i:14;a:7:{s:9:"is_header";s:4:"true";s:13:"function_name";s:0:"";s:12:"display_name";s:0:"";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:10:"top/bottom";s:11:"module_name";s:7:"Billing";}i:15;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"invoices_panel";s:12:"display_name";s:14:"Invoices Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:7:"Invoice";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:16;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"add_new_invoice";s:12:"display_name";s:15:"Add New Invoice";s:4:"type";s:8:"function";s:13:"Parent_module";s:7:"Invoice";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:17;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:12:"edit_invoice";s:12:"display_name";s:12:"Edit Invoice";s:4:"type";s:8:"function";s:13:"Parent_module";s:7:"Invoice";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:18;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:16:"mark_paid_unpaid";s:12:"display_name";s:26:"Invoice Mark Paid / Unpaid";s:4:"type";s:5:"event";s:13:"Parent_module";s:7:"Invoice";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:19;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"resend_invoice";s:12:"display_name";s:21:"Resend Invoice E-Mail";s:4:"type";s:5:"event";s:13:"Parent_module";s:7:"Invoice";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:20;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"delete_invoice";s:12:"display_name";s:14:"Delete Invoice";s:4:"type";s:5:"event";s:13:"Parent_module";s:7:"Invoice";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:21;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:13:"list_products";s:12:"display_name";s:27:"Market Place Products Panel";s:4:"type";s:5:"Class";s:13:"Parent_module";s:8:"Products";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:22;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"add_new_product";s:12:"display_name";s:15:"Add New Product";s:4:"type";s:8:"function";s:13:"Parent_module";s:8:"Products";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:23;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:12:"edit_product";s:12:"display_name";s:12:"Edit Product";s:4:"type";s:8:"function";s:13:"Parent_module";s:8:"Products";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:24;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:13:"clone_product";s:12:"display_name";s:13:"Clone Product";s:4:"type";s:8:"function";s:13:"Parent_module";s:8:"Products";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:25;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:28:"activate_deactivate_products";s:12:"display_name";s:28:"Activate Deactivate Products";s:4:"type";s:5:"event";s:13:"Parent_module";s:8:"Products";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:26;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"list_promotions";s:12:"display_name";s:23:"Manage Promotions Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:10:"Promotions";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:27;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:17:"add_new_promotion";s:12:"display_name";s:17:"Add New Promotion";s:4:"type";s:8:"function";s:13:"Parent_module";s:10:"Promotions";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:28;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"edit_promotion";s:12:"display_name";s:14:"Edit Promotion";s:4:"type";s:8:"function";s:13:"Parent_module";s:10:"Promotions";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:29;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:29:"activate_deactivate_promotion";s:12:"display_name";s:29:"Activate Deactivate Promotion";s:4:"type";s:5:"event";s:13:"Parent_module";s:10:"Promotions";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:30;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:16:"delete_promotion";s:12:"display_name";s:16:"Delete Promotion";s:4:"type";s:5:"event";s:13:"Parent_module";s:10:"Promotions";s:6:"status";s:6:"enable";s:11:"module_name";s:7:"Billing";}i:31;a:7:{s:9:"is_header";s:4:"true";s:13:"function_name";s:0:"";s:12:"display_name";s:0:"";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:10:"top/bottom";s:11:"module_name";s:20:"System Configuration";}i:32;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"system_settings";s:12:"display_name";s:21:"System Settings Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:8:"Settings";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:33;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:17:"security_settings";s:12:"display_name";s:23:"Security Settings Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:17:"Security_settings";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:34;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"email_templates";s:12:"display_name";s:20:"Email Template Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:15:"email_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:35;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:25:"add_email_templates_group";s:12:"display_name";s:24:"Add a New Email Template";s:4:"type";s:8:"function";s:13:"Parent_module";s:15:"email_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:36;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:20:"email_templates_view";s:12:"display_name";s:19:"View Template Mails";s:4:"type";s:8:"function";s:13:"Parent_module";s:15:"email_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:37;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:25:"edit_email_templates_view";s:12:"display_name";s:19:"Edit Email Template";s:4:"type";s:8:"function";s:13:"Parent_module";s:15:"email_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:38;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:27:"delete_email_templates_view";s:12:"display_name";s:21:"Delete Email Template";s:4:"type";s:8:"function";s:13:"Parent_module";s:15:"email_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:39;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:19:"free_demo_enquiries";s:12:"display_name";s:19:"Free Demo Enquiries";s:4:"type";s:5:"class";s:13:"Parent_module";s:9:"Free_demo";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:40;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:19:"email_enquiries_log";s:12:"display_name";s:17:"Email Inquiry Log";s:4:"type";s:8:"function";s:13:"Parent_module";s:4:"logs";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:41;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:16:"private_messages";s:12:"display_name";s:28:"Private Messages Inbox Panel";s:4:"type";s:5:"class";s:13:"Parent_module";s:16:"Private_messages";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:42;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:23:"private_messages_outbox";s:12:"display_name";s:29:"Private Messages Outbox Panel";s:4:"type";s:8:"function";s:13:"Parent_module";s:16:"Private_messages";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:43;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:23:"compose_private_message";s:12:"display_name";s:24:"Compose Private Messages";s:4:"type";s:8:"function";s:13:"Parent_module";s:16:"Private_messages";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:44;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:22:"delete_private_message";s:12:"display_name";s:23:"Delete Private Messages";s:4:"type";s:8:"function";s:13:"Parent_module";s:16:"Private_messages";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:45;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:13:"reply_message";s:12:"display_name";s:25:"Reply to Private Messages";s:4:"type";s:8:"function";s:13:"Parent_module";s:16:"Private_messages";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:46;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:21:"job_listing_templates";s:12:"display_name";s:21:"Job Listing Templates";s:4:"type";s:5:"class";s:13:"Parent_module";s:21:"Job_listing_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:47;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:14:"add_edit_group";s:12:"display_name";s:27:"Add/Edit Job Template Group";s:4:"type";s:5:"class";s:13:"Parent_module";s:21:"Job_listing_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:48;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:30:"add_edit_job_listing_templates";s:12:"display_name";s:33:"Add/Edit New Job Listing Template";s:4:"type";s:8:"function";s:13:"Parent_module";s:21:"Job_listing_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:49;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:20:"fDeleteTemplateGroup";s:12:"display_name";s:33:"Delete Job Listing Template Group";s:4:"type";s:5:"event";s:13:"Parent_module";s:21:"Job_listing_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:50;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:15:"fDeleteTemplate";s:12:"display_name";s:28:"Delete Job Listing Template ";s:4:"type";s:5:"event";s:13:"Parent_module";s:21:"Job_listing_templates";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:51;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:13:"fSwitchStatus";s:12:"display_name";s:41:"Activate Deactivate Job Listing Templates";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:6:"enable";s:11:"module_name";s:20:"System Configuration";}i:52;a:7:{s:9:"is_header";s:4:"true";s:13:"function_name";s:0:"";s:12:"display_name";s:0:"";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:10:"top/bottom";s:11:"module_name";s:19:"Accurate Backgorund";}i:53;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:19:"accurate_background";s:12:"display_name";s:39:"Accurate Backgorund Activation Requests";s:4:"type";s:8:"function";s:13:"Parent_module";s:19:"Accurate_background";s:6:"status";s:6:"enable";s:11:"module_name";s:19:"Accurate Backgorund";}i:54;a:7:{s:9:"is_header";s:5:"false";s:13:"function_name";s:17:"activation_orders";s:12:"display_name";s:26:"Accurate Backgorund Orders";s:4:"type";s:8:"function";s:13:"Parent_module";s:19:"Accurate_background";s:6:"status";s:6:"enable";s:11:"module_name";s:19:"Accurate Backgorund";}i:55;a:7:{s:9:"is_header";s:4:"true";s:13:"function_name";s:0:"";s:12:"display_name";s:0:"";s:4:"type";s:0:"";s:13:"Parent_module";s:0:"";s:6:"status";s:6:"bottom";s:11:"module_name";s:0:"";}}';
            $this->ion_auth->create_group($group_name, $group_description, '', $modules);
            $this->session->set_flashdata('message', $this->ion_auth->messages());
            redirect('manage_admin/groups', 'refresh');
        }
    }

    public function edit($group_id = NULL)
    {
        $group_id = $this->input->post('group_id') ? $this->input->post('group_id') : $group_id;
        $admin_id = $this->session->userdata('user_id');
        $security_details = db_get_admin_access_level_details($admin_id);
        $this->data['security_details'] = $security_details;
        check_access_permissions($security_details, 'manage_admin', 'create_admin_groups'); // Param2: Redirect URL, Param3: Function Name

        $this->data['page_title'] = 'Edit group';
        $this->load->library('form_validation');

        $this->form_validation->set_rules('group_name', 'Group name', 'trim|required');
        $this->form_validation->set_rules('group_description', 'Group description', 'trim|required');
        $this->form_validation->set_rules('group_id', 'Group id', 'trim|integer|required');

        if ($this->form_validation->run() === FALSE) {
            if ($group = $this->ion_auth->group((int)$group_id)->row()) {
                $this->data['group'] = $group;
                $permissions = array();
                $access_level_permissions = $group->permissions;

                if (!empty($access_level_permissions)) {
                    $permissions = unserialize($access_level_permissions);
                }

                $this->data['permissions'] = $permissions;
                $available_modules = $group->available_modules;
                $available_modules = unserialize($available_modules);
                $this->data['modules'] = $available_modules;

            } else {
                $this->session->set_flashdata('message', 'The group doesn\'t exist.');
                redirect('manage_admin/groups', 'refresh');
            }

            $this->load->helper('form');
            $this->render('manage_admin/groups/edit_group_view');
        } else {
            $group_name = $this->input->post('group_name');
            $group_description = $this->input->post('group_description');
            $group_id = $this->input->post('group_id');
            $group = $this->ion_auth->group((int)$group_id)->row();
            $available_modules = $group->available_modules;
            $available_modules = unserialize($available_modules);
            $function_name = '';
            $update_permission = array();
            //$available_modules                                              = unserialize($available_modules);
            if (isset($_POST['function_name'])) {
                $function_name = $_POST['function_name'];
            }

            if (!empty($function_name)) { // update permissions for the user
                foreach ($function_name as $mykey => $fn_name) {
                    $key = array_search($fn_name, array_column($available_modules, 'function_name'));
                    $mykey++;
                    $update_permission[] = $available_modules[$key];
                }
            }
            $update_permission = serialize($update_permission);
            $this->ion_auth->update_group($group_id, $group_name, $group_description, $update_permission);
            $this->session->set_flashdata('message', $this->ion_auth->messages());
            redirect('manage_admin/groups', 'refresh');
        }
    }

    public function delete()
    {
        $group_id = $this->input->post('sid');
        $admin_id = $this->session->userdata('user_id');
        $security_details = db_get_admin_access_level_details($admin_id);
        $this->data['security_details'] = $security_details;
        if (in_array('full_access', $security_details) || in_array('create_admin_groups', $security_details)) {
            $this->ion_auth->delete_group($group_id);
            $this->session->set_flashdata('message', $this->ion_auth->messages());
        }
    }
}