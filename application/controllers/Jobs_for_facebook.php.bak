<?php

defined('BASEPATH') OR exit('No direct script access allowed');

class jobs_for_facebook extends CI_Controller {

    function __construct() {
        parent::__construct();

        $this->load->helper('url');
        $this->load->model('Facebook_configuration_model');

    }

    public function index($fb_unique_identifier = null) {
        $data = array();
        $data['title'] = 'Job Listings';
        if($fb_unique_identifier != null){

            $fbConfiguration = $this->Facebook_configuration_model->GetFacebookConfigurationByUniqueString($fb_unique_identifier);



            if(!empty($fbConfiguration)){
                $Jobs = $this->Facebook_configuration_model->fetch_all_active_jobs($fbConfiguration['company_sid']);



                $companyDetails = $this->Facebook_configuration_model->GetCompanyDetails($fbConfiguration['company_sid']);



                if(!empty($Jobs)){



                    $data_countries = array();
                    $data_states = array();

                    $data_countries = db_get_active_countries();
                    foreach ($data_countries as $value) {
                        $data_states[$value['sid']] = db_get_active_states($value['sid']);
                    }



                    $data['active_countries'] = $data_countries;
                    $data['active_states'] = $data_states;
                    $data['company_details'] =$companyDetails;

                    foreach($Jobs as $Key => $Job){
                        $country_id = $Job['Location_Country'];
                        // get country name
                        if (!empty($country_id)) {
                            $country_name = $this->Facebook_configuration_model->GetCountryNameById($country_id);

                            //var_dump($country_name);

                            if (!empty($country_name[0]['country_name'])) {
                                $Jobs[$Key]['Location_Country'] = $country_name[0]['country_name'];
                            }
                        }


                        //Set State
                        $state_id = $Job['Location_State'];
                        if (!empty($state_id)) {
                            // get state name
                            $state_name = $this->Facebook_configuration_model->GetStateNameById($state_id);



                            $Jobs[$Key]['Location_State'] = $state_name['state_name'];
                        }

                        //Set Categories
                        $JobCategorys = $Job['JobCategory'];
                        if ($JobCategorys != null) {
                            $cat_id = explode(',', $JobCategorys);
                            $job_category_array = array();
                            foreach ($cat_id as $id) {
                                $job_cat_name = $this->Facebook_configuration_model->GetJobsCategoryNameById($id);
                                $job_category_array[] = $job_cat_name['value'];
                            }
                            $job_category = implode(', ', $job_category_array);
                            $Jobs[$Key]['JobCategory'] = $job_category;
                        }


                        //Making job title start
                        $company_id = $fbConfiguration['company_sid'];
                        $Jobs[$Key]['Title'] = db_get_job_title($company_id, $Jobs[$Key]['Title'], $Jobs[$Key]['Location_City'], $Jobs[$Key]['Location_State'], $Jobs[$Key]['Location_Country']);
                        //Making job title ends

                        $Jobs[$Key]['Job_Url'] = db_get_sub_domain($company_id) . '/job_details/' . $Job['sid'];

                    }



                    $data['jobs'] = $Jobs;
                    $this->load->view('jobs_for_facebook/jobs_list_view', $data);
                }else{
                    echo 'No Jobs Found!';
                }
            }else{
                echo 'Wrong Unique Identifier!';
            }
        }else{
            echo 'Unique Identifier Not Provided.';
        }
    }
}
