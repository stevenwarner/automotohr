<?php

defined('BASEPATH') OR exit('No direct script access allowed');

class Trato_feed extends CI_Controller {

    public function __construct() {
        parent::__construct();
        $this->load->model('all_feed_model');
        require_once(APPPATH . 'libraries/aws/aws.php');
    }

    public function index() {
        $jobData = $this->all_feed_model->get_all_company_jobs_trato();
        
        header('Content-type: text/xml');
        header('Pragma: public');
        header('Cache-control: private');
        header('Expires: -1');
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>";
        echo '<xml>';
        foreach ($jobData as $job) {
                        $company_id = $job['user_sid'];
                        $companyPortal = $this->all_feed_model->get_portal_detail($company_id);
                        $companyName = $this->all_feed_model->get_company_name_by_id($company_id);
                        $companyDetail = $this->all_feed_model->get_company_detail($company_id);
                        $companyLogo = $companyDetail['Logo'];
                        $companyContactName = $companyDetail['ContactName'];
                        $companyYoutube = $companyDetail['YouTubeVideo'];
                        $companyUserName = strtolower(str_replace(" ", "", $companyName));

                        if (isset($job['Location_Country']) && $job['Location_Country'] != NULL) {
                            $country = db_get_country_name($job['Location_Country']);
                        } else {
                            $country['country_code'] = "US";
                        }

                        if (isset($job['Location_State']) && $job['Location_State'] != NULL) {
                            $state = db_get_state_name($job['Location_State']);
                        } else {
                            $state['state_name'] = "";
                        }

                        if (isset($job['Location_City']) && $job['Location_City'] != NULL) {
                            $city = $job['Location_City'];
                        } else {
                            $city = "";
                        }
                        if (isset($job['Location_ZipCode']) && $job['Location_ZipCode'] != NULL) {
                            $zipcode = $job['Location_ZipCode'];
                        } else {
                            $zipcode = "";
                        }
                        if (isset($job['Salary']) && $job['Salary'] != NULL) {
                            $salary = $job['Salary'];
                        } else {
                            $salary = "";
                        }
                        if (isset($job['SalaryType']) && $job['SalaryType'] != NULL) {
                            if ($job['SalaryType'] == 'per_hour') {
                                $jobType = "Per Hour";
                            } elseif ($job['SalaryType'] == 'per_week') {
                                $jobType = "Per Week";
                            } elseif ($job['SalaryType'] == 'per_month') {
                                $jobType = "Per Month   ";
                            } elseif ($job['SalaryType'] == 'per_year') {
                                $jobType = "Per Year";
                            }
                        } else {
                            $jobType = "";
                        }
                        $JobCategorys = $job['JobCategory'];
                        if ($JobCategorys != null) {
                            $cat_id = explode(',', $JobCategorys);
                            $job_category_array = array();
                            foreach ($cat_id as $id) {
                                $job_cat_name = $this->all_feed_model->get_job_category_name_by_id($id);
                                $job_category_array[] = $job_cat_name[0]['value'];
                            }
                            $job_category = implode(', ', $job_category_array);
                        }


                        $featured = 1;
                        if (isset($featuredId['expiry_date'])) {
                            $expiryDate = my_date_format($featuredId['expiry_date']) . " PST";
                        }

                        $jobDescription = str_replace('"', "'", strip_tags($job['JobDescription'], '<br>'));

                        if (isset($job['JobRequirements']) && $job['JobRequirements'] != NULL) {
                            $jobRequirements = str_replace('"', "'", strip_tags($job['JobRequirements'], '<br>'));
                        } else {
                            $jobRequirements = "";
                        }

                        if (!empty($companyDetail['YouTubeVideo'])) {
                            $companyYoutube = "https://www.youtube.com/watch?v=" . $companyDetail['YouTubeVideo'];
                        } else {
                            $companyYoutube = $companyDetail['YouTubeVideo'];
                        }
                        if (!empty($job['YouTube_Video'])) {
                            $job['YouTube_Video'] = "https://www.youtube.com/watch?v=" . $job['YouTube_Video'];
                        }


                        echo"
                    <job>
                    <title><![CDATA[" . db_get_job_title($company_id, $job['Title'], $city, $state['state_name'], $country['country_code']) . "]]></title>
                    <publish_date><![CDATA[" . date_with_time($job['activation_date']) . " PST]]></publish_date>
                    <expiry_date><![CDATA[" . $expiryDate . "]]></expiry_date>
                    <referencenumber><![CDATA[" . $job['sid'] . "]]></referencenumber>
                    <url><![CDATA[" . STORE_PROTOCOL . $companyPortal['sub_domain'] . "/job_details/" . $job['sid'] . "]]></url>
                    <company><![CDATA[" . $companyName . "]]></company>
                    <username><![CDATA[" . $companyUserName . "]]></username>
                    <city><![CDATA[" . $city . "]]></city>
                    <state><![CDATA[" . $state['state_name'] . "]]></state>
                    <country><![CDATA[" . $country['country_code'] . "]]></country>
                    <postalcode><![CDATA[" . $zipcode . "]]></postalcode>
                    <salary><![CDATA[" . $salary . "]]></salary>
                    <jobtype><![CDATA[" . $jobType . "]]></jobtype>
                    <AHR_featured><![CDATA[" . $featured . "]]></AHR_featured>
                    <AHR_priority><![CDATA[1]]></AHR_priority>
                    <category><![CDATA[" . $job_category . "]]></category>
                    <description><![CDATA[" . $jobDescription . "]]></description>
                    <jobRequirements><![CDATA[" . $jobRequirements . "]]></jobRequirements>
                    <youtube_video><![CDATA[" . $job['YouTube_Video'] . "]]></youtube_video>
                    <company_logo><![CDATA[" . AWS_S3_BUCKET_URL . $companyLogo . "]]></company_logo>
                    <apply_url><![CDATA[" . STORE_PROTOCOL . $companyPortal['sub_domain'] . "/job_details/" . $job['sid'] . "]]></apply_url>
                    <company_url><![CDATA[" . STORE_PROTOCOL . $companyPortal['sub_domain'] . "]]></company_url>
                    <contact_name><![CDATA[" . $companyContactName . "]]></contact_name>
                    <company_youtube_video><![CDATA[" . $companyYoutube . "]]></company_youtube_video>
                    </job>";
                }
        echo '</xml>';
        exit;
    }
}