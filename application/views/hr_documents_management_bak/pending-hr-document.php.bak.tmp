<!-- Main Start -->
<div class="main-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-3 col-md-3 col-xs-12 col-sm-12">
                <?php $this->load->view('main/manage_ems_left_view'); ?>
            </div>  
            <div class="col-lg-9 col-md-9 col-xs-12 col-sm-12">
                <?php $this->load->view('templates/_parts/admin_flash_message'); ?>
                <div class="dashboard-conetnt-wrp">
                    <div class="page-header-area">
                        <span class="page-heading down-arrow"><a class="dashboard-link-btn" href="<?php echo base_url('hr_documents_management/people_with_pending_documents'); ?>"><i class="fa fa-chevron-left"></i>People With Pending Documents</a><?php echo $title; ?> </span>
                    </div>
                    <div class="create-job-wrap">
                        <?php if (count($documents) == 0) { ?>
                            <div class="archived-document-area">
                                <div class="cloud-icon"><i class="fa fa-cloud-upload"></i></div>
                                <div class="archived-heading-area">
                                    <h2>No Pending Document!</h2>
                                </div>
                            </div>
                        <?php } else { ?>
                            <?php if (count($documents) > 0 || !empty($w4_form) || !empty($w9_form) || !empty($i9_form)) { ?>
                                <div class="table-responsive">
                                    <h3>Document Details For Employee: <b><?php echo $userDetail['first_name']; ?> <?php echo $userDetail['last_name']; ?></b></h3>
                                    <div class="hr-document-list">
                                        <table class="hr-doc-list-table">
                                            <thead>
                                                <tr>
                                                    <th>Document Name</th>
                                                    <th class="text-center">Type</th>
                                                    <th class="text-center">Sent On</th>
                                                    <th class="text-center">Acknowledged</th>
                                                    <th class="text-center">Downloaded</th>
                                                    <th class="text-center">Uploaded</th>
                                                    <th class="text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php if (!empty($w4_form)) { ?>
                                                    <tr>
                                                        <td>
                                                            W4 Fillable <b>(Employment Eligibility Verification Documents)</b> 
                                                        </td>
                                                        <td>
                                                            <i class="fa fa-2x fa-file-text"></i>
                                                        </td>
                                                        <td>
                                                            <?php echo reset_datetime(array('datetime' => $w4_form['sent_date'], '_this' => $this)); ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <a class="btn btn-success btn-sm btn-block" data-toggle="modal" data-target="#w4_modal" href="javascript:void(0);">
                                                                Preview Assigned
                                                            </a>
                                                        </td>
                                                    </tr>
                                                <?php } ?> 

                                                <?php if (!empty($w9_form)) { ?>
                                                    <tr>
                                                        <td>
                                                            W9 Fillable <b>(Employment Eligibility Verification Documents)</b> 
                                                        </td>
                                                        <td>
                                                            <i class="fa fa-2x fa-file-text"></i>
                                                        </td>
                                                        <td>
                                                            <?php echo reset_datetime(array('datetime' => $w9_form['sent_date'], '_this' => $this)); ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <a class="btn btn-success btn-sm btn-block" data-toggle="modal" data-target="#w9_modal" href="javascript:void(0);">
                                                                Preview Assigned
                                                            </a>
                                                        </td>
                                                    </tr>
                                                <?php } ?>  

                                             
                                                <?php if (!empty($i9_form)) { ?>
                                                    <tr>
                                                        <td>
                                                            I9 Fillable <b>(Employment Eligibility Verification Documents)</b> 
                                                        </td>
                                                        <td>
                                                            <i class="fa fa-2x fa-file-text"></i>
                                                        </td>
                                                        <td>
                                                            <?php echo reset_datetime(array('datetime' => $i9_form['sent_date'], '_this' => $this)); ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <?php echo '<b>N/A</b>'; ?>
                                                        </td>
                                                        <td>
                                                            <a class="btn btn-success btn-sm btn-block" data-toggle="modal" data-target="#i9_modal" href="javascript:void(0);">
                                                                Preview Assigned
                                                            </a>
                                                        </td>
                                                    </tr>
                                                <?php } ?>   

                                                <?php foreach ($documents as $document) { ?>
                                                    <tr>
                                                        <td><?php echo ucfirst($document['document_title']) . '<br>';
                                                            echo $document['status'] ? '' : '<b>(revoked)</b>';?></td>
                                                        <td class="text-center">
                                                            <?php $doc_type = '';

                                                            if (!empty($document['document_extension'])) {
                                                                $doc_type = strtolower($document['document_extension']);
                                                            } ?>
                                                            <?php if ($doc_type == 'pdf') { ?>
                                                                <i class="fa fa-2x fa-file-pdf-o"></i>
                                                            <?php } else if (in_array($doc_type, ['ppt', 'pptx'])) { ?>
                                                                <i class="fa fa-2x fa-file-powerpoint-o"></i>
                                                            <?php } else if (in_array($doc_type, ['doc', 'docx'])) { ?>
                                                                <i class="fa fa-2x fa-file-o"></i>
                                                            <?php } else if (in_array($doc_type, ['xlsx'])) { ?>
                                                                <i class="fa fa-2x fa-file-excel-o"></i>
                                                            <?php } else if ($doc_type == '') { ?>
                                                                <i class="fa fa-2x fa-file-text"></i>
                                                            <?php } ?>
                                                        </td>
                                                        <td><?=reset_datetime(array('datetime' => $document['assigned_date'], '_this' => $this)); ?></td>
                                                        <td class="text-center">
                                                            <?php
                                                                if(!$document['acknowledgment_required']){
                                                                    echo '<b>N/A</b>';
                                                                } elseif ($document['acknowledged']) {
                                                                    echo '<i class="fa fa-check fa-2x text-success"></i> ' . reset_datetime(array('datetime' => $document['acknowledged_date'], '_this' => $this));
                                                                } else {
                                                                    echo '<i class="fa fa-times fa-2x text-danger"></i>';
                                                                } 
                                                            ?>
                                                        </td>
                                                        <td class="text-center">
                                                            <?php
                                                                if(!$document['download_required']){
                                                                    echo '<b>N/A</b>';
                                                                } elseif ($document['downloaded']) {
                                                                    echo '<i class="fa fa-check fa-2x text-success"></i> ' . reset_datetime(array('datetime' => $document['downloaded_date'], '_this' => $this));
                                                                } else {
                                                                    echo '<i class="fa fa-times fa-2x text-danger"></i>';
                                                                }
                                                            ?>
                                                        </td>
                                                        <td class="text-center">
                                                            <?php 
                                                                if(!$document['signature_required']){
                                                                    echo '<b>N/A</b>';
                                                                } elseif ($document['uploaded']) {
                                                                    echo '<i class="fa fa-check fa-2x text-success"></i> ' . reset_datetime(array('datetime' => $document['uploaded_date'], '_this' => $this));
                                                                } else {
                                                                    echo '<i class="fa fa-times fa-2x text-danger"></i>';
                                                                }
                                                            ?>      
                                                        </td>
                                                        <td class="col-lg-1 text-center">
                                                            <?php if ($document['document_type'] == 'uploaded') { ?>
                                                                <button
                                                                    class="btn btn-success btn-sm btn-block"
                                                                    onclick="fLaunchModal(this);"
                                                                    data-preview-url="<?php echo AWS_S3_BUCKET_URL . $document['document_s3_name']; ?>"
                                                                    data-download-url="<?php echo AWS_S3_BUCKET_URL . $document['document_s3_name']; ?>"
                                                                    data-file-name="<?php echo $document['document_original_name']; ?>"
                                                                    data-document-title="<?php echo $document['document_original_name']; ?>">
                                                                    Preview Assigned
                                                                </button>
                                                                <button
                                                                    class="btn btn-success btn-sm btn-block"
                                                                    onclick="fLaunchModal(this);"
                                                                    data-preview-url="<?php echo AWS_S3_BUCKET_URL . $document['uploaded_file']; ?>"
                                                                    data-download-url="<?php echo AWS_S3_BUCKET_URL . $document['uploaded_file']; ?>"
                                                                    data-file-name="<?php echo $document['uploaded_file']; ?>"
                                                                    data-document-title="<?php echo $document['uploaded_file']; ?>" <?= !$document['uploaded'] ? 'disabled' : ''; ?>>
                                                                    Preview Submitted
                                                                </button>
                                                            <?php } else { ?>
                                                                <button
                                                                    onclick="func_get_generated_document_preview(<?php echo $document['document_sid']; ?>, 'generated', 'modified');"
                                                                    class="btn btn-success btn-sm btn-block">
                                                                    Preview Assigned
                                                                </button>
                                                                <?php if (!empty($document['uploaded_file'])) { ?>
                                                                    <button
                                                                        class="btn btn-success btn-sm btn-block"
                                                                        onclick="fLaunchModal(this);"
                                                                        data-preview-url="<?php echo AWS_S3_BUCKET_URL . $document['uploaded_file']; ?>"
                                                                        data-download-url="<?php echo AWS_S3_BUCKET_URL . $document['uploaded_file']; ?>"
                                                                        data-file-name="<?php echo $document['uploaded_file']; ?>"
                                                                        data-document-title="<?php echo $document['uploaded_file']; ?>" <?= !$document['uploaded'] ? 'disabled' : ''; ?>>
                                                                        Preview Submitted
                                                                    </button>
                                                                <?php } else if (!empty($document['submitted_description'])) { ?> 
                                                                     <button
                                                                        onclick="func_show_submitted_generated_document('<?php echo $document['submitted_description']; ?>')"
                                                                        class="btn btn-success btn-sm btn-block">
                                                                        Preview Submitted
                                                                    </button>
                                                                <?php } else { ?>
                                                                    <button
                                                                        class="btn btn-success btn-sm btn-block"
                                                                        <?= !$document['uploaded'] ? 'disabled' : ''; ?>>
                                                                        Preview Submitted
                                                                    </button>
                                                                <?php } ?>   
                                                            <?php } ?>
                                                        </td>
                                                    </tr>
                                                <?php }
                                                ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            <?php } else { ?>
                                <table class="hr-doc-list-table">
                                    <thead>
                                        <tr>                                                
                                            <th>Document Name</th>
                                            <th>Sent On</th>
                                            <th>Acknowledged</th>
                                            <th>Downloaded</th>
                                            <th>Uploaded</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            No Document Available
                                        </tr>
                                    </tbody>
                                </table>
                                <?php
                            }
                        }
                        
                        if (check_access_permissions_for_view($security_details, 'send_reminder')) { ?>
                            <div class="btn-panel">
                                <a class="delete-all-btn active-btn"  onclick="send_reminder(this.id)" id="<?php echo $userDetail['sid'] ?>" href="javascript:;">Send Reminder</a>
                            </div>
                        <?php } ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="document_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-bg">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="document_modal_title">Modal title</h4>
            </div>
            <div id="document_modal_body" class="modal-body">
                ...
            </div>
            <div id="document_modal_footer" class="modal-footer">

            </div>
        </div>
    </div>
</div>

<?php if(!empty($w4_form)>0) { ?>
    <div id="w4_modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-bg">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="review_modal_title">Assigned W4 Form</h4>
                </div>
                <div id="review_modal_body" class="modal-body">
                    <?php $view = get_form_view('pw4',$w4_form);
                    echo $view; ?>
                </div>
                <div id="review_modal_footer" class="modal-footer">

                </div>
            </div>
        </div>
    </div>
<?php } ?>

<?php if(!empty($w9_form)>0) { ?>
    <div id="w9_modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-bg">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="review_modal_title">Assigned W9 Form</h4>
                </div>
                <div id="review_modal_body" class="modal-body">
                    <?php $view = get_form_view('pw9',$w9_form);
                    echo $view; ?>
                </div>
                <div id="review_modal_footer" class="modal-footer">

                </div>
            </div>
        </div>
    </div>
<?php } ?>

<?php if(!empty($i9_form)>0) { ?>
    <div id="i9_modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-bg">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="review_modal_title">Assigned I9 Form</h4>
                </div>
                <div id="review_modal_body" class="modal-body">
                    <?php $view = get_form_view('i9',$i9_form);
                    echo $view; ?>
                </div>
                <div id="review_modal_footer" class="modal-footer">

                </div>
            </div>
        </div>
    </div>
<?php } ?>

<script type="text/javascript">
    function fLaunchModal(source) {
        var document_preview_url = $(source).attr('data-preview-url');
        var document_download_url = $(source).attr('data-download-url');
        var document_title = $(source).attr('data-document-title');
        var document_file_name = $(source).attr('data-file-name');
        var file_extension = document_file_name.substr(document_file_name.lastIndexOf('.') + 1, document_file_name.length);
        var modal_content = '';
        var footer_content = '';
        var iframe_url = '';

        if (document_preview_url != '') {
            switch (file_extension.toLowerCase()) {
                case 'doc':
                case 'docx':
                case 'DOC':
                case 'DOCX':
                    iframe_url = 'https://view.officeapps.live.com/op/embed.aspx?src=' + document_preview_url;
                    modal_content = '<iframe src="' + iframe_url + '" id="preview_iframe" class="uploaded-file-preview"  style="width:100%; height:500px;" frameborder="0"></iframe>';
                    break;
                case 'jpg':
                case 'jpe':
                case 'jpeg':
                case 'png':
                case 'gif':
                case 'JPG':
                case 'JPE':
                case 'JPEG':
                case 'PNG':
                case 'GIF':
                    modal_content = '<img src="' + document_preview_url + '" style="width:100%; height:500px;" />';
                default : //using google docs
                    iframe_url = 'https://docs.google.com/gview?url=' + document_preview_url + '&embedded=true';
                    modal_content = '<iframe src="' + iframe_url + '" id="preview_iframe" class="uploaded-file-preview"  style="width:100%; height:500px;" frameborder="0"></iframe>';
                    break;
            }

            footer_content = '<a target="_blank" download="download" class="btn btn-success" href="' + document_download_url + '">Download</a>';
        } else {
            modal_content = '<h5>No ' + document_title + ' Uploaded.</h5>';
            footer_content = '';
        }

        $('#document_modal_body').html(modal_content);
        $('#document_modal_footer').html(footer_content);
        $('#document_modal_title').html(document_title);
        $('#document_modal').modal("toggle");
        $('#document_modal').on("shown.bs.modal", function () {
        
            if (iframe_url != '') {
                $('#preview_iframe').attr('src', iframe_url);
            }
        });
    }

    function func_get_generated_document_preview(document_sid, source = 'original', fetch_data = 'original') {
        var my_request;
        my_request = $.ajax({
            'url': '<?php echo base_url('hr_documents_management/ajax_responder'); ?>',
            'type': 'POST',
            'data': {
                'perform_action': 'get_generated_document_preview',
                'document_sid': document_sid,
                'user_type': '<?php echo $user_type; ?>',
                'user_sid': <?php echo $user_sid; ?>,
                'source': source,
                'fetch_data': fetch_data
            }
        });

        my_request.done(function (response) {
            $('#popupmodalbody').html(response);
            $('#popupmodallabel').html('Preview Hr Document');
            $('#popupmodal .modal-dialog').css('width', '60%');
            $('#popupmodal').modal('toggle');
        });
    }

    function func_show_submitted_generated_document(document_base_64) {
        modal_content = '<iframe src="' + document_base_64 + '" id="preview_iframe" class="uploaded-file-preview"  style="width:100%; height:500px;" frameborder="0"></iframe>';
        footer_content = '';
        $('#document_modal_body').html(modal_content);
        $('#document_modal_footer').html(footer_content);
        $('#document_modal_title').html('Preview Hr Document');
        $('#document_modal').modal("toggle");
    }

    function send_reminder(id) {
        var url = "<?= base_url() ?>hr_documents_management/send_document_reminder";
        alertify.confirm('Confirmation', "Are you sure you want to send a Document Reminder?",
            function () {
                $.post(url, {user_document_sid: id})
                    .done(function (data) {
                    });
            },
            function () {
            });
    }
</script>
