<style>
    .csModalLoader{
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        background-color: #ffffff;
    }
    .csModalLoader i{
        position: relative;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 50px;
        color: #81b431;
    }
</style>

<script>
    //
    let policyEmployeeId = null;
    let policyTimeslot = null;
    let policyFormat = null;
    // startBalanceProcess(58); 
    // Step 1
    async function startPolicyProcess(employeeId){
        // Load Modal
        let rows = `
        <!-- Modal -->
        <div class="modal fade" id="jsEmployeePolicyModal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #81b431; color: #ffffff;">
                        <h3 class="modal-title">Balance Breakdown</h3>
                    </div>
                    <div class="modal-body">
                        <div>
                            <div class="csModalLoader jsEPModalLoader"><i class="fa fa-circle-o-notch fa-spin"></i></div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Policy</th>
                                            <th>Allowed Time</th>
                                            <th>Manual Balance</th>
                                            <th>Total Time</th>
                                            <th>Consumed Time</th>
                                            <th>Pending Time</th>
                                            <th>Policy Reset Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jsEmployeePolicyModalBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>`;
        //
        $('#jsEmployeePolicyModal').remove();
        //
        $('body').append(rows);
        $('.jsEPModalLoader').show(0);
        $('#jsEmployeePolicyModal').modal('show');
        // Set the employee id
        policyEmployeeId = employeeId;
        // Get employee policies
        let policies = await fetchPolicies2();
        //
        if(policies.Status === false){
            alertify.alert('ERROR!', 'System could not found any policies against the selected employee.', () => {});
            return;
        }
        else policies = policies.Data;
        //
        let policyList = {};
        //
        policyFormat = policies[0]['format'];
        policyTimeslot = policies[0]['employee_timeslot'];
        //
        policies.map(function(policy){
            //
            if(!policyList.hasOwnProperty(policy.Category)) policyList[policy.Category] = [];
            //
            policyList[policy.Category].push(policy);
        });
        //
        policyList  = sortObjectByKey(policyList);
        //
        let policyOptions = '';
        //
        Object.keys(policyList).map((p) => {
            //
            let policy = policyList[p];
            //
            policyOptions += `<tr><th colspan="7">${p}</th></tr>`;
            //
            policy.map((pi) => {
              policyOptions += `
                <tr>
                    <td>${pi.title}</td>
                    <td>${pi.AllowedBreakDown !== undefined  ? pi.AllowedBreakDown.text : 'Unlimited'}</td>
                    <td>${pi.ManualBalanceBreakDown !== undefined  ? pi.ManualBalanceBreakDown.text : '0'}</td>
                    <td>${pi.TotalBreakDown !== undefined ? pi.TotalBreakDown.text : 'Unlimited'}</td>
                    <td>${pi.ConsumedBreakDown !== undefined  ? pi.ConsumedBreakDown.text : '0'}</td>
                    <td>${pi.PendingBreakDown !== undefined ? pi.PendingBreakDown.text : 'Unlimited'}</td>
                    <td>${
                        moment().diff(moment(pi.PolicyResetDate), 'years', false) ?
                        moment(pi.PolicyResetDate).add(1, 'year').format('MM/DD/YYYY') :
                        moment(pi.PolicyResetDate).format('MM/DD/YYYY')
                    }</td>
                </tr>
              `;
            });
        });
        //
        $('#jsEmployeePolicyModalBody').html(policyOptions);
        $('.jsEPModalLoader').hide(0);
    }

    // Fetch employee policies
    function fetchPolicies2(){
        return new Promise((res, rej) => {
            //
            $.post("<?=base_url('timeoff/handler');?>", {
                action: 'get_employee_all_policies',
                companySid: <?=$company_sid;?>,
                employeeSid: policyEmployeeId
            }, function(resp){
                res(resp);
            });
        });
    }

    // Object sorter
    var sortObjectByKey = function(obj){
        var keys = [];
        var sorted_obj = {};

        for(var key in obj){
            if(obj.hasOwnProperty(key)){
                keys.push(key);
            }
        }

        // sort keys
        keys.sort();

        // create new array based on Sorted Keys
        jQuery.each(keys, function(i, key){
            sorted_obj[key] = obj[key];
        });

        return sorted_obj;
    };

</script>

<style>
    .cs-required{
        font-weight: bold;
        font-size: 14px;
        color: #cc1100;
    }
    .js-number{
        height: 40px;
    }
    #ui-datepicker-div{
        z-index: 1051 !important;
    }
</style>

