<script type="text/javascript" src="<?= base_url("assets/js/owl.carousel.min.js"); ?>"></script>

<script>
    var intervalHolder = null;
    $(function(){
        $('.js-to-heading').text('Time Off');
        var
        requests = {},
        filterActive = false,
        dataTarget = $('.js-data-load-area'),
        currentRequest = {},
        employeePolicies = [],
        overwrite = {
            'teamlead' : 'Team Lead',
            'supervisor' : 'Supervisor',
            'approver' : 'Approver'
        },
        FMLACategories = {
            health: 'Certification of Health Care Provider for Employeeâ€™s Serious Health Condition',
            medical: 'Notice of Eligibility and Rights & Responsibilities',
            designation: 'Designation Notice'
        },
        emt = {
            modal: $('#js-edit-modal'),
            header: $('#js-edit-modal-header'),
            tabs: $('#js-edit-modal-tabs'),
            requestDate: $('#js-edit-modal-date'),
            requestTime: $('#js-edit-modal-time'),
            policies: $('#js-edit-modal-policies'),
            status: $('#js-edit-modal-status'),
            isPartialLeave: $('#js-edit-modal-partial-leave'),
            partialLeaveCheck: '.js-edit-modal-partial-check',
            noteBox: $('#js-edit-modal-note-box'),
            note: $('#js-edit-modal-note-input'),
            reason: $('#js-edit-modal-reason'),
            comment: 'js-edit-modal-comment',
            progress: $('#js-edit-modal-progress-bar'),
            saveBtn: $('#js-edit-modal-save-btn'),
            cancelBtn: $('#js-edit-modal-cancel-btn')
        },
        fetchRequestOBJ = {
            action: 'fetch_employee_requests',
            fromDate: 'all',
            noDraft: true,
            toDate: 'all',
            status: 'all',
            employeeSid: <?=$sid;?>,
            companySid: <?=$companyData['sid'];?>
        };

        // Filter
        $('#js-filter-from-date').datepicker({
            format: 'mm/dd/yyyy',
            onSelect: function(dt){
               $('#js-filter-to-date').datepicker("option", "minDate", dt);
            }
        });
        $('#js-filter-to-date').datepicker({
            format: 'mm/dd/yyyy',
            onSelect: function(dt){
               $('#js-filter-from-date').datepicker("option", "maxDate", dt);
            }
        });
        //
        $('#js-filter-status').select2();
        //
        $('#js-filter-apply-btn').click(function(e){
            e.preventDefault();
            if($('#js-filter-from-date').val() != '') fetchRequestOBJ.fromDate = moment($('#js-filter-from-date').val(), 'MM/DD/YYYY').format('YYYY-MM-DD');
            if($('#js-filter-to-date').val() != '') fetchRequestOBJ.toDate = moment($('#js-filter-to-date').val(), 'MM/DD/YYYY').format('YYYY-MM-DD');
            if($('#js-filter-status').val() != null) fetchRequestOBJ.status = $('#js-filter-status').val();
            //
            fetchRequests();
        });
        $('#js-filter-reset-btn').click(function(e){
            e.preventDefault();
            fetchRequestOBJ.fromDate = 'all';
            fetchRequestOBJ.toDate = 'all';
            fetchRequestOBJ.status = 'all';
            //
            $('#js-filter-from-date').val('');
            $('#js-filter-to-date').val('');
            $('#js-filter-status').select2('val', 'all');
            //
            fetchRequests();
        });
        //
        setPoliciesList();
        setHolidayList();
        //
        fetchMatricsList();
        //
        fetchRequests();

        function setHolidayList(){
            $.post(baseURI+'handler', {
                action: 'get_company_all_holidays',
                companySid: <?=$company_sid;?>
            }, function(resp){
                if(resp.Status === false){
                    console.log(resp.Response);
                    return;
                }
                if(resp.Data.length === 0) return;
                //
                var target = $('.js-holiday-list-ul'),
                holidays = resp.Data,
                rows = '',
                trs = '';
                //
                holidays.map(function(holiday){
                    rows += '<li><p><strong>'+( getHolidayText(holiday) )+'</strong><br />'+( holiday.holiday_title )+'<p></li>';
                    trs += '<tr><td><strong>'+( holiday.holiday_title )+'</strong></td><td>'+( getHolidayText(holiday) )+'</td></tr>';
                });
                target.css({'height': '200px', 'overflow-y': 'hidden'});

                target.html(rows);
                rows = '<hr /><p class="text-center text-info js-expand-holiday" style="cursor: pointer; color: #81b431;"><strong>See More</strong></p>';
                target.parent().append(rows);
                $('#js-timeoff-holiday-list-modal tbody').html(trs);
            });
        }

        $('#js-company-holidays-btn').click(function(){
            $('#js-timeoff-holiday-list-modal').modal();
        })
        //
        $(document).on('click', '.js-expand-holiday', function(){
            $(this).removeClass('js-expand-holiday').addClass('js-less-holiday').text('See Less');
            $('.js-holiday-list-ul').css({'height': 'auto', 'overflow-y': 'auto'});
        });
        $(document).on('click', '.js-less-holiday', function(){
            $(this).removeClass('js-less-holiday').addClass('js-expand-holiday').text('See More');
            $('.js-holiday-list-ul').css({'height': '200px', 'overflow-y': 'hidden'});
        });
        //
        $(document).on('click', '.js-request-title-li', function(e){
            //
            e.preventDefault();
            //
            $('.js-request-title-li').parent().removeClass('active');
            $(this).parent().addClass('active');
            //
            $('#js-data-load-area tr').hide();
            $('#js-data-load-area tr[data-type="'+( $(this).data('key') )+'"]').show();
        });
        //
        $(document).on('click', '.js-cancel-request', function(e){
            //
            e.preventDefault();
            //
            var megaOBJ = {};
            megaOBJ.action = 'cancel_employee_request';
            megaOBJ.requestId = $(this).closest('tr').data('id');
            megaOBJ.employeeSid = <?=$sid;?>;
            megaOBJ.companySid = <?=$companyData['sid']?>;
            //
            alertify.confirm('Do you really want to cancel this Time Off request?', function(){
                cancelEmployeeRequest(megaOBJ);
            }).set('labels', {
                ok: 'Yes',
                cancel: 'No'
            });
        });
        //
        $('#js-apply-filter-btn').click(function(e){
            e.preventDefault();
            $('#js-filter').toggle();
        });
        //
        function cancelEmployeeRequest(obj){
            $.post(handlerURI, obj, function(resp) {
                alertify.alert(resp.Response, function(){
                    window.location.reload();
                });
            });
        }
        //
        function fetchRequests(){
            loader('show', 'Please wait, while we are fetching your requests.');
            $.post(handlerURI, fetchRequestOBJ, function(resp){
                //
                if(resp.Status === false){
                    loader('hide');
                    $('#js-data-load-area').html('<tr><td colspan="'+( $('.js-data-head tr th').length )+'"><p class="alert alert-info text-center">No Time Off Requests Found!</p></td></tr>');
                    return;
                }
                //
                setEmployeeRequestTable(
                    resp.Data
                );
            });
        }
        //
        function fetchMatricsList(){
            $.post(handlerURI, {
                action: 'get_employee_policies_status',
                employeeSid: <?=$sid;?>,
                companySid: <?=$companyData['sid'];?>
            }, function(resp){

                $('#js-allowed-time').text(resp.Data.Total.active.hours);
                $('#js-consumed-time').text(resp.Data.Consumed.active.hours);
                $('#js-pending-time').text(resp.Data.Pending.active.hours);
            });
        }
        //
        function setEmployeeRequestTable(requests){
            //
            $('#js-data-load-area').html('');
            $('.js-request-title-li').remove();
            var 
            rows = '',
            trows = '';
            if(requests.length == 0) rows += '<tr><td colspan="'+( $('thead tr th').length )+'"><p class="alert alert-info text-center">No requests found</p></td></tr>';
            else{
                var i = 0,
                l = requests.Requests.length;
                //
                for(i; i < l; i++){
                    rows += '<tr data-type="'+( requests['Requests'][i]['Category']['category_name'].toLowerCase().replace(/\s+/g, '_') )+'" data-id="'+( requests['Requests'][i]['requestId'] )+'" style="display: none;">';
                    rows += '   <td>';
                    rows += '       <div class="upcoming-time-info">';
                    rows += '            <div class="icon-image">';
                    rows += '                   <img src="<?=base_url('assets');?>/images/upcoming-time-off-icon.png" class="emp-image" alt="emp-1">';
                    rows += '             </div>';
                    rows += '             <div class="text">';
                    rows += '                  <h4>'+( moment(requests['Requests'][i]['requested_date'], 'YYYY-MM-DD').format(timeoffDateFormat) )+'</h4>';
                    rows += '                  <p>'+( requests['Requests'][i]['requested_time'] == 0 ? 'Unlimited' : requests['Requests'][i]['timeoff_breakdown']['text'] )+' of <span>'+( requests['Requests'][i]['policy_title'] )+'</span></p>';
                    rows += '             </div>';
                    rows += '       </div>';
                    rows += '   </td>';
                    rows += '   <td style="vertical-align: middle;">';
                    rows += '      <div>';
                    rows += '           <p class="cs-status text-center '+( requests['Requests'][i]['status'].toLowerCase() == 'approved' ? 'text-success' : 'text-danger' )+'"><span class="'+( requests['Requests'][i]['status'].toLowerCase() )+'-stat">'+( requests['Requests'][i]['status'].toUpperCase() )+'</span></p>';
                    rows += '      </div>';
                    rows += '    </td>';
                    rows += '   <td style="vertical-align: middle;">';
                    rows += '           <p class="text-center js-popovers"  data-trigger="hover" data-placement="left" title="Comment" data-content="'+( requests['Requests'][i]['status'].toLowerCase() == 'approved' &&  requests['Requests'][i]['History'] != null ?  requests['Requests'][i]['History']['reason'] :  requests['Requests'][i]['reason'] )+'"><i class="fa fa-list-alt '+(  requests['Requests'][i]['History'] != null || requests['Requests'][i]['reason'] != '' ? 'text-success' : '' )+'"></i></p>';
                    rows += '    </td>';
                    rows += '    <td>';
                    rows += '        <div class="progress-bar-custom">';
                    rows += '            <div class="progress-bar-tooltip">';
                    rows += '                <div class="progress">';
                    rows += '                    <div class="progress-bar progress-bar-success progress-bar-success-blue" role="progressbar" aria-valuenow="'+( requests.Requests[i]['Progress']['CompletedPercentage'] )+'" aria-valuemin="0" aria-valuemax="'+( requests.Requests[i]['Progress']['Total'] )+'" style="width: '+( requests.Requests[i]['Progress']['CompletedPercentage'] )+'%">';
                    rows += '                        <div class="sr-only"></div>';
                    rows += '                    </div>';
                    rows += '                </div>';
                    rows += '            </div>';
                    rows += '            <div class="progress-percent progress-percent-custom">'+( requests.Requests[i]['Progress']['CompletedPercentage'] )+'% Completed</div>';
                    rows += '        </div>';
                    rows += '    </td>';
                    rows += '    <td colspan="2">';
                    rows += '        <a href="javascript:void()" class=" js-edit-request">';
                    rows += '            <div class="text-action text-success">';
                    rows += '                <p class="text-center text-success ">view</p>';
                    rows += '            </div>';
                    rows += '        </a>';
                    rows += '    </td>';
                    // rows += '    <td>';
                    // rows += '        <a href="javascript:void()" class="'+( requests.Requests[i]['status'] != 'cancelled' && requests.Requests[i]['expired'] != true ? 'js-cancel-request' : '' )+'" '+( requests.Requests[i]['status'] != 'cancelled' && requests.Requests[i]['expired'] != true ? '' : 'style="cursor: context-menu;"' )+'>';
                    // rows += '            <div class="text-action text-danger">';
                    // rows += '                <p class="text-center">'+( requests.Requests[i]['status'] != 'cancelled' && requests.Requests[i]['expired'] != true ? 'Cancel' : '-' )+'</p>';
                    // rows += '            </div>';
                    // rows += '        </a>';
                    // rows += '    </td>';
                    rows += '</tr>';
                }

                // set title
                i = 0;
                l = requests.Titles.length;

                for(i; i < l; i++){
                    trows += '<li class="'+( i == 0 ? 'active active-tab' : '' )+'"><a href="javascript:void(0)" data-key="'+( requests.Titles[i].toLowerCase().replace(/\s+/g, '_') )+'" class="js-request-title-li">'+( requests.Titles[i] )+'</a></li>';
                }
            }
            //
            $('#js-data-load-area').html(rows);
            $('.js-request-titles').prepend(trows);
            $('#js-data-load-area tr[data-type="'+( requests.Titles[0].toLowerCase().replace(/\s+/g, '_') )+'"]').show();
            $('.js-popovers').popover({
                html: true
            });
            loader('hide');
        }
        //
        function setPoliciesList(){
            if(policies.length == 0) {
                intervalHolder = setInterval(function () {
                    setPoliciesList();
                }, 1000);
                return;
            }
            //
            clearInterval(intervalHolder);
            //
            setPolicySlider();
            //
            var target = $('.js-policy-list-ul'),
            rows = '';
            //
            policies.map(function(policy){
                rows += '<li>'+( policy.title )+'<span>'+( policy.timeoff_breakdown !== undefined ?  policy.timeoff_breakdown.text : 'Unlimited' )+'</span></li>';
            });

            target.html(rows);
        }
        //
        function setPolicySlider(){
            //
            var target = $('.js-policy-slider'),
            rows = '';
            //
            policies.map(function(policy){
                rows += '<div class="item">';
                rows += '    <div class="widget-box">';
                rows += '       <a href="#">';
                rows += '           <div class="link-box bg-cyan full-width" >';
                rows += '                <h2>'+( policy.title )+'</h2>';
                rows += '                <div class="current-date">';
                rows += '                    <span style="font-size: 20px;">'+( policy.timeoff_breakdown !== undefined ?  policy.timeoff_breakdown.text : 'Unlimited' )+'</span>';
                rows += '                </div>';
                rows += '            </div>';
                rows += '       </a>';
                rows += '    </div>';
                rows += '</div>';
            });

            target.html(rows);
            setTimeout(function(){
                // attachOwl(target);
            }, 2000);
        }
        //
        function attachOwl(target){
            $(target).owlCarousel({
                loop:false,
                margin:17,
                nav:true,
                autoWidth:true,
                navText: ["<i class='fa fa-angle-left'></i>","<i class='fa fa-angle-right'></i>"],
                responsive:{
                    0:{
                        items:1
                    },
                    600:{
                        items:3
                    },
                    1000:{
                        items:5
                    }
                }
            });
            $('.owl-nav.disabled').show(0);
        }

        // View mode
        $(document).on('click', '.js-edit-request', loadEditPage); 
        //
        function loadEditPage(e){
            e.preventDefault();
            resetEditModal();
            //
            loader('show', 'Please wait, while we are fetching Time Off request details.');
            var megaOBJ = {};
            megaOBJ.action = 'get_single_request';
            megaOBJ.requestSid = $(this).closest('tr').data('id');
            megaOBJ.companySid = <?=$company_sid;?>;
            megaOBJ.employeeSid = <?=$employerData['sid'];?>;
            //
            $.post(baseURI+'handler', megaOBJ, function(resp) {
                //
                if(resp.Status === false){
                    alertify.alert('ERROR!', resp.Response);
                    return;
                }
                //
                startEditProcess(resp);
            });
        }
        //
        function startEditProcess(resp){
            currentRequest = resp.Data;
            // Set header
            emt.header.text('Time Off, '+( resp.Data.Info.full_name )+'');
            //
            emt.tabs.html(`<li class="js-tab-btn active btn-active tab-btn">
                <a data-target="js-detail-page">Details</a>
            </li>`);
            if(resp.Data.History.length != 0){
                emt.tabs.append(`<li class="js-tab-btn tab-btn">
                    <a data-target="js-history-page">History (${resp.Data.History.length})</a>
                </li>`);
                setHistory();
            }
            if(resp.Data.Conversation.length != 0){
                emt.tabs.append(`<li class="js-tab-btn tab-btn">
                    <a data-target="js-conversation-page">Conversation (${resp.Data.Conversation.length})</a>
                </li>`);
            }
            //
            emt.tabs.append(`<li class="js-tab-btn tab-btn">
                <a data-target="js-attachment-page">Documents (<span class="js-attachments-count">${resp.Data.Attachments.length}</span>)</a>
            </li>`);
            setAttachments();
            
            // Set Partial box
            if(resp.Data.Info.fmla != '' && resp.Data.Info.fmla != null && resp.Data.Info.fmla != '0'){
                $('.js-fmla-box').show();
                $('.js-fmla-type-check[value="'+(resp.Data.Info.fmla)+'"]').prop('checked', true);
                $('.js-fmla-check[value="yes"]').prop('checked', true);
            }else{
                $('.js-fmla-check[value="no"]').trigger('click');
            }
            // Multiple days off
            var ld = {};
            ld.startDate = moment(currentRequest.Info.request_from_date, 'YYYY-MM-DD').format('MM-DD-YYYY');
            ld.endDate = moment(currentRequest.Info.request_to_date, 'YYYY-MM-DD').format('MM-DD-YYYY');
            ld.days = currentRequest.Info.timeoff_days;
            //
            $('#js-timeoff-start-date-view').val(ld.startDate.replace(/-/g,'/'));
            $('#js-timeoff-end-date-view').val(ld.endDate.replace(/-/g,'/'));
            remakeRangeRowsView(ld);
            //
            $('#js-update-view-sid').val(currentRequest.Info.requestId);
            // Phase 3
            //
            switch (resp.Data.Info.Category.toLowerCase()) {
                case 'vacation':
                    $('#js-vacation-return-date-edit').val(resp.Data.Info.return_date == null || resp.Data.Info.return_date == '0000-00-00' ? '' : moment(resp.Data.Info.return_date, 'YYYY-MM-DD').format('MM/DD/YYYY'));
                    $('#js-vacation-address-edit').val(resp.Data.Info.temporary_address);
                    $('#js-vacation-contact-number-edit').val(resp.Data.Info.emergency_contact_number);
                    $('.js-vacation-row-edit').show();
                break;

                case 'bereavement':
                    $('#js-bereavement-return-date-edit').val(resp.Data.Info.return_date == null || resp.Data.Info.return_date == '0000-00-00' ? '' : moment(resp.Data.Info.return_date, 'YYYY-MM-DD').format('MM/DD/YYYY'));
                    $('#js-bereavement-relationship-edit').val(resp.Data.Info.relationship);
                    $('.js-bereavement-row-edit').show();
                break;

                case 'compensatory/ in lieu time':
                    $('#js-compensatory-return-date-edit').val(resp.Data.Info.return_date == null || resp.Data.Info.return_date == '0000-00-00' ? '' : moment(resp.Data.Info.return_date, 'YYYY-MM-DD').format('MM/DD/YYYY'));
                    $('#js-compensatory-start-time-edit').val(resp.Data.Info.compensation_start_time);
                    $('#js-compensatory-end-time-edit').val(resp.Data.Info.compensation_end_time);
                    $('.js-compensatory-row-edit').show();
                break;
            }
            // Phase 3 ends
            // Set requester date
            emt.reason.html(resp.Data.Info.reason);
            // Set progress bar
            emt.progress.find('.progress-bar').css('width', `${resp.Data.Info.Progress.CompletedPercentage}%`);
            emt.progress.find('.progress-bar').attr('aria-valuemin', '0');
            emt.progress.find('.progress-bar').attr('aria-valuemax', '100');
            emt.progress.find('.progress-bar').attr('aria-valuenow', `${resp.Data.Info.Progress.CompletedPercentage}%`);
            emt.progress.find('.progress-percent span').text(resp.Data.Info.Progress.CompletedPercentage);
             //
            $('#js-edit-start-partial-time').val(resp.Data.Info.start_time);
            $('#js-edit-end-partial-time').val(resp.Data.Info.end_time);
            //
            emt.status.find('option[value="pending"]').remove();
            emt.status.find('option[value="cancelled"]').remove();
            if(resp.Data.Info.level_status == 'pending') emt.status.prepend('<option value="pending">Pending</option>');
            emt.status.select2();
            fetchEmployeeAllPolicies(resp.Data.Info.employee_sid, function(res){
                // Set Policies
                var rows = '';
                res.map(function(policy){
                    rows += `<option value="${policy.sid}">${policy.title.ucwords()} (${policy.timeoff_breakdown != undefined ? policy.timeoff_breakdown.text : 'Unlimited'})</option>`;
                });
                emt.policies.html(rows).select2();
                emt.policies.select2('val', resp.Data.Info.policyId);
                $('#js-eme-img').prop('src', getImageURL(resp.Data.Info.img));
                $('#js-eme-name').text(resp.Data.Info.full_name);
                $('#js-eme-tag').text( remakeEmployeeName( resp.Data.Info, false ) );
                $('#js-eme-id').text(getEmployeeId(resp.Data.Info.employee_sid, resp.Data.Info.employee_number));
                $('#js-eme-id').prop('href', "<?=base_url('employee_profile');?>/"+( resp.Data.Info.employee_sid )+"");
                //
                setTimeView2(
                    emt.requestTime, 
                    resp.Data.Info.timeoff_breakdown.active
                );
                $('#js-edit-modal-types').html('<option>'+( resp.Data.Info.Category )+'</option>').select2();
                //
                if(resp.Data.Info.status == 'cancelled') { $('#js-edit-modal-save-btn').hide(0); emt.modal.find('input, textarea, select').prop('disabled', true); emt.status.prepend('<option value="cancelled">Cancelled</option>'); }
                else { $('#js-edit-modal-save-btn').show(0); emt.modal.find('input, textarea, select').prop('disabled', false); }
                emt.status.select2('val', resp.Data.Info.status != 'cancelled' ? resp.Data.Info.status : 'cancelled');
                //
                // Show modal
                emt.modal.modal();
                emt.modal.find('.modal-body').find('input, select, textarea').prop('disabled', 'true');
                loader('hide');             
            });
        }
         //
        function setHistory(level, employee){
            //
            level = level === undefined ? 'all' : level;
            employee = employee === undefined ? 'all' : employee;
            //
            var 
            rows = '',
            tls = ['Team Lead', 'Supervisor', 'Approvers'],
            data = currentRequest.History;
            loadHistoryData(data);
        }
        //
        function loadHistoryData(data){
            $('#js-history-data-area').pagination({
                dataSource: data,
                pageSize: 5,
                showPrevious: true,
                showNext: true,
                callback: function(hs, pagination) {
                    var rows = '';
                    hs.map(function(h, i){
                        var 
                        employeeData = getEmployeeRecord(h.timeoff_request_assignment_sid),
                        policyData = getPolicyRecord(h.timeoff_request_assignment_sid);

                        rows += '<div class="rows cs-timeoff-history-row">';
                        rows += '   <div class="col-sm-12" '+( i%2 == 0 ? 'style="background-color: #f1f1f1; padding: 10px;"' : '' )+'>';
                        rows += '   <div class="col-sm-3 cs-row">';
                        rows += '       <h5><b>Employee</b></h5>';
                        rows += '       <span>'+( employeeData['full_name'] )+' ('+(overwrite[employeeData['role']])+')</span>';
                        rows += '   </div>';
                        rows += '   <div class="col-sm-3 cs-row">';
                        rows += '       <h5><b>Date</b></h5>';
                        rows += '       <span>'+( h.requested_date != '0000-00-00' && h.requested_date != '' && h.requested_date != null ? moment(h.requested_date, 'YYYY-MM-DD').format('MM-DD-YYYY') : '-' )+'</span>';
                        rows += '   </div>';
                        rows += '   <div class="col-sm-3 cs-row">';
                        rows += '       <h5><b>Time</b></h5>';
                        rows += '       <span>'+( h.timeoff_breakdown.text == '0 hour, 0 minute' ? '-' : h.timeoff_breakdown.text )+'</span>';
                        rows += '   </div>';
                        rows += '   <div class="col-sm-3 cs-row">';
                        rows += '       <h5><b>Status</b></h5>';
                        rows += '       <span>'+( h.status.ucwords() )+'</span>';
                        rows += '   </div>';
                        rows += '   <div class="col-sm-12 cs-row">';
                        if(policyData != 'N/A'){
                            rows += '       <p>';
                            rows += '           <strong>Policy Name:</strong> '+( policyData['title'] )+'';
                            rows += '       </p>';
                        }
                        if(h.start_time != null && h.start_time != ''){
                            rows += '       <p>';
                            rows += '           <strong>Partial Time:</strong> '+( h.start_time )+' - '+( h.end_time )+'';
                            rows += '       </p>';
                        }
                        if(h.reason.trim() != ''){
                            rows += '       <p>';
                            rows += '           <strong>Comment:</strong> '+( h.reason == '' ? '-' : h.reason )+'';
                            rows += '       </p>';
                        }
                        rows += '<hr />';
                        rows += '    </div>';
                        rows += '    </div>';
                        rows += '</div>';
                    });
                    $('#js-history-data-append').html(rows);
                }
            })
        }
        //
        function resetEditModal(){
            $('.js-em-page').hide(0);
            $('#js-detail-page').show(0);
            currentRequest = {};
            attachedDocuments = {};
            localDocument = {};
            emt.header.text('');
            emt.tabs.text('');
            emt.noteBox.hide();
            emt.note.val('');
            emt.progress.find('.progress-bar').attr('aria-valuemax', '0');
            emt.progress.find('.progress-bar').attr('aria-valuemin', '0');
            emt.progress.find('.progress-bar').attr('aria-valuenow', '0%');
            emt.progress.find('.progress-percent span').text('0');
            $('.js-edit-modal-partial-check[value="no"]').prop('checked', true);
            $('.js-edit-modal-partial-check[value="no"]').trigger('click');
            $('.js-fmla-check[value="no"]').prop('checked', true);
            $('.js-fmla-check[value="no"]').trigger('click');
            $('#js-attachment-data-area').html('');
            $(emt.comment).val('');
        }
        // Fetch employee all policies
        function fetchEmployeeAllPolicies(employeeId, cb){
            $.post(baseURI+'handler', {
                action: 'get_employee_all_policies',
                companySid: <?=$company_sid;?>,
                employeeSid: employeeId
            }, function(resp){
                if(resp.Status === false){
                    loader('hide');
                    console.log('Failed to load policies.');
                    return;
                }
                //
                employeePolicies = resp.Data;
                cb(resp.Data);
            });
        }
        // Set attachment views
        function setAttachments(){
            //
            var 
            attachments = currentRequest.Attachments;

            var rows = '';
            rows += '<div class="pto-foot-print-listing">';
            rows += '    <div class="roww">';
            rows += '        <div class="col-sm-12">';
            rows += '           <h3>Documents </h3>';
            rows += '        </div>';
            rows += '    </div>';
            rows += '    <div class="roww">';
            rows += '        <div class="col-sm-12">';
            rows += '            <div class="responsive">';
            rows += '                   <table class="table table-striped">';
            rows += '                         <thead>';
            rows += '                           <tr>';
            rows += '                              <th>Document Title</th>';
            rows += '                              <th>Document Type</th>';
            rows += '                              <th>Created At</th>';
            rows += '                              <th>Action</th>';
            rows += '                           </tr>';
            rows += '                         </thead>';
            rows += '                         <tbody id="js-attachment-tbody">';
            rows += '                         </tbody>';
            rows += '                   </table>';
            rows += '            </div>';
            rows += '        </div>';
            rows += '    </div>';
            rows += '</div>';

            $('#js-attachment-data-area').html(rows);
            //
            rows = '';
            rows = '<tr class="js-no-records"><td colspan="4"><p class="alert alert-info text-center">No attachments found.</p></td></tr>';
            if(attachments.length !== 0){
                rows = '';
                attachments.map(function(attachment){
                    let sd = attachment.serialized_data == null ? {} : JSON.parse(attachment.serialized_data);

                    attachment.showEmployerSection = sd.hasOwnProperty('type') && attachment.document_title.toLowerCase() == 'health' ? true : false;

                    attachedDocuments[attachment.sid] = {
                        id: attachment.sid,
                        created_at: moment(attachment.created_at).format('MM-DD-YYYY'),
                        type: attachment.document_type,
                        serialized_data: attachment.serialized_data,
                        file: {
                            name: sd.hasOwnProperty('type') ? sd.type : attachment.s3_filename,
                            s3_filename: attachment.s3_filename
                        },
                        showEmployerSection: attachment.showEmployerSection,
                        slug: attachment.document_title.replace(/[^0-9a-zA-Z.]/g, '_').toLowerCase(),
                        title: attachment.document_type == 'generated' ? FMLACategories[attachment.document_title.toLowerCase()] : attachment.document_title
                    };
                    //
                    rows += '<tr class="js-attachments" data-id="'+( attachment.sid )+'">';
                    rows += '   <td>'+( attachment.document_type == 'generated' ? FMLACategories[attachment.document_title.toLowerCase()] : attachment.document_title )+'</td>';
                    rows += '   <td>'+( attachment.document_type.ucwords() )+'</td>';
                    rows += '   <td>'+( moment(attachment.created_at).format('MM-DD-YYYY') )+'</td>';
                    rows += '   <td>';
                    if(attachment.document_type == 'uploaded'){
                        rows += '       <button class="btn btn-success js-attachment-view">View</button>';
                    }else if(attachment.s3_filename != null){
                        rows += '       <button class="btn btn-success js-attachment-view">View</button>';
                    }else{
                        rows += '       <button class="btn btn-success js-attachment-view">View</button>';
                    }
                    rows += '   </td>';
                    rows += '</tr>';
                });
            }
            $('#js-attachment-tbody').html(rows);
        }
         // Page Shifter
        $(document).on('click', '.js-tab-btn', function(e){
            //
            $('.js-tab-btn').removeClass('active');
            $(this).addClass('active');

            $('.js-em-page').fadeOut();
            $(`#${$(this).find('a').data('target')}`).fadeIn();
        });
        $(document).on('click', '.js-attachment-view', viewDocument);
        function viewDocument(){
            var file = attachedDocuments[$(this).closest('tr').data('id')];
            if(file.type === 'uploaded' ){
                // Generate modal content
                var URL = '';
                var iframe = '';
                if(file.file.name.match(/(.doc|.docx|.ppt|.pptx)$/) !== null){
                    URL = "https://view.officeapps.live.com/op/embed.aspx?src=<?=AWS_S3_BUCKET_URL;?>"+( file.file.name )+"&embedded=true";
                    iframe = '<iframe src="'+( URL )+'" style="width: 100%; height: 500px;" frameborder="0"></iframe>'
                }else if(file.file.name.match(/(.png|.jpg|.jpeg)$/) !== null){
                    URL = "<?=AWS_S3_BUCKET_URL;?>"+( file.file.name )+"";
                    iframe = '<img src="'+( URL )+'" style="width: 100%;">'
                }else{
                    URL = "https://docs.google.com/gview?url=<?=AWS_S3_BUCKET_URL;?>"+( file.file.name )+"&embedded=true";
                    iframe = '<iframe src="'+( URL )+'" style="width: 100%; height: 500px;" frameborder="0"></iframe>'
                }

                loadModal(file, iframe, URL);
            }else if(file.file.s3_filename != null ){
                // Generate modal content
                var URL = '';
                var iframe = '';
                if(file.file.s3_filename.match(/(.doc|.docx|.ppt|.pptx)$/) !== null){
                    URL = "https://view.officeapps.live.com/op/embed.aspx?src=<?=AWS_S3_BUCKET_URL;?>"+( file.file.s3_filename )+"&embedded=true";
                    iframe = '<iframe src="'+( URL )+'" style="width: 100%; height: 500px;" frameborder="0"></iframe>'
                }else if(file.file.s3_filename.match(/(.png|.jpg|.jpeg)$/) !== null){
                    URL = "<?=AWS_S3_BUCKET_URL;?>"+( file.file.s3_filename )+"";
                    iframe = '<img src="'+( URL )+'" style="width: 100%;">'
                }else{
                    URL = "https://docs.google.com/gview?url=<?=AWS_S3_BUCKET_URL;?>"+( file.file.s3_filename )+"&embedded=true";
                    iframe = '<iframe src="'+( URL )+'" style="width: 100%; height: 500px;" frameborder="0"></iframe>'
                }

                loadModal(file, iframe, URL);
            }else{
                // for generated
                $.post(baseURI+'handler', {
                    action: 'get_generated_fmla_view',
                    companySid: <?=$companyData['sid'];?>,
                    fmla: file
                }, function(resp) {
                    //
                    if(resp.Status === false){
                        console.log('Failed to load view');
                        return;
                    }
                    //
                    loadModal(file, resp.View);
                });
            }
        }
        //
        function loadModal(file, iframe, URL){
            //
            var 
            modal = '<div class="modal fade" id="js-attachment-view-modal">';
            modal +='    <div class="modal-dialog modal-lg">';
            modal +='            <div class="modal-content">';
            modal +='                <div class="modal-header modal-header-bg">';
            modal +='                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>';
            modal +='                    <h4 class="modal-title">'+( file.title )+'</h4>';
            modal +='                </div>';
            modal +='                <div class="modal-body">';
            modal +=  iframe
            modal +='                </div>';
            modal +='                <div class="modal-footer">';
            if(file.type === 'uploaded'){
                modal +='         <a href="<?=base_url('hr_documents_management/download_upload_document');?>/'+( file.file.name )+'" class="btn btn-success">Download</a>';
                modal +='         <a href="'+( URL )+'" target="_blank" class="btn btn-success">Print</a>';
            }else if(file.file.s3_filename != null){
                modal +='         <a href="<?=base_url('hr_documents_management/download_upload_document');?>/'+( file.file.s3_filename )+'" class="btn btn-success">Download</a>';
                modal +='         <a href="'+( URL )+'" target="_blank" class="btn btn-success">Print</a>';
            }else{
                modal +='         <a href="<?=base_url('timeoff/download/document');?>/'+( file.id )+'" target="_blank" class="btn btn-success">Download</a>';
                modal +='         <a href="<?=base_url('timeoff/print/document');?>/'+( file.id )+'" target="_blank" class="btn btn-success">Print</a>';
            }
            modal +='                </div>';
            modal +='            </div>';
            modal +='     </div>';
            modal +='</div>';
            //
            emt.modal.modal('hide');
            // Show modal content
            $('#js-attachment-view-modal').remove();
            $('body').append(modal);
            $('#js-attachment-view-modal').modal();
        }
        $(document).on('hidden.bs.modal', '#js-attachment-view-modal', function (e) { emt.modal.modal('show'); });

        function setTimeView2(target, data){
            var row = '';
            if(employeePolicies[0]['format'] == 'D:H:M'){
                row += '<div class="col-sm-4">';
                row += '    <div class="form-group">';
                row += '        <label>Days </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.days != undefined ? data.days : '' )+'" id="js-request-days" />';
                row += '    </div>';
                row += '</div>';
                row += '<div class="col-sm-4">';
                row += '    <div class="form-group">';
                row += '        <label>Hours </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.hours != undefined ? data.hours : '' )+'" id="js-request-hours" />';
                row += '    </div>';
                row += '</div>';
                row += '<div class="col-sm-4">';
                row += '    <div class="form-group">';
                row += '        <label>Minutes </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.minutes != undefined ? data.minutes : '' )+'" id="js-request-minutes" />';
                row += '    </div>';
                row += '</div>';
            }
            else if(employeePolicies[0]['format'] == 'D:H'){
                row += '<div class="col-sm-6">';
                row += '    <div class="form-group">';
                row += '        <label>Days </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.days != undefined ? data.days : '' )+'" id="js-request-days" />';
                row += '    </div>';
                row += '</div>';
                row += '<div class="col-sm-6">';
                row += '    <div class="form-group">';
                row += '        <label>Hours </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.hours != undefined ? data.hours : '' )+'" id="js-request-hours" />';
                row += '    </div>';
                row += '</div>';
            }
            else if(employeePolicies[0]['format'] == 'H:M'){
                row += '<div class="col-sm-6">';
                row += '    <div class="form-group">';
                row += '        <label>Hours </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.hours != undefined ? data.hours : '' )+'" id="js-request-hours" />';
                row += '    </div>';
                row += '</div>';
                row += '<div class="col-sm-6">';
                row += '    <div class="form-group">';
                row += '        <label>Minutes </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.minutes != undefined ? data.minutes : '' )+'" id="js-request-minutes" />';
                row += '    </div>';
                row += '</div>';
            }else if(employeePolicies[0]['format'] == 'H'){
                row += '<div class="col-sm-12">';
                row += '    <div class="form-group">';
                row += '        <label>Hours </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.hours != undefined ? data.hours : '' )+'" id="js-request-hours" />';
                row += '    </div>';
                row += '</div>';
            }else{
                row += '<div class="col-sm-12">';
                row += '    <div class="form-group">';
                row += '        <label>Minutes </label>';
                row += '        <input type="text" class="form-control js-number" value="'+( data.minutes != undefined ? data.minutes : '' )+'" id="js-request-minutes" />';
                row += '    </div>';
                row += '</div>';
            }
            //
            $(target).html(row);


        }
        //
        function getEmployeeRecord(timeoff_request_assignment_sid){
            var 
            i = 0,
            l = currentRequest.Assigned.length;
            //
            for(i; i < l; i++){
                if(currentRequest.Assigned[i]['sid'] == timeoff_request_assignment_sid) return currentRequest.Assigned[i];
            }
            return 'N/A';
        }
        //
        function getPolicyRecord(policyId){
            var 
            i = 0,
            l = employeePolicies.length;
            //
            for(i; i < l; i++){
                if(employeePolicies[i]['sid'] == policyId) return employeePolicies[i];
            }
            return 'N/A';
        }

        function timePickers(){
            $('#js-start-partial-time').datetimepicker({
                datepicker: false,
                format: 'g:i A',
                formatTime: 'g:i A',
                step: 1,
                onClose: function(d){
                    // $('#js-end-partial-time').setOptions({
                    //     minTime: d
                    // });
                }
            });

            $('#js-end-partial-time').datetimepicker({
                datepicker: false,
                format: 'g:i A',
                formatTime: 'g:i A',
                step: 1,
                onClose: function(d){
                    // this.setOptions({
                    //     minTime: $('#js-start-partial-time').val() ? $('#js-start-partial-time').val() : false
                    // });
                }
            });
        }
    })
</script>


<style>
    .js-request-titles{ min-height: 51px !important; }
    .bg-cyan{
        width:250px !important;
        height:145px !important;
        }
    .current-date{
          position: absolute;
          bottom: 0;
    }
        .js-holiday-list-ul li,
    .js-holiday-list-ul li p{ color: #000000 !important; }
    .js-holiday-list-ul{ margin-top: 0; }
    .js-holiday-list-ul li p{ margin-top: 0; }

    .js-policy-list-ul li,
    .js-policy-list-ul li p,
    .js-policy-list-ul li span{ color: #000000 !important; }
    .js-policy-list-ul{ margin-top: 0; }
    .js-policy-list-ul li p{ margin-top: 0; }

    .paginationjs-pages{ margin-top: 10px; margin-left: 10px; }
</style>