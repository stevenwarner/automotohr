<?php $slug = $userInfo['first_name'].' '.$userInfo['last_name']; ?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="<?= base_url() ?>assets/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="<?= base_url() ?>assets/css/font-awesome.css">
    <script type="text/javascript" src="<?= base_url() ?>assets/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="<?php echo base_url('assets/employee_panel/js/kendoUI.min.js'); ?>"></script>
    <title>Export Document(s)</title>
    <style>
        .cs-main {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .cs-box {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .cs-box i {
            font-size: 90px;
        }

        .cs-box p {
            font-size: 16px;
        }

        .cs-box h6 {
            font-size: 16px;
        }
    </style>
</head>

<body style="overflow: hidden;">

    <div class="cs-main">
        <div class="col-sm-4 cs-box">
            <i class="fa fa-download"></i>
            <h5><strong id="js-dc">0</strong> of <strong id="js-dt">
                    <?=
                        (count($documents['Assigned'])) +
                            (isset($documents['I9']['sid']) ? 1 : 0) +
                            (isset($documents['W9']['sid']) ? 1 : 0) +
                            (isset($documents['W4']['sid']) ? 1 : 0)

                    ?>
                </strong> documents</h5>
            <div class="progress">
                <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                </div>
            </div>
            <p>Please wait while we are loading documents.</p>
        </div>
    </div>

    <script>
        var has = {
            'I9': "<?= isset($documents['I9']['sid']) ? "false" : "null"; ?>",
            'W9': "<?= isset($documents['W9']['sid']) ? "false" : "null"; ?>",
            'W4': "<?= isset($documents['W4']['sid']) ? "false" : "null"; ?>"
        };
        $(function() {
            let assigned = <?= json_encode($documents['Assigned']); ?>;
            let assignedLength = assigned.length;
            let dt = 10;
            let dc = 0;
            let gd = 0;
            let token = "<?= $token; ?>";

            if (has['I9'] != "null")  assignedLength++;
            if (has['W9'] != "null")  assignedLength++;
            if (has['W4'] != "null")  assignedLength++;
            

            if (has['I9'] != "null") {
                // Check for if
                checkI9('Adding I9 form to export');
            } else if (has['W9'] != "null") {
                // Check for if
                checkW9('Adding W9 form to export');
            } else if (has['W4'] != "null") {
                // Check for if
                checkW4('Adding W4 form to export');
            }


            //
            function checkI9(s) {

                if (has['I9'] == "null") {
                    checkW9('Adding W9 form to export');
                    return;
                }

                if (has['I9'] !== true) {
                    dc++;
                    m(s);
                    checkW9('Adding W9 form to export');
                    return;
                }
                //
                setTimeout(() => {
                    checkI9(s);
                }, 1000);
            }

            //
            function checkW9(s) {
                if (has['W9'] == "null") {
                    checkW4('Adding W4 form to export');
                    return;
                }
                if (has['W9'] == true) {
                    dc++;
                    m(s);
                    checkW4('Adding W4 form to export');
                    return;
                }
                //
                setTimeout(() => {
                    checkW9(s);
                }, 1000);
            }

            //
            function checkW4(s) {
                if (has['W4'] == "null") {
                    return;
                }
                if (has['W4'] === true) {
                    dc++;
                    m(s);
                    return;
                }
                //
                setTimeout(() => {
                    checkW4(s);
                }, 1000);
            }

            //
            function checkDocument(i, s) {
                if (has[i] !== undefined) {
                    dc++;
                    m(s);
                    return;
                }
                //
                setTimeout(() => {
                    checkDocument(i, s);
                }, 1000);
            }
            //
            function m(message) {
                let sc = (100 / assignedLength) * dc;
                $('#js-dc').text(dc);
                $('.cs-box p').html(message);
                $('.progress-bar').attr('aria-valuenow', sc);
                $('.progress-bar').attr('aria-valuemin', sc);
                $('.progress-bar').css('width', sc + '%');
            }
            //
            startGeneratingPDFs();
            //
            function startGeneratingPDFs() {
                //
                if (
                    (has['I9'] != "null" && has['I9'] !== true) ||
                    (has['W9'] != "null" && has['W9'] !== true) ||
                    (has['W4'] != "null" && has['W4'] !== true)
                ) {
                    setTimeout(startGeneratingPDFs, 2000);
                    return;
                }
                //
                startMoveProcess(getDocument());
            }

            //
            function getDocument() {
                dc++;
                //
                let sc = assigned[gd];
                //
                if (sc === undefined) return false;
                //
                gd++;
                //
                m(`Adding <strong>"${sc.document_title}"</strong> to export.`);
                //
                return sc;
            }

            //
            function startMoveProcess(dct) {
                if (dct === false) {
                    generateZip();
                    return false;
                }
                //
                if (
                    dct.document_type == 'uploaded' ||
                    dct.offer_letter_type == 'uploaded'
                ) {
                    uploadDocument({
                        title: dct.document_title,
                        orig_filename: dct.document_original_name,
                        s3_filename: dct.document_s3_name
                    });
                } else if (
                    dct.document_type == 'generated' ||
                    dct.offer_letter_type == 'generated'
                ) {
                    getSubmittedDocument(dct);
                } else {
                    getSubmittedDocument(dct);
                }
            }

            function getSubmittedDocument(dct){
                //
                $.get(`<?=base_url('hr_documents_management/getSubmittedDocument');?>/${dct.sid}/submitted/assigned_document/${dct.document_type}`, (resp) => {
                    var obj = jQuery.parseJSON(resp);
                    $('#js-export-area div').html(obj.html);
                    let o = {
                        title: dct.document_title,
                        content: obj.html
                    };
                    //
                    if(dct.document_type == 'hybrid_document') o.file = dct.document_s3_name;
                    // Check for existing base64
                    if(o.content.indexOf('data:application/pdf;base64,') !== -1 ){
                        o.content = o.content.replace(/data:application\/pdf;base64,/, '');
                        uploadDocument(o, o.title);
                    } else{
                        $('#js-export-area div').html(obj.html);
                        //
                        if($('#jsContentArea').find('select').length >= 0){
                            $('#jsContentArea').find('select').map(function(i){
                                //
                                $(this).addClass('js_select_document');
                                $(this).prop('name', 'selectDD'+i);
                            });
                        }
                        //
                        var form_input_data = obj.input_data;
                        //
                        form_input_data = Object.entries(form_input_data);
                        //
                        $.each(form_input_data, function(key ,input_value) { 
                            if(input_value[0].match(/select/) !== -1){
                                if(input_value[1] != null){
                                    let cc =get_select_box_value(input_value[0],input_value[1]);
                                    $(`select.js_select_document[name="${input_value[0]}"]`).html('');  
                                    $(`select.js_select_document[name="${input_value[0]}"]`).hide(0);    
                                    $(`select.js_select_document[name="${input_value[0]}"]`).after(`<strong style="font-size: 20px;">${cc}</strong>`);
                                }
                            }    
                        }); 
                        //
                        generatePDF($('#js-export-area div'), o);
                    }
                });
            }

            function get_select_box_value(select_box_name, select_box_val) {
                var data = select_box_val;
                let cc = '';

                if (select_box_val.indexOf(',') > -1) { 
                    data = select_box_val.split(','); 
                }
                

                if($.isArray(data)) {
                    let modify_string = '';
                    $.each(data, function(key ,value) { 
                        if (modify_string == '') {
                            modify_string = ' '+$(`select.js_select_document[name="${select_box_name}"] option[value="${value}"]`).text();
                        } else {
                            modify_string = modify_string + ', ' + $(`select.js_select_document[name="${select_box_name}"] option[value="${value}"]`).text();
                        }
                    });
                    cc = modify_string;
                } else {
                    cc = $(`select.js_select_document[name="${select_box_name}"] option[value="${select_box_val}"]`).text();
                }
                
                return cc;
            }

            var XHR = null;
            //
            function uploadDocument(d) {
                if(XHR !== null) {
                    setTimeout(() => {
                        uploadDocument(d);
                    }, 1000);
                    return;
                }
                //
                XHR = $.post("<?=base_url('hr_documents_management/upload');?>", {
                    token: token,
                    data: d,
                    typo: 'document',
                    employeeSid: "<?=$user_sid;?>",
                    userFullNameSlug: "<?=$slug;?>"
                }, () => {
                    XHR = null;
                    setTimeout(() => {
                        startMoveProcess(
                            getDocument()
                        );
                    }, 1000);
                }).fail(() => {
                    setTimeout(() => {
                        uploadDocument(d);
                    }, 1000);
                });
            }
            
            //
            function generateZip(d) {
            	var user_sid = "<?=$user_sid;?>";
            	var user_type = "<?=$user_type;?>";
            	var company_sid = "<?=$company_sid;?>";
                window.location.href = "<?=base_url('hr_documents_management/generate_zip');?>/"+token+"/<?=$slug;?>/"+user_sid+"/"+user_type+"/"+company_sid;
                setTimeout(() => {
                    window.close();
                }, 10000);
            }


            //
        function generatePDF(
            target,
            o
        ){
            let draw = kendo.drawing;
            draw.drawDOM(target, {
                avoidLinks: false,
                paperSize: "auto",
                multiPage: true,
                margin: { bottom: "1cm" },
                scale: 0.8
            })
            .then(function(root) {
                return draw.exportPDF(root);
            })
            .done(function(data) {
                o.content  = data;
                uploadDocument(
                    o
                );
            });
        }
        })
    </script>


    <!--  -->
    <div style="float: left; margin-left: -1000px; width: 800px;">
        <?php
        if (count($documents['I9'])) {
            $this->load->view('form_i9/download_i9_pdf', [
                'pre_form' => $documents['I9'],
                'doUpload' => 1,
                'token' => $token,
                'employeeSid' => $user_sid,
                'userFullNameSlug' => $slug
            ]);
        }

        if (count($documents['W9'])) {
            $this->load->view('form_w9/form_w9_pdf', [
                'pre_form' => $documents['W9'],
                'doUpload' => 1,
                'token' => $token,
                'employeeSid' => $user_sid,
                'userFullNameSlug' => $slug
            ]);
        }

        if (count($documents['W4'])) {
            //
            $assign_on = date("Y-m-d", strtotime($documents['W4']['sent_date']));
            $compare_date = date("Y-m-d", strtotime('2020-01-06'));
            //
            $this->load->view('form_w4/' . ($assign_on >= $compare_date ? "form_w4_2020_pdf" : "form_w4_pdf") . '', [
                'pre_form' => $documents['W4'],
                'doUpload' => 1,
                'token' => $token,
                'employeeSid' => $user_sid,
                'userFullNameSlug' => $slug
            ]);
        }
        ?>
    </div>

    
<!--  -->
<div id="js-export-area" style="
position: fixed;
left: -1000px;
top: 0;
max-width: 800px;
overflow: hidden;
">
<div class="A4">
</div>
</div>

</body>

</html>