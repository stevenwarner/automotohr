<div class="main">
    <div class="container-fluid">
        <div class="row">		
            <div class="inner-content">
                <?php $this->load->view('templates/_parts/admin_column_left_view'); ?>
                <div class="col-lg-9 col-md-9 col-xs-12 col-sm-9 no-padding">
                    <div class="dashboard-content">
                        <div class="dash-inner-block">
                            <div class="row">
                                <?php $this->load->view('templates/_parts/admin_flash_message'); ?>
                                <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                                    <div class="heading-title page-title">
                                        <h1 class="page-title"><i class="fa fa-file-excel-o"></i>invoices</h1>
                                    </div>
                                    <?php if(in_array('full_access', $security_details) || in_array('add_new_invoice', $security_details)){ ?>
                                        <!--<div class="add-new-promotions">
                                            <a class="site-btn" href="<?php /*echo base_url('manage_admin/invoice/add_new_invoice'); */?>">Add New Invoice</a>
                                        </div>-->
                                    <?php } ?>
                                    <div class="hr-search-criteria <?= $flag ? 'opened' : "" ?>">
                                        <strong>Click to modify search criteria</strong>
                                    </div>
                                    <!-- Search Table Start -->
                                    <div class="hr-search-main" <?= $flag ? "style='display:block'" : "" ?>>
                                        <form>
                                            <ul>
                                                <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6 field-row">
                                                    <label>Date From</label>
                                                    <input type="text" name="start" value="<?= empty($search['start']) ? "" : $search['start']; ?>" class="invoice-fields" id="startdate" readonly>
                                                </div>
                                                <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6 field-row">
                                                    <label>Date To</label>
                                                    <input type="text" name="end" value="<?= empty($search['end']) ? "" : $search['end']; ?>"  class="invoice-fields" id="enddate"  readonly>
                                                </div>
                                                <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6 field-row">
                                                    <label>Customer Name</label>
                                                    <input type="text" name="username" value="<?= empty($search['username']) ? "" : $search['username']; ?>"   class="invoice-fields">
                                                </div>
                                                <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6 field-row">
                                                    <label>Invoice#</label>
                                                    <input type="text" name="sid" value="<?= empty($search['sid']) ? "" : $search['sid']; ?>"  class="invoice-fields">
                                                </div>
                                                <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6 field-row">
                                                    <label>Payment Method</label>
                                                    <div class="hr-select-dropdown">
                                                        <select class="invoice-fields" name="payment_method">
                                                            <option value="">Any Payment method</option>
                                                            <option <?php if (isset($search['payment_method']) && $search['payment_method'] == 'Invoice billing') { ?> selected="selected" <?php } ?>>Invoice billing</option>
                                                            <option <?php if (isset($search['payment_method']) && $search['payment_method'] == 'Paypal Standard') { ?> selected="selected" <?php } ?>>Paypal Standard</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-md-6 col-xs-12 col-sm-6 field-row">
                                                    <label>Status</label>
                                                    <div class="hr-select-dropdown">
                                                        <select class="invoice-fields" name="status">
                                                            <option value="">Any Invoice Status</option>
                                                            <option <?php if (isset($search['status']) && $search['status'] == 'Paid') { ?> selected="selected" <?php } ?>>Paid</option>
                                                            <option <?php if (isset($search['status']) && $search['status'] == 'Unpaid') { ?> selected="selected" <?php } ?>>Unpaid</option>
                                                            <option <?php if (isset($search['status']) && $search['status'] == 'Pending') { ?> selected="selected" <?php } ?>>Pending</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-12 text-right field-row field-row-autoheight">
                                                    <input type="submit" class="btn btn-success" value="Search">
                                                    <a href="<?php echo base_url('manage_admin/invoice'); ?>" class="btn btn-success">Clear</a>
                                                </div>
                                            </ul>
                                        </form>
                                    </div>
                                    <!-- Search Table End -->
                                    <!-- Search Result table Start -->
                                    <form name="users_form" method="post">
                                        <div class="hr-box">
                                            <div class="hr-box-header">
                                                <h1 class="hr-registered pull-left">Marketplace Invoices</h1>
                                                <div class="pull-right">
                                                    <strong id="invoiceCount"><?= $invoiceCount ?></strong> invoices
                                                </div>
                                            </div>
                                            <div class="table-responsive hr-innerpadding">
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <!--<th><input type="checkbox"></th>-->
                                                            <th>Invoice #</th>
                                                            <th>Customer Name</th>
                                                            <th>Date</th>
                                                            <th>Payment Method</th>
                                                            <th class="text-center">Total</th>
                                                            <th class="text-center">Status</th>
                                                            <?php $function_names = array('edit_invoice', 'mark_paid_unpaid', 'resend_invoice', 'delete_invoice');?>
                                                            <?php if(check_access_permissions_for_view($security_details, $function_names)){ ?>
                                                                <th width="1%" colspan="4" class="text-center">Actions</th>
                                                            <?php } ?>
                                                        </tr> 
                                                    </thead>
                                                    <tbody>
                                                        <?php foreach ($invoices as $invoice) { ?>
                                                            <tr id="parent_<?= $invoice["invoice_number"] ?>">
                                                                <!--<td><input type="checkbox" ></td>-->
                                                                <td><?= $invoice["invoice_number"] ?></td>
                                                                <td><?= $invoice["username"] ?></td>
                                                                <td><?= date_with_time($invoice["date"]); ?></td>
                                                                <td><?= $invoice["payment_method"] ?></td>
                                                                <td  class="text-center">$<?= $invoice["total"] ?></td>
                                                                <td class="text-center"><span class="<?= $invoice["status"] ?>"><?= $invoice["status"] ?></span></td>                                                              
                                                                <?php if(check_access_permissions_for_view($security_details, 'edit_invoice')){ ?>
                                                                    <td><a class="btn btn-success btn-sm" href="<?php base_url(); ?>invoice/edit_invoice/<?php echo $invoice['invoice_number']; ?> " title="View/Edit"><i class="fa fa-pencil"></i></a>
                                                                <?php } ?>
                                                                <?php if(check_access_permissions_for_view($security_details, 'delete_invoice')){ ?>
                                                                    <td>
                                                                        <a href="javascipt:;" class="btn btn-danger btn-sm" title="Delete" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('delete', this.id)"><i class="fa fa-times"></i></a>
<!--                                                                        <input type="button" class="btn btn-danger btn-block" value="Delete" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('delete', this.id)">-->
                                                                    </td>
                                                                <?php } ?>
                                                                <?php if(check_access_permissions_for_view($security_details, 'mark_paid_unpaid')){ ?>
                                                                    <?php if ($invoice["status"] == "Unpaid") { ?>
                                                                        <td><input type="button" class="btn btn-success btn-block" value="Mark Paid" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('mark paid', this.id)" ></td>
                                                                    <?php } else { ?>
                                                                        <td><input type="button" class="btn btn-success btn-block" value="Mark Unpaid" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('mark unpaid', this.id)" ></td>
                                                                    <?php } ?>
                                                                <?php } ?>
                                                                <?php if(check_access_permissions_for_view($security_details, 'resend_invoice')){ ?>
                                                                    <td><input type="button" class="btn btn-success btn-block" value="Resend" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('resend', this.id)" ></td>
                                                                <?php } ?>                                                                
                                                            </tr>
                                                        <?php }
                                                        
                                                        if (count($email_invoices) > 0) { ?>
                                                            <tr><th colspan="10">Emailed Invoices</th></tr>
                                                            <?php foreach ($email_invoices as $invoice) { ?>
                                                                <tr id="parent_<?= $invoice["invoice_number"] ?>">
                                                                    <!--<td><input type="checkbox" ></td>-->
                                                                    <td><?= $invoice["invoice_number"] ?></td>
                                                                    <td><?= $invoice["to_name"] ?></td>
                                                                    <td><?= $invoice["date"] ?></td>
                                                                    <td><?= $invoice["payment_method"] ?></td>
                                                                    <td>$<?= $invoice["total"] ?></td>
                                                                    <td><?= $invoice["status"] ?></td>
                                                                    <?php if ($invoice["status"] == "Unpaid") { ?>
                                                                        <td><input type="button" class="btn btn-success" value="Mark Paid" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('mark paid', this.id)" ></td>
                                                                    <?php } else { ?>
                                                                        <td><input type="button" class="btn btn-success" value="Mark Unpaid" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('mark unpaid', this.id)" ></td>
                                                                    <?php } ?>
                                                                    <td><input type="button" class="btn btn-success" value="Resend" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('resend', this.id)" ></td>
                                                                    <td><a class="hr-edit-btn" href="<?php base_url(); ?>invoice/edit_invoice/<?php echo $invoice['invoice_number']; ?> " title="Edit">View/Edit</a>
                                                                    <td><input type="button" class="btn btn-danger" value="Delete" id="<?= $invoice['invoice_number'] ?>" onclick="return todo('delete', this.id)"></td>
                                                                </tr>
                                                            <?php }
                                                        } ?>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </form>
                                    <!-- Search Result Table End -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function todo(action, id) {
        url = "<?= base_url() ?>manage_admin/invoice/invoice_task";
        alertify.confirm('Confirmation', "Are you sure you want to " + action + " this Invoice?",
                function () {
                    $.post(url, {action: action, sid: id})
                            .done(function (data) {

                                if (action == "delete") {
                                    alertify.success('Selected promotion have been ' + action + 'd.');
                                    invoiceCounter = parseInt($("#invoiceCount").html());
                                    invoiceCounter--;
                                    $("#invoiceCount").html(invoiceCounter);
                                    $("#parent_" + id).remove();
                                }
                                else {
                                    location.reload();
                                }
                            });

                },
                function () {
                    alertify.error('Canceled');
                });
    }
</script>