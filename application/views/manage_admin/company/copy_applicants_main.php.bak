<?php defined('BASEPATH') OR exit('No direct script access allowed'); ?>
<div class="main">
    <div class="container-fluid">
        <div class="row">
            <div class="inner-content">
                <?php $this->load->view('templates/_parts/admin_column_left_view'); ?>
                <div class="col-lg-9 col-md-9 col-xs-12 col-sm-9 no-padding">
                    <div class="dashboard-content">
                        <div class="dash-inner-block">
                            <div class="row">
                                <?php $this->load->view('templates/_parts/admin_flash_message'); ?>
                                <div class="job-feature-main m_job">
                                    <div class="portalmid">
                                        <div id="file_loader" style="display:none; height:1353px;"></div>
                                        <i class="fa fa-refresh fa-spin my_spinner" style="visibility: hidden;"></i>
                                        <div class="loader_message" style="display:none; margin-top: 35px;">Please wait while applicants are loading...</div>

                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                                    <div class="heading-title page-title">
                                        <h1 class="page-title"><i class="fa fa-users"></i><?php echo $page_title; ?></h1>
                                    </div>
                                    <div class="hr-setting-page">
                                        <?php echo form_open(base_url('manage_admin/copy_applicants/'), array('id' => 'copy-form')); ?>
                                        <ul>
                                            <li>
                                                <label>Copy From</label>
                                                <div class="hr-fields-wrap">
                                                    <select name="copy_from" class="invoice-fields" id="copy_from">
                                                        <?php   foreach ($active_companies as $company) { ?>
                                                                    <option value="<?php echo $company['sid']; ?>" <?php if ($source == $company['sid']) echo 'selected="selected"'; ?>><?php echo $company['CompanyName']; ?></option>
                                                        <?php   } ?>
                                                    </select>
                                                </div>
                                            </li>
                                            <li>
                                                <label>Applicants Type</label>
                                                <div class="hr-fields-wrap">
                                                    <?php echo form_dropdown('applicants_type', $applicants_type, set_value('applicants_type', $type), ' class="invoice-fields" id="app-type"'); ?>
                                                    <?php echo form_error('applicants_type'); ?>
                                                </div>
                                            </li>
                                            <li>
                                                <label>Copy To</label>
                                                <div class="hr-fields-wrap">
                                                    <select name="copy_to" class="invoice-fields" id="copy_to">
                                                        <?php foreach ($active_companies as $company) { ?>
                                                            <option value="<?php echo $company['sid']; ?>" <?php if ($destination == $company['sid']) echo 'selected="selected"'; ?>><?php echo $company['CompanyName']; ?></option>
                                                        <?php } ?>
                                                    </select>
                                                </div>
                                            </li>
                                            <li>
                                                <a class="site-btn" id="fetch-applicant" href="#">Fetch All Jobs</a>
                                                <?php echo form_submit('setting_submit', 'Copy All Applicants', array('class' => 'site-btn', 'id' => 'btn-submit')); ?>

                                            </li>
                                        </ul>
                                        <div class="custom_loader">
                                            <div id="copy-loader" class="copy-loader" style="display: none">
                                                <i style="font-size: 25px; color: #81b431;" class="fa fa-cog fa-spin"></i>
                                                <span>Copy Applicants Processing... </span>
                                            </div>
                                        </div>
                                        <?php echo form_close(); ?>
                                    </div>
                                </div>
                            </div>
                            <?php
                            $active_job = ($this->uri->segment(7)) ? $this->uri->segment(7) : '';
                            if (isset($applicants)) { ?>
                            <div class="row">
                                <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                                    <div class="hr-setting-page">
                                        <ul>
                                            <li>
                                                <label>Filter Job</label>
                                                <div class="hr-fields-wrap">
                                                    <select name="job_select" class="invoice-fields" id="job_select">
                                                        <option value="0">Please Select</option>
                                                        <option value="1">All Jobs</option>
                                                        <?php if($jobs){
                                                            foreach($jobs as $job){
                                                                $select = '';
                                                                if($active_job == $job['sid']){
                                                                    $select = 'selected="selected"';
                                                                }
                                                                echo '<option value="'.$job['sid'].'" '.$select.' >'.ucfirst($job['Title']).'</option>';
                                                            }
                                                        }
                                                        ?>
                                                    </select>
                                                </div>
                                            </li>
                                            <li><a class="site-btn" id="jobs" href="#">Filter</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <?php } ?>
                            <?php   if (isset($applicants) && !empty($applicants)) {
                                        echo '<h4><b>Total</b>: <span>'.sizeof($applicants).' applicants found</span></h4>';
                                    } ?>
                            <?php  if (isset($applicants)) { ?>
                            <div class="hr-box">
                                <div class="hr-box-header">
                                    <h4>Copy Specific Applicants</h4>
                                </div>
                                <div class="hr-innerpadding">
                                    <div class="table-responsive">
                                        <form name="multiple_actions" id="multiple_actions_employer" method="POST">
                                            <table class="table table-bordered table-hover table-striped">
                                                <thead>
                                                    <tr>
                                                        <th><input type="checkbox" id="check_all"></th>
                                                        <th class="text-center">ID</th>
                                                        <th>Name</th>
                                                        <th>Email</th>
                                                        <th>Jobs</th>
<!--                                                        <th>Company Name</th>-->
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <?php if (isset($applicants) && !empty($applicants)) { ?>
                                                        <?php foreach ($applicants as $key => $value) { ?>
                                                            <tr id="parent">
                                                                <td><input type="checkbox" name="checkit[]" value="<?php echo $value['sid']; ?>" class="my_checkbox"></td>
                                                                <td class="text-center">
                                                                    <div class="employee-profile-info">
                                                                        <figure>
                                                                            <?php if (!empty($value['pictures'])) { ?>
                                                                                <img class="img-responsive" src="<?php echo AWS_S3_BUCKET_URL . $value['pictures']; ?>">
                                                                            <?php } else { ?>
                                                                                <img class="img-responsive" src="<?= base_url() ?>assets/images/img-applicant.jpg">
                                                                            <?php } ?>
                                                                        </figure>
                                                                    </div>
                                                                    <b><?php echo $value['sid']; ?></b>
                                                                </td>
                                                                <td>
                                                                    <?php echo ucwords($value['first_name'] . " " . $value['last_name']); ?>
                                                                </td>
                                                                <td><?php echo $value['email']; ?></td>
                                                                <td><?php
                                                                    if (isset($value['job_details'])) {
                                                                        foreach ($value['job_details'] as $key => $job) {
                                                                            echo $key + 1 . '. ' . $job . '<br>';
                                                                        }
                                                                    }
                                                                    else if(isset($value['Title'])){
                                                                        echo $value['Title'];
                                                                    } else{
                                                                        echo 'Not Applied for job';
                                                                    }
                                                                    ?>
                                                                </td>
<!--                                                                <td>Company</td>-->
                                                            </tr>
                                                    <?php } ?>
                                                <?php } else if ($active_job == 0) { ?>
                                                        <tr>
                                                            <td colspan="8" class="text-center">
                                                                <span class="no-data">Please Select Job</span>
                                                            </td>
                                                        </tr>
                                                <?php } else { ?>
                                                    <tr>
                                                        <td colspan="8" class="text-center">
                                                            <span class="no-data">No Applicants Found</span>
                                                        </td>
                                                    </tr>
                                                <?php }?>
                                                </tbody>
                                            </table>
                                            <input type="hidden" name="copy_to" value="" id="form-copy">
                                            <input type="hidden" name="form_action" value="copy_selected">
                                            <?php if (isset($applicants) && !empty($applicants)) { ?>
                                                <button type="button" onclick="verify_checklist();" class="btn btn-success pull-right">Copy Selected Applicants</button>
                                                <!--<input class="site-btn pull-right" type="button" name="submit" value="Copy Selected Applicants" onclick="verify_checklist();">-->
                                            <?php } ?>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <?php } ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--document.getElementById('form_id').action = 'somethingelse';-->
<script>
    function verify_checklist() {
        if ($('#copy_from').val() == $('#copy_to').val()) {
            alertify.error("Both companies can't be same");
        } else if ($(".my_checkbox:checked").size() == 0) {
            alertify.alert('Error! No applicant selected', 'Please Select at-least one applicant');
        } else {
            alertify.confirm(
                'Processing ....',
                'Please wait till coping',
                function () {
                    $('#multiple_actions_employer').submit();
                },
                function () {
                    alertify.error('Cancelled!');
                });
        }
    }

    $(document).ready(function () {
        $('#form-copy').val($('#copy_to').val());
        $('#check_all').click(function () {
            if ($('#check_all').is(":checked")) {
                $('.my_checkbox:checkbox').each(function () {
                    this.checked = true;
                });
            } else {
                $('.my_checkbox:checkbox').each(function () {
                    this.checked = false;
                });
            }
        });

        var url = '<?php echo base_url('manage_admin/copy_applicants/fetch_applicants/') ?>' + '/' + $('#copy_from').val() + '/' + $('#app-type').val() + '/' + $('#copy_to').val();

        $('#fetch-applicant').attr('href', url);
        jobFilter();
    });

    $("#btn-submit").on("click", function (event) {
        event.preventDefault();

        if ($('#copy_from').val() == $('#copy_to').val()) {
            alertify.error("Both companies can't be same");
            return false;
        }

        alertify.confirm("Are you sure you want to copy the applicants", function (e) {
            if (e) {
                $('#copy-loader').show();
                $('#btn-submit').attr('disabled', 'disabled');
                $('#btn-submit').addClass('disabled-btn');
                $("#copy-form").submit();
//                $('#copy-loader').hide();
                alertify.success("Applicants saved.");
                return true;
            } else {
                alertify.warning("Cancelled");
                return false;
            }
        });
    });

    $("#fetch-applicant").on("click", function (event) {
        event.preventDefault();
//        if( $('#copy_from').val() == $('#copy_to').val() ){
//            alertify.error("Both companies can't be same");
//            return false;
//        }
        $('#file_loader').css("display", "block");
        $('.my_spinner').css("visibility", "visible");
        $('.loader_message').css("display", "block");
        window.location = $(this).attr('href').toString();

    });

    $('#copy_from').on('change', function () {
        var url = '<?php echo base_url('manage_admin/copy_applicants/fetch_applicants/') ?>' + '/' + $(this).val() + '/' + $('#app-type').val() + '/' + $('#copy_to').val();
        $('#fetch-applicant').attr('href', url);
        jobFilter();
    });

    $('#app-type').on('change', function () {
        var url = '<?php echo base_url('manage_admin/copy_applicants/fetch_applicants/') ?>' + '/' + $('#copy_from').val() + '/' + $(this).val() + '/' + $('#copy_to').val();
        $('#fetch-applicant').attr('href', url);
        jobFilter();
    });

    $('#copy_to').on('change', function () {
        $('#form-copy').val($(this).val());
        var url = '<?php echo base_url('manage_admin/copy_applicants/fetch_applicants/') ?>' + '/' + $('#copy_from').val() + '/' + $('#app-type').val() + '/' + $(this).val();
        $('#fetch-applicant').attr('href', url);
        jobFilter();
    });

    $('#job_select').on('change',function(){
        jobFilter();
    });

    function jobFilter(){
        var job_url = '<?php echo base_url('manage_admin/copy_applicants/fetch_applicants/') ?>' + '/' + $('#copy_from').val() + '/' + $('#app-type').val() + '/' + $('#copy_to').val() + '/' + $('#job_select').val();
        $('#jobs').attr('href', job_url);
    }

    $('#jobs').on('click',function(){
        window.location = $(this).attr('href').toString();
    });
</script>