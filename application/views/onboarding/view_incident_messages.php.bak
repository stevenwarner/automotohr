<div class="main">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                 <?php $this->load->view('templates/_parts/admin_flash_message'); ?>
                <div class="page-header full-width">
                    <h1 class="section-ttile"><?php echo $title; ?></h1>
                    <strong> Information:</strong> If you are unable to view the Email, kindly reload the page.
                </div>
            </div>
            <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                <div class="table-responsive table-outer">
                    <div class="panel panel-blue">
                        <div class="panel-heading">
                            <b>Related Emails</b>
                        </div>
                        <div class="panel-body">
                            <?php if (!empty($emails)) { ?>
                                <?php foreach($emails as $key => $email) { ?>
                                    <div class="accordion-colored-header">
                                        <div class="panel-group" id="accordion">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <h4 class="panel-title">
                                                        <?php
                                                        
                                                            $email_type = '';
                                                            $read_function = '';
                                                            if ($email['sender_sid'] == $current_user || $email['sender_sid'] == 0) {
                                                                if ($email['sender_sid'] == 0 && $current_user !=  $email['manual_email']) {
                                                                    $email_type = 'Received';
                                                                    if ($email['is_read'] == 0) {
                                                                        $read_function = 'onclick="mark_read('.$email['sid'].')"';
                                                                    }
                                                                } else {
                                                                    $email_type = 'Sent';
                                                                }
                                                                
                                                            } else {
                                                                $email_type = 'Received';
                                                                if ($email['is_read'] == 0) {
                                                                    $read_function = 'onclick="mark_read('.$email['sid'].')"';
                                                                }
                                                            }
                                                        ?>
                                                        <a class="collapsed" data-toggle="collapse" aria-expanded="false" data-parent="#accordion" href="#email_<?php echo $key; ?>">
                                                            <span class="glyphicon glyphicon-plus  js-main-gly" <?php echo $read_function; ?>></span>
                                                            <?php echo $email['subject'].' ( '.my_date_format($email['send_date']).' ) ( '.$email_type.' )'; ?>
                                                            <?php if ($email['is_read'] == 0 && $email_type == 'Received') { ?>
                                                                <img src="<?php echo base_url() ?>assets/images/new_msg.gif" id="email_read_<?php echo $email['sid']; ?>">
                                                            <?php } ?>
                                                        </a>
                                                        
                                                    </h4>
                                                </div>
                                                <div id="email_<?php echo $key; ?>" class="panel-collapse collapse js-main-coll">
                                                    <div class="panel-body">
                                                        <div class="form-wrp">
                                                            <table class="table table-bordered table-hover table-stripped">
                                                                <tbody>
                                                                    <tr>
                                                                        <td>
                                                                            <b>Action</b>
                                                                        </td>
                                                                        <td>
                                                                            <?php if ($email['sender_sid'] == $current_user || $email['sender_sid'] == 0) { ?>
                                                                                
                                                                                <?php if ($receiver_user !=  $email['manual_email']) { ?>
                                                                                    <?php
                                                                                        $receiver_sid = $email['receiver_sid'];
                                                                                        $receiver_email = "";
                                                                                        $receiver_subject = $email["subject"];
                                                                                        if (str_replace('_wid', '', $receiver_sid) != $receiver_sid) {
                                                                                            $witness_id = str_replace('_wid', '', $receiver_sid);
                                                                                            $receiver_email = get_witness_email_by_id($witness_id);
                                                                                        } else {
                                                                                            $receiver_info = db_get_employee_profile($receiver_sid);
                                                                                            $receiver_email = $receiver_info[0]['email'];
                                                                                        }
                                                                                    ?>
                                                                                    <a href="javascript:;" class="btn-blockpull-right print-incident modify-comment-btn" data-title="<?php echo 'resend'; ?>" data-type="system" data-sid="<?php echo $receiver_sid; ?>" data-email="<?php echo $receiver_email; ?>" data-subject="<?php echo $receiver_subject; ?>" onclick="send_email(this);"><i class="fa fa-retweet"></i> Resend Email</a>
                                                                                <?php } else { ?>
                                                                                    <?php if ($email['receiver_sid'] != 0) { ?>
                                                                                        <a href="javascript:;" class="btn-blockpull-right print-incident modify-comment-btn" data-title="<?php echo 'reply'; ?>" data-type="manual" data-sid="<?php echo $email['manual_email']; ?>" data-subject="<?php echo $email["subject"]; ?>" onclick="send_email(this);">
                                                                                            <i class="fa fa-reply"></i> 
                                                                                            Reply Email
                                                                                        </a>
                                                                                    <?php } else { ?>
                                                                                        <a href="javascript:;" class="btn-blockpull-right print-incident modify-comment-btn" data-title="<?php echo 'resend'; ?>" data-type="manual" data-sid="<?php echo $email['manual_email']; ?>" data-subject="<?php echo $email["subject"]; ?>" onclick="send_email(this);"><i class="fa fa-retweet"></i> Resend Email</a>
                                                                                    <?php } ?> 
                                                                                <?php } ?>    
                                                                            <?php } else { ?>
                                                                                <?php
                                                                                    $sender_sid = $email['sender_sid'];
                                                                                    $sender_email = "";
                                                                                    $sender_subject = $email["subject"];
                                                                                    if (str_replace('_wid', '', $sender_sid) != $sender_sid) {
                                                                                        $witness_id = str_replace('_wid', '', $sender_sid);
                                                                                        $sender_email = get_witness_email_by_id($witness_id);
                                                                                    } else {
                                                                                        $sender_info = db_get_employee_profile($sender_sid);
                                                                                        $sender_email = $sender_info[0]['email'];
                                                                                    }
                                                                                ?>
                                                                                <a href="javascript:;" class="btn-blockpull-right print-incident modify-comment-btn" data-title="<?php echo 'reply'; ?>" data-type="system" data-sid="<?php echo $sender_sid; ?>" data-email="<?php echo $sender_email; ?>" data-subject="<?php echo $sender_subject; ?>" onclick="send_email(this);">
                                                                                    <i class="fa fa-reply"></i> 
                                                                                    Reply Email
                                                                                </a>
                                                                            <?php } ?>    
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td><b>Message To</b></td>
                                                                        <td>
                                                                            <?php
                                                                                $receiver_sid = $email['receiver_sid'];
                                                                                if (!$receiver_sid == 0) {
                                                                                    if (str_replace('_wid', '', $receiver_sid) != $receiver_sid) {
                                                                                        $witness_id = str_replace('_wid', '', $receiver_sid);
                                                                                        $receiver_name = get_witness_name_by_id($witness_id);
                                                                                        echo $receiver_name;
                                                                                    } else {
                                                                                        $receiver_info = db_get_employee_profile($receiver_sid);
                                                                                        $receiver_name = $receiver_info[0]['first_name'].' '.$receiver_info[0]['last_name'];
                                                                                        echo $receiver_name;
                                                                                    }
                                                                                } else {
                                                                                    echo $email['manual_email'];
                                                                                }
                                                                            ?>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td><b>Message From</b></td>
                                                                        <td>
                                                                            <?php
                                                                                $sender_sid = $email['sender_sid'];
                                                                                if (!$sender_sid == 0) {
                                                                                    if (str_replace('_wid', '', $sender_sid) != $sender_sid) {
                                                                                        $witness_id = str_replace('_wid', '', $sender_sid);
                                                                                        $receiver_name = get_witness_name_by_id($witness_id);
                                                                                        echo $receiver_name;
                                                                                    } else {
                                                                                        $receiver_info = db_get_employee_profile($sender_sid);
                                                                                        $receiver_name = $receiver_info[0]['first_name'].' '.$receiver_info[0]['last_name'];
                                                                                        echo $receiver_name;
                                                                                    }
                                                                                } else {
                                                                                    echo $email['manual_email'];
                                                                                }
                                                                            ?>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td><b>Subject</b><span class="hr-required red"> * </span></td>
                                                                        <td>
                                                                            <?php echo $email['subject']; ?>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td><b>Message</b></td>
                                                                        <td>
                                                                            <?php echo $email['message_body']; ?>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <?php } ?>
                            <?php } else { ?>
                                <div id="print_offer_letter" class="hr-box text-center" style="background: #fff; padding: 20px;">
                                    <h1 class="section-ttile">No Email Found!</h1>
                                </div>
                            <?php } ?>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                <div class="hr-box">
                    <div class="panel panel-blue">
                        <div class="panel-heading">
                            <strong>Compose Message</strong>
                        </div>
                        <div class="hr-innerpadding">
                            <div class="row">
                                <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                                    <div class="dashboard-conetnt-wrp">
                                        <div class="table-responsive table-outer">
                                            <div class="table-wrp data-table">
                                                <div class="col-lg-12 col-md-12 col-xs-12 col-sm-12">
                                                    <form id="form_new_message" enctype="multipart/form-data" method="post" action="" autocomplete="off">
                                                        <input type="hidden" id="perform_action" name="perform_action" value="send_email" />
                                                        <table class="table table-bordered table-hover table-stripped">
                                                            <tbody>
                                                                <?php if (!empty($incident_users)) { ?>
                                                                    <tr>
                                                                        <td><b>Select Email Type</b></td>
                                                                        <td>
                                                                            <div class="form-group edit_filter autoheight">
                                                                                <label class="control control--radio" style="margin-left:10px; margin-top:10px;">
                                                                                    Internal System Email
                                                                                    <input checked="checked" name="send_type" class="email_type" type="radio" value="system"/>
                                                                                    <div class="control__indicator"></div>
                                                                                </label>
                                                                                <label class="control control--radio" style="margin-left:10px; margin-top:10px;">
                                                                                    Outside Email
                                                                                    <input class="email_type" name="send_type" type="radio" value="manual"/>
                                                                                    <div class="control__indicator"></div>
                                                                                </label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                <?php } ?>    
                                                                <tr>
                                                                    <td><b>Message To</b></td>
                                                                    <td>
                                                                        <?php if (empty($incident_users)) { ?>
                                                                            <input type="text" id="email_to" name="receivers[]" value="<?php echo $sender_email; ?>" class="form-control invoice-fields" readonly>
                                                                        <?php } else { ?>
                                                                            <div id="system_email">
                                                                                <select multiple class="chosen-select" tabindex="8" name='receivers[]' id="receivers">
                                                                                    <?php foreach ($incident_users as $user) { ?>
                                                                                        <?php if ($user['employee_name'] != 'Anonymous ( Incident Reporter )') { ?>
                                                                                            <option value="<?php echo $user['employee_id']; ?>"><?php echo $user['employee_name']; ?></option>
                                                                                        <?php } ?>
                                                                                    <?php } ?>
                                                                                </select>
                                                                            </div>
                                                                            <div id="manual_email">
                                                                                <input type="text" name="manual_email" id="manual_address" value="" class="form-control invoice-fields">
                                                                            </div>
                                                                        <?php } ?>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td><b>Subject</b><span class="hr-required red"> * </span></td>
                                                                    <td>
                                                                        <input type="text" id="subject" name="subject" value="" class="form-control invoice-fields">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td><b>Message</b></td>
                                                                    <td>
                                                                        <textarea class="ckeditor" style="padding:5px; height:200px; width:100%;" class="invoice-fields" name="message" id="message"></textarea>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="2">
                                                                        <div class="btn-wrp full-width text-right">
                                                                            <button type="submit" class="btn btn-info" name="submit" value="submit">Send Email</button>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Email Section Start -->
<div id="send_email_modal" class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-bg">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="resend_title"><i class="fa fa-retweet"></i> Resend Email</h4>
                <h4 class="modal-title" id="reply_title"><i class="fa fa-reply"></i> Reply Email</h4>
            </div>
            <div class="modal-body">
                <form id="form_send_email" enctype="multipart/form-data" method="post" action="" autocomplete="off">
                    <input type="hidden" id="perform_action" name="perform_action" value="send_email" />
                    <input type="hidden" id="send_email_type" name="send_type" value="" />
                    <input type="hidden" id="send_email_user" name="" value="" />

                    <table class="table table-bordered table-hover table-stripped">
                        <tbody>
                            <tr>
                                <td><b>Message To</b></td>
                                <td>
                                    <input type="text" id="send_email_address" value="" class="form-control invoice-fields" readonly="">
                                </td>
                            </tr>
                            <tr>
                                <td><b>Subject</b><span class="hr-required red"> * </span></td>
                                <td>
                                    <input type="text" id="send_email_subject" name="subject" value="" class="form-control invoice-fields">
                                </td>
                            </tr>
                            <tr>
                                <td><b>Message</b></td>
                                <td>
                                    <textarea class="ckeditor" style="padding:5px; height:200px; width:100%;" class="invoice-fields" name="message" id="send_email_message"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div class="btn-wrp full-width text-right">
                                        <button type="button" class="btn btn-black incident-panal-button" data-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-info incident-panal-button" name="submit" value="submit">Send Email</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Send Email Section End -->

<script>
    $(document).ready(function () {
        $('#manual_email').hide();
        $('#view_0').trigger('click');

        var config = { // Multiselect
            '.chosen-select': {}
        }

        for (var selector in config) {
            $(selector).chosen(config[selector]);
        }

        $('.js-main-coll').on('shown.bs.collapse', function (e) {
            e.stopPropagation();
            $(this).parent().find(".js-main-gly").removeClass("glyphicon-plus").addClass("glyphicon-minus");
        }).on('hidden.bs.collapse', function () {
            $(this).parent().find(".js-main-gly").removeClass("glyphicon-minus").addClass("glyphicon-plus");
        });
    });

    $('#form_new_message').submit(function(){
        <?php if (empty($incident_users)) { ?>
            var message_subject = $('#subject').val();
            var message_body = CKEDITOR.instances['message'].getData();

            if (message_subject == '' && message_body == '') {
                alertify.alert('Subject and Message body are required.');
                return false;
            } else if (message_body == '') {
                alertify.alert('Message body is required.');
                return false;
            } else if (message_subject == '') {
                alertify.alert('Subject is required.');
                return false;
            }
        <?php } else { ?>    

            var receivers;
            if($('input[name="send_type"]:checked').val() == 'system'){
                receivers = $('#receivers').val();
            } else {
                receivers = $('#manual_address').val();
            }
            var message_subject = $('#subject').val();
            var message_body = CKEDITOR.instances['message'].getData();

            if (receivers == null && message_subject == '' && message_body == '') {
                alertify.alert('All fields are required.');
                return false;
            } else if (receivers == null && message_subject == '') {
                alertify.alert('Email address and Subject are required.');
                return false;
            } else if (receivers == null && message_body == '') {
                alertify.alert('Email address and Message are required.');
                return false;
            } else if (message_subject == '' && message_body == '') {
                alertify.alert('Subject and Message body are required.');
                return false;
            } else if (receivers == null || receivers == '') {
                alertify.alert('Email address is required.');
                return false;
            } else if (message_body == '') {
                alertify.alert('Message body is required.');
                return false;
            } else if (message_subject == '') {
                alertify.alert('Subject is required.');
                return false;
            }
        <?php } ?>
    });

    $('.email_type').on('click', function(){
        var selected = $(this).val();

        if (selected == 'system') {
            $('#system_email').show();
            $('#manual_email').hide();
        } else if (selected == 'manual') {
            $('#manual_email').show();
            $('#system_email').hide();
        }
    });

    function send_email (source) {
        var email_type          = $(source).attr('data-type');
        var email_reciever      = $(source).attr('data-sid');
        var email_subject       = $(source).attr('data-subject');
        var email_title         = $(source).attr('data-title');

        if (email_type == 'system') {
            var system_user_email = $(source).attr('data-email');
            $('#send_email_address').val(system_user_email);
            $('#send_email_user').attr('name', 'receivers[]');
            var user = [email_reciever];
            $('#send_email_user').val(user);
        } else {
            $('#send_email_address').val(email_reciever);
            $('#send_email_user').attr('name', 'manual_email');
            $('#send_email_user').val(email_reciever);
        }

        if (email_title == 'reply') {
            $('#reply_title').show();
            $('#resend_title').hide();
        } else if (email_title == 'resend') {
            $('#reply_title').hide();
            $('#resend_title').show();
        }

        $('#send_email_type').val(email_type);
        $('#send_email_subject').val(email_subject);
        $('#send_email_modal').modal('show');
    }

    $('#form_send_email').submit(function(){
        var message_subject = $('#send_email_subject').val();
        var message_body = CKEDITOR.instances['send_email_message'].getData();

        if (message_subject == '' && message_body == '') {
            alertify.alert('All fields are required.');
            return false;
        } else if (message_body == '') {
            alertify.alert('Message body is required.');
            return false;
        } else if (message_subject == '') {
            alertify.alert('Subject is required.');
            return false;
        }
    });

    function mark_read (email_sid) {
        var update_url = '<?php echo base_url('incident_reporting_system/update_email_read_flag'); ?>';
            var targit_document = $('#update_document_sid').val();
            var form_data = new FormData();

            
            form_data.append('email_sid', email_sid);

            $.ajax({
                url: update_url,
                cache: false,
                contentType: false,
                processData: false,
                type: 'post',
                data: form_data,
                success: function(return_data_array){
                    $('#email_read_'+email_sid).hide();
                },
                error: function(){
                }
            });
    }
</script>
