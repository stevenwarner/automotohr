<?php
class Application_status_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }
    
    function check_company_status($company_sid) {
        $this->db->where('company_sid', $company_sid);
        $records = $this->db->get('application_status')->result_array();
        
        if(sizeof($records) <= 0){
            // empty; do insertion here 
            $this->db->where('company_sid', 0);
            $this->db->order_by("status_order", "ASC");
            $default_records = $this->db->get('application_status')->result_array();
            
            foreach ($default_records as $record){
                $insert_array = array();
                $insert_array['name'] = $record['name'];
                $insert_array['css_class'] = $record['css_class'];
                $insert_array['text_css_class'] = $record['text_css_class'];
                $insert_array['status_order'] = $record['status_order'];
                $insert_array['company_sid'] = $company_sid;
                
                $this->db->insert("application_status", $insert_array);
            }
            return true;
        } else {
            return false;
        }
    }
    
    function get_status_by_company($company_sid) {
        $this->db->select('sid, name, css_class, status_order');
        $this->db->where('company_sid', $company_sid);
        $this->db->order_by('status_order', 'asc');
        return $this->db->get('application_status')->result_array();
    }
    
    function update_company_status($statuses, $company_sid){
        foreach($statuses as $key => $status){
            $this->db->where('company_sid', $company_sid);
            
            $is_order = explode('order_', $key);
            if(sizeof($is_order) > 1){
                $key = $is_order[1];
                $column = 'status_order';
            } else {
                $column = 'name';
            }
            
            $this->db->where('css_class', $key);
            $this->db->update('application_status', array($column => $status));
        }
        
        $statuses = $this->get_status_by_company($company_sid);
        foreach($statuses as $status) {
            // update status texts in both portal_applicant_jobs_list and manual candidates table
            
            $this->db->where('company_sid', $company_sid);
            $this->db->where('status_sid', $status['sid']);
            $this->db->update('portal_applicant_jobs_list', array('status' => $status['name']));
            
            $this->db->where('employer_sid', $company_sid);
            $this->db->where('status_sid', $status['sid']);
            $this->db->update('portal_manual_candidates', array('status' => $status['name']));
        }
    }
}
?>