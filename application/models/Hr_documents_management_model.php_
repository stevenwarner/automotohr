<?php

class Hr_documents_management_model extends CI_Model {

    function __construct() {
        parent::__construct();
    }

    function get_all_documents($company_sid, $archive_status = null) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);

        if ($archive_status !== null) {
            $this->db->where('archive', $archive_status);
        }

        $this->db->order_by('sort_order','ASC');
        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    public function get_all_offer_letters($company_sid, $archive = null) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);

        if (!is_null($archive)) {
            $this->db->where('archive', $archive);
        }

        $this->db->from('offer_letter');
        $this->db->order_by('sort_order','ASC');
        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    function insert_document_record($data_to_insert) {
        $this->db->insert('documents_management', $data_to_insert);
        return $this->db->insert_id();
    }

    public function add_new_offer_letter($offer_letter_data) {
        $this->db->insert('offer_letter', $offer_letter_data);
        return $this->db->insert_id();
    }

    function get_hr_document_details($company_sid, $sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('sid', $sid);
        $record_obj = $this->db->get('documents_management');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function change_eeoc_forms_status ($sid) {
        $data_to_update = array();
        $data_to_update['eeo_form'] = 'No';
        $this->db->where('sid', $sid);
        $this->db->update('portal_applicant_jobs_list', $data_to_update);
    }

    function delete_eeoc_forms_info($sid) {
        $this->db->where('application_sid', $sid);
        $this->db->delete('portal_eeo_form');
    }

    function eeoc_forms_history ($eeoc_form_history) {
//        echo '<pre>';
//        print_r($eeoc_form_history);
//        die();
    }

    function update_documents($sid, $data, $table_name) {
        $this->db->where('sid', $sid);
        $this->db->update($table_name, $data);
    }

    function is_assigned_authorized_document_to_me ($company_sid, $document_sid, $assigned_to_sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('document_assigned_sid', $document_sid);
        $this->db->where('assigned_to_sid', $assigned_to_sid);
        $this->db->where('assigned_status', 1);

        $record_obj = $this->db->get('authorized_document_assigned_manager');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        
        if (!empty($record_arr)) {
            return 'yes';
        } else {
            return 'no';
        }
    }

    function update_assigned_authorized_document ($document_assigned_sid, $assigned_to_sid, $data_to_update) {
        $this->db->where('document_assigned_sid', $document_assigned_sid);
        $this->db->where('assigned_to_sid', $assigned_to_sid);
        $this->db->where('assigned_status', 1);
        $this->db->update('authorized_document_assigned_manager', $data_to_update);
    }

    function reassign_authorized_document ($document_sid, $data_to_update) {
        $this->db->where('sid', $document_sid);
        $this->db->update('authorized_document_assigned_manager', $data_to_update);
    }

    function assign_authorized_document_to_user ($data_to_insert) {
        $this->db->insert('authorized_document_assigned_manager', $data_to_insert);
    }

    function update_generated_documents($document_sid, $user_sid, $user_type, $data) {
        $this->db->where('sid', $document_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->update('documents_assigned', $data);
    }

    function update_assigned_documents($document_sid, $user_sid, $user_type, $data_to_update) {
        $this->db->where('sid', $document_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->update('documents_assigned', $data_to_update);
    }

    function assign_revoke_assigned_documents($document_sid, $document_type, $user_sid, $user_type, $data) {
        $this->db->where('document_sid', $document_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('document_type', $document_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->update('documents_assigned', $data);
//        change status of history table too
        $this->db->where('document_sid', $document_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('document_type', $document_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->update('documents_assigned_history', $data);
    }

    function assign_revoke_assigned_offer_documents($document_type, $user_sid, $user_type, $data) {
        $this->db->where('user_type', $user_type);
        $this->db->where('document_type', $document_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->update('documents_assigned', $data);
    }

    function check_assigned_document($document_sid, $user_sid, $user_type) {
        $this->db->select('sid');
        $this->db->where('user_sid', $user_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('document_sid', $document_sid);

        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_offer_letter_details($company_sid, $sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('sid', $sid);
        $record_obj = $this->db->get('offer_letter');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function fetch_all_company_managers($company_sid, $employer_sid) {
        $ignore[] = $employer_sid;
        $this->db->select('sid, first_name, last_name, access_level_plus, pay_plan_flag, access_level, is_executive_admin, concat(first_name," ",last_name) as employee_name');
        $this->db->where_in('access_level', ['Manager', 'Hiring Manager', 'Admin']);
        $this->db->where('parent_sid', $company_sid);
        $this->db->where('terminated_status', 0);
        $this->db->where_not_in('sid', $ignore);
        $this->db->order_by('employee_name','ASC');

        $record_obj = $this->db->get('users');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    public function set_offer_letter_archive_status($offer_letter_sid, $archive_status) {
        $this->db->where('sid', $offer_letter_sid);
        $this->db->set('archive', $archive_status);
        $this->db->update('offer_letter');
    }

    public function delete_offer_letter($offer_letter_sid) {
        $this->db->where('sid', $offer_letter_sid);
        $this->db->delete('offer_letter');
    }

    function get_applicant_information($company_sid, $applicant_sid) {
        $this->db->select('sid');
        $this->db->select('first_name');
        $this->db->select('last_name');
        $this->db->select('email');
        $this->db->select('pictures');
        $this->db->select('phone_number as phone');
        $this->db->select('verification_key');
        $this->db->select('employee_status');
        $this->db->select('employee_type');
        $this->db->where('employer_sid', $company_sid);
        $this->db->where('sid', $applicant_sid);

        $record_obj = $this->db->get('portal_job_applications');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function check_authorized_document_already_assigned ($company_sid, $document_sid, $manager_sid) {
        $this->db->select('sid, assigned_to_signature');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('document_assigned_sid', $document_sid);
        $this->db->where('assigned_to_sid', $manager_sid);

        $record_obj = $this->db->get('authorized_document_assigned_manager');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function get_all_assigned_auth_documents ($company_sid, $employer_sid) {
        $this->db->select('documents_assigned.*, authorized_document_assigned_manager.assigned_by_date');
        $this->db->where('authorized_document_assigned_manager.company_sid', $company_sid);
        $this->db->where('authorized_document_assigned_manager.assigned_to_sid', $employer_sid);
        $this->db->where('authorized_document_assigned_manager.assigned_status', 1);
        $this->db->join('documents_assigned','documents_assigned.sid = authorized_document_assigned_manager.document_assigned_sid','left');

        $record_obj = $this->db->get('authorized_document_assigned_manager');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_all_paginate_auth_documents ($company_sid, $employer_sid, $limit = null, $start = null) {
        $this->db->select('documents_assigned.*, authorized_document_assigned_manager.assigned_by_date');
        $this->db->where('authorized_document_assigned_manager.company_sid', $company_sid);
        $this->db->where('authorized_document_assigned_manager.assigned_to_sid', $employer_sid);
        $this->db->where('authorized_document_assigned_manager.assigned_status', 1);
        if($limit != null){
            $this->db->limit($limit, $start);
        }
        $this->db->join('documents_assigned','documents_assigned.sid = authorized_document_assigned_manager.document_assigned_sid','left');

        $record_obj = $this->db->get('authorized_document_assigned_manager');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_assign_authorized_document ($company_sid, $assign_document_sid) {
        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required,documents_management.archive,documents_management.visible_to_payroll');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('documents_assigned.sid', $assign_document_sid);
        $this->db->where('documents_assigned.archive', 0);
        $this->db->where('status', 1);
        
        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function get_employee_information($company_sid, $employee_sid) {
        $this->db->select('sid,document_sent_on');
        $this->db->select('first_name');
        $this->db->select('last_name');
        $this->db->select('email');
        $this->db->select('PhoneNumber as phone');
        $this->db->select('verification_key');
        $this->db->where('parent_sid', $company_sid);
        $this->db->where('sid', $employee_sid);

        $record_obj = $this->db->get('users');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function get_archive_assigned_documents($company_sid, $user_type, $user_sid = null, $pp_flag = 0) {
        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_management_sids = $payroll_sids['documents_management_sids'];
        $documents_assigned_sids = $payroll_sids['documents_assigned_sids'];

        $this->db->select('documents_assigned.sid, documents_assigned.document_type, documents_assigned.document_sid, documents_assigned.document_title, documents_assigned.assigned_date, documents_assigned.document_original_name, documents_assigned.visible_to_payroll, documents_assigned.document_s3_name, documents_assigned.archive as user_archived, documents_management.archive as company_archived');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('documents_assigned.user_type', $user_type);
        $this->db->where('documents_assigned.user_sid', $user_sid);

        $this->db->group_start();
            $this->db->where('documents_assigned.archive', 1);
            $this->db->or_where('documents_management.archive', 1);
        $this->db->group_end();    

        $this->db->group_start();
            $this->db->where('documents_assigned.user_consent', 0);
            $this->db->or_where('documents_assigned.document_sid', 0);
        $this->db->group_end(); 

        if($pp_flag) {
            $this->db->group_start();
                $this->db->where('documents_management.visible_to_payroll',1);
                $this->db->or_where('documents_assigned.visible_to_payroll',1);

                if (!empty($documents_management_sids)) {
                    $this->db->or_where_in('documents_management.sid',$documents_management_sids);
                }

                if (!empty($documents_assigned_sids)) {
                    $this->db->or_where_in('documents_assigned.sid',$documents_assigned_sids);
                }
            $this->db->group_end();
        } 

        $this->db->where('documents_assigned.document_type <>', 'offer_letter');
        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_all_user_assigned_manual_documents($company_sid, $user_type, $user_sid = null, $pp_flag = 0) {
        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_assigned_sids = $payroll_sids['documents_assigned_sids'];

        $this->db->select('sid, document_type, document_sid, document_title, assigned_date, document_original_name, visible_to_payroll, document_s3_name');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('archive', 0);
        $this->db->where('status', 1);
        $this->db->where('document_type', 'uploaded');
        if($pp_flag) {
            $this->db->group_start();
                $this->db->where('visible_to_payroll',1);

                if (!empty($documents_assigned_sids)) {
                    $this->db->or_where_in('sid',$documents_assigned_sids);
                }
            $this->db->group_end();
        } 
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_assigned_documents($company_sid, $user_type, $user_sid = null, $status = 1, $fetch_offer_letter = 1, $archive = 0, $pp_flag = 0) {

        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_management_sids = $payroll_sids['documents_management_sids'];
        $documents_assigned_sids = $payroll_sids['documents_assigned_sids'];

        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required,documents_management.archive,documents_management.visible_to_payroll');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.archive', $archive);

        if($fetch_offer_letter){
            $this->db->where('documents_assigned.document_type <>', 'offer_letter');
        }

        if ($status) {
            $this->db->where('status', $status);
        }

        if($pp_flag) {
            $this->db->group_start();
            $this->db->where('documents_management.visible_to_payroll',1);
            $this->db->or_where('documents_assigned.visible_to_payroll',1);

            if (!empty($documents_management_sids)) {
                $this->db->or_where_in('documents_management.sid',$documents_management_sids);
            }

            if (!empty($documents_assigned_sids)) {
                $this->db->or_where_in('documents_assigned.sid',$documents_assigned_sids);
            }
            $this->db->group_end();
        }
        
        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        //$this->db->order_by('documents_assigned.assigned_date', 'desc');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        return $record_arr;
    }

    function get_archived_manual_documents ($company_sid, $user_type, $user_sid = null, $status = 1, $pp_flag = 0) {
        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required,documents_management.archive');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.archive', 1);
        $this->db->where('documents_assigned.document_type <>', 'offer_letter');
        
        if ($status) {
            $this->db->where('status', $status);
        }

        if($pp_flag) {
            $this->db->where('documents_assigned.visible_to_payroll',1);
        }


        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_payroll_documents_sids () {
        $this->db->select('document_sid, document_type');
        $this->db->where('category_sid', PP_CATEGORY_SID);
        $record_obj = $this->db->get('documents_2_category');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        $documents_management_sids = array();
        $documents_assigned_sids = array();
        $return_array = array();

        foreach ($record_arr as $key=> $row) {
            if ($row['document_type'] == 'documents_management') {
                array_push($documents_management_sids,$row['document_sid']);
            } else {
                array_push($documents_assigned_sids,$row['document_sid']);
            }
        }

        $return_array['documents_management_sids'] = $documents_management_sids;
        $return_array['documents_assigned_sids'] = $documents_assigned_sids;

        return $return_array;
    }

    function get_all_assign_payroll_document($company_sid, $user_type, $user_sid) {
        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_management_sids = $payroll_sids['documents_management_sids'];
        $documents_assigned_sids = $payroll_sids['documents_assigned_sids'];
        
        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.company_sid', $company_sid);
        
        if (!empty($documents_management_sids) && !empty($documents_assigned_sids)) {//die('one');
            $this->db->group_start();
            $this->db->where_in('documents_assigned.document_sid', $documents_management_sids);
            $this->db->or_where_in('documents_assigned.sid', $documents_assigned_sids);
            $this->db->group_end();
        } else if (!empty($documents_management_sids)) {//die('two');
            $this->db->where_in('documents_assigned.document_sid', $documents_management_sids);
        } else if (!empty($documents_assigned_sids)) {//die('three');
            $this->db->where_in('documents_assigned.sid', $documents_assigned_sids);
        }
        
        $this->db->where('documents_assigned.status', 1);
        $this->db->where('documents_assigned.archive', 0);
        $this->db->where('documents_assigned.document_type <>', 'offer_letter');
        
        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');

        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr) && (!empty($documents_management_sids) || !empty($documents_assigned_sids))) {
            return $records_arr;
        } else {
            return array();
        }
    }

    function get_all_visible_payroll_document ($company_sid, $user_type, $user_sid) {
        $this->db->select('*');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('company_sid', $company_sid);
        $this->db->where('status', 1);
        $this->db->where('archive', 0);
        $this->db->where('visible_to_payroll', 1);
        $this->db->where('document_type <>', 'offer_letter');

        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr;
        } else {
            return array();
        }
    }

    function get_all_company_offers_letters($company_sid, $archive_status) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);

        if ($archive_status !== null) {
            $this->db->where('archive', $archive_status);
        }

        $this->db->order_by('sort_order','ASC');
        $records_obj = $this->db->get('offer_letter');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    function get_assigned_offer_letter($company_sid, $user_type, $user_sid = null, $status = 1) {
        $this->db->select('documents_assigned.*,offer_letter.acknowledgment_required,offer_letter.download_required,offer_letter.signature_required');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('documents_assigned.user_type', $user_type);
        $this->db->where('documents_assigned.user_sid', $user_sid);
        $this->db->where('documents_assigned.document_type', 'offer_letter');
        $this->db->where('status', $status);
        $this->db->join('offer_letter','offer_letter.sid = documents_assigned.document_sid','left');

        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_assigned_offers($company_sid, $user_type, $user_sid = null, $status = 1) {
        $this->db->select('documents_assigned.*,offer_letter.acknowledgment_required,offer_letter.download_required,offer_letter.signature_required');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.document_type', 'offer_letter');

        if ($status) {
            $this->db->where('status', $status);
        }

        $this->db->join('offer_letter','offer_letter.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        return $record_arr;
    }

    function get_current_assigned_offer_letter($company_sid, $user_type, $user_sid = null, $status = 1) {
        $this->db->select('documents_assigned.*,offer_letter.acknowledgment_required,offer_letter.download_required,offer_letter.signature_required');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.document_type', 'offer_letter');
        $this->db->where('documents_assigned.archive', 0);

        if ($status) {
            $this->db->where('status', $status);
        }

        $this->db->join('offer_letter','offer_letter.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_manual_assigned_offers($company_sid, $user_type, $user_sid = null, $status = 1, $admin = 1) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('manual_document_type', 'offer_letter');

        if ($status) {
            $this->db->where('status', $status);
        }

        if ($admin == 0) {
            $this->db->where('document_type <>', 'confidential');
        }

        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_assigned_offer_letter_history($company_sid, $user_type, $user_sid = null, $status = 1) {
        $this->db->select('documents_assigned_history.*,offer_letter.acknowledgment_required,offer_letter.download_required,offer_letter.signature_required');
        $this->db->where('documents_assigned_history.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned_history.document_type', 'offer_letter');

        if ($status) {
            $this->db->where('status', $status);
        }

        $this->db->order_by('documents_assigned_history.assigned_date', 'DESC');
        $this->db->join('offer_letter','offer_letter.sid = documents_assigned_history.doc_sid','left');
        $record_obj = $this->db->get('documents_assigned_history');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_assigned_document($user_type, $user_sid, $document_sid, $doc = NULL) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.sid', $document_sid);
        $this->db->where('documents_assigned.status', 1);

        if ($doc == 'o') {
            $this->db->select('documents_assigned.*,offer_letter.acknowledgment_required,offer_letter.download_required,offer_letter.signature_required');
            $this->db->where('documents_assigned.document_type', 'offer_letter');
            $this->db->join('offer_letter','offer_letter.sid = documents_assigned.document_sid','left');
        } else {
            $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required, documents_management.document_description');
            $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        }

        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_authorized_signature_document ($user_type, $user_sid, $document_sid) {
        $this->db->where('sid', $document_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('status', 1);

        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_submitted_generated_document ($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);

        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_original_document ($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);

        $record_obj = $this->db->get('documents_management');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_assigned_submitted_document ($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);

        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_offer_latter ($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);

        $record_obj = $this->db->get('offer_letter');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_assigned_document_record($user_type, $user_sid, $document_sid) {
        $this->db->select('document_title,document_description');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('document_sid', $document_sid);
        $record_obj = $this->db->get('documents_assigned');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_document_attached_video($document_sid) {
        $this->db->select('video_required,video_source,video_url');
        $this->db->where('sid', $document_sid);
        $record_obj = $this->db->get('documents_management');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_assigned_document_history_record($user_type, $user_sid, $document_sid, $history_sid) {
        $this->db->select('document_title,document_description');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('document_sid', $document_sid);
        $this->db->where('sid', $history_sid);
        $record_obj = $this->db->get('documents_assigned_history');
        $records_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    public function sign_document($company_sid, $user_type, $user_sid, $document_assignment_sid, $data_to_update) {
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('sid', $document_assignment_sid);
        $this->db->update('documents_assignment', $data_to_update);
    }

    function update_download_status($user_type, $user_sid, $document_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('sid', $document_sid);
        $this->db->where('status', 1);
        $this->db->set('downloaded', 1);
        $this->db->set('downloaded_date', date('Y-m-d H:i:s'));
        $this->db->update('documents_assigned');
    }

    function update_acknowledge_status($user_type, $user_sid, $document_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('sid', $document_sid);
        $this->db->where('status', 1);
        $this->db->set('acknowledged', 1);
        $this->db->set('acknowledged_date', date('Y-m-d H:i:s'));
        $this->db->update('documents_assigned');
    }

    function save_doc_history($data) {
        $this->db->insert('document_management_history', $data);
        return $this->db->insert_id();
    }

    public function fetch_form($form_name, $user_type, $user_sid) {
        $this->db->select('*');

        if ($form_name == 'w4') {
            $this->db->where('user_type', $user_type);
            $this->db->where('employer_sid', $user_sid);
//            $this->db->where('status', 1);
            $this->db->from('form_w4_original');

            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
        } elseif ($form_name == 'w9') {
            $this->db->where('user_type', $user_type);
            $this->db->where('user_sid', $user_sid);
//            $this->db->where('status', 1);
            $this->db->from('applicant_w9form');

            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
        } else {
            $this->db->where('user_type', $user_type);
            $this->db->where('user_sid', $user_sid);
//            $this->db->where('status', 1);
            $this->db->from('applicant_i9form');

            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
        }

        if (sizeof($records_arr) > 0) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    public function fetch_form_for_front_end($form_name, $user_type, $user_sid) {
        $this->db->select('*');

        if ($form_name == 'w4') {
            $this->db->where('user_type', $user_type);
            $this->db->where('employer_sid', $user_sid);
            $this->db->where('status', 1);
            $this->db->from('form_w4_original');

            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
        } elseif ($form_name == 'w9') {
            $this->db->where('user_type', $user_type);
            $this->db->where('user_sid', $user_sid);
            $this->db->where('status', 1);
            $this->db->from('applicant_w9form');

            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
        } else {
            $this->db->where('user_type', $user_type);
            $this->db->where('user_sid', $user_sid);
            $this->db->where('status', 1);
            $this->db->from('applicant_i9form');

            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
        }

        if (sizeof($records_arr) > 0) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function get_company_detail($sid) {
        $this->db->where('sid', $sid);
        $result = $this->db->get('users')->result_array();

        if (!empty($result)) {
            return $result[0];
        }
    }

    function get_eeo_form_status ($sid) {
        $this->db->select('eeo_form');
        $this->db->where('portal_job_applications_sid', $sid);
        $result = $this->db->get('portal_applicant_jobs_list')->result_array();
        $return_data = array();

        if (!empty($result)) {
            $return_data = $result[0]['eeo_form'];
        }

        return $return_data;
    }

    function get_eeo_form_info ($sid) {
        $this->db->select('*');
        $this->db->where('application_sid', $sid);
        $result = $this->db->get('portal_eeo_form')->result_array();
        $return_data = array();

        if (!empty($result)) {
            $return_data = $result[0];
        }

        return $return_data;
    }

    function get_applicants_details($sid) {
        $this->db->select('sid, employer_sid as company_sid, first_name, last_name, email, address, city, country, state, zipcode, phone_number, pictures');
        $this->db->where('sid', $sid);
        $this->db->from('portal_job_applications');
        $data = array();

        $records_obj = $this->db->get();
        $result = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($result)) {
            $data = $result[0];
        }

        return $data;
    }

    function getApplicantAverageRating($app_id, $users_type = NULL, $date = NULL) {
        $this->db->where('applicant_job_sid', $app_id);

        if ($users_type != NULL) {
            $this->db->where('users_type', $users_type);
        }

        if ($date != NULL) { // get all rating after his/her hiring date.
            $this->db->where('date_added >', $date);
        }

        $this->db->from('portal_applicant_rating');
        $rows = $this->db->count_all_results();

        if ($rows > 0) {
            $this->db->select_sum('rating');
            $this->db->where('applicant_job_sid', $app_id);
            $this->db->where('users_type', $users_type);
            $this->db->from('portal_applicant_rating');
            $records_obj = $this->db->get();
            $records_arr = $records_obj->result_array();
            $records_obj->free_result();
            $data = round($records_arr[0]['rating'] / $rows, 2);
            return $data;
        }
    }

    function insert_documents_assignment_record($data_to_insert) {
        $this->db->insert('documents_assigned', $data_to_insert);
        return $this->db->insert_id();
    }

    function insert_documents_assignment_record_history($data_to_insert) {
        $this->db->insert('documents_assigned_history', $data_to_insert);
    }

    function insert_w4_form_record($data_to_insert) {
        $this->db->insert('form_w4_original', $data_to_insert);
    }

    function w4_forms_history($data_to_insert) {
        $this->db->insert('form_w4_original_history', $data_to_insert);
    }

    function insert_w9_form_record($data_to_insert) {
        $this->db->insert('applicant_w9form', $data_to_insert);
    }

    function w9_forms_history($data_to_insert) {
        $this->db->insert('applicant_w9form_history', $data_to_insert);
    }

    function get_eev_uploaded_document ($document_sid) {
        $this->db->where('sid', $document_sid);
        $this->db->from('eev_documents');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function is_exist_in_eev_document ($document_type, $company_sid, $user_sid) {
        $this->db->where('company_sid', $company_sid);
        $this->db->where('employee_sid', $user_sid);
        $this->db->where('document_type ', $document_type);
        $this->db->from('eev_documents');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function is_w4_form_assign($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('employer_sid', $user_sid);
        $this->db->where('user_consent ', 0);
        $this->db->where('status', 1);

        $this->db->from('form_w4_original');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function is_w9_form_assign($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('user_consent', NULL);
        $this->db->where('status', 1);

        $this->db->from('applicant_w9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function is_i9_form_assign($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('user_consent', NULL);
        $this->db->where('status', 1);
        $this->db->from('applicant_i9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function check_w4_form_exist($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('employer_sid', $user_sid);
        $this->db->from('form_w4_original');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function check_w9_form_exist($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
//        $this->db->where('user_consent', NULL);
        $this->db->from('applicant_w9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function deactivate_w4_forms($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('employer_sid', $user_sid);
        $this->db->set('status', 0);
        $this->db->from('form_w4_original');
        $this->db->update();
    }

    function update_w4_employer_info ($user_type, $user_sid, $company_sid, $update_w4_employer) {
        $this->db->where('user_type', $user_type);
        $this->db->where('employer_sid', $user_sid);
        $this->db->where('company_sid', $company_sid);
        $this->db->update('form_w4_original',$update_w4_employer);
    }

    function deactivate_w9_forms($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->set('status', 0);
        $this->db->from('applicant_w9form');
        $this->db->update();
    }

    function activate_w4_forms($user_type, $user_sid, $data) {
        $this->db->where('user_type', $user_type);
        $this->db->where('employer_sid', $user_sid);
        $this->db->update('form_w4_original',$data);
    }

    function activate_w9_forms($user_type, $user_sid, $data) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->update('applicant_w9form', $data);
    }

    function get_i9_form($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('status', 1);
        $this->db->from('applicant_i9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function check_i9_exist($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
//        $this->db->where('user_consent', NULL);
        $this->db->from('applicant_i9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr[0];
        } else {
            return array();
        }
    }

    function deactivate_i9_forms($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->set('status', 0);
        $this->db->from('applicant_i9form');
        $this->db->update();
    }

    function activate_i9_forms($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->set('status', 1);
        $this->db->set('sent_date', date('Y-m-d H:i:s'));
        $this->db->from('applicant_i9form');
        $this->db->update();
    }

    function delete_i9_form($sid) {
        $this->db->where('sid', $sid);
        $this->db->delete('applicant_i9form');
    }

    function insert_i9_form_record($data_to_insert) {
        $this->db->insert('applicant_i9form', $data_to_insert);
    }

    function i9_forms_history($data_to_insert) {
        $this->db->insert('applicant_i9form_history', $data_to_insert);
    }

    function revoke_assigned_offer_letter ($user_type, $user_sid, $offer_letter_sid) {
        $this->db->where('document_sid', $offer_letter_sid);
        $this->db->where('document_type', 'offer_letter');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->set('archive', 1);
        $this->db->update('documents_assigned');
    }

    function update_upload_status($company_sid, $user_type, $user_sid, $document_type, $document_sid, $uploaded_file) {
        $now = date('Y-m-d H:i:s');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('sid', $document_sid);
        $this->db->where('status', 1);
        $this->db->set('uploaded', 1);
        $this->db->set('user_consent', 1);
        $this->db->set('uploaded_date', $now);
        $this->db->set('uploaded_file', $uploaded_file);
        $this->db->update('documents_assigned');

        $data_to_insert = array();
        $data_to_insert['company_sid'] = $company_sid;
        $data_to_insert['document_type'] = $document_type;
        $data_to_insert['document_sid'] = $document_sid;
        $data_to_insert['user_type'] = $user_type;
        $data_to_insert['user_sid'] = $user_sid;
        $data_to_insert['uploaded_date'] = $now;
        $data_to_insert['uploaded_file'] = $uploaded_file;
        $this->db->insert('document_user_activity_history', $data_to_insert);
    }

    function get_assigned_document_details($company_sid, $sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);
        $this->db->where('company_sid', $company_sid);
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function get_assigned_documents_history($document_sid = 0, $user_type, $user_sid,$pp_flag = 0) {
        $this->db->select('documents_assigned_history.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required');
        $this->db->where('documents_assigned_history.document_type !=', 'offer_letter');
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->order_by('documents_assigned_history.sid', 'DESC');
        if($pp_flag){
            $this->db->where('documents_2_category.category_sid', PP_CATEGORY_SID);
            $this->db->join('documents_2_category','documents_2_category.document_sid = documents_assigned_history.doc_sid','inner');
        }else{
            //$this->db->where_not_in('documents_assigned_history.doc_sid', 'Select `document_sid` from documents_2_category where `category_sid = `'.PP_CATEGORY_SID);
        }
        $this->db->join('documents_management','documents_management.sid = documents_assigned_history.document_sid','left');
        $record_obj = $this->db->get('documents_assigned_history');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function getEmployeesWithPendingDoc($company_sid) {
        $this->db->select('user_sid');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_consent', 0);
        $this->db->where('user_type', 'employee');
        $this->db->group_by('user_sid');
        $employee_sids = $this->db->get('documents_assigned')->result_array();

        foreach ($employee_sids as $emp_key => $employee) {
            $employee_sid = $employee['user_sid'];
            $assigned_documents = $this->get_employee_assigned_documents($company_sid, 'employee', $employee_sid);
            if ($employee_sid == 9950) {
                _e(sizeof($assigned_documents), true, false, true);
            //     echo '<pre>';
            //     print_r($assigned_documents);
            //     die();
            }

            foreach ($assigned_documents as $document_key => $assigned_document) {
                $is_magic_tag_exist = 0;
                $is_document_completed = 0;

                if (!empty($assigned_document['document_description']) && ($assigned_document['document_type'] == 'generated' || $assigned_document['offer_letter_type'] == 'generated')) {
                    $document_body = $assigned_document['document_description'];
                    $magic_codes = array('{{signature}}', '{{signature_print_name}}', '{{inital}}', '{{sign_date}}', '{{short_text}}', '{{text}}', '{{text_area}}', '{{checkbox}}');

                    if (str_replace($magic_codes, '', $document_body) != $document_body) {
                        $is_magic_tag_exist = 1;
                    }
                }

                if ($assigned_document['document_type'] != 'offer_letter') {
                        if (($assigned_document['acknowledgment_required'] || $assigned_document['download_required'] || $assigned_document['signature_required'] || $is_magic_tag_exist) && $assigned_document['archive'] == 0 && $assigned_document['status'] == 1) {

                            if ($assigned_document['acknowledgment_required'] == 1 && $assigned_document['download_required'] == 1 && $assigned_document['signature_required'] == 1) {
                                if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($assigned_document['acknowledgment_required'] == 1 && $assigned_document['download_required'] == 1) {
                                if ($is_magic_tag_exist == 1) {
                                    if ($assigned_document['uploaded'] == 1) {
                                        $is_document_completed = 1;
                                    } else {
                                        $is_document_completed = 0;
                                    }
                                } else if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else if ($assigned_document['acknowledged'] == 1 && $assigned_document['downloaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($assigned_document['acknowledgment_required'] == 1 && $assigned_document['signature_required'] == 1) {
                                if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($assigned_document['download_required'] == 1 && $assigned_document['signature_required'] == 1) {
                                if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($assigned_document['acknowledgment_required'] == 1) {
                                if ($assigned_document['acknowledged'] == 1) {
                                    $is_document_completed = 1;
                                } else if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($assigned_document['download_required'] == 1) {
                                if ($assigned_document['downloaded'] == 1) {
                                    $is_document_completed = 1;
                                } else if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($assigned_document['signature_required'] == 1) {
                                if ($assigned_document['uploaded'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            } else if ($is_magic_tag_exist == 1) {
                                if ($assigned_document['user_consent'] == 1) {
                                    $is_document_completed = 1;
                                } else {
                                    $is_document_completed = 0;
                                }
                            }

                            if ($is_document_completed > 0) {
                               unset($assigned_documents[$document_key]);
                            } else {
                                $assigned_sids[] = $assigned_document['document_sid'];
                            }
                        } else {
                            unset($assigned_documents[$document_key]);
                        }
                    }else{
                        //
                        if($assigned_document['user_consent'] == 1){
                            unset($assigned_documents[$document_key]);
                        }
                    }

                

            }

            $pending_documents  = count($assigned_documents);
            $pending_w4         = $this->is_employee_w4_document_pending('employee', $employee_sid);
            $pending_w9         = $this->is_employee_w9_document_pending('employee', $employee_sid);
            $pending_i9         = $this->is_employee_i9_document_pending('employee', $employee_sid);

            if ($pending_documents == 0 && $pending_w4 == 0 && $pending_w9 == 0 && $pending_i9 == 0) {
                unset($employee_sids[$emp_key]);
            }
        }

        return $employee_sids;
    }

    function get_employee_assigned_documents($company_sid, $user_type, $user_sid = null) {

        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required,documents_management.archive,documents_management.visible_to_payroll');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.archive', 0);
        $this->db->where('status', 1);
        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        return $record_arr;
    }

    function is_employee_w4_document_pending($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('employer_sid', $user_sid);
        $this->db->group_start();
        $this->db->where('user_consent ', 0);
        // $this->db->or_where('user_consent', NULL);
        $this->db->group_end();
        $this->db->where('status', 1);

        $this->db->from('form_w4_original');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return 1;
        } else {
            return 0;
        }
    }

    function is_employee_w9_document_pending($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->group_start();
        $this->db->where('user_consent ', 0);
        $this->db->or_where('user_consent', NULL);
        $this->db->group_end();
        $this->db->where('status', 1);

        $this->db->from('applicant_w9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return 1;
        } else {
            return 0;
        }
    }

    function is_employee_i9_document_pending($user_type, $user_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->group_start();
        $this->db->where('user_consent ', 0);
        $this->db->or_where('user_consent', NULL);
        $this->db->group_end();
        $this->db->where('status', 1);
        $this->db->from('applicant_i9form');

        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return 1;
        } else {
            return 0;
        }
    }

    function getEmployeesDetails($employees) {
        return $this->db->select('sid,first_name,last_name,email')->where_in('sid', $employees)->order_by("sid", "desc")->get('users')->result_array();
    }

    function getEmployeePendingActionDocument($company_sid, $employee_type, $employee_id) {
        return $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required')
                        ->where('documents_assigned.company_sid', $company_sid)
                        ->where('documents_assigned.user_sid', $employee_id)
                        ->where('documents_assigned.user_type', $employee_type)
                        ->join('documents_management','documents_management.sid = documents_assigned.document_sid','left')
                        ->get('documents_assigned')->result_array();
    }

    function getEmployerDetail($id) {
        $this->db->where('sid', $id);
        return $this->db->get('users')->row_array();
    }

    function get_all_assigned_documents($company_sid, $user_type, $user_sid = null, $status = 1) {
        $this->db->select('documents_assigned.*');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);

        if ($status) {
            $this->db->where('status', $status);
        }

        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_uploaded_generated_documents($company_sid, $archive_status = null, $pp_flag = 0) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);

        if ($archive_status !== null) {
            $this->db->where('archive', $archive_status);
        }
        if($pp_flag){
            $this->db->where('documents_2_category.category_sid', PP_CATEGORY_SID);
            $this->db->join('documents_2_category','documents_2_category.document_sid = documents_management.sid','inner');
        }else{
            //$this->db->where_not_in('documents_management.sid', 'Select `document_sid` from documents_2_category where `category_sid = `'.PP_CATEGORY_SID);
        }
        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        foreach ($records_arr as $key => $record) {
            $preview_url = AWS_S3_BUCKET_URL . $record['uploaded_document_s3_name'];
            $download_url = $preview_url;
            $records_arr[$key]['preview_url'] = $preview_url;
            $records_arr[$key]['download_url'] = $download_url;
        }

        return $records_arr;
    }

    function get_offer_letter($company_sid, $offer_letter_sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('sid', $offer_letter_sid);
        $this->db->from('offer_letter');
        $record_obj = $this->db->get();
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function check_if_document_already_assigned($user_type, $user_sid, $document_type, $document_sid) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('document_type', $document_type);
//        $this->db->where('document_sid', $document_sid);

        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function update_assign_offer_letter($previous_assigned_sid, $data_to_update) {
        $this->db->where('sid', $previous_assigned_sid);
        $this->db->update('documents_assigned', $data_to_update);
    }

    function set_assigned_offer_letter_status($user_type, $user_sid, $document_type) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('document_type', $document_type);
        $this->db->set('status', 0);
        $this->db->update('documents_assignment');
    }

    function getUserDocument($userSid) {
        $this->db->select('first_name,last_name,email');
        $this->db->where('sid',$userSid);
        $result = $this->db->get('users')->result_array();
        return $result;
    }

    function get_admin_or_company_email_template($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);
        $record_obj = $this->db->get('email_templates');
        $record_arr = $record_obj->row_array();
        $record_obj->free_result();

        if (count($record_arr) > 0) {
            return $record_arr;
        } else {
            return 0;
        }
    }

    function downloaded_generated_doc_on($company_sid, $user_sid, $document_sid, $user_type) {
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('sid', $document_sid);
        $this->db->where('status', 1);
        $this->db->set('downloaded', 1);
        $this->db->set('downloaded_date', date('Y-m-d H:i:s'));
        $this->db->update('documents_assigned');
    }

    function manager_document_activity_track($data_to_insert) {
        $this->db->insert('documents_assigned_manager_activity', $data_to_insert);
    }

    function get_hr_documents_section_records($status = null){
        $this->db->select('*');

        if($status !== null){
            $this->db->where('status', $status);
        }

        $records_obj = $this->db->get('hr_documents_editors_data');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        return $records_arr;
    }

    function fetch_documents_employees($doc_sid, $doc_type, $company_sid){
        $this->db->select('user_sid');
        $this->db->from('documents_assigned');
        $this->db->where('document_sid', $doc_sid);
        $this->db->where('document_type', $doc_type);
        $where_clause = $this->db->get_compiled_select();
        $this->db->select('
            sid,
            first_name,
            last_name,
            access_level_plus,
            pay_plan_flag,
            access_level,
            is_executive_admin, 
            job_title
        ');
        $this->db->order_by("concat(first_name,' ',last_name)","ASC",false);
        $this->db->where('parent_sid', $company_sid);
        $this->db->where('active', 1);
        $this->db->where("`sid` NOT IN ($where_clause)", NULL, False);
        $result = $this->db->get('users')->result_array();
        return $result;
    }

    function update_document_pending_status($document_sid = NULL){
        $this->db->where('sid',$document_sid);
        $this->db->update('documents_assigned',array('is_pending' => 0));
    }

    function save_document_authorized_signature($data_to_insert) {
        $this->db->insert('documents_authorized_signature', $data_to_insert);
        return $this->db->insert_id();
    }

    function update_authorized_signature($sid, $data_to_update){
        $this->db->where('sid',$sid);
        $this->db->update('documents_authorized_signature', $data_to_update);
    }

    function is_authorized_signature_exist($document_sid, $company_sid) {
        $this->db->select('*');
        $this->db->where('document_sid', $document_sid);
        $this->db->where('company_sid', $company_sid);
        $this->db->where('status', 1);
        $this->db->limit(1);
        $record_obj = $this->db->get('documents_authorized_signature');
        $record_arr = $record_obj->row_array();
        $record_obj->free_result();

        if (count($record_arr) > 0) {
            return $record_arr;
        } else {
            return 0;
        }
    }

    function remove_authorized_signature_if_exist($sid, $data_to_update){
        $this->db->where('document_sid',$sid);
        $this->db->update('documents_authorized_signature', $data_to_update);
    }

    function update_hr_document($document_id, $data) {
        $this->db->where('sid', $document_id)->update('hr_documents', $data);
    }

    function get_all_hr_documents($company_sid = NULL) {
        $this->db->select('*');
        $this->db->where('documents_management_sid', 0);

        if($company_sid != NULL) {
             $this->db->where('company_sid', $company_sid);
        }

        $this->db->order_by('sid', 'asc');
        $record_obj = $this->db->get('hr_documents');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function insert_document_management_history($data) {
        $this->db->insert('documents_management_history', $data);
    }

    function insert_offer_letter_history($data) {
        $this->db->insert('offer_letter_history', $data);
    }

    function insert_group_record($data_to_insert) {
        $this->db->insert('documents_group_management', $data_to_insert);
        return $this->db->insert_id();
    }

    function insert_group_history($data_to_insert) {
        $this->db->insert('documents_group_management_history', $data_to_insert);
    }

    function get_all_documents_group($company_sid, $status=NULL) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);

        if($status != NULL) {
            $this->db->where('status', $status);
        }

        $this->db->order_by('sort_order', 'asc');
        $records_obj = $this->db->get('documents_group_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr;
        } else {
            return array();
        }
    }

    function get_document_group($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);
        $record_obj = $this->db->get('documents_group_management');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function update_document_group($sid, $data_to_update){
        $this->db->where('sid',$sid);
        $this->db->update('documents_group_management', $data_to_update);
    }

    function get_all_document_2_group($group_sid) {
        $this->db->select('document_sid');
        $this->db->where('group_sid', $group_sid);
        $record_obj = $this->db->get('documents_2_group');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }



    function get_all_group_2_document($sid) {
        $this->db->select('group_sid');
        $this->db->where('document_sid', $sid);
        $record_obj = $this->db->get('documents_2_group');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function delete_document_2_group($group_sid) {
        $this->db->where('group_sid', $group_sid);
        $this->db->delete('documents_2_group');
    }

    function delete_group_2_document($document_sid) {
        $this->db->where('document_sid', $document_sid);
        $this->db->delete('documents_2_group');
    }

    function assign_document_2_group($data_to_insert) {
        $this->db->insert('documents_2_group', $data_to_insert);
    }

    function fetch_all_company_employees($company_sid){
        $this->db->select('sid,first_name,last_name');
        $this->db->where('parent_sid', $company_sid);
        $result = $this->db->get('users')->result_array();
        return $result;
    }

    function assign_document_group_2_empliyees($data_to_insert) {
        $this->db->insert('documents_group_2_employee', $data_to_insert);
    }

    function get_assign_group_documents($company_sid, $user_type, $user_sid) {
        $this->db->select('documents_2_group.document_sid, documents_group_2_employee.assigned_by_sid');
        $this->db->where('documents_group_2_employee.company_sid', $company_sid);

        if ($user_type == 'employee') {
            $this->db->where('documents_group_2_employee.employer_sid', $user_sid);
        } else if ($user_type == 'applicant') {
            $this->db->where('documents_group_2_employee.applicant_sid', $user_sid);
        }

        $this->db->join('documents_2_group','documents_2_group.group_sid = documents_group_2_employee.group_sid','left');

        $record_obj = $this->db->get('documents_group_2_employee');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function check_document_already_assigned($company_sid, $user_type, $user_sid, $document_sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('document_sid', $document_sid);
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return 1;
        } else {
            return 0;
        }
    }

    function check_group_already_assigned($company_sid, $employer_sid, $group_sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('employer_sid', $employer_sid);
        $this->db->where('group_sid', $group_sid);
        $record_obj = $this->db->get('documents_group_2_employee');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return 1;
        } else {
            return 0;
        }
    }

    function is_document_assign_2_group($group_sid) {
        $this->db->select('*');
        $this->db->where('group_sid', $group_sid);
        $record_obj = $this->db->get('documents_2_group');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return 1;
        } else {
            return 0;
        }
    }

    function get_all_documents_group_assigned($company_sid, $user_type, $user_sid) {
        $this->db->select('group_sid');
        $this->db->where('company_sid', $company_sid);

        if ($user_type == 'employee') {
            $this->db->where('employer_sid', $user_sid);
        } else if ($user_type == 'applicant') {
            $this->db->where('applicant_sid', $user_sid);
        }

        $record_obj = $this->db->get('documents_group_2_employee');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function unassign_system_document_from_group ($sid) {
        $data_to_update = array();
        $data_to_update['w4'] = 0;
        $data_to_update['w9'] = 0;
        $data_to_update['i9'] = 0;

        $this->db->where('sid',$sid);
        $this->db->update('documents_group_management', $data_to_update);
    }

    function assign_system_document_2_group ($sid, $data_to_update) {
        $this->db->where('sid',$sid);
        $this->db->update('documents_group_management', $data_to_update);
    }

    function get_applicant_jobs_list_id($applicant_sid){
        $this->db->select('sid');
        $this->db->where('portal_job_applications_sid',$applicant_sid);
        $result = $this->db->get('portal_applicant_jobs_list')->result_array()[0];
        return $result;
    }

    function get_group_id_based_on_document_id($document_sid) {
        $this->db->select('group_sid, document_sid');
        $this->db->where('document_sid', $document_sid);
        $record_obj = $this->db->get('documents_2_group');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }



    function get_all_documents_in_group($group_id, $archive = 2, $pp_flag = 0) {
        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_management_sids = $payroll_sids['documents_management_sids'];

        $this->db->select('documents_2_group.group_sid, documents_management.*');
        $this->db->where('documents_2_group.group_sid', $group_id);

        if($archive < 2) {
            $this->db->where('documents_management.archive', $archive);
        }
        

        if($pp_flag) {
            $this->db->group_start();
            $this->db->where('documents_management.visible_to_payroll',1);
            if (!empty($documents_management_sids)) {
                $this->db->or_where_in('documents_management.sid', $documents_management_sids);  
            } 
            $this->db->group_end();
        }

        $this->db->join('documents_management','documents_management.sid = documents_2_group.document_sid','left');

        $records_obj = $this->db->get('documents_2_group');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            foreach ($records_arr as $key => $document) {
                if ($document['group_sid'] != $group_id) {
                    unset($records_arr[$key]);
                }
            }
        }

        return $records_arr;
    }

    function test_query() {
        $this->db->select('documents_management.sid, ');
        /*
        SELECT Call.ID, Call.date, Call.phone_number
        FROM Call
        LEFT OUTER JOIN Phone_Book
        ON (Call.phone_number=Phone_book.phone_number)
        WHERE Phone_book.phone_number IS NULL */
    }

    function get_uncategorized_docs($company_sid, $document_ids, $status = 2, $pp_flag = 0) {

        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_management_sids = $payroll_sids['documents_management_sids'];

        foreach ($document_ids as $key => $value) {
            $pos = array_search($value, $documents_management_sids);
            unset($documents_management_sids[$pos]);
        }

        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);

        if(!empty($document_ids)) {
            $this->db->where_not_in('sid', $document_ids);
        }

        if($status < 2) {
            $this->db->where('archive', $status);
        }

        if($pp_flag) {
            $this->db->group_start();
            $this->db->where('documents_management.visible_to_payroll',1);
            if (!empty($documents_management_sids)) {
                $this->db->or_where_in('documents_management.sid', $documents_management_sids);
            }
            $this->db->group_end();
        }

        $this->db->order_by('sort_order','ASC');
        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
       
        return $records_arr;

    }

    function get_access_level_manual_doc($company_sid, $employer_sid, $employer_type, $pp_flag = 0) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_sid', $employer_sid);
        $this->db->where('user_type', $employer_type);
        $this->db->where('documents_assigned.document_type', 'confidential');
        $this->db->where('documents_assigned.archive', 0);
        if($pp_flag){
            $this->db->where('documents_2_category.category_sid', PP_CATEGORY_SID);
            $this->db->join('documents_2_category','documents_2_category.document_sid = documents_assigned.sid','inner');
        }else{
            //$this->db->where_not_in('documents_assigned.sid', 'Select `document_sid` from documents_2_category where `category_sid = `'.PP_CATEGORY_SID);
        }
        $records_obj = $this->db->get('documents_assigned');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;

    }

    function get_distinct_group_docs($group_ids) {
        $this->db->distinct();
        $this->db->select('document_sid');
        $this->db->where_in('group_sid', $group_ids);
        $records_obj = $this->db->get('documents_2_group');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    function insert_eev_document($eev_document_data){
        if($eev_document_data['sid'] > 0){
            $this->db->where('sid', $eev_document_data['sid']);
            $this->db->update('eev_documents', $eev_document_data);
            unset($eev_document_data['sid']);
            $this->db->insert('eev_documents_history', $eev_document_data);
        }else{
            unset($eev_document_data['sid']);
            $this->db->insert('eev_documents', $eev_document_data);
            $insert_id = $this->db->insert_id();
            $this->db->insert('eev_documents_history', $eev_document_data);

            $this->db->where('employee_sid', $eev_document_data['employee_sid']);
            $this->db->where('form_type', $eev_document_data['document_type']."_assigned");
            $this->db->update('eev_required_documents',
                    [
                        'eev_documents_sid' => $insert_id,
                        'form_type' => 'uploaded'
                    ]);
        }
        return $this->db->insert_id();
    }

    function get_form_uploaded($employee_sid, $document_type){
        $this->db->select('*');
        $this->db->where('employee_sid', $employee_sid);
        $this->db->where('document_type', $document_type);
        $records_obj = $this->db->get('eev_documents');
        $record = $records_obj->row_array();

        return $record;
    }

    function get_form_uploaded_by_id($sid){
        $this->db->select('*');
        $this->db->where('sid', $sid);
        $records_obj = $this->db->get('eev_documents');
        $record = $records_obj->row_array();

        return $record;
    }

    function get_eev_required_document($employee_sid, $eev_documents_sid,$form_type){
        $this->db->select('*');
        $this->db->where('employee_sid', $employee_sid);
        $this->db->where('eev_documents_sid', $eev_documents_sid);
        $this->db->where('form_type', $form_type);
        $records_obj = $this->db->get('eev_required_documents');
        $record = $records_obj->result_array();

        return $record;
    }

    function insert_required_document($data_to_insert){
        if($data_to_insert['sid'] > 0){
            $this->db->where('sid', $data_to_insert['sid']);
            $this->db->update('eev_required_documents', $data_to_insert);
        }else{
           $this->db->insert('eev_required_documents', $data_to_insert);
        }
        return $this->db->insert_id();

    }
    
    function get_assigned_new_documents($company_sid, $user_type, $user_sid = null, $status = 1, $fetch_offer_letter = 1) {

        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required,documents_management.archive');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
    //   $this->db->where('documents_management.archive', 0);

        if($fetch_offer_letter){
            $this->db->where('documents_assigned.document_type <>', 'offer_letter');
        }

        if ($status) {
            $this->db->where('status', $status);
        }

        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function get_total_documents_for_documents_assignment($company_sid, $pp_flag) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('archive',0);

        if ($pp_flag) {
            $this->db->where('documents_management.visible_to_payroll', 1);
        }

        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    function get_all_company_documents($company_sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('archive',0);
        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }
     
    function get_total_documents($company_sid, $pp_flag) {
        $payroll_sids = $this->get_payroll_documents_sids();
        $documents_management_sids = $payroll_sids['documents_management_sids'];

        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('archive',0);

        if ($pp_flag) {
            $this->db->group_start();
            $this->db->where('visible_to_payroll', 1);
            if (!empty($documents_management_sids)) {
                $this->db->or_where_in('documents_management.sid', $documents_management_sids);
            }
            $this->db->group_end();
        }

        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    function get_all_documents_in_category($category_sid, $archive = 2) {
        $this->db->select('documents_2_category.category_sid, documents_management.*');
        $this->db->where('documents_2_category.category_sid', $category_sid);

        if($archive < 2) {
            $this->db->where('documents_management.archive', $archive);
        }

        $this->db->join('documents_management','documents_management.sid = documents_2_category.document_sid','left');
        $records_obj = $this->db->get('documents_2_category');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }
    
    function get_all_documents_category($company_sid, $status=NULL, $sort_order = NULL) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->or_where('sid', PP_CATEGORY_SID);

        if($status != NULL) {
            $this->db->where('status', $status);
        }
        // if($sort_order == 'descending') {
        //     $this->db->order_by('created_date', 'desc');
        // }else{
        //     $this->db->order_by('name', 'asc');
        // }

        $this->db->order_by('sort_order', 'asc');

        $records_obj = $this->db->get('documents_category_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        if (!empty($records_arr)) {
            return $records_arr;
        } else {
            return array();
        }
    }

    function is_document_assign_2_category($category_sid) {
        $this->db->select('*');
        $this->db->where('category_sid', $category_sid);
        $record_obj = $this->db->get('documents_2_category');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return 1;
        } else {
            return 0;
        }
    }
    function get_all_documents_category_assigned($company_sid, $user_type, $user_sid) {
        $this->db->select('category_sid');
        $this->db->where('company_sid', $company_sid);

        if ($user_type == 'employee') {
            $this->db->where('employer_sid', $user_sid);
        } else if ($user_type == 'applicant') {
            $this->db->where('applicant_sid', $user_sid);
        }

        $record_obj = $this->db->get('documents_category_2_employee');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }
    function get_document_category($sid) {
        $this->db->select('*');
        $this->db->where('sid', $sid);
        $record_obj = $this->db->get('documents_category_management');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }
    function get_all_documents_active_categories($company_sid){
        $this->db->select('*');
        $this->db->group_start();
        $this->db->where('documents_category_management.company_sid', $company_sid);
        $this->db->or_where('documents_2_category.category_sid', PP_CATEGORY_SID);
        $this->db->group_end();
        $this->db->where('documents_category_management.status', 1);
        $this->db->join('documents_2_category','documents_2_category.category_sid = documents_category_management.sid','left');

        $record_obj = $this->db->get('documents_category_management');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        return $record_arr;
    }

    function insert_category_history($data_to_insert) {
        $this->db->insert('documents_category_management_history', $data_to_insert);
    }

    function update_document_category($sid, $data_to_update){
        $this->db->where('sid',$sid);
        $this->db->update('documents_category_management', $data_to_update);
    }

    function insert_category_record($data_to_insert) {
        $this->db->insert('documents_category_management', $data_to_insert);
        return $this->db->insert_id();
    }

    function get_all_document_2_category($category_sid) {
        $this->db->select('document_sid');
        $this->db->where('category_sid', $category_sid);
        $record_obj = $this->db->get('documents_2_category');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_manual_doc_visible_payroll_check($document_sid) {
        $this->db->select('visible_to_payroll');
        $this->db->where('sid', $document_sid);
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0]['visible_to_payroll'];
        } else {
            return 0;
        }
    }

    function get_assigned_offer_letter_title($offer_letter_sid) {
        $this->db->select('letter_name');
        $this->db->where('sid', $offer_letter_sid);
        $record_obj = $this->db->get('offer_letter');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0]['letter_name'];
        } else {
            return 'Offer Letter';
        }
    }

    function delete_document_2_category($category_sid) {
        $this->db->where('category_sid', $category_sid);
        $this->db->where('document_type', 'documents_management');
        $this->db->delete('documents_2_category');
    }

    function assign_document_2_category($data_to_insert) {

        $data_to_insert['document_type'] = 'documents_management';
        $this->db->insert('documents_2_category', $data_to_insert);
    }

    function add_update_categories_2_documents($document_sid, $categories,$document_type) {
        $this->db->where('document_sid', $document_sid);
        $this->db->where('document_type', $document_type);
        $this->db->delete('documents_2_category');
        if(is_array($categories)){
            foreach($categories as $category){
                $this->db->insert('documents_2_category', ['document_sid' => $document_sid, 'category_sid' => $category,'document_type' => $document_type]);
            }
        }
    }

    function update_documents_assignment_record($documents_assigned_sid, $data_to_update){
        $previous_record = $this->get_assigned_submitted_document ($documents_assigned_sid);
        $previous_record['doc_sid'] = $previous_record['sid'];
        unset($previous_record['sid']);
        $this->db->insert('documents_assigned_history', $previous_record);

        $this->db->where('sid', $documents_assigned_sid);
        $this->db->update('documents_assigned', $data_to_update);

    }

    function categrize_documents($company_sid,$completed_documents,$no_action_required_documents,$access_level_plus){
        $categories = $this->get_all_documents_active_categories($company_sid);
        $categories_documents_completed = array();
        $completed_documents_copy = $completed_documents;
        if (!empty($categories) && !empty($completed_documents_copy)) {
            foreach ($categories as $key => $category) {
                $categories_documents_completed[$category['category_sid']]['name'] = ucfirst($category['name']);
                $categories_documents_completed[$category['category_sid']]['category_sid'] = $category['category_sid'];
                foreach($completed_documents_copy as $key => $completed_document){
                    if($category['document_sid'] == $completed_document['document_sid']){
                        $categories_documents_completed[$category['category_sid']]['documents'][] = $completed_document;
                        unset($completed_documents[$key]);
                    }
                }
            }
        }
        if(count($completed_documents) > 0){
            $cat_index = count($categories);
            $categories_documents_completed[$cat_index]['name'] = "Uncategorized Documents";
            $categories_documents_completed[$cat_index]['category_sid'] = 0;
            $categories_documents_completed[$cat_index]['documents'] = $completed_documents;
        }
        $no_action_required_documents_copy = $no_action_required_documents;
        $categories_no_action_documents = array();
        $no_action_document_categories = array();
        if (!empty($categories) && !empty($no_action_required_documents_copy)) {
            foreach ($categories as $key => $category) {
                $categories_no_action_documents[$category['category_sid']]['name'] = ucfirst($category['name']);
                $categories_no_action_documents[$category['category_sid']]['category_sid'] = $category['category_sid'];
                foreach($no_action_required_documents_copy as $key => $no_action_document){
                    if(($category['document_type'] == "documents_assigned" && $category['document_sid'] == $no_action_document['sid']) || ($category['document_type'] == "documents_management" && $category['document_sid'] == $no_action_document['document_sid'])){
                        if(($access_level_plus && $no_action_document['document_type'] == "confidential") || $no_action_document['document_type'] != "confidential"){

                            $categories_no_action_documents[$category['category_sid']]['documents'][] = $no_action_document;
                            $no_action_document_categories[$no_action_document['sid']][] = $category['category_sid'];

                        }
                        unset($no_action_required_documents[$key]);
                    }else if((!$access_level_plus && $no_action_document['document_type'] == "confidential")){
                        unset($no_action_required_documents[$key]);
                    }

                }
            }
        }
        if(count($no_action_required_documents)>0){
            $cat_index = count($categories);
            $categories_no_action_documents[$cat_index]['name'] = "Uncategorized Documents";
            $categories_no_action_documents[$cat_index]['category_sid'] = 0;
            $categories_no_action_documents[$cat_index]['documents'] = $no_action_required_documents;
        }
        foreach($categories_no_action_documents as $key => $categories_no_action_document){
            if(isset($categories_no_action_document['documents'])){
                $sorted_docs = $categories_no_action_document['documents'];
                usort($sorted_docs, function($a, $b) {
                    return strtotime($a['assigned_date']) > strtotime($b['assigned_date']) ? -1 : 1;
                });
                $categories_no_action_documents[$key]['documents'] = $sorted_docs;
            }
        }
        $data['categories_no_action_documents'] = $categories_no_action_documents;
        $data['categories_documents_completed'] = $categories_documents_completed;
        $data['no_action_document_categories'] = $no_action_document_categories;

        return $data;
    }
    function delete_category_2_document($document_sid) {
        $this->db->where('document_sid', $document_sid);
        $this->db->delete('documents_2_category');
    }
    function get_all_category_2_document($sid) {
        $this->db->select('category_sid');
        $this->db->where('document_sid', $sid);
        $record_obj = $this->db->get('documents_2_category');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }

    }
    /**
     * Get email template
     * Created on: 10-02-2019
     *
     * @param Int   $adminEmailTemplateId
     * @param Int   $companySid
     *
     * @return Array
     */
    function getEmailTemplate($adminEmailTemplateId, $companySid){
        // First check in company email templates
        $result = $this->db
        ->select('subject, message_body as body, from_name, from_email')
        ->from('portal_email_templates')
        ->where('admin_template_sid', $adminEmailTemplateId)
        ->where('company_sid', $companySid)
        ->where('status', 1)
        ->limit(1)
        ->get();
        //
        $templateArray = $result->row_array();
        $result = $result->free_result();
        // If template found then return it
        if(sizeof($templateArray)) return $templateArray;
        // Check and get the admin template
        $result = $this->db
        ->select('subject, text as body, from_name, from_email')
        ->from('email_templates')
        ->where('sid', $adminEmailTemplateId)
        ->where('status', 1)
        ->limit(1)
        ->get();
        //
        $templateArray = $result->row_array();
        $result = $result->free_result();
        return $templateArray;

    }

    function categories_count($company_sid){
        $this->db->select('COUNT(sid) as count')
        ->where('company_sid', $company_sid);
        $record_obj = $this->db->get('documents_category_management');
        $record_arr = $record_obj->row_array();
        $record_obj->free_result();
        if (!empty($record_arr)) {
            return $record_arr['count']+1;
        } else {
            return array();
        }

    }
    function array_sort_by_column(&$arr, $col, $dir = SORT_DESC) {
        $sort_col = array();
        foreach ($arr as $key=> $row) {
            $sort_col[$key] = $row[$col];
        }

        array_multisort($sort_col, $dir, $arr);
    }

    function checkCategoryName($categorySid, $companySid){
        $this->db
        ->where_in('company_sid', [$companySid,0])
        ->where('name', $this->input->post('name', true))
        ->from('documents_category_management')
        ->limit(1);

        if($categorySid != null) $this->db->where("sid <> $categorySid", null);

        return $this->db->count_all_results() ? false : true;
    }

    function change_document_status($sid, $data_to_update) {
        $this->db->where('sid', $sid);
        $this->db->update('documents_assigned', $data_to_update);
    }

    function getUploadedDocumentById($documentId){
        $a = $this->db
        ->select('
            document_title as letter_name,
            document_type as letter_type,
            document_description as letter_body,
            uploaded_document_original_name,
            uploaded_document_s3_name,
            acknowledgment_required,
            download_required,
            signature_required,
            archive,
            sort_order
        ')
        ->where('sid', $documentId)
        ->get('documents_management');
        //
        $b = $a->row_array();
        $a->free_result();
        //
        return $b;
    }

    //
    function insertOfferLetter($d){
        $this->db->insert('offer_letter', $d);
        return $this->db->insert_id();
    }

    //
    function updateAssignedDocumentId($nDocumentId, $documentId){
        $this->db
        ->where('document_sid', $documentId)
        ->update('documents_assigned', array(
            'document_sid' => $nDocumentId,
            'document_type' => 'offer_letter'
        ));

        $this->db
        ->where('document_sid', $documentId)
        ->update('documents_assignment', array(
            'document_sid' => $nDocumentId,
            'is_offer_letter' => 1,
            'document_type' => 'offer_letter'
        ));
        //
    }

    //
    function createConvertHistory($d){
        $this->db->insert('document_to_pay_plan', $d);
    }

    //
    function getDocumentById($documentId){
        $a = $this->db
        ->where('sid', $documentId)
        ->get('documents_management');
        //
        $b = $a->row_array();
        $a->free_result();
        //
        return $b;
    }

    //
    function removeDocument($documentId){
        $this->db
        ->where('sid', $documentId)
        ->delete('documents_management');
    }
    //
    function get_assigned_documents2($company_sid, $user_type, $user_sid = null, $status = 1, $fetch_offer_letter = 1, $archive = 0, $pp_flag = 0) {
        $this->db->select('documents_assigned.*,documents_management.acknowledgment_required,documents_management.download_required,documents_management.signature_required,documents_management.archive');
        $this->db->where('documents_assigned.company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('documents_assigned.archive', $archive);
        if($fetch_offer_letter){
            $this->db->where('documents_assigned.document_type <>', 'offer_letter');
        }
        if ($status) {
            $this->db->where('status', $status);
        }
        if($pp_flag){
            $this->db->where('documents_2_category.category_sid', PP_CATEGORY_SID);
            $this->db->join('documents_2_category','documents_2_category.document_sid = documents_assigned.sid','inner');
        }
        
        $this->db->join('documents_management','documents_management.sid = documents_assigned.document_sid','left');
        return $this->db->get_compiled_select('documents_assigned');
    }

    function check_applicant_offer_letter_exist($company_sid, $user_type, $user_sid, $document_type) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('document_type', $document_type);

        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        
        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function check_offer_letter_moved($document_sid, $document_type) {
        $this->db->select('*');
        $this->db->where('doc_sid', $document_sid);
        $this->db->where('document_type', $document_type);

        $record_obj = $this->db->get('documents_assigned_history');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
        
        if (!empty($record_arr)) {
            return 'yes';
        } else {
            return 'no';
        }
    }

    function disable_all_previous_letter ($company_sid, $user_type, $user_sid, $document_type) {
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('company_sid', $company_sid);
        $this->db->where('document_type', $document_type);
        $this->db->set('status', 0);
        $this->db->set('archive', 1);
        $this->db->update('documents_assigned');
    }

    function set_offer_letter_verification_key ($sid, $verification_key, $type = 'applicant') {
        $this->db->where('sid', $sid);

        if($type == 'applicant'){
            $dataToUpdate = array();
            $dataToUpdate['verification_key'] = $verification_key;
            $this->db->update('portal_job_applications', $dataToUpdate);
        }else{

            $dataToUpdate = array();
            $dataToUpdate['emp_offer_letter_key'] = $verification_key;
            $this->db->update('users', $dataToUpdate);
        }
    }

    function get_requested_authorized_content ($document_sid, $request_from) {
        $this->db->select('*');
        $this->db->where('sid', $document_sid);

        if ($request_from == 'assigned_document') {
            $record_obj = $this->db->get('documents_assigned');
        } else if ($request_from == 'company_document') {
            $record_obj = $this->db->get('documents_management');
        } else if ($request_from == 'company_offer_letter') {
            $record_obj = $this->db->get('offer_letter');
        } else if ($request_from == 'assigned_document_history') {
            $record_obj = $this->db->get('documents_assigned_history');
        } 

        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }

    function get_requested_content($document_sid, $request_type, $request_from, $request_for) {
        $this->db->select('*');
        $this->db->where('sid', $document_sid);

        if ($request_from == 'assigned_document') {
            $record_obj = $this->db->get('documents_assigned');
        } else if ($request_from == 'company_document') {
            $record_obj = $this->db->get('documents_management');
        } else if ($request_from == 'company_offer_letter') {
            $record_obj = $this->db->get('offer_letter');
        } else if ($request_from == 'assigned_document_history') {
            $record_obj = $this->db->get('documents_assigned_history');
        } 

        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
       
        if (!empty($record_arr)) {
            
            $company_sid = $record_arr[0]['company_sid'];
            $user_sid = isset($record_arr[0]['user_sid']) ? $record_arr[0]['user_sid'] : '';
            $user_type = isset($record_arr[0]['user_type']) ? $record_arr[0]['user_type'] : '';
            $document_body = $record_arr[0]['document_description'];

            if ($request_type == 'assigned' && ($request_from == 'assigned_document' || $request_from == 'assigned_document_history')) {

                if ($request_for == 'P&D') {
                    $contant_body = $this->replace_magic_tag_for_print_and_download($company_sid, $document_sid, $document_body);
                } else {
                    $contant_body = replace_tags_for_document($company_sid, $user_sid, $user_type, $document_body, $document_sid); 
                }
                
                return $contant_body;
            } else if ($request_type == 'submitted' && ($request_from == 'assigned_document' || $request_from == 'assigned_document_history')) {
                if (!empty($record_arr[0]['authorized_signature'])) {
                    $authorized_signature_image = '<img style="max-height: '.SIGNATURE_MAX_HEIGHT.';" src="'.$record_arr[0]['authorized_signature'].'" id="show_authorized_signature">';
                    
                } else {
                    $authorized_signature_image = '------------------------------';
                }

                $signature_bas64_image = '<img style="max-height: '.SIGNATURE_MAX_HEIGHT.';" src="'.$record_arr[0]['signature_base64'].'">';
                $init_signature_bas64_image = '<img style="max-height: '.SIGNATURE_MAX_HEIGHT.';" src="'.$record_arr[0]['signature_initial'].'">';
                $sign_date = '<p><strong>'.date_with_time($record_arr[0]['signature_timestamp']).'</strong></p>';

                $document_body = str_replace('{{signature}}', $signature_bas64_image, $document_body);
                $document_body = str_replace('{{inital}}', $init_signature_bas64_image, $document_body);
                $document_body = str_replace('{{sign_date}}', $sign_date , $document_body);
                $document_body = str_replace('{{authorized_signature}}', $authorized_signature_image , $document_body);
                
                if ($request_for == 'P&D') {

                    if (!empty($record_arr[0]['form_input_data'])) {
                        $contant_body = replace_tags_for_document($company_sid, $user_sid, $user_type, $document_body, $document_sid); 
                        return $contant_body;
                    } else if (!empty($record_arr[0]['submitted_description'])) {
                        return $record_arr[0]['submitted_description'];
                    } else {
                        $contant_body = $this->replace_magic_tag_for_print_and_download($company_sid, $document_sid, $document_body);
                        return $contant_body;
                    }
                } else {
                    if (!empty($record_arr[0]['form_input_data'])) {
                        $contant_body = replace_tags_for_document($company_sid, $user_sid, $user_type, $document_body, $document_sid); 
                        return $contant_body;
                    } else if (!empty($record_arr[0]['submitted_description'])) {
                        return $record_arr[0]['submitted_description'];
                    } else {
                        $contant_body = replace_tags_for_document($company_sid, $user_sid, $user_type, $document_body, $document_sid);
                        return $contant_body;
                    }
                }    
                
            } else if ($request_type == 'company' && ($request_from == 'company_offer_letter' || $request_from == 'company_document')) {
                

                if ($request_for == 'P&D') {
                    $contant_body = $this->replace_magic_tag_for_print_and_download($company_sid, $document_sid, $document_body);
                } else {
                    $contant_body = replace_tags_for_document($company_sid, $user_sid, $user_type, $document_body, $document_sid); 
                }

                return $contant_body;
            }
        } else {
            return array();
        }
    }

    function get_document_title($document_sid, $request_type, $request_from) {
        $this->db->select('*');
        $this->db->where('sid', $document_sid);

        if ($request_from == 'assigned_document') {
            $record_obj = $this->db->get('documents_assigned');
        } else if ($request_from == 'company_document') {
            $record_obj = $this->db->get('documents_management');
        } else if ($request_from == 'company_offer_letter') {
            $record_obj = $this->db->get('offer_letter');
        } else if ($request_from == 'assigned_document_history') {
            $record_obj = $this->db->get('documents_assigned_history');
        } 

        $record_arr = $record_obj->result_array();
        $record_obj->free_result();
       
        if (!empty($record_arr)) {
            $user_sid = $record_arr[0]['user_sid'];
            $user_type = $record_arr[0]['user_type'];
            $company_sid = $record_arr[0]['company_sid'];
            $user_name = '';

            if ($user_type == 'applicant') {
                $user_info = $this->get_applicant_information($company_sid,$user_sid);
                $user_name = $user_info['first_name'].'_'.$user_info['last_name'];
               
            } else if ($user_type == 'employee') {
                $user_info = db_get_employee_profile($user_sid);
                $user_name = $user_info[0]['first_name'].'_'.$user_info[0]['last_name'];
            }

            $document_title = $record_arr[0]['document_title'];
            $title = str_replace(" ", '_', $document_title);
            return $user_name.'_'.$title.'_'.date('Y_m_d');
        } else {
            return 'document';
        }
    }

    function replace_magic_tag_for_print_and_download ($company_sid, $document_sid, $document_content) {
        $value = '------------------------------';
        $document_content = str_replace('{{first_name}}', $value, $document_content);
        $document_content = str_replace('{{firstname}}', $value, $document_content);
        $document_content = str_replace('{{last_name}}', $value, $document_content);
        $document_content = str_replace('{{lastname}}', $value, $document_content);
        $document_content = str_replace('{{email}}', $value, $document_content);
        $document_content = str_replace('{{job_title}}', $value, $document_content);
        $document_content = str_replace('{{company_name}}', $value, $document_content);
        $document_content = str_replace('{{company_address}}', $value, $document_content);
        $document_content = str_replace('{{company_phone}}', $value, $document_content);
        $document_content = str_replace('{{career_site_url}}', $value, $document_content);
        $document_content = str_replace('{{signature}}', $value, $document_content);
        $document_content = str_replace('{{inital}}', $value, $document_content);
        $document_content = str_replace('{{sign_date}}', $value, $document_content);
        $document_content = str_replace('{{signature_print_name}}', $value, $document_content);
        $document_content = str_replace('{{short_text}}', $value, $document_content);
        $value = '------/-------/----------------';
        $document_content = str_replace('{{start_date}}', $value, $document_content);

        $value = 'Date :------/-------/----------------';
        $document_content = str_replace('{{date}}', $value, $document_content);

        $value = 'Please contact with your manager';
        $document_content = str_replace('{{username}}', $value, $document_content);
        $document_content = str_replace('{{password}}', $value, $document_content);

        $authorized_signature = '------------------------------';

        $document_content = str_replace('{{authorized_signature}}', $authorized_signature, $document_content);

        $value = '<br><input type="checkbox" class="user_checkbox input-grey"/>';
        $document_content = str_replace('{{checkbox}}', $value, $document_content);

        $value = '<div style="border: 1px dotted #777; padding:5px;background-color:#eee;"  contenteditable="true"></div>';
        $document_content = str_replace('{{text}}', $value, $document_content);

        $value = '<div style="border: 1px dotted #777; padding:5px; min-height: 145px;background-color:#eee;" class="div-editable fillable_input_field" id="div_editable_text" contenteditable="true" data-placeholder="Type Here"></div>';
        $document_content = str_replace('{{text_area}}', $value, $document_content);

        return $document_content;
    }

    function update_employee ($sid, $data) {
        $this->db->where('sid', $sid);
        $this->db->update('users', $data);
    }

    function get_all_companies() {

        $this->db->select('sid, CompanyName');
        $this->db->where('active', 1);
        $this->db->where('is_paid', 1);
        $this->db->where('parent_sid', 0);
        $this->db->order_by('CompanyName', 'ASC');
        $this->db->from('users');
        $records_obj = $this->db->get();
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();

        $result = array();
        if (!empty($records_arr)) {
            $result = $records_arr;
        }
        return $result;
    }

    function get_company_all_documents($company_sid) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('archive', 0);
        $this->db->where('automatic_assign_in >', 0);
        $this->db->order_by('sort_order','ASC');
        $records_obj = $this->db->get('documents_management');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        return $records_arr;
    }

    function checkAndAssignDoc($document, $cid, $cName) {
        $docId = $document['sid'];
        $days = $document['automatic_assign_in'];
        $type = $document['automatic_assign_type'];
        if($type == 'days'){
            $date = date('Y-m-d H:i:s',strtotime('-'.$days.' Days'));
            $date2 = date('Y-m-d',strtotime('-'.$days.' Days'));
        }else{
            $date = date('Y-m-d H:i:s',strtotime('-'.$days.' Months'));
            $date2 = date('Y-m-d',strtotime('-'.$days.' Months'));
        }
        $this->db->select('sid,document_sent_on,first_name,last_name,email,PhoneNumber as phone');
        $this->db->where('parent_sid', $cid);
        $this->db->group_start();
        $this->db->where('registration_date <= ',$date);
        $this->db->or_where('joined_at <= ',$date2);
        $this->db->group_end();
        $this->db->where('active', 1);
        $this->db->where('terminated_status', 0);

        $records_obj = $this->db->get('users');
        $records_arr = $records_obj->result_array();
        $records_obj->free_result();
        if (!empty($records_arr)) {
            foreach($records_arr as $user_info){
                $check_exist = $this->check_assigned_document($docId, $user_info['sid'], 'employee');
                if(empty($check_exist)){
                    $data_to_insert = array();
                    $data_to_insert['company_sid'] = $cid;
                    $data_to_insert['assigned_date'] = date('Y-m-d H:i:s');
                    $data_to_insert['assigned_by'] = 0;
                    $data_to_insert['user_type'] = 'employee';
                    $data_to_insert['user_sid'] = $user_info['sid'];
                    $data_to_insert['document_type'] = $document['document_type'];
                    $data_to_insert['document_sid'] = $document['sid'];
                    $data_to_insert['status'] = 1;
                    $data_to_insert['document_original_name'] = $document['uploaded_document_original_name'];
                    $data_to_insert['document_extension'] = $document['uploaded_document_extension'];
                    $data_to_insert['document_s3_name'] = $document['uploaded_document_s3_name'];
                    $data_to_insert['document_title'] = $document['document_title'];
                    $data_to_insert['document_description'] = $document['document_description'];
                    $this->insert_documents_assignment_record($data_to_insert);
                    //Send Email and SMS
//                    $replacement_array = array();
//                    $replacement_array['contact-name'] = ucwords($user_info['first_name'] . ' ' . $user_info['last_name']);
//                    $replacement_array['company_name'] = ucwords($cName);
//                    $replacement_array['firstname'] = $user_info['first_name'];
//                    $replacement_array['lastname'] = $user_info['last_name'];
//                    $replacement_array['first_name'] = $user_info['first_name'];
//                    $replacement_array['last_name'] = $user_info['last_name'];
//                    $replacement_array['baseurl'] = base_url();
//                    $replacement_array['url'] = base_url('hr_documents_management/my_documents');
                    //SMS Start
//                    if(empty($user_info['document_sent_on']) || $user_info['document_sent_on'] == NULL || date('Y-m-d H:i:s') > date('Y-m-d H:i:s',strtotime('+'.DOCUMENT_SEND_DURATION.' hours',strtotime($user_info['document_sent_on'])))){
//                        $company_sms_notification_status = get_company_sms_status($this, $cid);
//                        if($company_sms_notification_status){
//                            $notify_by = get_employee_sms_status($this, $user_info['sid']);
//                            $sms_notify = 0 ;
//                            if(strpos($notify_by['notified_by'],'sms') !== false){
//                                $contact_no = $notify_by['PhoneNumber'];
//                                $sms_notify = 1;
//                            }
//                            if($sms_notify){
//                                $this->load->library('Twilioapp');
//                                // Send SMS
//                                $sms_template = get_company_sms_template($this,$cid,'hr_document_notification');
//                                $sms_body = replace_sms_body($sms_template['sms_body'],$replacement_array);
//                                sendSMS(
//                                    $contact_no,
//                                    $sms_body,
//                                    trim(ucwords(strtolower($replacement_array['company_name']))),
//                                    $user_info['email'],
//                                    $this,
//                                    $sms_notify,
//                                    $cid
//                                );
//                            }
//                        }
//                        log_and_send_templated_email(HR_DOCUMENTS_NOTIFICATION_EMS, $user_info['email'], $replacement_array);
//                        $this->update_employee($user_info['sid'], array('document_sent_on' => date('Y-m-d H:i:s')));
//                    }
                }
            }
        }
    }

    function get_all_assigned_offer_letters($company_sid) {
        $this->db->select('*');
        $this->db->where('document_type', 'offer_letter');
        $this->db->where('company_sid', $company_sid);
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function get_all_user_assigned_offer_letter($company_sid, $user_sid, $user_type) {
        $this->db->select('*');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('document_type', 'offer_letter');
        $record_obj = $this->db->get('documents_assigned');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr;
        } else {
            return array();
        }
    }

    function disable_current_processing_offer_letter ($document_sid) {
        $this->db->where('sid', $document_sid);
        $this->db->set('status', 0);
        $this->db->set('archive', 1);
        $this->db->update('documents_assigned');
    }

    function get_current_user_signature ($company_sid, $user_type, $user_sid) {
        $this->db->select('signature_bas64_image');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('user_type', $user_type);
        $this->db->where('user_sid', $user_sid);
        $this->db->where('is_active', 1);
        $record_obj = $this->db->get('e_signatures_data');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0]['signature_bas64_image'];
        } else {
            return array();
        }
    }

    function deactivate_assign_authorized_documents ($company_sid, $document_sid) {
        $this->db->where('company_sid', $company_sid);
        $this->db->where('document_assigned_sid', $document_sid);
        $this->db->set('assigned_status', 0);
        $this->db->update('authorized_document_assigned_manager');
    }

    function fetch_authorized_doc_assign_user ($company_sid, $assign_document_sid) {
        $this->db->select('assigned_to_sid, assigned_by_date');
        $this->db->where('company_sid', $company_sid);
        $this->db->where('document_assigned_sid', $assign_document_sid);
        $this->db->where('assigned_status', 1);
        $record_obj = $this->db->get('authorized_document_assigned_manager');
        $record_arr = $record_obj->result_array();
        $record_obj->free_result();

        if (!empty($record_arr)) {
            return $record_arr[0];
        } else {
            return array();
        }
    }


    function getDepartments( $companySid ){
        $a = $this->db
        ->select('sid, name')
        ->where('company_sid', $companySid)
        ->where('status', 1)
        ->where('is_deleted', 0)
        ->order_by('sort_order', 'ASC')
        ->get('departments_management');
        //
        $b = $a->result_array();
        $a = $a->free_result();
        //
        return $b;
    }


    function getEmployees( $employeeList, $companySid ){
        //
        if(array_search('-1', $employeeList) === false){
            return $employeeList;
        };
 
        $a = $this->db
        ->select('sid')
        ->where('parent_sid', $companySid)
        ->where('active', 1)
        ->get('users');
        //
        $b = $a->result_array();
        $a = $a->free_result();
        //
        $r = array();
        //
        if(sizeof($b)) foreach ($b as $k => $v) $r[] = $v['sid'];
        return $r;
    }

    function getEmployeesFromDepartment( $departmentList, $companySid ){
        //
        $departmentSids = array();
        if(array_search('-1', $departmentList) !== false){
            $a = $this->db
            ->select('sid')
            ->where('company_sid', $companySid)
            ->where('status', 1)
            ->where('is_deleted', 0)
            ->get('departments_management');
            //
            $b = $a->result_array();
            $a = $a->free_result();
            //
            if(sizeof($b)) foreach ($b as $k => $v) $departmentSids[] = $v['sid'];
        } else $departmentSids = $departmentList;
        // 
        if(!sizeof($departmentSids)) return array();
        //
        $a = $this->db
        ->select('employee_sid')
        ->where_in('department_sid', $departmentSids)
        ->get('departments_employee_2_team');
        //
        $b = $a->result_array();
        $a = $a->free_result();
        //
        $r = array();
        //
        if(sizeof($b)) foreach ($b as $k => $v) $r[] = $v['employee_sid'];
        return $r;
    }
}
