$(function(){let o,n={question_id:0,question_required:!1,is_required:!1,question_title:"",question_content:"",question_type:"text",choice_list:{},video_type:"none",video_file_name:""},d,a;$(document).on("click",".jsModalCancel",function(){a.close()}),$(document).on("change","#jsAddQuestionType",function(){$(".jsAddQuestionPlace").addClass("hidden"),"multiple_choice"===$(this).val()||"single_choice"===$(this).val()?$(".jsAddQuestionChoice").removeClass("hidden"):"yes_no"===$(this).val()?$(".jsAddQuestionYesNo").removeClass("hidden"):"rating"===$(this).val()&&$(".jsAddQuestionRating").removeClass("hidden")}),$(document).on("change",".jsAddQuestionVideoType",function(){$(".jsAddQuestionUploadVideoBox").addClass("hidden"),$(".jsAddQuestionRecordVideoBox").addClass("hidden"),$(".jsAddQuestionLinkVideoBox").addClass("hidden"),a.close(),"upload"===$(this).val()?$(".jsAddQuestionUploadVideoBox").removeClass("hidden"):"record"===$(this).val()?($(".jsAddQuestionRecordVideoBox").removeClass("hidden"),a.init()):"none"!=$(this).val()&&$(".jsAddQuestionLinkVideoBox").removeClass("hidden")}),$(document).on("click",".jsAddQuestionSaveBtn",function(e){e.preventDefault(),(async()=>{let i=[],t=(n.question_title=$("#jsAddQuestionTitle").val().trim(),n.question_content=$("#jsAddQuestionHelp").val().trim(),n.question_required=$("#jsAddQuestionRequired").prop("checked"),n.is_required=$("#jsAddQuestionRequired").prop("checked"),n.question_type=$("#jsAddQuestionType").select2("val"),n.choice_list={},n.video_type=$(".jsAddQuestionVideoType:checked").val()||null,n.video_file_name="",n.question_title||i.push('"Question" field is mandatory.'),n.question_type||i.push('"Question type" field is mandatory.'),"single_choice"===n.question_type||"multiple_choice"===n.question_type?$(".csChoiceRow").map(function(e){var t={answer_choice:$(this).find(".jsAddQuestionChoiceAnswer").val().trim(),answer_score:$(this).find(".jsAddQuestionChoiceAnswerScore").val().trim(),answer_status:$(this).find(".jsAddQuestionChoiceAnswerStatus").val().trim()};t.answer_choice||i.push('"Answer Choice" is missing for row '+(e+1)+"."),n.choice_list[e]=t}):"yes_no"===n.question_type?(n.choice_list.yes={score:$("#jsAddQuestionYesNoYSelect option:checked").val(),status:$("#jsAddQuestionYesNoYStatus option:checked").val()},n.choice_list.no={score:$("#jsAddQuestionYesNoNSelect option:checked").val(),status:$("#jsAddQuestionYesNoNStatus option:checked").val()}):"rating"===n.question_type&&(n.choice_list={rating:$("#jsAddQuestionRatingScale option:checked").val(),min:$("#jsAddQuestionRatingMinText").val()||"Very poor",max:$("#jsAddQuestionRatingMaxText").val()||"Very good"}),n.video_type||i.push('"Video type" field is mandatory.'),{}),s={},e=!1;if("upload"===n.video_type?(t=$("#jsAddQuestionUploadVideo").msFileUploader("get"),Object.keys(t).length?t.errorCode&&i.push(t.errorCode):i.push('"Video file" is mandatory. Please upload a file.'),e=!0):"record"===n.video_type?(5===(s=await a.getVideo()).length&&i.push('"Video Recording" is mandatory. Please record a video.'),e=!0):"link"===n.video_type&&(n.video_file_name=$("#jsAddQuestionLink").val().trim(),n.video_file_name?n.video_file_name.isValidYoutubeLink()||n.video_file_name.isValidVimeoLink()||i.push("Invalid YouTube / Vimeo link."):i.push("YouTube / Vimeo link is required.")),i.length)return alertify.alert("ERROR!",getErrorsStringFromArray(i),CB);if(o=callButtonHook($(".jsAddQuestionSaveBtn"),!0),e){let e={};if("upload"===n.video_type?"string"==typeof(e=await(e=>{var t=new FormData;return t.append("file",e),makeSecureCallToApiServer("uploader",{method:"POST",timeout:0,processData:!1,mimeType:"multipart/form-data",contentType:!1,data:t})})(t))&&(e=JSON.parse(e)):e=await(e=>makeSecureCallToApiServer("uploader/stream",{method:"POST",timeout:0,contentType:"application/json",data:JSON.stringify({stream:e})}))(s),!Object.keys(e).length)return callButtonHook(o,!1),alertify.alert("ERROR!","Failed to upload file.",CB);n.video_file_name=e.data}n.question_id=Date.now(),a.close(),$("#jsAddQuestionUploadVideo").msFileUploader("clear"),callButtonHook(o,!1),d(n)})()}),$(document).on("click",".jsAddChoiceAnswer",function(e){e.preventDefault();$(".csChoiceBox").append(`
		<!-- secondary question row -->
		<div class="csChoiceRow">
			<div class="row">
				<div class="col-xs-12 col-sm-5">
					<label>Answer Choice <strong class="text-danger">*</strong></label>
					<input type="text" class="form-control jsAddQuestionChoiceAnswer" />
				</div>
				<div class="col-xs-12 col-sm-3">
					<label>Question Score <strong class="text-danger">*</strong></label>
					<select class="form-control jsAddQuestionChoiceAnswerScore">
						<option value="0">Not acceptable - 0</option>
						<option value="1">Acceptable - 1</option>
						<option value="2">Good - 2</option>
						<option value="3">Very Good - 3</option>
						<option value="4">Excellent - 4</option>
					</select>
				</div>
				<div class="col-xs-12 col-sm-2">
					<label>Status <strong class="text-danger">*</strong></label>
					<select class="form-control jsAddQuestionChoiceAnswerStatus">
						<option value="pass">Pass</option>
						<option value="fail">Fail</option>
					</select>
				</div>
				<div class="col-xs-12 col-sm-1">
					<p>&nbsp;</p>
					<button class="btn btn-danger jsDeleteChoiceAnswer" type="button" title="Remove answer" placement="top">
						<i class="fa fa-times-circle" aria-hidden="true"></i>
					</button>
				</div>
			</div>
			<br />
		</div>
				`)}),$(document).on("click",".jsDeleteChoiceAnswer",function(e){e.preventDefault(),$(this).closest(".csChoiceRow").remove()}),window.loadAddQuestionView=function(e){d=e,a=new msVideoRecorder({recorderPlayer:"jsAddQuestionRecordingLive",previewPlayer:"jsAddQuestionRecordingRecorded",recordButton:"jsAddQuestionRecordingStart",playRecordedVideoBTN:"jsAddQuestionRecordingPlay",pauseRecordedVideoBTN:"jsAddQuestionRecordingPause",resumeRecordedVideoBTN:"jsAddQuestionRecordingResume",removeRecordedVideoBTN:"jsAddQuestionRecordingRemove",errorSectionReference:"jsAddQuestionRecordingError"}),$("#jsAddQuestionUploadVideo").msFileUploader({fileLimit:"200mb",allowedTypes:["mp4","mov"]}),$("#jsAddQuestionType").select2({minimumResultsForSearch:-1}),$("#jsAddQuestionTitle").val(""),$("#jsAddQuestionHelp").val(""),$("#jsAddQuestionRequired").prop("checked",!1),$("#jsAddQuestionType").select2("val","text"),$(".jsAddQuestionPlace").addClass("hidden"),$('#jsAddQuestionYesNoYSelect option[value="0"]').prop("selected",!0),$('#jsAddQuestionYesNoYStatus option[value="pass"]').prop("selected",!0),$('#jsAddcallbackReferenceQuestionYesNoNSelect option[value="0"]').prop("selected",!0),$('#jsAddQuestionYesNoNStatus option[value="pass"]').prop("selected",!0),$(".jsAddQuestionChoiceAnswer").val(""),$(".csChoiceBox").html(""),$('#jsAddQuestionChoiceAnswerScore option[value="0"]').prop("selected",!0),$('#jsAddQuestionChoiceAnswerStatus option[value="pass"]').prop("selected",!0),$(".jsAddQuestionVideoType").prop("checked",!1),$(".jsAddQuestionUploadVideoBox").addClass("hidden"),$(".jsAddQuestionRecordVideoBox").addClass("hidden"),$(".jsAddQuestionLinkVideoBox").addClass("hidden"),$("#jsAddQuestionLink").val(""),n={question_id:0,question_title:"",question_required:!1,is_required:!1,question_content:"",question_type:"text",choice_list:{},video_type:"upload",video_file_name:""}}}),$(function(){let o,n={question_id:0,question_title:"",question_required:!1,is_required:!1,question_content:"",question_type:"text",choice_list:{},video_type:"none",video_file_name:"",tag:""},d,a;$(document).on("click",".jsModalCancel",function(){a.close()}),$(document).on("change","#jsEditQuestionType",function(){$(".jsEditQuestionPlace").addClass("hidden"),"multiple_choice"===$(this).val()||"single_choice"===$(this).val()?$(".jsEditQuestionChoice").removeClass("hidden"):"yes_no"===$(this).val()?$(".jsEditQuestionYesNo").removeClass("hidden"):"rating"===$(this).val()&&(console.log($(this).val()),$(".jsEditQuestionRating").removeClass("hidden"))}),$(document).on("change",".jsEditQuestionVideoType",function(){$(".jsEditQuestionUploadVideoBox").addClass("hidden"),$(".jsEditQuestionRecordVideoBox").addClass("hidden"),$(".jsEditQuestionLinkVideoBox").addClass("hidden"),a.close(),"upload"===$(this).val()?$(".jsEditQuestionUploadVideoBox").removeClass("hidden"):"record"===$(this).val()?($(".jsEditQuestionRecordVideoBox").removeClass("hidden"),a.init()):"link"===$(this).val()&&$(".jsEditQuestionLinkVideoBox").removeClass("hidden")}),$(document).on("click",".jsEditQuestionSaveBtn",function(e){e.preventDefault(),(async()=>{let i=[],t=(n.question_required=$("#jsEditQuestionRequired").prop("checked"),n.is_required=$("#jsEditQuestionRequired").prop("checked"),n.question_title=$("#jsEditQuestionTitle").val().trim(),n.question_content=$("#jsEditQuestionHelp").val().trim(),n.question_type=$("#jsEditQuestionType").select2("val"),n.choice_list={},n.video_type=$(".jsEditQuestionVideoType:checked").val()||null,n.question_title||i.push('"Question" field is mandatory.'),n.question_type||i.push('"Question type" field is mandatory.'),"single_choice"===n.question_type||"multiple_choice"===n.question_type?$(".csEditChoiceRow").map(function(e){var t={answer_choice:$(this).find(".jsEditQuestionChoiceAnswer").val().trim(),answer_score:$(this).find(".jsEditQuestionChoiceAnswerScore").val().trim(),answer_status:$(this).find(".jsEditQuestionChoiceAnswerStatus").val().trim()};t.answer_choice||i.push('"Answer Choice" is missing for row '+(e+1)+"."),n.choice_list[e]=t}):"yes_no"===n.question_type?(n.choice_list.yes={score:$("#jsEditQuestionYesNoYSelect option:checked").val(),status:$("#jsEditQuestionYesNoYStatus option:checked").val()},n.choice_list.no={score:$("#jsEditQuestionYesNoNSelect option:checked").val(),status:$("#jsEditQuestionYesNoNStatus option:checked").val()}):"rating"===n.question_type&&(n.choice_list={rating:$("#jsEditQuestionRatingScale option:checked").val(),min:$("#jsEditQuestionRatingMinText").val()||"Very poor",max:$("#jsEditQuestionRatingMaxText").val()||"Very good"}),n.video_type||i.push('"Video type" field is mandatory.'),{}),s={},e=!1;if("upload"===n.video_type?(t=$("#jsEditQuestionUploadVideo").msFileUploader("get"),Object.keys(t).length?(t.errorCode&&i.push(t.errorCode),e=!0):n.video_file_name||i.push('"Video file" is mandatory. Please upload a file.')):"record"===n.video_type?5!==(s=await a.getVideo()).length||n.video_file_name?e=!0:i.push('"Video Recording" is mandatory. Please record a video.'):"link"===n.video_type?(n.video_file_name=$("#jsEditQuestionLink").val().trim(),n.video_file_name?n.video_file_name.isValidYoutubeLink()||n.video_file_name.isValidVimeoLink()||i.push("Invalid YouTube / Vimeo link."):i.push("YouTube / Vimeo link is required.")):n.video_file_name="none",i.length)return alertify.alert("ERROR!",getErrorsStringFromArray(i),CB);if(o=callButtonHook($(".jsEditQuestionSaveBtn"),!0),e&&"none"!=n.video_type){let e={};if("upload"===n.video_type?"string"==typeof(e=await(e=>{var t=new FormData;return t.append("file",e),makeSecureCallToApiServer("uploader",{method:"POST",timeout:0,processData:!1,mimeType:"multipart/form-data",contentType:!1,data:t})})(t))&&(e=JSON.parse(e)):e=await(e=>makeSecureCallToApiServer("uploader/stream",{method:"POST",timeout:0,contentType:"application/json",data:JSON.stringify({stream:e})}))(s),!Object.keys(e).length)return callButtonHook(o,!1),alertify.alert("ERROR!","Failed to upload file.",CB);n.video_file_name=e.data}a.close(),$("#jsEditQuestionUploadVideo").msFileUploader("clear"),callButtonHook(o,!1),d(n)})()}),$(document).on("click",".jsEditChoiceAnswer",function(e){e.preventDefault();$(".csEditChoiceBox").append(`
		<!-- secondary question row -->
		<div class="csEditChoiceRow">
			<div class="row">
				<div class="col-xs-12 col-sm-5">
					<label>Answer Choice <strong class="text-danger">*</strong></label>
					<input type="text" class="form-control jsEditQuestionChoiceAnswer" />
				</div>
				<div class="col-xs-12 col-sm-3">
					<label>Question Score <strong class="text-danger">*</strong></label>
					<select class="form-control jsEditQuestionChoiceAnswerScore">
						<option value="0">Not acceptable - 0</option>
						<option value="1">Acceptable - 1</option>
						<option value="2">Good - 2</option>
						<option value="3">Very Good - 3</option>
						<option value="4">Excellent - 4</option>
					</select>
				</div>
				<div class="col-xs-12 col-sm-2">
					<label>Status <strong class="text-danger">*</strong></label>
					<select class="form-control jsEditQuestionChoiceAnswerStatus">
						<option value="pass">Pass</option>
						<option value="fail">Fail</option>
					</select>
				</div>
				<div class="col-xs-12 col-sm-1">
					<p>&nbsp;</p>
					<button class="btn btn-danger jsEditDeleteChoiceAnswer" type="button" title="Remove answer" placement="top">
						<i class="fa fa-times-circle" aria-hidden="true"></i>
					</button>
				</div>
			</div>
			<br />
		</div>
				`)}),$(document).on("click",".jsEditDeleteChoiceAnswer",function(e){e.preventDefault(),$(this).closest(".csChoiceRowEdit").remove()}),window.loadEditQuestionView=function(e,t){if(n=e,d=t,a=new msVideoRecorder({recorderPlayer:"jsEditQuestionRecordingLive",previewPlayer:"jsEditQuestionRecordingRecorded",recordButton:"jsEditQuestionRecordingStart",playRecordedVideoBTN:"jsEditQuestionRecordingPlay",pauseRecordedVideoBTN:"jsEditQuestionRecordingPause",resumeRecordedVideoBTN:"jsEditQuestionRecordingResume",removeRecordedVideoBTN:"jsEditQuestionRecordingRemove",errorSectionReference:"jsEditQuestionRecordingError"}),$(".jsEditQuestionUploadVideoBox").find(".jsMainUploadAreaWrapper").remove(),$("#jsEditQuestionUploadVideo").msFileUploader({fileLimit:"200mb",allowedTypes:["mp4","mov"],placeholderImage:n.video_file_name}),$('#jsEditQuestionType option[value="'+n.question_type+'"]').prop("selected",!0),$("#jsEditQuestionType").select2({minimumResultsForSearch:-1}),$("#jsEditQuestionMultipleChoiceAnswer").select2({minimumResultsForSearch:-1}),$("#jsEditQuestionTitle").val(n.question_title),$("#jsEditQuestionRequired").prop("checked",n.question_required),$("#jsEditQuestionRequired").prop("checked",n.is_required),$("#jsEditQuestionHelp").val(n.question_content),$('.jsEditQuestionVideoType[value="'+n.video_type+'"]').prop("checked",!0),"none"===n.video_type?($('.jsEditQuestionVideoType[value="'+n.video_type+'"]').prop("checked",!0),$(".jsEditQuestionUploadVideoBox").addClass("hidden"),$(".jsEditQuestionRecordVideoBox").addClass("hidden"),$(".jsEditQuestionLinkVideoBox").addClass("hidden"),$("#jsEditQuestionLink").val(n.video_file_name)):"link"===n.video_type?($('.jsEditQuestionVideoType[value="'+n.video_type+'"]').prop("checked",!0),$(".jsEditQuestionUploadVideoBox").addClass("hidden"),$(".jsEditQuestionRecordVideoBox").addClass("hidden"),$(".jsEditQuestionLinkVideoBox").removeClass("hidden"),$("#jsEditQuestionLink").val(n.video_file_name)):($('.jsEditQuestionVideoType[value="upload"]').prop("checked",!0),$(".jsEditQuestionRecordVideoBox").addClass("hidden"),$(".jsEditQuestionUploadVideoBox").removeClass("hidden")),$('#jsEditQuestionYesNoYSelect option[value="0"]').prop("selected",!0),$('#jsEditQuestionYesNoYStatus option[value="pass"]').prop("selected",!0),$('#jsEditQuestionYesNoNSelect option[value="0"]').prop("selected",!0),$('#jsEditQuestionYesNoNStatus option[value="pass"]').prop("selected",!0),$(".csEditChoiceBox").html(""),$(".jsEditQuestionChoiceAnswer").val(""),$('#jsEditQuestionChoiceAnswerScore option[value="0"]').prop("selected",!0),$('#jsEditQuestionChoiceAnswerStatus option[value="pass"]').prop("selected",!0),$(".jsEditQuestionPlace").addClass("hidden"),"yes_no"===n.question_type)$(".jsEditQuestionYesNo").removeClass("hidden"),$('#jsEditQuestionYesNoYSelect option[value="'+n.choice_list.yes.score+'"]').prop("selected",!0),$('#jsEditQuestionYesNoYStatus option[value="'+n.choice_list.yes.status+'"]').prop("selected",!0),$('#jsEditQuestionYesNoNSelect option[value="'+n.choice_list.no.score+'"]').prop("selected",!0),$('#jsEditQuestionYesNoNStatus option[value="'+n.choice_list.no.status+'"]').prop("selected",!0);else if("single_choice"===n.question_type||"multiple_choice"===n.question_type)for(var i in $(".jsEditQuestionChoice").removeClass("hidden"),$(".jsEditQuestionChoiceAnswerPrimary").val(n.choice_list[0].answer_choice),$('.jsEditQuestionChoiceAnswerPrimaryScore option[value="'+n.choice_list[0].answer_score+'"]').prop("selected",!0),$('.jsEditQuestionChoiceAnswerPrimaryStatus option[value="'+n.choice_list[0].answer_status+'"]').prop("selected",!0),n.choice_list)0!=i&&$(".csEditChoiceBox").append(`
						<!-- secondary question row -->
						<div class="csEditChoiceRow">
							<div class="row">
								<div class="col-xs-12 col-sm-5">
									<label>Answer Choice <strong class="text-danger">*</strong></label>
									<input type="text" class="form-control jsEditQuestionChoiceAnswer" value="${n.choice_list[i].answer_choice}" />
								</div>
								<div class="col-xs-12 col-sm-3">
									<label>Question Score <strong class="text-danger">*</strong></label>
									<select class="form-control jsEditQuestionChoiceAnswerScore">
										<option ${"0"===n.choice_list[i].answer_score?"selected":""} value="0">Not acceptable - 0</option>
										<option ${"1"===n.choice_list[i].answer_score?"selected":""} value="1">Acceptable - 1</option>
										<option ${"2"===n.choice_list[i].answer_score?"selected":""} value="2">Good - 2</option>
										<option ${"3"===n.choice_list[i].answer_score?"selected":""} value="3">Very Good - 3</option>
										<option ${"4"===n.choice_list[i].answer_score?"selected":""} value="4">Excellent - 4</option>
									</select>
								</div>
								<div class="col-xs-12 col-sm-2">
									<label>Status <strong class="text-danger">*</strong></label>
									<select class="form-control jsEditQuestionChoiceAnswerStatus">
										<option ${"pass"===n.choice_list[i].answer_status?"selected":""} value="pass">Pass</option>
										<option ${"fail"===n.choice_list[i].answer_status?"selected":""} value="fail">Fail</option>
									</select>
								</div>
								<div class="col-xs-12 col-sm-1">
									<p>&nbsp;</p>
									<button class="btn btn-danger jsEditDeleteChoiceAnswer" type="button" title="Remove answer" placement="top">
										<i class="fa fa-times-circle" aria-hidden="true"></i>
									</button>
								</div>
							</div>
							<br />
						</div>
				`)}}),$(function(){let t=null,i,s,o={title:"",description:"",category:"",is_recurring:!1,recur_type:"days",recur_number:0,available_date:0,questions:[]},n=[];function d(){if(!n.length)return $("#jsAddQuestionsArea").html('<p class="alert alert-info text-center">No questions found yet.</p>');let t="";n.map(function(e){void 0!==e.description?t+=getDescriptionPreview(e):t+=getQuestionPreview(e)}),$("#jsAddQuestionsArea").html(t)}function a(t){n=n.filter(function(e){return e.question_id!=t}),d()}function c(t){return n.filter(function(e){return e.question_id==t})[0]}function r(e){console.log("Add ",e),$("#sectionMain").addClass("hidden"),$("#sectionAddQuestionBox").addClass("hidden"),$("#sectionEditQuestionBox").addClass("hidden"),$("#sectionAddDescription").addClass("hidden"),$("#jsAddEditDescriptionId").val(""),s.setButtons(""),setTimeout(function(){"basic"===e?($("#sectionMain").removeClass("hidden"),s.setButtons('<button type="button" class="btn btn-orange jsTemplateSaveBtn"><i class="fa fa-save"></i>Save Changes</button>')):"add_question"===e?($("#sectionAddQuestionBox").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToAddCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsAddQuestionSaveBtn"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Save Question</button>
                `)):"edit_question"===e?($("#sectionEditQuestionBox").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToAddCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsEditQuestionSaveBtn"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Update Question</button>
                `)):"add_description"===e?($("#sectionAddDescription").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToAddCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsAddEditDescription"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Save Changes</button>
                `)):"edit_description"===e&&($("#sectionAddDescription").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToAddCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsAddModifyDescription"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Save Changes</button>
                `))},10)}$(document).on("keyup","#jsTemplateTitle",function(e){o.title=$(this).val()}),$(document).on("keyup","#jsTemplateDescription",function(e){o.description=$(this).val()}),$(document).on("click","#jsTemplateRecur",function(e){o.is_recurring=$(this).prop("checked"),o.is_recurring?$(".jsRecurringSurveyBox").removeClass("hidden"):$(".jsRecurringSurveyBox").addClass("hidden")}),$(document).on("keyup","#jsTemplateRecurNumber",function(e){o.recur_number=$(this).val()}),$(document).on("change","#jsTemplateRecurType",function(e){o.recur_type=$(this).val()}),$(document).on("click",".jsTemplateSaveBtn",function(e){e.preventDefault(),o.title?o.is_recurring&&!o.recur_number?_error("Recur number is required."):0===n.length?_error("Please add at least one question."):(o.questions=n,(async()=>{i=callButtonHook($(".jsTemplateSaveBtn"),!0);try{var e=await makeSecureCallToApiServer("surveys/templates/create",{method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(o),caches:!1});s.closeModal(),_success(e.message,function(){getTemplates()})}catch(e){handleErrorResponse(e),callButtonHook(i,!1)}})()):_error("Title is required.")}),$(document).on("click",".jsTemplateAddQuestion",function(e){e.preventDefault(),r("add_question"),loadAddQuestionView(function(e){e.tag=(()=>{let t="";return n.map(function(e){void 0!==e.description&&(t=e.description)}),t})(),n.push(e),d(),r("basic")})}),$(document).on("click",".jsTemplateAddDescription",function(e){e.preventDefault(),r("add_description"),CKEDITOR.instances.jsAddEditDescription||CKEDITOR.replace("jsAddEditDescription",{toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline"]}]}),CKEDITOR.instances.jsAddEditDescription.setData("")}),$(document).on("click",".jsTemplateEditDescription",function(e){e.preventDefault();e=c($(this).closest(".jsQuestionDescription").data("id").replace("desc_",""));r("edit_description"),CKEDITOR.instances.jsAddEditDescription||CKEDITOR.replace("jsAddEditDescription",{toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline"]}]}),CKEDITOR.instances.jsAddEditDescription.setData(e.description),$("#jsAddEditDescriptionId").val(e.question_id)}),$(document).on("click",".jsAddEditDescription",function(e){e.preventDefault();e=CKEDITOR.instances.jsAddEditDescription.getData();e.trim()&&""!==$("<div>").html(e).text().trim()?(n.push({question_id:generateRandomAndUniqueId(),description:e,plainDescription:$("<div>").html(e).text().trim(),slug:getSlug(e),questions:[]}),r("basic"),d()):_error("Description cannot be empty.")}),$(document).on("click",".jsAddModifyDescription",function(e){e.preventDefault();let t=CKEDITOR.instances.jsAddEditDescription.getData(),i=$("#jsAddEditDescriptionId").val();t.trim()&&""!==$("<div>").html(t).text().trim()?(n=n.map(function(e){return e.question_id===i&&(e.description=t,e.plainDescription=$("<div>").html(t).text().trim(),e.slug=getSlug(t)),e}),r("basic"),d()):_error("Description cannot be empty.")}),$(document).on("click",".jsRemoveDescription",function(e){e.preventDefault();let t=$(this).closest(".jsQuestionDescription").data("id").replace("desc_","");_confirm("Do you want to delete this question?",function(){a(t)})}),$(document).on("click",".jsBackToAddCoursePage",function(e){e.preventDefault(),r("basic")}),$(document).on("click",".jsRemoveQuestion",function(e){e.preventDefault();let t=$(this).closest(".jsQuestionView").data("id");_confirm("Do you want to delete this question?",function(){a(t)})}),$(document).on("click",".jsEditQuestion",function(e){e.preventDefault(),e.stopPropagation();e=c($(this).closest(".jsQuestionView").data("id"));r("edit_question"),loadEditQuestionView(e,function(e){var t,i;i=(t=e).question_id,n=n.map(function(e){return e.question_id===i?t:e}),d(),r("basic")})}),window.startTemplateAddProcess=function(){(s=$.msSiteModal()).loader(!0).open(),(async()=>{null!==t&&t.abort(),o={title:"",description:"",category:"",is_recurring:!1,recur_type:"days",recur_number:0,available_date:0};try{var e=await makeSecureCallToApiServer("surveys/templates/view",{method:"GET"});s.setContent(e),$("#jsTemplateTitle").val(o.title),$("#jsTemplateDescription").val(o.description),$("#jsTemplateRecur").prop("checked",o.is_recurring),$("#jsTemplateRecurNumber").val(o.recur_number),$("#jsTemplateRecurType option[value='"+o.recur_type+"']").prop("selected",!0),0==o.is_recurring?$(".jsRecurringSurveyBox").addClass("hidden"):$(",jsRecurringSurveyBox").removeClass("hidden"),d(),s.loader(!1),r("basic"),$("#jsAddQuestionsArea").sortable({stop:function(e){console.log(e);{let e=$("#jsAddQuestionsArea").sortable("toArray",{attribute:"data-id"}),t=[],i="";e.map(function(e){"desc_"===e.substr(0,5)?(question=c(e.replace("desc_","")),t.push(question),i=question.plainDescription):((e=c(e)).tag=i,t.push(e))}),n=t}},onchange:function(e){console.log(e)}})}catch(e){handleErrorResponse(e),s.closeModal()}})()}}),$(function(){let t=null,i,s,o=0,n={title:"",description:"",category:"",is_recurring:!1,recur_type:"days",recur_number:0,available_date:0,questions:[]},d=[];function a(i=!1){if(!d.length)return $("#jsEditQuestionsArea").html('<p class="alert alert-info text-center">No questions found yet.</p>');let s="";d.map(function(e,t){void 0!==e.description||"tag"===e.question_type?(i&&(e.plainDescription=$("<div>").html(e.question_content).text().trim(),e.description=e.question_content,e.slug=getSlug(e.question_content),d[t]=e),s+=getDescriptionPreview(e,!0)):(i&&(e.choice_list=JSON.parse(e.choices_json),e.question_required=e.is_required,d[t]=e),s+=getQuestionPreview(e,"",!0))}),$("#jsEditQuestionsArea").html(s)}function c(t){d=d.filter(function(e){return e.question_id!=t}),a()}function r(t){return d.filter(function(e){return e.question_id==t})[0]}function l(e){console.log("Edit"),$("#sectionMain").addClass("hidden"),$("#sectionAddQuestionBox").addClass("hidden"),$("#sectionEditQuestionBox").addClass("hidden"),$("#sectionEditDescription").addClass("hidden"),$("#jsEditEditDescriptionId").val(""),s.setButtons(""),setTimeout(function(){"basic"===e?($("#sectionMain").removeClass("hidden"),s.setButtons('<button type="button" class="btn btn-orange jsTemplateEditSaveBtn"><i class="fa fa-save"></i>Save Changes</button>')):"add_question"===e?($("#sectionAddQuestionBox").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToEditCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsAddQuestionSaveBtn"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Save Question</button>
                `)):"edit_question"===e?($("#sectionEditQuestionBox").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToEditCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsEditQuestionSaveBtn"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Update Question</button>
                `)):"edit_description"===e?($("#sectionEditDescription").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToEditCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsEditEditDescription"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Save Changes</button>
                `)):"edit_edit_description"===e&&($("#sectionEditDescription").removeClass("hidden"),s.setButtons(`
                    <button type="button" class="btn btn-black jsBackToEditCoursePage"><i class="fa fa-arrow-left" aria-hidden="true"></i>&nbsp;Back</button>
                    <button type="button" class="btn btn-orange jsEditModifyDescription"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Save Changes</button>
                `))},10)}$(document).on("keyup","#jsTemplateEditTitle",function(e){n.title=$(this).val()}),$(document).on("keyup","#jsTemplateEditDescription",function(e){n.description=$(this).val()}),$(document).on("click","#jsTemplateEditRecur",function(e){n.is_recurring=$(this).prop("checked"),n.is_recurring?$(".jsRecurringSurveyBox").removeClass("hidden"):$(".jsRecurringSurveyBox").addClass("hidden")}),$(document).on("keyup","#jsTemplateEditRecurNumber",function(e){n.recur_number=$(this).val()}),$(document).on("change","#jsTemplateEditRecurType",function(e){n.recur_type=$(this).val()}),$(document).on("click",".jsTemplateEditSaveBtn",function(e){e.preventDefault(),n.title?n.is_recurring&&!n.recur_number?_error("Recur number is required."):0===d.length?_error("Please add at least one question."):(n.questions=d,(async()=>{i=callButtonHook($(".jsTemplateEditSaveBtn"),!0);try{var e=await makeSecureCallToApiServer("surveys/templates/"+o,{method:"PUT",headers:{"Content-Type":"application/json"},data:JSON.stringify(n),caches:!1});s.closeModal(),_success(e.message,function(){getTemplates()})}catch(e){handleErrorResponse(e),callButtonHook(i,!1)}})()):_error("Title is required.")}),$(document).on("click",".jsTemplateEditAddQuestion",function(e){e.preventDefault(),l("add_question"),loadAddQuestionView(function(e){e.tag=(()=>{let t="";return d.map(function(e){void 0!==e.description&&(t=e.description)}),t})(),d.push(e),a(),l("basic")})}),$(document).on("click",".jsTemplateEditAddDescription",function(e){e.preventDefault(),l("edit_description"),CKEDITOR.instances.jsEditEditDescription||CKEDITOR.replace("jsEditEditDescription",{toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline"]}]}),CKEDITOR.instances.jsEditEditDescription.setData("")}),$(document).on("click",".jsTemplateEditEditDescription",function(e){e.preventDefault();var e=$(this).closest(".jsQuestionDescription").data("id").replace("desc_",""),t=r(e);console.log(e),console.log(t),l("edit_edit_description"),CKEDITOR.instances.jsEditEditDescription||CKEDITOR.replace("jsEditEditDescription",{toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline"]}]}),CKEDITOR.instances.jsEditEditDescription.setData(t.description),$("#jsEditEditDescriptionId").val(t.question_id)}),$(document).on("click",".jsEditEditDescription",function(e){e.preventDefault();e=CKEDITOR.instances.jsEditEditDescription.getData();e.trim()&&""!==$("<div>").html(e).text().trim()?(d.push({question_id:generateRandomAndUniqueId(),description:e,plainDescription:$("<div>").html(e).text().trim(),slug:getSlug(e),questions:[]}),l("basic"),a()):_error("Description cannot be empty.")}),$(document).on("click",".jsEditModifyDescription",function(e){e.preventDefault();let t=CKEDITOR.instances.jsEditEditDescription.getData(),i=$("#jsEditEditDescriptionId").val();t.trim()&&""!==$("<div>").html(t).text().trim()?(d=d.map(function(e){return e.question_id==i&&(console.log("Found it"),e.description=t,e.plainDescription=$("<div>").html(t).text().trim(),e.slug=getSlug(t)),e}),l("basic"),a()):_error("Description cannot be empty.")}),$(document).on("click",".jsRemoveEditDescription",function(e){e.preventDefault();let t=$(this).closest(".jsQuestionDescription").data("id").replace("desc_","");_confirm("Do you want to delete this question?",function(){c(t)})}),$(document).on("click",".jsBackToEditCoursePage",function(e){e.preventDefault(),l("basic")}),$(document).on("click",".jsRemoveEditQuestion",function(e){e.preventDefault();let t=$(this).closest(".jsQuestionView").data("id");_confirm("Do you want to delete this question?",function(){c(t)})}),$(document).on("click",".jsEditEditQuestion",function(e){e.preventDefault(),e.stopPropagation();e=r($(this).closest(".jsQuestionView").data("id"));l("edit_question"),loadEditQuestionView(e,function(e){var t,i;console.log(e),i=(t=e).question_id,d=d.map(function(e){return e.question_id===i?t:e}),a(),l("basic")})}),window.startTemplateEditProcess=function(e){o=e,(s=$.msSiteModal()).loader(!0).open(),(async()=>{null!==t&&t.abort(),n={title:"",description:"",category:"",is_recurring:!1,recur_type:"days",recur_number:0,available_date:0};try{var e=await makeSecureCallToApiServer("surveys/templates/view/edit/"+o,{method:"GET"});n=e.data,d=n.questions,s.setContent(e.view),$("#jsTemplateEditTitle").val(n.title),$("#jsTemplateEditDescription").val(n.description),$("#jsTemplateEditRecur").prop("checked",n.is_recurring),$("#jsTemplateEditRecurNumber").val(n.recur_number),$("#jsTemplateEditRecurType option[value='"+n.recur_type+"']").prop("selected",!0),n.is_recurring?$(".jsRecurringSurveyBox").removeClass("hidden"):$(".jsRecurringSurveyBox").addClass("hidden"),a(!0),s.loader(!1),l("basic"),$("#jsEditQuestionsArea").sortable({stop:function(e){console.log(e);{let e=$("#jsEditQuestionsArea").sortable("toArray",{attribute:"data-id"}),t=[],i="";e.map(function(e){"desc_"===e.substr(0,5)?(question=r(e.replace("desc_","")),t.push(question),i=question.plainDescription):((e=r(e)).tag=i,t.push(e))}),d=t}},onchange:function(e){console.log(e)}})}catch(e){handleErrorResponse(e),s.closeModal()}})()}}),$(function(){async function i(){$("#jsTemplatesArea").html(`
           <tr>
                <td colspan="4">
                    <div class="alert text-center">
                        <i class="fa fa-spinner fa-spin text-large"></i>
                    </div>
                </td>
            </tr>
        `);var e=await makeSecureCallToApiServer("surveys/templates?keyword="+$(".jsFilterKeyword").val().trim(),{method:"GET"});if(0===e.data.length)return $("#jsTemplatesArea").html(`
            <tr>
                <td colspan="4">
                    <p class="alert alert-info text-center">
                        No templates found.
                    </p>
                </td>
            </tr>
        `);{let t="";(e=e.data).map(function(e){t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t+`<tr class="jsSurveyTemplateRow" data-id="${e.template_sid}">`+' <td class="vam">')+e.title+" </td>")+' <td class="vam">     <button type="button" class="btn btn-link jsPreviewSurveyTemplate">')+`         ${e.number_of_questions} Questions`+"     </button>")+' </td> <td class="vam">')+(e.is_recurring?`Every ${e.recur_number} `+e.recur_type:"-"))+' </td> <td class="vam text-right">')+'     <button type="button" class="btn btn-orange jsPreviewSurveyTemplate">         <i class="fa fa-eye"></i>')+"         Preview     </button>")+'     <button type="button" class="btn btn-warning jsEditSurveyTemplate">         <i class="fa fa-edit"></i>')+"         Edit     </button>")+'     <button type="button" class="btn btn-danger jsDeleteSurveyTemplate">         <i class="fa fa-trash"></i>')+"         Delete     </button>")+" </td></tr>"}),$("#jsTemplatesArea").html(t)}}$(".jsFilterSearchBtn").click(function(e){e.preventDefault(),i()}),$(".jsFilterClearBtn").click(function(e){e.preventDefault(),$(".jsFilterKeyword").val(""),i()}),$(".jsAddSurveyTemplateBtn").click(function(e){e.preventDefault(),startTemplateAddProcess()}),$(document).on("click",".jsPreviewSurveyTemplate",function(){(async e=>{void 0!==s&&s.closeModal(),(s=$.msSiteModal()).setContent("").open(),s.loader(!0);try{(e=>{let t="",i=(e.questions.map(function(e){t+=generateQuestionPreviewView(e,"","preview")}),"");i+=`
            <table class="table table-bordered">
                <tr>
                    <th class="text-small">Title</th>
                    <td class="text-medium">${e.title}</td>
                </tr>
                <tr>
                    <th class="text-small">Description</th>
                    <td class="text-medium">${e.description||"-"}</td>
                </tr>
                <tr>
                    <th class="text-small">Recur</th>
                    <td class="text-medium">${e.is_recurring?`Every ${e.recur_number} `+e.recur_type:"-"}</td>
                </tr>
            </table>
            <hr />
            ${t}
        `,s.setContent(i),s.loader(!1)})((await makeSecureCallToApiServer("surveys/templates/"+e,{method:"GET"})).data)}catch(e){return s.closeModal(),handleErrorResponse(e)}})($(this).closest(".jsSurveyTemplateRow").data("id"))});let s;$(document).on("click",".jsDeleteSurveyTemplate",function(){let t=$(this).closest(".jsSurveyTemplateRow").data("id");_confirm("Do you want to delete this template?",async function(){try{var e=await makeSecureCallToApiServer("surveys/templates/"+t,{method:"DELETE"});_success(e.message,function(){i()})}catch(e){handleErrorResponse(e)}})}),$(document).on("click",".jsEditSurveyTemplate",function(){var e=$(this).closest(".jsSurveyTemplateRow").data("id");startTemplateEditProcess(e)}),(window.getTemplates=i)()});
