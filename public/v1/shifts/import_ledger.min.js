$(function(){function d(e,t){show=void 0===e||!0===e||"show"===e?"show":e,t=void 0===t?"":t,"show"==e?($(".js-loader-text").html(t),$(".js-loader").show()):($(".js-loader-text").html(""),$(".js-loader").fadeOut(150))}$(function(){function r(e){file=e}d("hide"),$("#js-import-form").submit(function(e){e.preventDefault();var e=file.target.result.split(/\n/g),o=e[0].split(","),a=(o=o.map(function(e,t){e=function(e){var t,r,s;for(t=0,r=emailAddressTitles.length,s=emailAddressTitles;t<r;t++)if(e==s[t])return"email_address";for(t=0,r=policyTitles.length,s=policyTitles;t<r;t++)if(e==s[t])return"policy";for(t=0,r=partialTitles.length,s=partialTitles;t<r;t++)if(e==s[t])return"partial_leave";for(t=0,r=partialNoteTitles.length,s=partialNoteTitles;t<r;t++)if(e==s[t])return"partial_leave_note";for(t=0,r=requestedDateTitles.length,s=requestedDateTitles;t<r;t++)if(e==s[t])return"requested_date";for(t=0,r=requestedFromDateTitles.length,s=requestedFromDateTitles;t<r;t++)if(e==s[t])return"requested_from_date";for(t=0,r=requestedToDateTitles.length,s=requestedToDateTitles;t<r;t++)if(e==s[t])return"requested_to_date";for(t=0,r=requestedHoursTiles.length,s=requestedHoursTiles;t<r;t++)if(e==s[t])return"requested_hours";for(t=0,r=requestStatusTitles.length,s=requestStatusTitles;t<r;t++)if(e==s[t])return"status";for(t=0,r=reasonTitles.length,s=reasonTitles;t<r;t++)if(e==s[t])return"reason";for(t=0,r=commentTitles.length,s=commentTitles;t<r;t++)if(e==s[t])return"comment";return-1}(e.toLowerCase().replace(/[^a-z]/g,"").trim());return-1===e?"extra":e}),e.splice(0,1),[]);e.map(function(e){for(var t=e.split(","),r=new Object,s=0,l=t.length;s<l;s++)r[o[s]]=t[s];a.push(r)}),function(e){s.records=[],s.recordsLength=e.length,s.totalChunks=Math.ceil(s.recordsLength/Math.ceil(s.recordsLength/s.chunkSize)),1!=s.totalChunks?s.records=_.chunk(e,s.totalChunks):s.records.push(e);i()}(a)}),$("#userfile").mFileUploader({fileLimit:-1,allowedTypes:["csv"],onSuccess:function(e){var t;$(".js-submit-btn").prop("disabled",!0).addClass("disabled"),0===Object.keys(e).length?alertify.alert("WARNING!","Please, select a file.",()=>{}):!0===e.hasError?alertify.alert("WARNING!","Invalid file is uploaded.",()=>{}):($(".js-submit-btn").removeAttr("disabled").removeClass("disabled"),(t=new FileReader).onload=r,t.readAsText(e))},onError:()=>{$(".js-submit-btn").prop("disabled",!0).addClass("disabled")},onClear:()=>{$(".js-submit-btn").prop("disabled",!0).addClass("disabled")}});var s={current:0,chunkSize:50,loaded:0,records:[],totalChunks:0,recordsLength:0},l=0,o=0,a=0;function i(){var e,t;void 0===s.records[s.current]?console.log("All chunks are being uploaded.."):(e=s.records[s.current],null===n&&(void 0===s.records[s.current]?(d("hide"),alertify.alert("SUCCESS!","You have successfully imported <b>"+o+"</b> new employees, <b>"+a+"</b> employees already exists and <b>"+l+"</b> employees failed to add."),l=a=o=s.loaded=s.current=s.totalChunks=s.recordsLength=0):(s.loaded+=e.length,t="Please, be patient as we import time offs.<br />",d("show",t=(t+="It may take a few minutes<br />")+("Importing "+s.loaded+" of "+s.recordsLength+" employees.")),n=$.post("<?= base_url('timeoff/handler'); ?>",{action:"import",companySid:15708,employeeSid:15717,timeoffs:e},function(e){n=null,!1===e.Status?(alertify.alert("ERROR!","Something went wrong"),d("hide")):(l+=parseInt(e.Failed),a+=parseInt(e.Existed),o+=parseInt(e.Inserted),s.current++,s.current>=s.records.length?(d("hide"),alertify.alert("SUCCESS!","You have successfully imported <b>"+o+"</b> new employees, <b>"+a+"</b> employees already exists and <b>"+l+"</b> employees failed to add.",function(){window.location.reload()}),l=a=o=s.loaded=s.current=s.totalChunks=s.recordsLength=0):setTimeout(function(){i()},1e3))}))))}var n=null})});
