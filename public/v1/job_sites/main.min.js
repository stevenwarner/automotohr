$(function(){let r=null,i=null;const t="jsModalPage",n=t+"Loader",o=t+"Body",a={};let s={};function l(e,a,i,s){Modal({Id:t,Title:e,Body:'<div id="'+o+'"></div>',Loader:n},function(){var e=a,t=i,n=s;null!==r&&r.abort(),r=$.ajax({url:baseUrl("settings/page/"+e+"/"+t),method:"GET"}).always(function(){r=null}).fail(handleErrorResponse).done(function(e){$("#"+o).html(e.view),n(e)})})}function d(e,t,n){if(null===r){const a=callButtonHook(t,!0);r=$.ajax({url:baseUrl(n),method:"POST",data:e,processData:!1,contentType:!1}).always(function(){callButtonHook(a,!1),r=null}).fail(handleErrorResponse).done(function(e){return i?.destroy(),_success(e.msg,function(){window.location.href=baseUrl("settings/job_sites")})})}}function u(){s={};var e={street_1:$('[name="street_1"]').val().trim(),street_2:$('[name="street_2"]').val().trim(),city:$('[name="city"]').val().trim(),state:$('[name="state"] option[value="'+$('[name="state"] option:selected').val()+'"]').text(),zip_code:$('[name="zip_code"]').val().trim(),site_radius:$('[name="site_radius"]').val().trim()};if(e.street_1&&e.city&&e.state&&e.zip_code&&e.site_radius&&5==e.zip_code.length){null!==r&&r.abort();let t=e.street_1;if(e.street_2&&(t+=","+e.street_2),t=(t=(t+=","+e.city)+(","+e.state))+(","+e.zip_code)+", USA",t=encodeURI(t),a[t])return s=a[t],$("#job_site_map").mapMarker({center:a[t],radius:parseInt($('[name="site_radius"]').val().trim()),draggable:!0,onDragEnd:function(e){s=e}});r=$.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json?address="+t+"&key=AIzaSyAbODx02cE7VVn-ufkpSO9HwUoXfgXTCng",method:"GET",cache:!0}).always(function(){r=null}).done(function(e){e.results[0]&&(e=e.results[0].geometry.location,a[t]={lat:e.lat,lng:e.lng},s=e,$("#job_site_map").mapMarker({center:e,radius:parseInt($('[name="site_radius"]').val().trim()),draggable:!0,onDragEnd:function(e){s=e}}))})}else $("#job_site_map").html('<p class="alert alert-danger">Please select the address first</p>')}$(".jsAddJobSiteBtn").click(function(e){e.preventDefault(),s={},l("New Job Site","job_site",0,function(){ml(!1,n),i=$("#jsPageJobSiteForm").validate({rules:{site_name:{required:!0},street_1:{required:!0},city:{required:!0},state:{required:!0},zip_code:{required:!0,digits:!0,minlength:5,maxlength:5},site_radius:{required:!0,digits:!0}},errorPlacement:function(e,t){($(t).parent().hasClass("input-group")?$(t).parent():$(t)).after(e)},submitHandler:function(e){return s.lat&&s.lng?((e=formArrayToObj($(e).serializeArray())).append("lat",s.lat),e.append("lng",s.lng),d(e,$(".jsPageJobSiteBtn"),"settings/job_sites")):i.showErrors({site_radius:"Address latitude and longitude are missing."})}})})}),$(".jsEditJobSiteBtn").click(function(e){e.preventDefault();const t=$(this).closest(".jsBox").data("id");s={},l("Edit Job Site","job_site",t,function(e){ml(!1,n),u(),i=$("#jsPageJobSiteForm").validate({rules:{site_name:{required:!0},street_1:{required:!0},city:{required:!0},state:{required:!0},zip_code:{required:!0,digits:!0,minlength:5,maxlength:5},site_radius:{required:!0,digits:!0}},errorPlacement:function(e,t){($(t).parent().hasClass("input-group")?$(t).parent():$(t)).after(e)},submitHandler:function(e){return s.lat&&s.lng?((e=formArrayToObj($(e).serializeArray())).append("id",t),e.append("lat",s.lat),e.append("lng",s.lng),d(e,$(".jsPageJobSiteBtn"),"settings/job_sites")):i.showErrors({site_radius:"Address latitude and longitude are missing."})}}),$("#job_site_map").mapMarker({center:{lat:e.data.lat,lng:e.data.lng},radius:parseInt($('[name="site_radius"]').val().trim()),draggable:!0,onDragEnd:function(e){s=e}})})}),$(".jsDeleteJobSiteBtn").click(function(e){e.preventDefault();const a=$(this).closest(".jsBox"),i=a.data("id");return _confirm("Are you sure you want to delete it? This action cannot be undone.",function(){var e=a,t=i;if(null===r){const n=callButtonHook(e.find(".jsDeleteShiftTemplateBtn"),!0);r=$.ajax({url:baseUrl("settings/job_sites/"+t),method:"DELETE"}).always(function(){callButtonHook(n,!1),r=null}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.href=baseUrl("settings/job_sites")})})}})}),$(document).on("keyup",'[name="street_1"]',u),$(document).on("keyup",'[name="street_2"]',u),$(document).on("keyup",'[name="city"]',u),$(document).on("keyup",'[name="zip_code"]',u),$(document).on("keyup",'[name="site_radius"]',u),$(document).on("change",'[name="state"]',u)});
