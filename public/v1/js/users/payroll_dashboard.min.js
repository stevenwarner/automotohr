$(function(){let o=null;const t="jsModalPage",l=t+"Loader",s=t+"Body";function a(e,a,n){Modal({Id:t,Title:e,Body:'<div id="'+s+'"></div>',Loader:l},function(){var e=a,t=n;null!==o&&o.abort(),o=$.ajax({url:baseUrl("payrolls/page/"+e+"/"+profileUserInfo.userId+"/"+profileUserInfo.userType),method:"GET"}).always(function(){o=null}).fail(handleErrorResponse).done(function(e){$("#"+s).html(e.view),t(e)})})}$("#jsStartDate").daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoApply:!0,locale:{format:"MM/DD/YYYY"}}),$("#jsEndDate").daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoApply:!0,locale:{format:"MM/DD/YYYY"}}),$(document).on("click",".jsApplyFilter",function(e){var t=$("#jsStartDate").val(),a=$("#jsEndDate").val(),n=t.split("/"),o=a.split("/");if((t=n[0]+"-"+n[2])!=(a=o[0]+"-"+o[2]))return(n=[]).push("Please select start date or end date within the same month."),alertify.alert("ERROR",getErrorsStringFromArray(n),CB);window.location.href=window.location.origin+"/payrolls/dashboard/"+profileUserInfo.userType+"/"+profileUserInfo.userId+"?start="+$("#jsStartDate").val()+"&end="+$("#jsEndDate").val()}),$(document).on("click",".jsAdjustForMinimumWage",function(e){$(this).is(":checked")?$(".jsMinimumWagesBox").removeClass("hidden"):($(".jsMinimumWagesBox").addClass("hidden"),$(".jsMinimumWages").select2("val",""))}),$(".jsEditPaySchedule").click(function(e){e.preventDefault(),a(profileUserInfo.nameWithRole,"pay_schedule",function(){ml(!1,l),$("#jsPagePayScheduleForm").validate({rules:{pay_schedule:{required:!0}},messages:{pay_schedule:{required:"Please select a pay schedule."}},submitHandler:function(e){var e=formArrayToObj($(e).serializeArray()),t=(e.append("page","pay_schedule"),e.append("userId",profileUserInfo.userId),e.append("userType",profileUserInfo.userType),$(".jsPagePayScheduleBtn"));if(null===o){const a=callButtonHook(t,!0);o=$.ajax({url:baseUrl("payrolls/page/update"),method:"POST",data:e,processData:!1,contentType:!1}).always(function(){callButtonHook(a,!1),o=null}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.href=baseUrl("payrolls/dashboard/"+profileUserInfo.userType+"/"+profileUserInfo.userId)})})}}})})}),$(document).on("click",".jsPagePayScheduleBtn",function(e){e.preventDefault();var e={employeeType:$(".jsEmploymentType option:selected").val(),classification:$(".jsFLSAStatus option:selected").val().trim(),per:$(".jsPayType option:selected").val().trim(),hireDate:$(".jsHireDate").val().trim(),overTimeRule:$(".jsOvertimeRule option:selected").val().trim(),amount:$(".jsEmployeeRate").val().trim(),minimumWage:"on"==$('input[name="adjust_for_minimum_wage"]:checked').val()?1:0,wagesId:$(".jsMinimumWages").select2("val"),guaranteeRate:$(".jsEmployeeGuaranteeRate").val().trim(),guaranteePer:$(".jsEmployeeGuaranteePayType option:selected").val().trim(),guaranteeTime:$(".jsEmployeeGuaranteeTimes").val().trim()},t=[];if(e.employeeType||t.push('"Employment type" is missing.'),e.classification||t.push('"FLSA status" is missing.'),e.per||t.push('"Pay type" is missing.'),e.hireDate||t.push('"Hire date" is missing.'),e.amount||t.push('"Rate" is missing.'),e.overTimeRule||t.push('"Overtime rule" is missing.'),!e.guaranteeRate||e.guaranteeTime||t.push('"Guarantee time" is missing.'),t.length)return alertify.alert("ERROR",getErrorsStringFromArray(t),CB);ml(!0,l),o=$.ajax({url:window.location.origin+"/payrolls/employee_job_compensation/"+profileUserInfo.userId+"/"+profileUserInfo.userType,method:"POST",data:e}).always(function(){ml(!1,l),o=null}).fail(function(e){return console.log(),alertify.alert("ERROR",getErrorsStringFromArray(e.responseJSON.errors))}).done(function(e){return alertify.alert("SUCCESS",e.msg,function(){window.location.reload()})})}),$(".jsEditJobWage").click(function(e){e.preventDefault(),a(profileUserInfo.nameWithRole,"job_and_wage",function(){ml(!1,l),$(".jsMinimumWages").select2({closeOnSelect:!1}),$(".jsHireDate").daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoApply:!0,locale:{format:"MM/DD/YYYY"}})})}),$(".jsEditCustomEarning").click(function(e){e.preventDefault(),a(profileUserInfo.nameWithRole,"employee_custom_earnings",function(){ml(!1,l)})}),$(document).on("click",".jsCheckAll",function(){$(".jsStoreCourseRow").find('input[name="earningIds[]"]').prop("checked",$(this).prop("checked"))}),$(document).on("click",".jsAssignEarning",function(){$(".jsCheckAll").prop("checked",$(".jsAssignEarning").length==$(".jsAssignEarning:checked").length)}),$(document).on("click",".jsPageEarningTypeBtn",function(e){if(e.preventDefault(),processData=function(){var t=[],a=[];var e={};return $.each($('input[name="earningIds[]"]:checked'),function(){var e={};e.sid=parseInt($(this).val()),e.title=$(this).closest("tr").find("td.jsEarningTitle").text(),e.wageType=$(this).closest("tr").find("td.jsWageType").text(),e.rateType=$(this).closest("tr").find("td.jsRateType").text(),e.rate=$(this).closest("tr").find("td.jsRate input").val(),0==e.rate&&a.push('Please add rate for earning type"'+e.title+'".'),t.push(e)}),e.selectedEarnings=t,e.errors=a,e}(),console.log(processData),0===processData.selectedEarnings.length)return alertify.alert("ERROR!","Please select at least one earning to start the process.");if(processData.errors.length)return alertify.alert("ERROR!",getErrorsStringFromArray(processData.errors),CB);ml(!0,l),o=$.ajax({url:window.location.origin+"/payrolls/employee_earning_types/"+profileUserInfo.userId+"/"+profileUserInfo.userType,method:"POST",data:{employeeEarnings:processData.selectedEarnings}}).always(function(){ml(!1,l),o=null}).fail(function(e){return alertify.alert("ERROR",e.msg)}).done(function(e){return alertify.alert("SUCCESS",e.msg,function(){window.location.reload()})})})}),$(function(){let l=null,s={};function t(){Modal({Id:"jsTimeSheetModal",Loader:"jsTimeSheetModalLoader",Title:0===s.id?"Add":"Edit time sheet for "+moment(s.date).format("MM/DD/Y"),Body:'<div id="jsTimeSheetModalBody"></div>'},e)}function e(){null!==l&&l.abort(),l=$.ajax({url:baseUrl("v1/clock/timesheet/"+s.id+"/"+s.date),method:"get"}).always(function(){l=null}).fail(handleErrorResponse).done(function(e){$("#jsTimeSheetModalBody").html(e.view),ml(!1,"jsTimeSheetModalLoader"),$("#jsManageTimeSheetForm").validate({submitHandler:function(e){const t=[];$(".jsEventRow").length&&$(".jsEventRow").map(function(){var e={id:$(this).data("id")};e.startTime=$(this).find(`[name="start_time_${e.id}"]`).val(),e.eventType=$(this).find(`[name="event_type_${e.id}"] option:selected`).val(),e.endTime=$(this).find(`[name="end_time_${e.id}"]`).val(),e.employeeId=profileUserInfo.userId,t.push(e)});var a,n,o=callButtonHook($(".jsManageTimeSheetBtn"),!0,!0);a=t,n=o,null===l&&$.ajax({url:baseUrl("v1/clock/timesheet/"+s.id+"/"+s.date),method:"post",data:{logs:a}}).always(function(){l=null,callButtonHook(n,!1)}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.reload()})})}}),$(".jsEventRow").length&&$(".jsEventRow").map(function(){var e=$(this).data("id");$(`[name="event_type_${e}"]`).rules("add",{required:!0}),$(`[name="start_time_${e}"]`).rules("add",{required:!0}),$(`[name="end_time_${e}"]`).rules("add",{required:!0})}),$(".jsAddEventRow").click(function(e){var t;e.preventDefault(),e=getRandomCode(),t=`
        <div class="row jsEventRow" data-id="${e}">
            <br>
            <div class="col-sm-3">
                <label>Event type</label>
                <select name="event_type_${e}" class="form-control">
                    <option value="clocked_in_out">
                        Clock in/out
                    </option>
                    <option value="break_in_out">
                        Break start/end
                    </option>
                </select>
            </div>
            <div class="col-sm-3">
                <label>Start time</label>
                <input type="text" name="start_time_${e}" class="form-control jsTimeField" />
            </div>
            <div class="col-sm-3">
                <label>End time</label>
                <input type="text" name="end_time_${e}" class="form-control jsTimeField" />
            </div>
			<div class="col-sm-3">
				<label><br /></label>
				<button class="btn btn-red jsDeleteEventRow" type="button">
					<i class="fa fa-trash"></i>
				</button>
			</div>
        `,t+="</div>",$("#jsTimeSheetModalBody .panel-body").append(t),$(`[name="event_type_${e}"]`).rules("add",{required:!0}),$(`[name="start_time_${e}"]`).rules("add",{required:!0}),$(`[name="end_time_${e}"]`).rules("add",{required:!0}),a()}),$(document).on("click",".jsDeleteEventRow",function(e){e.preventDefault();const a=$(this).closest(".row").data("id");return _confirm("Do you want to delete the selected event row? It is not revertible.",function(){var t;t=a,$.ajax({url:baseUrl("v1/clock/timesheet/log/"+t),method:"delete"}).fail(handleErrorResponse).done(function(e){$(`.jsEventRow[data-id="${t}"]`).remove()})})}),a()})}function a(){$(".jsTimeField").timepicker({timeFormat:"h:mm p",dynamic:!1,dropdown:!1,scrollbar:!1})}function n(e){if(0===$(".jsSingleSelect:checked").length)return _success("Please select at least one employee.");const t=[];if($(".jsSingleSelect:checked").map(function(){t.push($(this).val())}),null===l){const a=callButtonHook(1==e?$(".jsApproveTimeSheet"):$(".jsUnApproveTimeSheet"),!0);$.ajax({url:baseUrl("v1/clock/timesheet/status"),method:"post",data:{ids:t,status:e}}).always(function(){l=null,callButtonHook(a,!1)}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.reload()})})}}function i(e){var t=new google.maps.Marker(e);e.markers.push(t),e.coords.push({lat:e.position.lat,lng:e.position.lng})}$(".jsEditTimeSheet").click(function(e){e.preventDefault(),s=$(this).closest("tr").data(),t()}),$(".jsAddTimeSheet").click(function(e){e.preventDefault(),(s=$(this).closest("tr").data()).id=0,t()}),$(".jsViewTimeSheet").click(function(e){var t;e.preventDefault(),t=$(this).closest("tr").data(),Modal({Id:"jsTimeSheetHistoryModal",Loader:"jsTimeSheetHistoryModalLoader",Title:"History for "+moment(t.date).format("MM/DD/Y"),Body:'<div id="jsTimeSheetHistoryModalBody"></div>'},function(){var e=t;null!==l&&l.abort(),l=$.ajax({url:baseUrl("v1/clock/timesheet/history/"+e.id),method:"get"}).always(function(){l=null}).fail(handleErrorResponse).done(function(e){$("#jsTimeSheetHistoryModalBody").html(e.view),null!=e.locations&&0<e.locations.length&&e.locations.forEach(e=>{var t=e.target,a=[],n=[],o=[],l=(e.lat=parseFloat(e.lat),e.lng=parseFloat(e.lng),e.lat_2&&!isNaN(e.lat_2)&&(e.lat_2=parseFloat(e.lat_2),e.lng_2=parseFloat(e.lng_2)),t=new google.maps.Map(document.getElementById(t),{center:{lat:e.lat,lng:e.lng},mapTypeId:google.maps.MapTypeId.ROADMAP}),i({markers:a,coords:n,map:t,position:{lat:e.lat,lng:e.lng},title:e.title}),o.push(new google.maps.LatLng(e.lat,e.lng)),e.lat_2&&!isNaN(e.lat_2)&&(i({markers:a,coords:n,map:t,position:{lat:e.lat_2,lng:e.lng_2},title:e.title}),o.push(new google.maps.LatLng(e.lat_2,e.lng_2)),new google.maps.Polyline({path:n,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}).setMap(t)),new google.maps.LatLngBounds);for(let e=0;e<o.length;e++)l.extend(o[e]);t.fitBounds(l),google.maps.event.trigger(t,"resize")}),ml(!1,"jsTimeSheetHistoryModalLoader")})})}),$(".jsSelectAll").click(function(){$(".jsSingleSelect").prop("checked",$(".jsSelectAll").prop("checked"))}),$(".jsSingleSelect").click(function(){$(".jsSelectAll").prop("checked",$(".jsSingleSelect:checked").length===$(".jsSingleSelect").length)}),$(".jsApproveTimeSheet").click(function(e){e.preventDefault(),n(1)}),$(".jsUnApproveTimeSheet").click(function(e){e.preventDefault(),n(0)}),$(document).on("click",".jsToggleMapView",function(e){e.preventDefault();e=$(this).data("id");$(".mapRow"+e).toggleClass("hidden")})});
