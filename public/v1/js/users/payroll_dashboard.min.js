$(function(){let l=null;const t="jsModalPage",n=t+"Loader",i=t+"Body";function a(e,a,o){Modal({Id:t,Title:e,Body:'<div id="'+i+'"></div>',Loader:n},function(){var e=a,t=o;null!==l&&l.abort(),l=$.ajax({url:baseUrl("payrolls/page/"+e+"/"+profileUserInfo.userId+"/"+profileUserInfo.userType),method:"GET"}).always(function(){l=null}).fail(handleErrorResponse).done(function(e){$("#"+i).html(e.view),t(e)})})}$(document).on("click",".jsAdjustForMinimumWage",function(e){$(this).is(":checked")?$(".jsMinimumWagesBox").removeClass("hidden"):($(".jsMinimumWagesBox").addClass("hidden"),$(".jsMinimumWages").select2("val",""))}),$(".jsEditPaySchedule").click(function(e){e.preventDefault(),a(profileUserInfo.nameWithRole,"pay_schedule",function(){ml(!1,n),$("#jsPagePayScheduleForm").validate({rules:{pay_schedule:{required:!0}},messages:{pay_schedule:{required:"Please select a pay schedule."}},submitHandler:function(e){var e=formArrayToObj($(e).serializeArray()),t=(e.append("page","pay_schedule"),e.append("userId",profileUserInfo.userId),e.append("userType",profileUserInfo.userType),$(".jsPagePayScheduleBtn"));if(null===l){const a=callButtonHook(t,!0);l=$.ajax({url:baseUrl("payrolls/page/update"),method:"POST",data:e,processData:!1,contentType:!1}).always(function(){callButtonHook(a,!1),l=null}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.href=baseUrl("payrolls/dashboard/"+profileUserInfo.userType+"/"+profileUserInfo.userId)})})}}})})}),$(document).on("click",".jsPagePayScheduleBtn",function(e){e.preventDefault();var e={employeeType:$(".jsEmploymentType option:selected").val(),classification:$(".jsFLSAStatus option:selected").val().trim(),per:$(".jsPayType option:selected").val().trim(),hireDate:$(".jsHireDate").val().trim(),overTimeRule:$(".jsOvertimeRule option:selected").val().trim(),amount:$(".jsEmployeeRate").val().trim(),minimumWage:"on"==$('input[name="adjust_for_minimum_wage"]:checked').val()?1:0,wagesId:$(".jsMinimumWages").select2("val"),guaranteeRate:$(".jsEmployeeGuaranteeRate").val().trim(),guaranteePer:$(".jsEmployeeGuaranteePayType option:selected").val().trim(),guaranteeTime:$(".jsEmployeeGuaranteeTimes").val().trim()},t=[];if(e.employeeType||t.push('"Employment type" is missing.'),e.classification||t.push('"FLSA status" is missing.'),e.per||t.push('"Pay type" is missing.'),e.hireDate||t.push('"Hire date" is missing.'),e.amount||t.push('"Rate" is missing.'),e.overTimeRule||t.push('"Overtime rule" is missing.'),!e.guaranteeRate||e.guaranteeTime||t.push('"Guarantee time" is missing.'),t.length)return alertify.alert("ERROR",getErrorsStringFromArray(t),CB);ml(!0,n),l=$.ajax({url:window.location.origin+"/payrolls/employee_job_compensation/"+profileUserInfo.userId+"/"+profileUserInfo.userType,method:"POST",data:e}).always(function(){ml(!1,n),l=null}).fail(function(e){return console.log(),alertify.alert("ERROR",getErrorsStringFromArray(e.responseJSON.errors))}).done(function(e){return alertify.alert("SUCCESS",e.msg)})}),$(".jsEditJobWage").click(function(e){e.preventDefault(),a(profileUserInfo.nameWithRole,"job_and_wage",function(){ml(!1,n),$(".jsMinimumWages").select2({closeOnSelect:!1}),$(".jsHireDate").daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoApply:!0,locale:{format:"MM/DD/YYYY"}})})})}),$(function(){let n=null,i={};function t(){Modal({Id:"jsTimeSheetModal",Loader:"jsTimeSheetModalLoader",Title:0===i.id?"Add":"Edit time sheet for "+moment(i.date).format("MM/DD/Y"),Body:'<div id="jsTimeSheetModalBody"></div>'},e)}function e(){null!==n&&n.abort(),n=$.ajax({url:baseUrl("v1/clock/timesheet/"+i.id+"/"+i.date),method:"get"}).always(function(){n=null}).fail(handleErrorResponse).done(function(e){$("#jsTimeSheetModalBody").html(e.view),ml(!1,"jsTimeSheetModalLoader"),$("#jsManageTimeSheetForm").validate({submitHandler:function(e){const t=[];$(".jsEventRow").length&&$(".jsEventRow").map(function(){var e={id:$(this).data("id")};e.startTime=$(this).find(`[name="start_time_${e.id}"]`).val(),e.eventType=$(this).find(`[name="event_type_${e.id}"] option:selected`).val(),e.endTime=$(this).find(`[name="end_time_${e.id}"]`).val(),e.employeeId=profileUserInfo.userId,t.push(e)});var a,o,l=callButtonHook($(".jsManageTimeSheetBtn"),!0,!0);a=t,o=l,null===n&&$.ajax({url:baseUrl("v1/clock/timesheet/"+i.id+"/"+i.date),method:"post",data:{logs:a}}).always(function(){n=null,callButtonHook(o,!1)}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.reload()})})}}),$(".jsEventRow").length&&$(".jsEventRow").map(function(){var e=$(this).data("id");$(`[name="event_type_${e}"]`).rules("add",{required:!0}),$(`[name="start_time_${e}"]`).rules("add",{required:!0}),$(`[name="end_time_${e}"]`).rules("add",{required:!0})}),$(".jsAddEventRow").click(function(e){var t;e.preventDefault(),e=getRandomCode(),t=`
        <div class="row jsEventRow" data-id="${e}">
            <br>
            <div class="col-sm-3">
                <label>Event type</label>
                <select name="event_type_${e}" class="form-control">
                    <option value="clocked_in_out">
                        Clock in/out
                    </option>
                    <option value="clocked_in_out">
                        Break start/end
                    </option>
                </select>
            </div>
            <div class="col-sm-3">
                <label>Start time</label>
                <input type="text" name="start_time_${e}" class="form-control jsTimeField" />
            </div>
            <div class="col-sm-3">
                <label>End time</label>
                <input type="text" name="end_time_${e}" class="form-control jsTimeField" />
            </div>
			<div class="col-sm-3">
				<label><br /></label>
				<button class="btn btn-red jsDeleteEventRow" type="button">
					<i class="fa fa-trash"></i>
				</button>
			</div>
        `,t+="</div>",$("#jsTimeSheetModalBody .panel-body").append(t),$(`[name="event_type_${e}"]`).rules("add",{required:!0}),$(`[name="start_time_${e}"]`).rules("add",{required:!0}),$(`[name="end_time_${e}"]`).rules("add",{required:!0}),a()}),$(document).on("click",".jsDeleteEventRow",function(e){e.preventDefault();const a=$(this).closest(".row").data("id");return _confirm("Do you want to delete the selected event row? It is not revertible.",function(){var t;t=a,$.ajax({url:baseUrl("v1/clock/timesheet/log/"+t),method:"delete"}).fail(handleErrorResponse).done(function(e){$(`.jsEventRow[data-id="${t}"]`).remove()})})}),a()})}function a(){$(".jsTimeField").timepicker({timeFormat:"h:mm p",dynamic:!1,dropdown:!1,scrollbar:!1})}function o(e){if(0===$(".jsSingleSelect:checked").length)return _success("Please select at least one employee.");const t=[];if($(".jsSingleSelect:checked").map(function(){t.push($(this).val())}),null===n){const a=callButtonHook(1==e?$(".jsApproveTimeSheet"):$(".jsUnApproveTimeSheet"),!0);$.ajax({url:baseUrl("v1/clock/timesheet/status"),method:"post",data:{ids:t,status:e}}).always(function(){n=null,callButtonHook(a,!1)}).fail(handleErrorResponse).done(function(e){return _success(e.msg,function(){window.location.reload()})})}}function s(e){var t=new google.maps.Marker(e);e.markers.push(t),e.coords.push({lat:e.position.lat,lng:e.position.lng})}$(".jsEditTimeSheet").click(function(e){e.preventDefault(),i=$(this).closest("tr").data(),t()}),$(".jsAddTimeSheet").click(function(e){e.preventDefault(),(i=$(this).closest("tr").data()).id=0,t()}),$(".jsViewTimeSheet").click(function(e){var t;e.preventDefault(),t=$(this).closest("tr").data(),Modal({Id:"jsTimeSheetHistoryModal",Loader:"jsTimeSheetHistoryModalLoader",Title:"History for "+moment(t.date).format("MM/DD/Y"),Body:'<div id="jsTimeSheetHistoryModalBody"></div>'},function(){var e=t;null!==n&&n.abort(),n=$.ajax({url:baseUrl("v1/clock/timesheet/history/"+e.id),method:"get"}).always(function(){n=null}).fail(handleErrorResponse).done(function(e){$("#jsTimeSheetHistoryModalBody").html(e.view),e.locations.length&&e.locations.forEach(e=>{var t=e.target,a=[],o=[],l=[],n=(e.lat=parseFloat(e.lat),e.lng=parseFloat(e.lng),e.lat_2&&!isNaN(e.lat_2)&&(e.lat_2=parseFloat(e.lat_2),e.lng_2=parseFloat(e.lng_2)),t=new google.maps.Map(document.getElementById(t),{center:{lat:e.lat,lng:e.lng},mapTypeId:google.maps.MapTypeId.ROADMAP}),s({markers:a,coords:o,map:t,position:{lat:e.lat,lng:e.lng},title:e.title}),l.push(new google.maps.LatLng(e.lat,e.lng)),e.lat_2&&!isNaN(e.lat_2)&&(s({markers:a,coords:o,map:t,position:{lat:e.lat_2,lng:e.lng_2},title:e.title}),l.push(new google.maps.LatLng(e.lat_2,e.lng_2)),new google.maps.Polyline({path:o,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}).setMap(t)),new google.maps.LatLngBounds);for(let e=0;e<l.length;e++)n.extend(l[e]);t.fitBounds(n),google.maps.event.trigger(t,"resize")}),ml(!1,"jsTimeSheetHistoryModalLoader")})})}),$(".jsSelectAll").click(function(){$(".jsSingleSelect").prop("checked",$(".jsSelectAll").prop("checked"))}),$(".jsSingleSelect").click(function(){$(".jsSelectAll").prop("checked",$(".jsSingleSelect:checked").length===$(".jsSingleSelect").length)}),$(".jsApproveTimeSheet").click(function(e){e.preventDefault(),o(1)}),$(".jsUnApproveTimeSheet").click(function(e){e.preventDefault(),o(0)}),$(document).on("click",".jsToggleMapView",function(e){e.preventDefault();e=$(this).data("id");$(".mapRow"+e).toggleClass("hidden")})});
