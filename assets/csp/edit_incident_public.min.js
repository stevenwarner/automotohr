$(function(){function e(){let e=`\n        <div class="row" data-external="${u}">\n            <div class="col-md-5">\n                <div class="form-group">\n                    <label for="external_employee_name">Name</label>\n                    <input type="text" name="external_employees_names[${u}]['name']" class="form-control" required>\n                </div>\n            </div>\n            <div class="col-md-5">\n                <div class="form-group">\n                    <label for="external_employee_email">Email</label>\n                    <input type="email" name="external_employees_emails[${u}]['email']" class="form-control" required>\n                </div>\n            </div>\n            <div class="col-md-1">\n                <div class="form-group">\n                    <label>&nbsp;</label>\n                    <button type="button" class="btn btn-red btn-block jsRemoveExternalEmployee">\n                        <i class="fa fa-trash"></i>\n                    </button>\n                </div>\n            </div>\n        </div>\n        `;return u++,$(".jsAddExternalBody").append(e),$(`input[name="external_employees[${u-1}]['name']"]`).rules("add",{required:!0,messages:{required:"Please enter the name"}}),$(`input[name="external_employees[${u-1}]['email']"]`).rules("add",{required:!0,email:!0,messages:{required:"Please enter the email",email:"Please enter a valid email address"}}),e}function t(e){_confirm("Are you sure you want to remove this external employee? It will be removed from this report permanently as well.",function(){r(e)})}function a(e){null===p&&(ml(!0,"jsPageLoader"),p=$.ajax({url:baseUrl("csp/report/"+m(2)+"/incident/edit/"+m(5)),method:"POST",data:$(e).serializeArray()}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}function n(e){null===p&&(ml(!0,"jsPageLoader"),p=$.ajax({url:baseUrl("csp/notes/"+m(2)+"/"+m(5)),method:"POST",data:e}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}function i(e,t,a){$.ajax({url:baseUrl("csp/get_item_attachment_view"),method:"GET"}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(n){$("#jsFileAttachModalBody").html(n.view),$("#jsItemId").val(e),$("#jsReportId").val(t),$("#jsIncidentId").val(a),$("#jsItemDocuments").msFileUploader(f.document),ml(!1,"jsFileAttachModalLoader")})}async function l(e,t,a){if(null===p){ml(!0,"jsPageLoader");var n=$("#jsItemId").val(),i=$("#jsReportId").val(),l=$("#jsIncidentId").val();const o=new FormData;o.append("title",t),o.append("type",a),o.append("itemId",n),o.append("reportId",i),o.append("incidentId",l),"youtube"===e.type||"vimeo"===e.type?o.append("link",e.link):o.append("file",e),p=$.ajax({url:baseUrl("csp/add_file_to_incident_item"),method:"POST",async:!0,cache:!1,contentType:!1,processData:!1,data:o}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){alertify.alert("You have successfully upload the file",function(){window.location.refresh()})})}}function o(e){$.ajax({url:baseUrl("csp/file/view/"+e),method:"GET"}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsFileViewModalBody").html(e.view),$("#jsFileViewModalTitle").html(e.data.title),ml(!1,"jsFileViewModalLoader")})}function r(e){null===p&&(ml(!0,"jsPageLoader"),p=$.ajax({url:baseUrl("csp/"+m(2)+"/"+m(5)+"/"+e.data("id")),method:"DELETE"}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(t){_success(t.message,function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),u--,0==u&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}))}async function s(e,t,a){if(null===p){ml(!0,"jsPageLoader");const n=new FormData;n.append("title",t),n.append("type",a),"youtube"===e.type||"vimeo"===e.type?n.append("link",e.link):n.append("file",e),p=$.ajax({url:baseUrl("csp/file/"+m(2)+"/"+m(5)+"/"+a),method:"POST",async:!0,cache:!1,contentType:!1,processData:!1,data:n}).always(function(){p=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){$("#document_title").val(""),$("#report_documents").msFileUploader("clear"),"link"===a||"audio"===a||"video"===a?0!=$(".jsAudioArea").find(".jsFirst").length?$(".jsAudioArea").find(".jsFirst").append(e.view):$(".jsAudioArea").html(`<div class="row jsFirst">${e.view}</div>`):0!=$(".jsDocumentsArea").find(".jsFirst").length?$(".jsDocumentsArea").find(".jsFirst").append(e.view):$(".jsDocumentsArea").html(`<div class="row jsFirst">${e.view}</div>`)})})}}function d(e){if(!e)return"Unknown";const t=e.name.toLowerCase(),a=e.type;let n="file";return a.startsWith("audio/")?n="audio":a.startsWith("video/")?n="video":a.startsWith("image/")?n="image":a.startsWith("application/")&&("application/pdf"===a||a.startsWith("application/msword")||"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===a)&&(n="document"),"file"===n&&(t.match(/\.(pdf|doc|docx|txt|xls|xlsx|ppt|pptx)$/)?n="document":t.match(/\.(mp3|wav|ogg|flac|aac|m4a)$/)?n="audio":t.match(/\.(mp4|mkv|avi|mov|wmv|flv|webm)$/)&&(n="video")),n}function c(e){p=$.ajax({url:baseUrl("csp/report/"+m(2)+"/incident/"+m(5)+"/items/employees"),method:"POST",data:e}).always(function(){p=null}).fail(handleErrorResponse).done(function(e){})}function m(e){return 2===e?segments.reportId:segments.incidentId}let u=$(".jsAddExternalBody .jsEER").length,p=null;const f={document:{allowedTypes:["jpg","jpeg","png","gif","webp","rtf","pdf","doc","docx","pptx","ppt","xls","xlsx","csv","mov","mp4","webm","wav","mp3"],fileLimit:"200mb",allowLinks:!0}};$("#report_documents").msFileUploader(f.document),0!=u&&$(".jsAddExternalBody .jsEER").each(function(e){$(`input[name="external_employees[${e}]['name']"]`).rules("add",{required:!0,messages:{required:"Please enter the name"}}),$(`input[name="external_employees[${e}]['email']"]`).rules("add",{required:!0,email:!0,messages:{required:"Please enter the email",email:"Please enter a valid email address"}})}),$("#report_status").select2({minimumResultsForSearch:-1}),$("#report_note_type").select2({minimumResultsForSearch:-1}),$("#jsReportIncidentType").select2({minimumResultsForSearch:-1}),CKEDITOR.replace("report_note"),$("#report_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$("#report_completion_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$(".start_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$("#jsAddReportForm").validate({rules:{},messages:{},submitHandler:function(e){a(e)}}),$(".jsAddExternalEmployee").click(function(t){t.preventDefault(),$(".jsAddExternalBody .alert").remove(),e()}),$(document).on("click",".jsRemoveExternalEmployee",function(){const e=$(this).closest(".row");if(e.data("id"))return t(e);alertify.confirm("Are you sure you want to remove this external employee?",function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),u--,0==u&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}),$(".jsAddNote").click(function(e){e.preventDefault();const t={type:$("#report_note_type").val(),content:CKEDITOR.instances.report_note.getData()};""!==t.content.trim()?n(t):_error("Please enter a note.")}),$(".jsAddDocument").click(function(e){e.preventDefault();const t={title:$("#document_title").val(),file:$("#report_documents").msFileUploader("get")};if(""===t.title.trim())return void _error("Please enter a file title.");if(!t.file)return void _error("Please select a file.");if(0===Object.keys(t.file).length)return void _error("Please select a file.");if(t.file.hasError&&"vimeo"===t.file.type)return void _error("Vimeo link is invalid.");if(t.file.hasError&&"youtube"===t.file.type)return void _error("YouTube link is invalid.");if(t.file.hasError)return void _error(t.file.errorCode);let a="vimeo"===t.file.type||"youtube"===t.file.type?"link":d(t.file).toLowerCase();s(t.file,t.title,a)}),$(document).on("click",".jsViewFile",function(e){e.preventDefault();const t=$(this).closest(".jsFileBox").data("id");Modal({Id:"jsFileViewModal",Loader:"jsFileViewModalLoader",Title:'<span id="jsFileViewModalTitle"></span>',Body:'<div id="jsFileViewModalBody"></body>'},function(){o(t)})}),$(document).on("click",".jsCSPItemAttachmentBtn",function(e){e.preventDefault();const t=$(this).data("item_id"),a=$(this).data("report_id"),n=$(this).data("incident_id");Modal({Id:"FileAttachModal",Loader:"jsFileAttachModalLoader",Title:"<span>Upload Item Attachment</span>",Body:'<div id="jsFileAttachModalBody"></div>'},function(){i(t,a,n)})}),$(document).on("click",".jsAddItemDocument",function(e){e.preventDefault();const t={title:$("#jsItemDocumentTitle").val(),file:$("#jsItemDocuments").msFileUploader("get")};if(""===t.title.trim())return void _error("Please enter a file title.");if(!t.file)return void _error("Please select a file.");if(0===Object.keys(t.file).length)return void _error("Please select a file.");if(t.file.hasError&&"vimeo"===t.file.type)return void _error("Vimeo link is invalid.");if(t.file.hasError&&"youtube"===t.file.type)return void _error("YouTube link is invalid.");if(t.file.hasError)return void _error(t.file.errorCode);let a="vimeo"===t.file.type||"youtube"===t.file.type?"link":d(t.file).toLowerCase();l(t.file,t.title,a)}),$(".jsCSPItemListingBtn").click(function(e){e.preventDefault();let t=[];$(".jsCSPItemListingRow").length>0&&($(".jsCSPItemListingRow").map(function(){let e=$(this).find('[name="dynamicInput[]"]').map(function(){return $(this).val()}).get(),a=$(this).find('[name="dynamicCheckbox[]"]').map(function(){return $(this).prop("checked")?"on":"off"}).get();const n={id:$(this).data("id"),dynamicInput:e,dynamicCheckbox:a};t.push($(this).val()),c(n)}),alertify.alert("You have successfully updated the checklist",function(){window.location.refresh()}),ml(!1,"jsPageLoader"))}),ml(!1,"jsPageLoader")});