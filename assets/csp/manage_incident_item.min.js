$(function(){function e(){let e=`\n        <div class="row" data-external="${c}">\n            <div class="col-md-5">\n                <div class="form-group">\n                    <label for="external_employee_name">Name</label>\n                    <input type="text" name="external_employees_names[${c}]['name']" class="form-control" required>\n                </div>\n            </div>\n            <div class="col-md-5">\n                <div class="form-group">\n                    <label for="external_employee_email">Email</label>\n                    <input type="email" name="external_employees_emails[${c}]['email']" class="form-control" required>\n                </div>\n            </div>\n            <div class="col-md-1">\n                <div class="form-group">\n                    <label>&nbsp;</label>\n                    <button type="button" class="btn btn-red btn-block jsRemoveExternalEmployee">\n                        <i class="fa fa-trash"></i>\n                    </button>\n                </div>\n            </div>\n        </div>\n        `;return c++,$(".jsAddExternalBody").append(e),$(`input[name="external_employees[${c-1}]['name']"]`).rules("add",{required:!0,messages:{required:"Please enter the name"}}),$(`input[name="external_employees[${c-1}]['email']"]`).rules("add",{required:!0,email:!0,messages:{required:"Please enter the email",email:"Please enter a valid email address"}}),e}function t(e){_confirm("Are you sure you want to remove this external employee? It will be removed from this report permanently as well.",function(){r(e)})}function n(e){if(null===m){ml(!0,"jsPageLoader");let n=$('input[name="dynamicInput[]"]').map(function(){return $(this).val()}).get(),a=$('input[name="dynamicCheckbox[]"]').map(function(){return $(this).prop("checked")?"on":"off"}).get();var t=$(e).serializeArray();t.push({name:"itemInput",value:n}),t.push({name:"itemCheckbox",value:a}),m=$.ajax({url:baseUrl("compliance_safety_reporting/incident_item_management/"+reportId+"/"+incidentId+"/"+itemId),method:"POST",data:$.param(t)}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})})}}function a(e){null===m&&(ml(!0,"jsPageLoader"),m=$.ajax({url:baseUrl("compliance_safety_reporting/notes/"+reportId+"/"+incidentId+"/"+itemId),method:"POST",data:e}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}function i(e){$.ajax({url:baseUrl("compliance_safety_reporting/file/view/"+e),method:"GET"}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsFileViewModalBody").html(e.view),$("#jsFileViewModalTitle").html(e.data.title),ml(!1,"jsFileViewModalLoader")})}async function o(e,t,n){if(null===m){ml(!0,"jsPageLoader");const a=new FormData;a.append("title",t),a.append("type",n),a.append("itemId",itemId),a.append("reportId",reportId),a.append("incidentId",incidentId),"youtube"===e.type||"vimeo"===e.type?a.append("link",e.link):a.append("file",e),m=$.ajax({url:baseUrl("compliance_safety_reporting/add_file_to_incident_item"),method:"POST",async:!0,cache:!1,contentType:!1,processData:!1,data:a}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){alertify.alert("You have successfully upload the file",function(){window.location.refresh()})})}}function l(e,t){null===m&&(ml(!0,"jsPageLoader"),m=$.ajax({url:baseUrl("compliance_safety_reporting/delete_file/"+e),method:"DELETE"}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success("Removed "+t+" successfully",function(){window.location.reload()})}))}function r(e){null===m&&(ml(!0,"jsPageLoader"),m=$.ajax({url:baseUrl("compliance_safety_reporting/"+reportId+"/"+e.data("id")),method:"DELETE"}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(t){_success(t.message,function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),c--,0==c&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}))}function s(e){if(!e)return"Unknown";const t=e.name.toLowerCase(),n=e.type;let a="file";return n.startsWith("audio/")?a="audio":n.startsWith("video/")?a="video":n.startsWith("image/")?a="image":n.startsWith("application/")&&("application/pdf"===n||n.startsWith("application/msword")||"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===n)&&(a="document"),"file"===a&&(t.match(/\.(pdf|doc|docx|txt|xls|xlsx|ppt|pptx)$/)?a="document":t.match(/\.(mp3|wav|ogg|flac|aac|m4a)$/)?a="audio":t.match(/\.(mp4|mkv|avi|mov|wmv|flv|webm)$/)&&(a="video")),a}function d(){null===m&&(ml(!0,"jsPageLoader"),m=$.ajax({url:baseUrl("compliance_safety_reporting/"+getSegment(2)+"/emails/send/incidents"),method:"POST"}).always(function(){m=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message)}))}let c=$(".jsAddExternalBody .jsEER").length,m=null;const u={document:{allowedTypes:["jpg","jpeg","png","gif","webp","rtf","pdf","doc","docx","pptx","ppt","xls","xlsx","csv","mov","mp4","webm","wav","mp3"],fileLimit:"200mb",allowLinks:!0}};$("#report_documents").msFileUploader(u.document),0!=c&&$(".jsAddExternalBody .jsEER").each(function(e){$(`input[name="external_employees[${e}]['name']"]`).rules("add",{required:!0,messages:{required:"Please enter the name"}}),$(`input[name="external_employees[${e}]['email']"]`).rules("add",{required:!0,email:!0,messages:{required:"Please enter the email",email:"Please enter a valid email address"}})}),$("#report_status").select2({minimumResultsForSearch:-1}),$("#report_note_type").select2({minimumResultsForSearch:-1}),CKEDITOR.replace("report_note"),$("#item_completion_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$("#jsAddIncidentItemForm").validate({rules:{},messages:{},submitHandler:function(e){n(e)}}),$(".jsAddExternalEmployee").click(function(t){t.preventDefault(),$(".jsAddExternalBody .alert").remove(),e()}),$(document).on("click",".jsRemoveExternalEmployee",function(){const e=$(this).closest(".row");if(e.data("id"))return t(e);alertify.confirm("Are you sure you want to remove this external employee?",function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),c--,0==c&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}),$(".jsAddNote").click(function(e){e.preventDefault();const t={type:$("#report_note_type").val(),content:CKEDITOR.instances.report_note.getData()};""!==t.content.trim()?a(t):_error("Please enter a note.")}),$(".jsAddDocument").click(function(e){e.preventDefault();const t={title:$("#document_title").val(),file:$("#report_documents").msFileUploader("get")};if(""===t.title.trim())return void _error("Please enter a file title.");if(!t.file)return void _error("Please select a file.");if(0===Object.keys(t.file).length)return void _error("Please select a file.");if(t.file.hasError&&"vimeo"===t.file.type)return void _error("Vimeo link is invalid.");if(t.file.hasError&&"youtube"===t.file.type)return void _error("YouTube link is invalid.");if(t.file.hasError)return void _error(t.file.errorCode);let n="vimeo"===t.file.type||"youtube"===t.file.type?"link":s(t.file).toLowerCase();o(t.file,t.title,n)}),$(document).on("click",".jsViewFile",function(e){e.preventDefault();const t=$(this).closest(".jsFileBox").data("id");Modal({Id:"jsFileViewModal",Loader:"jsFileViewModalLoader",Title:'<span id="jsFileViewModalTitle"></span>',Body:'<div id="jsFileViewModalBody"></body>'},function(){i(t)})}),$(document).on("click",".jsDeleteFile",function(e){e.preventDefault();const t=$(this).data("file_id"),n=$(this).data("file_type");_confirm("Are you sure you want to remove this "+n+"? It will be removed from this issue permanently as well.",function(){l(t,n)})}),$(".jsDescriptionBody").length&&(descriptionFieldsObj&&descriptionFieldsObj.dynamicInput&&descriptionFieldsObj.dynamicInput.map(function(e,t){$('[name="dynamicInput[]"]').eq(t).val(e)}),descriptionFieldsObj&&descriptionFieldsObj.dynamicCheckbox&&descriptionFieldsObj.dynamicCheckbox.map(function(e,t){$('[name="dynamicCheckbox[]"]').eq(t).prop("checked","on"===e)})),$(".show-status-box").click(function(){$(this).closest(".row").next().show()}),$(".applicant").hover(function(){$(this).find(".jsSeverityLevelText").animate({"padding-top":0,"padding-right":0,"padding-bottom":0,"padding-left":15},"fast")},function(){$(this).find(".jsSeverityLevelText").animate({"padding-top":0,"padding-right":0,"padding-bottom":0,"padding-left":5},"fast")}),$(".applicant").click(function(){const e=$(this).data("id");$(this).parent().parent().parent().find(".jsSelectedPill").html(`\n\t\t\t<div data-id="${e}" class="csLabelPill jsSelectedLabelPill text-center" \n\t\t\tstyle="\n\t\t\tbackground-color: ${$(this).css("background-color")}; color: ${$(this).css("color")} ;">${$(this).text()}</div>\n\t\t`),$(this).parent().parent().parent().parent().find(".jsIncidentSeverityLevel").val(e)}),$(".cross").click(function(){$(this).parent().parent().css("display","none")}),$(".jsSendReminderEmails").click(function(e){e.preventDefault(),_confirm("Are you sure you want to send emails to the selected employees and external recipients?",d)}),$("#jsIssueStatus").change(function(){$("#jsIssueCompletionDate").prop("disabled","completed"!=$(this).val())}),$(".jsIssueProgressUpdateBtn").click(function(e){e.preventDefault();const t={status:$("#jsIssueStatus").val(),completionDate:$("#jsIssueCompletionDate").val(),itemId:getSegment(4),reportId:getSegment(3),incidentId:getSegment(2)};if(""===t.status.trim())return void _error("Please select a status.");if("completed"===t.status&&""===t.completionDate.trim())return void _error("Please select a completion date.");const n=callButtonHook($(this),!0);updateProgress(t).always(function(){m=null,ml(!1,"jsPageLoader"),callButtonHook(n,!1)}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.reload()})})}),updateProgress=function(e){return null===m&&(ml(!0,"jsPageLoader"),m=$.ajax({url:baseUrl("compliance_safety_reporting/issue/progress/update/main"),method:"POST",data:e})),m},ml(!1,"jsPageLoader")});