$(function(){function e(e){const t=callButtonHook($(".jsDeleteReportBtn"),!0);$.ajax({url:baseUrl(`compliance_safety_reporting/report/${e}`),method:"DELETE"}).always(function(){callButtonHook(t,!1)}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.href=baseUrl("compliance_safety_reporting/overview")})})}function t(){let e=`\n        <div class="row" data-external="${k}">\n            <div class="col-md-5">\n                <div class="form-group">\n                    <label for="external_employee_name">Name</label>\n                    <input type="text" name="external_employees_names[${k}]['name']" class="form-control jsEPName${k}" required>\n                </div>\n            </div>\n            <div class="col-md-5">\n                <div class="form-group">\n                    <label for="external_employee_email">Email</label>\n                    <input type="email" name="external_employees_emails[${k}]['email']" class="form-control jsEPEmail${k}" required>\n                </div>\n            </div>\n            <div class="col-md-1">\n                <div class="form-group">\n                    <label>&nbsp;</label>\n                    <button type="button" class="btn btn-red btn-block jsRemoveExternalEmployee">\n                        <i class="fa fa-trash"></i>\n                    </button>\n                </div>\n            </div>\n\t\t\t <div class="col-md-1 jsAddExternalEmployeeRow">\n                <div class="form-group">\n                    <label>&nbsp;</label>\n                    <button type="button" class="btn btn-orange btn-block jsAddExternalEmployeeBtn">\n                        <i class="fa fa-plus-circle"></i>\n                    </button>\n                </div>\n            </div>\n        </div>\n        `;return k++,$(".jsAddExternalBody").append(e),$(`input[name="external_employees[${k-1}]['name']"]`).rules("add",{required:!0,messages:{required:"Please enter the name"}}),$(`input[name="external_employees[${k-1}]['email']"]`).rules("add",{required:!0,email:!0,messages:{required:"Please enter the email",email:"Please enter a valid email address"}}),e}function a(e){_confirm("Are you sure you want to remove this external employee? It will be removed from this report permanently as well.",function(){d(e)})}function n(e){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/edit/"+getSegment(2)),method:"POST",data:$(e).serializeArray()}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){mn,_success(e.message,function(){window.location.refresh()})}))}function s(e){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/notes/"+getSegment(2)+"/0"),method:"POST",data:e}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}function o(e){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/report/"+getSegment(2)+"/incident"),method:"POST",data:{incidentId:e}}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}function i(e){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/incident/"+e),method:"delete"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}function l(e){$.ajax({url:baseUrl("compliance_safety_reporting/file/view/"+e),method:"GET"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsFileViewModalBody").html(e.view),$("#jsFileViewModalTitle").html(e.data.title),ml(!1,"jsFileViewModalLoader")})}function d(e){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/"+getSegment(2)+"/"+e.data("id")),method:"DELETE"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(t){_success(t.message,function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),k--,0==k&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}))}async function r(e,t,a){if(null===P){ml(!0,"jsPageLoader");const n=new FormData;n.append("title",t),n.append("type",a),"youtube"===e.type||"vimeo"===e.type?n.append("link",e.link):n.append("file",e),P=$.ajax({url:baseUrl("compliance_safety_reporting/file/"+getSegment(2)+"/0/"+a),method:"POST",async:!0,cache:!1,contentType:!1,processData:!1,data:n}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){$("#document_title").val(""),$("#report_documents").msFileUploader("clear"),"link"===a||"audio"===a||"video"===a?0!=$(".jsAudioArea").find(".jsFirst").length?$(".jsAudioArea").find(".jsFirst").append(e.view):$(".jsAudioArea").html(`<div class="row jsFirst">${e.view}</div>`):0!=$(".jsDocumentsArea").find(".jsFirst").length?$(".jsDocumentsArea").find(".jsFirst").append(e.view):$(".jsDocumentsArea").html(`<div class="row jsFirst">${e.view}</div>`)})})}}function c(e){if(!e)return"Unknown";const t=e.name.toLowerCase(),a=e.type;let n="file";return a.startsWith("audio/")?n="audio":a.startsWith("video/")?n="video":a.startsWith("image/")?n="image":a.startsWith("application/")&&("application/pdf"===a||a.startsWith("application/msword")||"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===a)&&(n="document"),"file"===n&&(t.match(/\.(pdf|doc|docx|txt|xls|xlsx|ppt|pptx)$/)?n="document":t.match(/\.(mp3|wav|ogg|flac|aac|m4a)$/)?n="audio":t.match(/\.(mp4|mkv|avi|mov|wmv|flv|webm)$/)&&(n="video")),n}function u(){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/"+getSegment(2)+"/emails/send"),method:"POST"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message)}))}async function m(e){$("#jsAddIssueModal").modal("hide"),ml(!0,"jsPageLoader");const t=$(".jsAddIssueBtn");t.prop("disabled",!0).text("Adding...");try{const a=await $.ajax({url:baseUrl("compliance_safety_reporting/issue/add/"+reportTypeId),method:"POST",data:e}),{reportId:n,incidentId:s,issueId:o}=a;$("#jsAttachedFileListing > .jsUploadIssueFile").length>0&&await p(n,s,o),$("#jsAttachedNoteListing > .jsUploadIssueNote").length>0&&await f(n,s,o),_success(a.message,function(){ml(!1,"jsPageLoader"),window.location.href=`${window.location.origin}/compliance_safety_reporting/edit/${n}?tab=issues`})}catch(e){handleErrorResponse(e)}finally{P=null,t.prop("disabled",!1).text("Add Issue")}}async function p(e,t,a){for(const n of R){const s=new FormData;s.append("reportId",e),s.append("incidentId",t),s.append("itemId",a),s.append("title",n.title),s.append("type",n.type),"link"===n.type?s.append("link",n.link):s.append("file",n.file);try{await $.ajax({url:baseUrl("compliance_safety_reporting/add_file_to_incident_item"),method:"POST",data:s,processData:!1,contentType:!1})}catch(e){handleErrorResponse(e)}}console.log("✅ All files processed.")}async function f(e,t,a){for(const n of S)try{await $.ajax({url:baseUrl(`compliance_safety_reporting/notes/${e}/${t}/${a}`),method:"POST",data:n})}catch(e){handleErrorResponse(e)}console.log("✅ All notes processed.")}function v(e){null!==P&&P.abort(),P=$.ajax({url:baseUrl("compliance_safety_reporting/issues/"+e),method:"GET"}).always(function(){P=null}).fail(handleErrorResponse).done(function(e){$("#jsAddIssueBox").html(e.view),$("#jsAddIssueModal .jsAddIssueBtn").removeClass("hidden")})}function y(e){const t=$(".jsEditModalIssue");t.prop("disabled",!0).text("Updating..."),null===P&&(P=$.ajax({url:baseUrl("compliance_safety_reporting/issue/edit"),method:"POST",data:e}).always(function(){P=null,t.prop("disabled",!1).text("Save changes")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.reload()})}))}function j(){if($("#jsAddIssueModal").length<=0){const e='\n\t\t\t<div class="modal fade" id="jsAddIssueModal" role="dialog" style="overflow-y:auto;" aria-labelledby="exampleModalLabel" aria-hidden="true">\n\t\t\t\t<div class="modal-dialog modal-lg" role="document">\n\t\t\t\t\t<div class="modal-content">\n\t\t\t\t\t\t<div class="modal-header">\n\t\t\t\t\t\t\t<h5 class="modal-title" id="exampleModalLabel">Report a new Issue</h5>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="modal-body">\n\t\t\t\t\t\t\t<div class="alert alert-info text-center">Generating view please wait.</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="modal-footer">\n\t\t\t\t\t\t\t<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>\n\t\t\t\t\t\t\t<button type="button" class="btn btn-primary jsAddIssueBtn hidden">Add Issue</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t';$("body").append(e)}$("#jsAddIssueModal").modal({backdrop:"static",keyboard:!1}),$("#jsAddIssueModal").modal("show")}function h(){if($("#jsEditIssueModal").length<=0){const e='\n\t\t\t<div class=modal fade" id="jsEditIssueModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">\n\t\t\t\t<div class="modal-dialog modal-lg" role="document">\n\t\t\t\t\t<div class="modal-content">\n\t\t\t\t\t\t<div class="modal-header">\n\t\t\t\t\t\t\t<h5 class="modal-title" id="exampleModalLabel">Modify an Issue</h5>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="modal-body">\n\t\t\t\t\t\t\t<div class="alert alert-info text-center">Generating view please wait.</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="modal-footer">\n\t\t\t\t\t\t\t<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>\n\t\t\t\t\t\t\t<button type="button" class="btn btn-primary jsEditModalIssue hidden">Save changes</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t';$("body").append(e)}$("#jsEditIssueModal").modal({backdrop:"static",keyboard:!1}),$("#jsEditIssueModal").modal("show")}function _(e){const t=$(".jsReportBasicUpdateBtn");t.prop("disabled",!0).text("Updating..."),null===P&&(P=$.ajax({url:baseUrl("compliance_safety_reporting/report/update/"+e.report_id),method:"POST",data:e}).always(function(){P=null,t.prop("disabled",!1).text("Save Changes")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){})}))}function g(){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/delete_issue_from_report/"+issueId),method:"Delete"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.reload()})}))}function I(e){if($("#jsIssueModalCommon").length<=0){const e='\n\t\t\t<div class=modal fade" id="jsIssueModalCommon" tabindex="-1" role="dialog" aria-hidden="true">\n\t\t\t\t<div class="modal-dialog modal-lg" role="document">\n\t\t\t\t\t<div class="modal-content">\n\t\t\t\t\t\t<div class="modal-header">\n\t\t\t\t\t\t\t<h5 class="modal-title"></h5>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="modal-body">\n\t\t\t\t\t\t\t<div class="alert alert-info text-center">Generating a view please wait.</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="modal-footer">\n\t\t\t\t\t\t\t<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t';$("body").append(e)}$("#jsIssueModalCommon").find(".modal-title").html(e.title),0==e.count?$("#jsIssueModalCommon").find(".modal-body").html('<div class="alert alert-info text-center">No file has been attached to this issue.</div>'):($("#jsIssueModalCommon").find(".modal-body").html('<div class="alert alert-info text-center">Generating a view please wait.</div>'),null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/get_attached_files/"+e.reportId+"/"+e.incidentId+"/"+e.issueId),method:"GET"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsIssueModalCommon").find(".modal-body").html(e.view),_success(e.message)}))),$("#jsIssueModalCommon").modal({backdrop:"static",keyboard:!1}),$("#jsIssueModalCommon").modal("show")}function l(e){$.ajax({url:baseUrl("compliance_safety_reporting/file/view/"+e),method:"GET"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsFileViewModalBody").html(e.view),$("#jsFileViewModalTitle").html(e.data.title),ml(!1,"jsFileViewModalLoader")})}function b(e,t){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/delete_file/"+e),method:"DELETE"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success("Removed "+t+" successfully",function(){window.location.reload()})}))}function c(e){if(!e)return"Unknown";const t=e.name.toLowerCase(),a=e.type;let n="file";return a.startsWith("audio/")?n="audio":a.startsWith("video/")?n="video":a.startsWith("image/")?n="image":a.startsWith("application/")&&("application/pdf"===a||a.startsWith("application/msword")||"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===a)&&(n="document"),"file"===n&&(t.match(/\.(pdf|doc|docx|txt|xls|xlsx|ppt|pptx)$/)?n="document":t.match(/\.(mp3|wav|ogg|flac|aac|m4a)$/)?n="audio":t.match(/\.(mp4|mkv|avi|mov|wmv|flv|webm)$/)&&(n="video")),n}function w(){null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/delete_department_and_team_from_report/"+reportId),method:"DELETE"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success("Removed department and team successfully",function(){window.location.reload()})}))}function x(){const e=$(".jsInternalEmployees:checked").length>0?$(".jsInternalEmployees:checked").map(function(){return $(this).val()}).get():[];ml(!0,"jsPageLoader"),$.ajax({url:baseUrl(`compliance_safety_reporting/report/${reportId}/employees/internal`),method:"POST",data:{ids:e}}).always(function(){ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message)})}function E(e){const t={name:$(`.jsEPName${e}`).val().trim(),email:$(`.jsEPEmail${e}`).val().trim()};if(!t.name)return void _error("Employee name is required.");if(!t.email)return void _error("Employee email is required.");let a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;a.test(t.email)?(ml(!0,"jsPageLoader"),$.ajax({url:baseUrl(`compliance_safety_reporting/report/${reportId}/employees/external`),method:"POST",data:{external:t}}).always(function(){ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(t){_success(t.message),$(`.row [data-external="${e}"]`).data("id",t.id),$(`.row [data-external="${e}"]`).find(".jsAddExternalEmployeeRow").remove()})):_error("Employee email is invalid.")}let k=$(".jsAddExternalBody .jsEER").length,P=null,A=1,L=1,R=[],S=[];const C={document:{allowedTypes:["jpg","jpeg","png","gif","webp","rtf","pdf","doc","docx","pptx","ppt","xls","xlsx","csv","mov","mp4","webm","wav","mp3"],fileLimit:"200mb",allowLinks:!0,allowCapture:!0}};$("#jsCompanyDepartments").select2({closeOnSelect:!1}),$("#jsTeams").select2({closeOnSelect:!1}),$(".jsDeleteReportBtn").click(function(t){t.preventDefault();const a=$(this).data("id");_confirm("Are you sure you want to delete this report? This action is not revertible.",function(){e(a)})}),$("#report_documents").msFileUploader(C.document),0!=k&&$(".jsAddExternalBody .jsEER").each(function(e){$(`input[name="external_employees[${e}]['name']"]`).rules("add",{required:!0,messages:{required:"Please enter the name"}}),$(`input[name="external_employees[${e}]['email']"]`).rules("add",{required:!0,email:!0,messages:{required:"Please enter the email",email:"Please enter a valid email address"}})}),$("#report_status").select2({minimumResultsForSearch:-1}),$("#report_note_type").select2({minimumResultsForSearch:-1}),$("#jsReportIncidentType").select2({}),CKEDITOR.replace("report_note"),$("#report_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$(".start_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$("#report_completion_date").datetimepicker({format:"m/d/Y",datepicker:!0,timepicker:!1,changeYear:!0,changeMonth:!0}),$("#jsAddReportForm").validate({rules:{report_title:{required:!0},report_date:{required:!0}},messages:{report_title:{required:"Please enter report title"},report_date:{required:"Please select report date"}},submitHandler:function(e){n(e)}}),$(document).on("click",".jsDeleteReportIncident",function(){const e=$(this).closest("tr").data("id");alertify.confirm("Are you sure you want to remove this incident type?",function(){i(e)})}),$(".jsAddNote").click(function(e){e.preventDefault();const t={type:$("#report_note_type").val(),content:CKEDITOR.instances.report_note.getData()};""!==t.content.trim()?s(t):_error("Please enter a note.")}),$(".jsAddIncident").click(function(e){e.preventDefault();const t={type:$("#jsReportIncidentType").val()};"0"!=t.type?o(t.type):_error("Please select an incident type.")}),$(".jsAddDocument").click(function(e){e.preventDefault();const t={title:$("#document_title").val(),file:$("#report_documents").msFileUploader("get")};if(""===t.title.trim())return void _error("Please enter a file title.");if(!t.file)return void _error("Please select a file.");if(0===Object.keys(t.file).length)return void _error("Please select a file.");if(t.file.hasError&&"vimeo"===t.file.type)return void _error("Vimeo link is invalid.");if(t.file.hasError&&"youtube"===t.file.type)return void _error("YouTube link is invalid.");if(t.file.hasError)return void _error(t.file.errorCode);let a="vimeo"===t.file.type||"youtube"===t.file.type?"link":c(t.file).toLowerCase();r(t.file,t.title,a)}),$(document).on("click",".jsViewFile",function(e){e.preventDefault();const t=$(this).closest(".jsFileBox").data("id");Modal({Id:"jsFileViewModal",Loader:"jsFileViewModalLoader",Title:'<span id="jsFileViewModalTitle"></span>',Body:'<div id="jsFileViewModalBody"></body>'},function(){l(t)})}),$(document).on("click",".jsReportProgressQuestionBtn",function(e){var t={};t.departments=$("#jsDepartments").val()||"",t.compliance_date=$("#jsComplianceDate").val(),null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/report_questions/"+getSegment(2)),method:"POST",data:t}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.href=`${window.location.origin}/compliance_safety_reporting/edit/${getSegment(2)}?tab=questions`})}))}),$(".jsSendReminderEmails").click(function(e){e.preventDefault(),_confirm("Are you sure you want to send emails to the selected employees and external recipients?",u)}),$(".jsAddAddIssueBtn").click(function(e){e.preventDefault(),j(),P=$.ajax({url:baseUrl("compliance_safety_reporting/issues/report_type_id/"+reportTypeId),method:"GET"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsAddIssueModal .modal-body").html(e.view),$.fn.modal.Constructor.prototype.enforceFocus=function(){},$("#jsNewItemSelect").select2(),$("#jsAddIssueNoteType").select2(),CKEDITOR.replace("jsManualIssueDescription",{toolbar:[["Bold","Italic","-","NumberedList","BulletedList","-","Link","Unlink"],["FontSize","TextColor","BGColor"]]}),CKEDITOR.replace("jsAddIssueNote"),$("#jsAddIssueFileUploadFile").msFileUploader(C.document),v($("#jsNewItemSelect").val())})}),$(document).on("change","#jsNewItemSelect",function(){v($(this).val())}),$(document).on("click",".jsAddIssueBtn",function(){const e={reportId:getSegment(2),incidentId:$("#jsNewItemIncidentId").val(),issueId:$("#jsNewItemId").val(),severityLevelId:$("#jsNewItemSeverityLevel").val(),dynamicInputs:[],dynamicCheckbox:[],type:$(".jsIssueType:checked").val(),title:"",description:"",report_to_dashboard:$(".jsReportToDashboard:checked").val(),ongoing_issue:$(".jsOngoingIssue:checked").val(),reported_by:$(".jsReportedBy:checked").val(),category_of_issue:$("#jsCategoryOfIssue").val()};if(e.reportId)if(e.incidentId)if(e.issueId){if("default"==e.type){if(e.dynamicInputs=$("#jsAddIssuePanelRef").find('[name="dynamicInput[]"]').length>0?$("#jsAddIssuePanelRef").find('[name="dynamicInput[]"]').map(function(){return $(this).val()}).get():[],e.dynamicCheckbox=$("#jsAddIssuePanelRef").find('[name="dynamicCheckbox[]"]')>0?$("#jsAddIssuePanelRef").find('[name="dynamicCheckbox[]"]').map(function(){return $(this).val()}).get():[],!e.severityLevelId)return void _error("Please select a severity level.")}else if("manual"==e.type){if(e.severityLevelId=$(".jsManualSeverityLevel").data("id"),e.title=$("#jsManualIssueTitle").val(),e.description=CKEDITOR.instances.jsManualIssueDescription.getData(),!e.title)return void _error("Please add a manual issue title.");if(!e.description)return void _error("Please add a manual issue description.")}m(e)}else _error("Please provide a issue id.");else _error("Please provide a incident id.");else _error("Please provide a report id.")}),$(".jsEditIssue").click(function(e){e.preventDefault();const t=$(this).data("id");h(),P=$.ajax({url:baseUrl("compliance_safety_reporting/issues/edit/"+t),method:"GET"}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){$("#jsEditIssueModal .modal-body").html(e.view),$(".jsEditModalIssue").removeClass("hidden"),CKEDITOR.replace("jsEditManualIssueDescription",{toolbar:[["Bold","Italic","-","NumberedList","BulletedList","-","Link","Unlink"],["FontSize","TextColor","BGColor"]]})})}),$(document).on("click",".jsEditModalIssue",function(){const e={type:$("#jsEditManualIssueType").val(),issueId:$("#jsNewItemId").val(),severityLevelId:$("#jsNewItemSeverityLevel").val(),dynamicInputs:[],dynamicCheckbox:[],report_to_dashboard:$(".jsReportToDashboard:checked").val(),ongoing_issue:$(".jsOngoingIssue:checked").val(),reported_by:$(".jsReportedBy:checked").val(),category_of_issue:$("#jsCategoryOfIssue").val()};if("default"==e.type){if(e.dynamicInputs=$("#jsAddIssuePanelRef").find('[name="dynamicInput[]"]').length>0?$("#jsAddIssuePanelRef").find('[name="dynamicInput[]"]').map(function(){return $(this).val()}).get():[],e.dynamicCheckbox=$("#jsAddIssuePanelRef").find('[name="dynamicCheckbox[]"]')>0?$("#jsAddIssuePanelRef").find('[name="dynamicCheckbox[]"]').map(function(){return $(this).val()}).get():[],!e.issueId)return void _error("Please provide a issue id.");if(!e.severityLevelId)return void _error("Please select a severity level.")}else if("manual"==e.type){if(e.issueTypeId=$("#jsEditManualIssueTypeId").val(),e.title=$("#jsEditManualIssueTitle").val(),e.description=CKEDITOR.instances.jsEditManualIssueDescription.getData(),!e.title)return void _error("Please add a manual issue title.");if(!e.description)return void _error("Please add a manual issue description.")}y(e)}),$(document).on("click",".show-status-box",function(){$(this).closest(".row").next().show()}),$(document).on("click",".applicant",function(){const e=$(this).data("id");$(this).parent().parent().parent().find(".jsSelectedPill").html(`\n\t\t\t<div id="jsNewItemSelectedSeverity" data-id="${e}" class="csLabelPill jsSelectedLabelPill text-center" \n\t\t\tstyle="\n\t\t\tbackground-color: ${$(this).css("background-color")}; color: ${$(this).css("color")} ;">${$(this).text()}</div>\n\t\t`),$("#jsNewItemSeverityLevel").val(e)}),$(document).on("click",".jsSelectManualSeverityLevel",function(){const e=$(this).data("id");$(this).parent().parent().parent().find(".jsSelectedPill").html(`\n\t\t\t<div id="jsNewManualSeverityLevelSelected" data-id="${e}" class="csLabelPill jsSelectedLabelPill jsManualSeverityLevel text-center" \n\t\t\tstyle="\n\t\t\tbackground-color: ${$(this).css("background-color")}; color: ${$(this).css("color")} ;">${$(this).text()}</div>\n\t\t`)}),$(document).on("click",".cross",function(){$(this).parent().parent().css("display","none")}),$(document).on("change",".jsIssueType",function(){const e=$(this).val();"manual"==e?($("#jsDefaultIssue").addClass("hidden"),$("#jsManualIssue").removeClass("hidden")):"default"==e&&($("#jsManualIssue").addClass("hidden"),$("#jsDefaultIssue").removeClass("hidden"))}),$(document).on("click",".jsIssueSection",function(){const e=$(this).data("section");$(".jsIssueSection").removeClass("active"),$(this).addClass("active"),"detail"==e?($("#jsDetailSection").removeClass("hidden"),$("#jsQuestionSection").addClass("hidden"),$("#jsFileSection").addClass("hidden"),$("#jsNoteSection").addClass("hidden")):"question"==e?($("#jsDetailSection").addClass("hidden"),$("#jsQuestionSection").removeClass("hidden"),$("#jsFileSection").addClass("hidden"),$("#jsNoteSection").addClass("hidden")):"file"==e?($("#jsDetailSection").addClass("hidden"),$("#jsQuestionSection").addClass("hidden"),$("#jsFileSection").removeClass("hidden"),$("#jsNoteSection").addClass("hidden")):"note"==e&&($("#jsDetailSection").addClass("hidden"),$("#jsQuestionSection").addClass("hidden"),$("#jsFileSection").addClass("hidden"),$("#jsNoteSection").removeClass("hidden"))}),$(".jsReportBasicUpdateBtn").click(function(e){e.preventDefault();const t={title:$(".report_title").val().trim(),report_date:$(".report_date").val(),report_completion_date:$(".report_completion_date").val(),report_status:$(".report_status option:selected").val(),report_id:getSegment(2)};t.title?t.report_date?"completed"!=t.status||t.date?_(t):_error("Please add a report completion date."):_error("Please add a report date."):_error("Please add a report title.")}),$(".jsDeleteIssue").click(function(e){e.preventDefault(),issueId=$(this).data("issue_id"),_confirm("Are you sure you want to delete this issue?",g)}),$(".jsViewIssuesFiles").click(function(e){e.preventDefault(),I({title:"View File(s)",reportId:$(this).data("report_id"),incidentId:$(this).data("incident_id"),issueId:$(this).data("issue_id"),count:$(this).data("files_count")})}),$(document).on("click",".jsViewFile",function(e){e.preventDefault();const t=$(this).closest(".jsFileBox").data("id");Modal({Id:"jsFileViewModal",Loader:"jsFileViewModalLoader",Title:'<span id="jsFileViewModalTitle"></span>',Body:'<div id="jsFileViewModalBody"></body>'},function(){$("#jsIssueModalCommon").modal("hide"),l(t)})}),$(document).on("click",".jsDeleteFile",function(e){e.preventDefault();const t=$(this).data("file_id"),a=$(this).data("file_type");_confirm("Are you sure you want to remove this "+a+"? It will be removed from this issue permanently as well.",function(){b(t,a)})}),$(document).on("click","#jsAddIssueFileBtn",function(e){e.preventDefault();const t={title:$("#jsAddIssueFileUploadTitle").val().trim(),file:$("#jsAddIssueFileUploadFile").msFileUploader("get")};if(!t.title)return void _error("Please add a title of the file.");if(0===Object.keys(t.file).length)return void _error("Please select a valid file.");if(t.hasError&&"vimeo"===t.type)return void _error("Vimeo link is invalid.");if(t.hasError&&"youtube"===t.type)return void _error("YouTube link is invalid.");if(t.file.hasError)return void _error("Please select a valid file.");t.fileType="vimeo"===t.file.type||"youtube"===t.file.type?"link":c(t.file).toLowerCase(),$("#jsAttachedFileListingSection").removeClass("hidden"),$("#jsAttachedFileListing").prepend('<tr id="jsIssueFile_'+A+'" class="jsUploadIssueFile" row-id="jsIssueFile_'+A+'" file-title="'+t.title+'"  file-data="'+t+'"><td class="text-center">'+t.title+'</td><td class="text-center">'+t.fileType+'</td><td><a href="javascript:;" item-sid="'+A+'" attachment-type="manual" class="btn btn-block btn-info jsRemoveAttachedIssueFile">Remove</a></td></tr>');let a={id:A,title:t.title,type:t.fileType};"youtube"===t.file.type||"vimeo"===t.file.type?a.link=t.file.link:a.file=t.file,R.push(a),++A,$("#jsAddIssueFileUploadTitle").val(""),$("#jsAddIssueFileUploadFile").msFileUploader("clear"),$('input[type="radio"][value="upload"]:checked')}),$(document).on("click",".jsRemoveAttachedIssueFile",function(){var e=$(this).attr("item-sid");$("#jsIssueFile_"+e).remove(),R=R.filter(function(t){return t.id!==e})}),$(document).on("click","#jsAddIssueNoteBtn",function(e){e.preventDefault();const t={type:$("#jsAddIssueNoteType").val(),content:CKEDITOR.instances.jsAddIssueNote.getData()};if(""===t.content.trim())return void _error("Please enter a note.");let a={id:L,type:t.type,content:t.content};S.push(a),$("#jsAttachedNoteListingSection").removeClass("hidden"),$("#jsAttachedNoteListing").prepend('<tr id="jsIssueNote_'+L+'" class="jsUploadIssueNote" row-id="jsIssueNote_'+L+'"  note-type="'+t.type+'"  note-content="'+t+'"><td class="text-center">'+t.type+'</td><td class="text-center">'+t.content+'</td><td><a href="javascript:;" note-sid="'+L+'" attachment-type="manual" class="btn btn-block btn-info jsRemoveAttachedIssueNote">Remove</a></td></tr>'),++L,$("#jsAddIssueNoteType").val(""),CKEDITOR.instances.jsAddIssueNote.setData("")}),$(document).on("click",".jsRemoveAttachedIssueNote",function(){var e=$(this).attr("note-sid");$("#jsIssueNote_"+e).remove(),S=S.filter(function(t){return t.id!==e})}),$(document).on("click",".jsAddDepartmentsAndTeams",function(){var e={};e.departments=$("#jsCompanyDepartments").val()||"",e.teams=$("#jsTeams").val()||"",null===P&&(ml(!0,"jsPageLoader"),P=$.ajax({url:baseUrl("compliance_safety_reporting/add_department_and_team_to_report/"+reportId),method:"POST",data:$.param(e)}).always(function(){P=null,ml(!1,"jsPageLoader")}).fail(handleErrorResponse).done(function(e){_success(e.message,function(){window.location.refresh()})}))}),$(document).on("click",".jsRemoveDepartmentsAndTeams",function(){_confirm("Are you sure you want to remove department(s) and team(s).",function(){w()})}),$(".jsUpdateItemBtn").click(function(e){e.preventDefault();const t=$(this).data("type");"internal"===t?x():processExternalEmployees()}),$(".jsAddExternalEmployee").click(function(e){e.preventDefault(),$(".jsAddExternalBody .alert").remove(),t()}),$(document).on("click",".jsRemoveExternalEmployee",function(){const e=$(this).closest(".row");if(e.data("id"))return a(e);alertify.confirm("Are you sure you want to remove this external employee?",function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),k--,0==k&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}),$(document).on("click",".jsSaveExternalEmployee",function(){const e=$(this).closest(".row");if(e.data("id"))return a(e);alertify.confirm("Are you sure you want to remove this external employee?",function(){$(`input[name="external_employees[${e.data("external")}]['name']"]`).rules("remove"),$(`input[name="external_employees[${e.data("external")}]['email']"]`).rules("remove"),e.remove(),k--,0==k&&$(".jsAddExternalBody").html(' <div class="alert alert-info text-center">No External employees found</div>')})}),$(document).on("click",".jsAddExternalEmployeeBtn",function(e){e.preventDefault(),E($(this).closest(".row").data("external"))}),ml(!1,"jsPageLoader")});