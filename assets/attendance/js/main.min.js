$(function(){function e(e,t){if(h.cb=a,h.params={},h.params.action=e,void 0!==t)for(var n in t)h.params[n]=t[n];console.log(h),u()}function t(){h.cb=o,h.params={},u()}function n(e,t){alertify.alert("Success",t,function(){ml(!1,"jsAttendanceManageLoader"),window.location.reload()})}function a(e){clearInterval(p),$(".jsAttendanceLoader").show(0),$.post(baseURI+"attendance/mark/attendance",e).done(function(t){return e.id?n(t,"Manual time slot added successfully!"):($(".jsAttendanceLoader").hide(0),t.errors?alertify.alert("Error!",t.errors.join("<br />"),k):alertify.alert("Success",t.success,function(){o()}))}).fail(j).always(function(){null,ml(!1,"jsAttendanceLoader")})}function o(){$(".jsAttendanceLoader").show(0);let e=Intl.DateTimeFormat().resolvedOptions().timeZone;moment.tz.setDefault("America/Los_Angeles"),console.log(e),$.ajax({url:baseURI+"attendance/get/clock",method:"GET",data:{timezone:e}}).done(function(e){if(i(e.success.last_status),"break_in"==e.success.last_status||"clock_in"==e.success.last_status){var t=0,n=0,a=0;if(e.success.break_record&&"break_in"==e.success.last_status){var o=e.success.break_record,s="";let c=moment.duration(0,"hours");o.map(function(e,t){"break_in"==e.action&&(s=e.action_date_time),"break_out"==e.action&&""!=s&&(breakDifference=moment.duration(moment(e.action_date_time).diff(s)),varDif=breakDifference.hours()+"-"+breakDifference.minutes()+"-"+breakDifference.seconds(),console.log(varDif),c.add(breakDifference.hours(),"hours"),c.add(breakDifference.minutes(),"minutes"),c.add(breakDifference.seconds(),"seconds"),s=""),t==o.length-1&&"break_in"==e.action&&(breakDifference=moment.duration(moment().diff(s)),c.add(breakDifference.hours(),"hours"),c.add(breakDifference.minutes(),"minutes"),c.add(breakDifference.seconds(),"seconds"))}),t=c.hours(),n=c.minutes(),a=c.seconds()}if("clock_in"==e.success.last_status){var c=e.success.action_date_time,d=moment.duration(moment().diff(moment(c,"Y-M-D H:m:s")));t=d.hours(),n=d.minutes(),a=d.seconds()}r(t,n,a,e.success.last_status)}}).fail(j)}function s(){navigator.geolocation&&(navigator.geolocation.getCurrentPosition(function(e){var t=e.coords.latitude,n=e.coords.longitude,a={};a.lat=t,a.lng=n,$.ajax({url:baseURI+"attendance/savelocation",method:"post",data:a}).success(function(e){}).fail(j),t,n},function(e){}),"clock_in"==S&&setTimeout(function(){s()},5e3))}function c(e){e.preventDefault();var t={};t.roles=$("#js-roles").val()||[],t.departments=$("#js-specific-department-visibility").val()||[],t.teams=$("#js-specific-team-visibility").val()||[],t.employees=$("#js-specific-employee-visibility").val()||[],t.payroll=$(".is_visible_to_payroll").prop("checked")?1:0,ml(!0,"jsAttendanceSettingsLoader"),$.ajax({url:baseURI+"attendance/settings",method:"post",data:t}).success(function(e){return ml(!1,"jsAttendanceSettingsLoader"),alertify.alert("Success!","Settings have been updated.",k)}).fail(j)}function i(e){$(".jsAttendanceClockBTN").hide(0),$(".jsAttendanceBTN").addClass("dn"),"clock_in"==e||"break_out"==e?($('.jsAttendanceClockBTN[data-type="break_in"]').show(0),$('.jsAttendanceClockBTN[data-type="clock_out"]').show(0),$('.jsAttendanceBTN[data-type="break_in"]').removeClass("dn"),$('.jsAttendanceBTN[data-type="clock_out"]').removeClass("dn")):"break_in"==e?($('.jsAttendanceClockBTN[data-type="break_out"]').show(0),$('.jsAttendanceClockBTN[data-type="clock_out"]').show(0),$('.jsAttendanceBTN[data-type="break_out"]').removeClass("dn"),$('.jsAttendanceBTN[data-type="clock_out"]').removeClass("dn")):($('.jsAttendanceClockBTN[data-type="clock_in"]').show(0),$('.jsAttendanceBTN[data-type="clock_in"]').removeClass("dn")),$(".jsAttendanceLoader").hide(0)}function r(e,t,n,a){if(clearInterval(p),"clock_out"===a||""===a)return $(".jsAttendanceClockHour").text(1==e.toString().length?"0"+e:e),$(".jsAttendanceClockMinute").text(1==t.toString().length?"0"+t:t),void $(".jsAttendanceClockSeconds").text(1==n.toString().length?"0"+n:n);var o=new Date,c=new Date(o.getFullYear(),o.getMonth(),o.getDate(),e,t,n,0),i=new Date(c.getTime());i.setSeconds(i.getSeconds()+1);var r,d,l,u=new Date(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),0);p=setInterval(function(){i=new Date(u.getTime()),i.setSeconds(i.getSeconds()+1),u=new Date(o.getFullYear(),o.getMonth(),o.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),0),r=u.getHours(),d=u.getMinutes(),l=u.getSeconds(),$(".jsAttendanceClockHour").text(1==r.toString().length?"0"+r:r),$(".jsAttendanceClockMinute").text(1==d.toString().length?"0"+d:d),$(".jsAttendanceClockSeconds").text(1==l.toString().length?"0"+l:l)},1e3),"clock_in"==a?(S="clock_in",$("#locationbox").show(),s()):(S="",$("#locationbox").hide())}function d(){if(void 0!==$(".jsAttendanceCurrentClockHour"))return setInterval(l,1)}function l(){var e=new Date;$(".jsAttendanceCurrentClockHour").text(1===e.getHours().toString().length?"0"+e.getHours():e.getHours()),$(".jsAttendanceCurrentClockMinutes").text(1===e.getMinutes().toString().length?"0"+e.getMinutes():e.getMinutes()),$(".jsAttendanceCurrentClockSeconds").text(1===e.getSeconds().toString().length?"0"+e.getSeconds():e.getSeconds())}function u(){navigator.geolocation?navigator.geolocation.getCurrentPosition(f,g):console.log("Geolocation is required for this page, but your browser doesn't support it. Try it with a browser that does")}function m(e){var t=e.replace(/[^0-9]/g,""),n=[0,0,":",0,0],a=t.split("");n[0]=a[0]?a[0]:0,n[1]=a[1]?a[1]:0,n[3]=a[2]?a[2]:0,n[4]=a[3]?a[3]:0;var o=n.join("");return o>"23:59"&&(o="23:59"),o}function f(e){b.lat=e.coords.latitude,b.lon=e.coords.longitude,h.params.lat=e.coords.latitude,h.params.lon=e.coords.longitude,h.cb(h.params)}function g(){b.lat=0,b.lon=0,h.cb(h.params)}function j(e){null,A()}function A(){$(".jsAttendanceLoader").hide(0),$('[data-page="jsAttendanceSettingsLoader"]').length&&ml(!1,"jsAttendanceSettingsLoader"),$('[data-page="jsAttendanceManageLoader"]').length&&ml(!1,"jsAttendanceManageLoader")}function v(){setInterval(function(){$(".jsAttendanceCurrentClockDateTime").text(moment().format("MMM D YYYY, ddd HH:mm:ss"))},1e3)}function k(){}var p,h={cb:{},params:{}},b={lat:0,lon:0},S="";$(document).on("click",".jsAttendanceClockBTN, .jsAttendanceBTN",function(t){t.preventDefault(),ml(!0,"jsAttendanceLoader"),e($(this).data("type"))}),$(document).on("click",".jsAttendanceViewLocation",function(e){e.preventDefault();var t=$(this).closest(".jsAttendanceMyList").data();Model({Id:"jsAttendanceViewLocationModal",Title:"Location",Loader:"jsAttendanceViewLocationModalLoader",Body:'<div class="container"><iframe style="width:100%; height: 400px;" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q='+t.lat+","+t.lon+'&hl=en&z=17&amp;output=embed"></iframe></div>'},function(){ml(!1,"jsAttendanceViewLocationModalLoader")})}),$(".jsAttendanceManageUpdate").click(function(e){e.preventDefault();var t=$(this).closest(".jsAttendanceMyList").data("id"),a=$(this).closest(".jsAttendanceMyList").find(".jsTimeField").val(),o=/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(a);if(!o)return alertify.alert("Notice","Please enter valid time format",k);ml(!0,"jsAttendanceManageLoader"),$.post(baseURI+"attendance/manage",{Id:t,time:m(a)}).success(function(e){n(e,"Time slot updated successfully!")}).fail(j)}),$(".jsAttendanceAddNewSlot").click(function(e){e.preventDefault();var t=$(this).data("attendance_sid");ml(!0,"jsAttendanceManageLoader"),$.get(baseURI+"attendance/add_slot/"+t).done(function(e){e.success&&($(".jsAddAttendanceSlot").show(),$("#jsAttendanceSlotID").val(t),$("#jsAttendanceDate").val(e.success.date),$("#jsAttendanceStatus").append(e.success.option),ml(!1,"jsAttendanceManageLoader"))}).fail(j)}),$(document).on("click",".jsAttendanceSaveSlot",function(t){t.preventDefault();var n=$("#jsAttendanceStatus").val(),a=$("#jsAttendanceTime").val(),o=$("#jsAttendanceSlotID").val(),s=$("#jsAttendanceDate").val(),c=$("#jsAttendanceLastSlotTime").val(),i=/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(a);if(!i)return alertify.alert("Notice","Please enter valid time format",k);var r=m(a);if(c>r||c==r)return alertify.alert("Notice","Please enter greater time then previous slot.",k);ml(!0,"jsAttendanceManageLoader"),e(n,{time:r,id:o,date:s})}),$(document).on("click",".jsAttendanceCancelSlot",function(e){$("#jsAttendanceSlotID").val(""),$("#jsAttendanceDate").val(""),$("#jsAttendanceTime").val(""),$("#jsAttendanceStatus").html(""),$(".jsAddAttendanceSlot").hide()}),$(".jsAttendanceSaveSettings").click(c),$(".jsDatePicker").length&&$(".jsDatePicker").datepicker({changeYear:!0,changeMonth:!0}),$(".jsTimePicker").length&&$(".jsTimePicker").datetimepicker({format:"m/d/Y H:m",minDate:0,maxDate:0,interval:15}),$("#jsSpecificEmployees").length&&$("#jsSpecificEmployees").select2({closeOnSelect:!1}),t(),d(),A(),v()});