$((function(){var XHR=null,CBObj={cb:{},params:{}},locOBJ={lat:0,lon:0};function CheckPost(action,obj){if(CBObj.cb=MarkAttendance,CBObj.params={},CBObj.params.action=action,void 0!==obj)for(var i in obj)CBObj.params[i]=obj[i];console.log(CBObj),CheckAndGetLatLon()}function CheckClock(){CBObj.cb=LoadClock,CBObj.params={},CheckAndGetLatLon()}function HandleManualCheckIn(resp,message){alertify.alert("Success",message,(function(){ml(!1,"jsAttendanceManageLoader"),window.location.reload()}))}function MarkAttendance(props){$(".jsAttendanceLoader").show(0),XHR=$.post(baseURI+"attendance/mark/attendance",props).done((function(resp){return props.id?HandleManualCheckIn(resp,"Manual time slot added successfully!"):($(".jsAttendanceLoader").hide(0),resp.errors?alertify.alert("Error!",resp.errors.join("<br />"),CB):alertify.alert("Success",resp.success,(function(){SetClock(props.action)})))})).fail(HandleError)}function LoadClock(){XHR=$.get(baseURI+"attendance/get/clock").done((function(resp){if(SetClock(resp.success.last_status),"clock_in"==resp.success.last_status||"break_out"==resp.success.last_status){var today=new Date,initialDate;SetClockCount(new Date(today.getFullYear(),today.getMonth(),today.getDate(),resp.success.hours,resp.success.minutes,resp.success.seconds))}})).fail(HandleError)}function SaveSettings(event){event.preventDefault();var obj={};obj.roles=$("#js-roles").val()||[],obj.departments=$("#js-specific-department-visibility").val()||[],obj.teams=$("#js-specific-team-visibility").val()||[],obj.employees=$("#js-specific-employee-visibility").val()||[],obj.payroll=$(".is_visible_to_payroll").prop("checked")?1:0,ml(!0,"jsAttendanceSettingsLoader"),XHR=$.ajax({url:baseURI+"attendance/settings",method:"post",data:obj}).success((function(resp){return ml(!1,"jsAttendanceSettingsLoader"),alertify.alert("Success!","Settings have been updated.",CB)})).fail(HandleError),console.log(obj)}function SetClock(action){$(".jsAttendanceClockBTN").hide(0),$(".jsAttendanceBTN").addClass("dn"),"clock_in"==action||"break_out"==action?($('.jsAttendanceClockBTN[data-type="break_in"]').show(0),$('.jsAttendanceClockBTN[data-type="clock_out"]').show(0),$('.jsAttendanceBTN[data-type="break_in"]').removeClass("dn"),$('.jsAttendanceBTN[data-type="clock_out"]').removeClass("dn")):"break_in"==action?($('.jsAttendanceClockBTN[data-type="break_out"]').show(0),$('.jsAttendanceClockBTN[data-type="clock_out"]').show(0),$('.jsAttendanceBTN[data-type="break_out"]').removeClass("dn"),$('.jsAttendanceBTN[data-type="clock_out"]').removeClass("dn")):($('.jsAttendanceClockBTN[data-type="clock_in"]').show(0),$('.jsAttendanceBTN[data-type="clock_in"]').removeClass("dn")),$(".jsAttendanceLoader").hide(0)}function SetClockCount(initialDate){let hour=initialDate.getHours(),minutes=initialDate.getMinutes(),seconds=initialDate.getSeconds();$(".jsAttendanceClockHour").text(1==hour.toString().length?"0"+hour:hour),$(".jsAttendanceClockMinute").text(1==minutes.toString().length?"0"+minutes:minutes),$(".jsAttendanceClockSeconds").text(1==seconds.toString().length?"0"+seconds:seconds)}function InitClock(){if(void 0!==$(".jsAttendanceCurrentClockHour"))return setInterval(StartClock,1)}function StartClock(){var dt=new Date;$(".jsAttendanceCurrentClockHour").text(1===dt.getHours().toString().length?"0"+dt.getHours():dt.getHours()),$(".jsAttendanceCurrentClockMinutes").text(1===dt.getMinutes().toString().length?"0"+dt.getMinutes():dt.getMinutes()),$(".jsAttendanceCurrentClockSeconds").text(1===dt.getSeconds().toString().length?"0"+dt.getSeconds():dt.getSeconds())}function CheckAndGetLatLon(){navigator.geolocation?navigator.geolocation.getCurrentPosition(onSuccess,onFail):console.log("Geolocation is required for this page, but your browser doesn't support it. Try it with a browser that does")}function CheckTime(input){var ov,av=[0,0,":",0,0],sv=input.replace(/[^0-9]/g,"").split("");av[0]=sv[0]?sv[0]:0,av[1]=sv[1]?sv[1]:0,av[3]=sv[2]?sv[2]:0,av[4]=sv[3]?sv[3]:0;var fv=av.join("");return fv>"23:59"&&(fv="23:59"),fv}function onSuccess(position){locOBJ.lat=position.coords.latitude,locOBJ.lon=position.coords.longitude,CBObj.params.lat=position.coords.latitude,CBObj.params.lon=position.coords.longitude,CBObj.cb(CBObj.params)}function onFail(){locOBJ.lat=0,locOBJ.lon=0,CBObj.cb(CBObj.params)}function HandleError(resp){XHR=null,HideLoaders()}function HideLoaders(){$('[data-page="jsAttendanceSettingsLoader"]').length&&ml(!1,"jsAttendanceSettingsLoader"),$('[data-page="jsAttendanceManageLoader"]').length&&ml(!1,"jsAttendanceManageLoader")}function CB(){}$(document).on("click",".jsAttendanceClockBTN, .jsAttendanceBTN",(function(event){event.preventDefault(),CheckPost($(this).data("type"))})),$(document).on("click",".jsAttendanceViewLocation",(function(event){event.preventDefault();var data=$(this).closest(".jsAttendanceMyList").data();Model({Id:"jsAttendanceViewLocationModal",Title:"Location",Loader:"jsAttendanceViewLocationModalLoader",Body:'<div class="container"><iframe style="width:100%; height: 400px;" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q='+data.lat+","+data.lon+'&hl=en&z=17&amp;output=embed"></iframe></div>'},(function(){ml(!1,"jsAttendanceViewLocationModalLoader")}))})),$(".jsAttendanceManageUpdate").click((function(event){event.preventDefault();var id=$(this).closest(".jsAttendanceMyList").data("id"),time=$(this).closest(".jsAttendanceMyList").find(".jsTimeField").val(),isValid;if(!/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(time))return alertify.alert("Notice","Please enter valid time format",CB);ml(!0,"jsAttendanceManageLoader"),XHR=$.post(baseURI+"attendance/manage",{Id:id,time:CheckTime(time)}).success((function(resp){HandleManualCheckIn(resp,"Time slot updated successfully!")})).fail(HandleError)})),$(".jsAttendanceAddNewSlot").click((function(event){event.preventDefault();var id=$(this).data("attendance_sid");ml(!0,"jsAttendanceManageLoader"),XHR=$.get(baseURI+"attendance/add_slot/"+id).done((function(resp){resp.success&&($(".jsAddAttendanceSlot").show(),$("#jsAttendanceSlotID").val(id),$("#jsAttendanceDate").val(resp.success.date),$("#jsAttendanceStatus").append(resp.success.option),ml(!1,"jsAttendanceManageLoader"))})).fail(HandleError)})),$(document).on("click",".jsAttendanceSaveSlot",(function(event){event.preventDefault();var status=$("#jsAttendanceStatus").val(),time=$("#jsAttendanceTime").val(),id=$("#jsAttendanceSlotID").val(),date=$("#jsAttendanceDate").val(),previousTime=$("#jsAttendanceLastSlotTime").val(),isValid;if(!/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(time))return alertify.alert("Notice","Please enter valid time format",CB);var new_time=CheckTime(time);if(previousTime>new_time||previousTime==new_time)return alertify.alert("Notice","Please enter greater time then previous slot.",CB);ml(!0,"jsAttendanceManageLoader"),CheckPost(status,{time:new_time,id:id,date:date})})),$(document).on("click",".jsAttendanceCancelSlot",(function(event){$("#jsAttendanceSlotID").val(""),$("#jsAttendanceDate").val(""),$("#jsAttendanceTime").val(""),$("#jsAttendanceStatus").html(""),$(".jsAddAttendanceSlot").hide()})),$(".jsAttendanceSaveSettings").click(SaveSettings),$(".jsDatePicker").datepicker({changeYear:!0,changeMonth:!0}),$(".jsTimePicker").datetimepicker({format:"m/d/Y H:m",minDate:0,maxDate:0,interval:15}),$(".jsAttendanceClockBTN").hide(0),$(".jsAttendanceBTN").addClass("dn"),CheckClock(),InitClock(),$("#jsSpecificEmployees").select2({closeOnSelect:!1}),HideLoaders()}));