$((function(){let callOBJ={Requests:{Main:{action:"get_requests",companyId:companyId,employerId:employerId,employeeId:employeeId,level:level,type:"pending",filter:{employees:"all",policies:"all",status:"all",order:"upcoming",startDate:"",endDate:""},public:0}}},xhr=null;function resetFilter(e){e.preventDefault(),$("#js-filter-employee").select2("val","all"),$("#js-filter-policies").select2("val","all"),$("#js-filter-status").select2("val","all"),$("#js-filter-sort").select2("val","upcoming"),$("#js-filter-from-date").val(""),$("#js-filter-end-date").val(""),callOBJ.Requests.Main.filter.employees="all",callOBJ.Requests.Main.filter.policies="all",callOBJ.Requests.Main.filter.status="all",callOBJ.Requests.Main.filter.order="upcoming",callOBJ.Requests.Main.filter.startDate="",callOBJ.Requests.Main.filter.endDate="",fetchTimeOffs()}function applyFilter(e){e.preventDefault(),callOBJ.Requests.Main.filter.employees=$("#js-filter-employee").val(),callOBJ.Requests.Main.filter.policies=$("#js-filter-policies").val(),callOBJ.Requests.Main.filter.status=$("#js-filter-status").val(),callOBJ.Requests.Main.filter.order=$("#js-filter-sort").val(),callOBJ.Requests.Main.filter.startDate=$("#js-filter-from-date").val(),callOBJ.Requests.Main.filter.endDate=$("#js-filter-to-date").val(),fetchTimeOffs()}function fetchTimeOffs(){void 0!==window.timeoff.employees?null==xhr&&(ml(!0,"requests"),$(".js-error-row").remove(),xhr=$.post(handlerURL,callOBJ.Requests.Main,(function(resp){if(xhr=null,!0!==resp.Redirect)return!1===resp.Status&&1==callOBJ.Balances.Main.page?($(".js-ip-pagination").html(""),$("#js-data-area").html(`<tr class="js-error-row"><td colspan="${$(".js-table-head").find("th").length}"><p class="alert alert-info text-center">${resp.Response}</p></td></tr>`),void ml(!1,"requests")):!1===resp.Status?($(".js-ip-pagination").html(""),void ml(!1,"requests")):void setTable(resp);alertify.alert("WARNING!","Your session expired. Please, re-login to continue.",()=>{window.location.reload()})}))):setTimeout(fetchTimeOffs,1e3)}function setTable(resp){let rows="";if(0==resp.Data.length)return $("#js-data-area").html('<tr><td colspan="6"><p class="alert alert-info text-center">No time-offs found.</p></td></tr>'),void ml(!1,"requests");$.each(resp.Data,(function(i,v){let userRow=getUserById(v.employee_sid,window.timeoff.employees,"user_id");0!=Object.keys(userRow).length&&(rows+=`<tr data-id="${v.sid}" data-status="${v.status}" data-userid="${v.employee_sid}" data-name="${userRow.first_name} ${userRow.last_name}">`,rows+='    <td scope="row">',rows+='        <div class="employee-info">',rows+="            <figure>",rows+=`                <img src="${getImageURL(userRow.image)}" class="img-circle emp-image" />`,rows+="            </figure>",rows+='            <div class="text">',rows+=`                <h4>${userRow.first_name} ${userRow.last_name} </h4>`,rows+=`                <p>${remakeEmployeeName(userRow,!1)}</p>`,rows+=`                <p><a href="${baseURL}employee_profile/${userRow.user_id}" target="_blank">Id: ${getEmployeeId(userRow.user_id,userRow.employee_number)}</a></p>`,rows+="            </div>",rows+="        </div>",rows+="    </td>",rows+=`<td>\n                        <div class="upcoming-time-info">            \n                            <div class="icon-image">                   \n                                <img src="${baseURL}assets/images/upcoming-time-off-icon.png" class="emp-image" alt="emp-1">             \n                            </div>             \n                            <div class="text">                  \n                                <h4>${v.request_from_date==v.request_to_date?moment(v.request_from_date).format(timeoffDateFormat):moment(v.request_from_date).format(timeoffDateFormat)+" - "+moment(v.request_to_date).format(timeoffDateFormat)}</h4>                  \n                                <span>${v.title}</span><br />          \n                                <span>${v.breakdown.text}</span>\n                            </div>       \n                        </div>\n                    </td>`,rows+=`<td>\n            <div class="progress" style="margin-top: 10px;">\n                <div class="progress-bar progress-bar-success" role="progressbar" style="width: ${"pending"==v.status?"pending"!=v.level_status?50:0:100}%;">\n                    <span class="sr-only"> ${"pending"==v.status?"pending"!=v.level_status?50:0:100} % Complete</span>\n                </div>\n                <p>${"pending"==v.status?"pending"!=v.level_status?50:0:100}%</p>\n            </div>\n            ${getApproverLisiting(v.history)}\n            </td>`,rows+=`<td class="cs-vam">\n                        <p>${""==v.reason||null==v.reason?"-":v.reason}</p>\n                    </td>`,rows+=`<td class="cs-vam">\n                        <p>${moment(v.created_at).format(timeoffDateFormatWithTime)}</p>\n                    </td>`,rows+="    <td>",rows+=`    <div class="dropdown" style="margin-top: 10px;">\n                        <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">\n                        Action\n                        <span class="caret"></span>\n                        </button>\n                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="right:0; left: auto;">\n                        <li><a href="#" class="jsEditTimeOff">Edit Time-off</a></li>\n                        ${"cancelled"==v.status?"":`<li><a href="#" class="${1==v.archive?"jsActiveTimeOff":"jsArchiveTimeOff"}">${1==v.archive?"Activate":"Archive"}</a></li>`}\n                        <li><a href="#" class="jsHistoryTimeOff">View History</a></li>\n                        <li role="separator" class="divider"></li>\n                        <li><a href="${baseURL}timeoff/print/requests/${v.sid}" target="_blank">Print</a></li>\n                        <li><a href="${baseURL}timeoff/download/requests/${v.sid}" target="_blank">Download</a></li>\n                        </ul>\n                    </div>`,rows+="    </td>",rows+="</tr>")})),$("#js-data-area").html(rows),$(".js-type-popover").popover({html:!0,trigger:"hover"}),$('[data-toggle="tooltip"]').tooltip(),$(".csApproverBox").popover({html:!0,trigger:"hover",placement:"left"}),ml(!1,"requests")}function getApproverLisiting(history){if(0==history.length)return"";let rows="",arr=[];return history.map(his=>{if("create"==his.action)return"";if("{}"==his.note)return"";let action=JSON.parse(his.note);if(null==action.canApprove)return"";let msg=`${remakeEmployeeName(his)}`,il="";return"pending"==action.status?"":("approved"==action.status?(msg+=` has approved the time-off at ${moment(his.created_at).format(timeoffDateFormatWithTime)}`,il='<i class="fa fa-check-circle text-success"></i>'):"rejected"==action.status&&(msg+=` has rejected the time-off at ${moment(his.created_at).format(timeoffDateFormatWithTime)}`,il='<i class="fa fa-times-circle text-danger"></i>'),-1!==$.inArray(his.userId,arr)?"":(arr.push(his.userId),void(rows+=`\n                <div class="csApproverBox" title="Approver" data-content="${msg}">\n                    <img src="${null==his.image||""==his.image?awsURL+"test_file_01.png":awsURL+his.image}" style="width: 40px; height: 40px;" />\n                    ${il}\n                </div>\n            `)))}),rows}$("#js-filter-status").select2(),$("#js-filter-sort").select2(),fetchTimeOffs(),$("#js-filter-from-date").datepicker({dateFormat:"mm-dd-yy",changeYear:!0,changeMonth:!0,onSelect:function(v){$("#js-filter-to-date").datepicker("option","minDate",v)}}),$("#js-filter-to-date").datepicker({dateFormat:"mm-dd-yy",changeYear:!0,changeMonth:!0}).datepicker("option","minDate",$("#js-filter-from-date").val()),$(document).on("click",".js-apply-filter-btn",applyFilter),$(document).on("click",".js-reset-filter-btn",resetFilter),$(document).on("change",".jsEditResetCheckbox",applyFilter),$(".jsReportTab").click((function(e){e.preventDefault(),callOBJ.Requests.Main.type=$(this).data("key"),$(".jsReportTab").parent().removeClass("active"),$(this).parent().addClass("active"),fetchTimeOffs()})),$("#js-filter-sort").change((function(){callOBJ.Requests.Main.filter.order=$(this).val(),fetchTimeOffs()})),$(document).on("click",".jsArchiveTimeOff",(function(e){e.preventDefault();let requestId=$(this).closest("tr").data("id");alertify.confirm("Do you really want to archive this time off?",()=>{ml(!0,"requests"),$.post(handlerURL,Object.assign({action:"archive_request",companyId:companyId,employerId:employerId,employeeId:employeeId},{requestId:requestId,archive:1}),resp=>{alertify.alert("SUCCESS!",resp.Response,()=>{window.location.reload()})})},()=>{}).set("labels",{ok:"YES",cancel:"NO"}).setHeader("CONFIRM!")})),$(document).on("click",".jsActiveTimeOff",(function(e){e.preventDefault();let requestId=$(this).closest("tr").data("id");alertify.confirm("Do you really want to activate this time off?",()=>{ml(!0,"requests"),$.post(handlerURL,Object.assign({action:"archive_request",companyId:companyId,employerId:employerId,employeeId:employeeId},{requestId:requestId,archive:0}),resp=>{alertify.alert("SUCCESS!",resp.Response,()=>{window.location.reload()})})},()=>{}).set("labels",{ok:"YES",cancel:"NO"}).setHeader("CONFIRM!")})),$(document).on("click",".jsHistoryTimeOff",(function(e){e.preventDefault();let requestId=$(this).closest("tr").data("id");Modal({Id:"jsTimeOffHistory",Title:"Time-off History",Body:' \n            <div id="jsData">\n\n            </div>\n            <div class="tabel-responsive">\n                <table class="table table-striped csCustomTableHeader">\n                    <thead>\n                        <tr>\n                            <th>Employee</th>\n                            <th>Details</th>\n                            <th>Action</th>\n                            <th>Comment</th>\n                            <th>Action Taken</th>\n                        </tr>\n                    </thead>\n                    <tbody id="jsTimeOffHistoryTable"></tbody>\n                </table>\n            </div>',Loader:"jsTimeOffHistoryLoader"},()=>{ml(!0,"jsTimeOffHistoryLoader"),$("#jsPolicyHistoryTable").html(""),$.post(handlerURL,Object.assign({action:"get_request_history",companyId:companyId,employerId:employerId,employeeId:employeeId},{requestId:requestId}),resp=>{if(!0===resp.Redirect)return void alertify.alert("WARNING!","Your session expired. Please, re-login to continue.",()=>{window.location.reload()});if($("#jsData").html(`<div class="row">\n                        <div class="col-sm-3">\n                            ${$(this).closest("tr").find(".employee-info").parent().html()}\n                        </div>\n                        <div class="col-sm-4">\n                            ${$(this).closest("tr").find(".upcoming-time-info").parent().html()}\n                        </div>\n                        <div class="clearfix"></div>\n                        <hr />\n                    </div>\n                    `),!1===resp.Status)return alertify.alert("WARNING!",resp.Response,()=>{}),void ml(!1,"jsTimeOffHistoryLoader");let rows="";0===resp.Data.length?rows=`\n                        <tr>\n                            <td colspan="5">\n                                <p class="alert alert-info text-center">${resp.Response}</p>\n                            </td>\n                        </tr>\n                    `:resp.Data.map(v=>{let note=JSON.parse(v.note),act="",comment="-";"create"==v.action?act="Time-off created.":(void 0!==note.status?("archive"==note.status?act="Time-off marked as archive":"activate"==note.status?act="Time-off marked as active":"approved"==note.status&&1==note.canApprove?act="Time-off approved 100%":"approved"==note.status&&0==note.canApprove?act="Time-off approved 50%":"rejected"==note.status&&1==note.canApprove?act="Time-off rejected 100%":"rejected"==note.status&&0==note.canApprove?act="Time-off rejected 50%":"pending"==note.status&&0==note.canApprove?act="Time-off updated":"cancelled"==note.status&&(act="Time-off cancelled"),null!=note.comment&&""!=note.comment&&(comment=note.comment)):act="","update"==v.action&&""==act&&(act="Time-off updated.")),rows+="<tr>",rows+="<td>",rows+='        <div class="employee-info">',rows+="            <figure>",rows+=`                <img src="${getImageURL(v.image)}" class="img-circle emp-image" />`,rows+="            </figure>",rows+='            <div class="text">',rows+=`                <h4>${v.first_name} ${v.last_name} </h4>`,rows+=`                <p>${remakeEmployeeName(v,!1)}</p>`,rows+=`                <p><a href="${baseURL}employee_profile/${v.userId}" target="_blank">Id: ${getEmployeeId(v.userId,v.employee_number)}</a></p>`,rows+="            </div>",rows+="        </div></td>",rows+="                <td>",void 0!==note.details&&(rows+=`                   <div class="upcoming-time-info">            \n                    <div class="icon-image">                   \n                        <img src="${baseURL}assets/images/upcoming-time-off-icon.png" class="emp-image" alt="emp-1">             \n                    </div>             \n                    <div class="text">                  \n                        <h4>${note.details.startDate==note.details.endDate?moment(note.details.startDate).format(timeoffDateFormat):moment(note.details.startDate).format(timeoffDateFormat)+" - "+moment(note.details.endDate).format(timeoffDateFormat)}</h4>                  \n                        <span>${note.details.policyTitle}</span><br />          \n                        <span>${get_array_from_minutes(note.details.time,v.user_shift_hours,"H:M").text}</span>\n                    </div>       \n                </div>`),rows+="                </td>",rows+=`                <td>${act}</td>`,rows+=`                <td>${comment}</td>`,rows+=`                <td>${moment(v.created_at).format(timeoffDateFormatWithTime)}</td>`,rows+="            </tr>"}),$("#jsTimeOffHistoryTable").html(rows),ml(!1,"jsTimeOffHistoryLoader")})})}))}));