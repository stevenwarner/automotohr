$(function(){function e(e){$.post(handlerURL,Object.assign({action:"update_timeoff",companyId:companyId,employerId:employerId,employeeId:c},e),e=>{if(!1===e.Status)return ml(!1,"editModalLoader"),void alertify.alert("WARNING!",e.Response,()=>{});ml(!1,"editModalLoader"),alertify.alert("SUCCESS!",e.Response,()=>{$(".jsModalCancel").removeAttr("data-ask"),$(".jsModalCancel").trigger("click"),window.location.reload()})})}function t(e){return new Promise(t=>{$.post(handlerURL,{action:"get_modal",companyId:companyId,employerId:employerId,employeeId:employeeId,type:e},e=>{t(e)})})}function a(e){return new Promise(t=>{$.post(handlerURL,{action:"get_employee_policies_with_approvers",companyId:companyId,employerId:employerId,employeeId:e},e=>{t(e)})})}function i(e){return new Promise(t=>{$.post(handlerURL,{action:"get_request_by_id",companyId:companyId,employerId:employerId,employeeId:c,requestId:e},e=>{t(e),p=e.Data.status,u=e.Data.sid,console.log(e.Data.sid)})})}function o(){$(".jsAsOfTodayPolicies").html(""),$.post(handlerURL,{action:"get_employee_policies_by_date",companyId:companyId,employerId:employerId,employeeId:c,fromDate:$("#jsStartDateEdit").val()},e=>{window.timeoff.cPolicies=e.Data,$(".jsEditTimeOffBTN").prop("disabled",!1),$("#jsEndDateEdit").prop("disabled",!1),$("#jsAddPolicyEdit").prop("disabled",!1);let t=[];if(e.Data.length>0){let a="";e.Data.map(e=>{""==e.Reason&&(t.push(e),a+=`\n                        <div>\n                        <strong>${e.Title} (<strong class="text-${1==e.categoryType?"success":"danger"}">${1==e.categoryType?"Paid":"Unpaid"}</strong>)</strong>\n                        <br />\n                        <span>Remaining Time: ${0==e.AllowedTime.M.minutes&&""==e.Reason?"Unlimited":e.RemainingTime.text}</span>\n                        <br />\n                        <span>Scheduled Time: ${0==e.AllowedTime.M.minutes&&""==e.Reason?"Unlimited":e.ConsumedTime.text}</span>\n                        <br />\n                        <span>Employment Status: ${ucwords(e.EmployementStatus)}</span><br>\n                        <span>Policy Cycle: ${moment(e.lastAnniversaryDate,"YYYY/MM/DD").format(timeoffDateFormat)} -\n                        ${moment(e.upcomingAnniversaryDate,"YYYY/MM/DD").format(timeoffDateFormat)}\n                        </span> \n                        </div>\n                        <hr />\n                        `)}),window.timeoff.cPolicies=t,$(".jsAsOfTodayPolicies").html(a)}0==window.timeoff.cPolicies.length&&($(".jsAsOfTodayPolicies").html('<div class="alert alert-success">No policies found.</div>'),$(".jsEditTimeOffBTN").prop("disabled",!0),$("#jsEndDateEdit").prop("disabled",!0),$("#jsAddPolicyEdit").prop("disabled",!0))})}function n(e){var t=void 0===policyOffDays?timeOffDays:policyOffDays,a=moment(e).format("MM-DD-YYYY");let i=moment(e).format("dddd").toString().toLowerCase(),o=1;return o=-1!==$.inArray(i,t)?{work_on_holiday:0,holiday_title:"Weekly off"}:inObject(a,holidayDates),-1==o?[!0,""]:1==o.work_on_holiday?[!0,"set_disable_date_color",o.holiday_title]:[!1,"",o.holiday_title]}function s(e,t){if(0===e.length)return $("#jsApproversListingEdit").html("<p>No approvers found.</p>"),void $("#jsApproversListingNoteEdit").hide();let a="",i="";e.map(e=>{let o=r(e.userId,t);0==o.length&&(o[0]=" - waiting for approval",o[1]="waiting");let n=`${remakeEmployeeName(e)} ${o[0]}`;a+=`\n            <div class="csApproverBox" title="Approver" data-content="${n}">\n            <img src="${null==e.profile_picture||""==e.profile_picture?awsURL+"test_file_01.png":awsURL+e.profile_picture}" />\n            <i class="fa fa-${"approved"==o[1]?"check-circle text-success":"rejected"==o[1]?"times-circle text-danger":"clock-o"}"></i>\n            </div>\n            `,i+=`\n            <div class="csApproverBox">\n                <div class="employee-info">            \n                    <figure>                \n                        <img src="${null==e.profile_picture||""==e.profile_picture?awsURL+"test_file_01.png":awsURL+e.profile_picture}" />  \n                        <i class="fa fa-${"approved"==o[1]?"check-circle text-success":"rejected"==o[1]?"times-circle text-danger":"clock-o"}"></i>        \n                    </figure>            \n                    <div class="text">                \n                        <h4>${n}</h4>                \n                        <p><a href="http://automotohr.local/employee_profile/${e.userId}" target="_blank">Id: ${getEmployeeId(e.userId,e.employee_number)}</a></p>            \n                    </div>        \n                </div>\n            </div>\n        `}),$("#jsApproversListingEdit").html(a),$("#jsApproversListingMobileEdit").html(i),$("#jsApproversListingNoteEdit").show(),$(".csApproverBox").popover({html:!0,trigger:"hover",placement:"left"})}function d(e){let t="";0==e.length?t='<p class="alert alert-info text-center">No History found</p>':e.map(e=>{let a=JSON.parse(e.note),i="",o="-";"create"==e.action?i="Created time-off.":(void 0!==a.status?("archive"==a.status?i="Marked time-off as archive.":"activate"==a.status?i="Marked time-off as active.":"approved"==a.status&&1==a.canApprove?i="Approved time-off 100%.":"approved"==a.status&&0==a.canApprove?i="Approved time-off 50%.":"rejected"==a.status&&1==a.canApprove?i="Rejected time-off 100%.":"rejected"==a.status&&0==a.canApprove?i="Rejected time-off 50%.":"pending"==a.status&&0==a.canApprove?i="Updated time-off.":"cancelled"==a.status&&(i="Canceled time-off."),null!=a.comment&&""!=a.comment&&(o=a.comment)):i="","update"==e.action&&""==i&&(i="Time-off updated.")),t+='        <div class="employee-info">',t+="            <figure>",t+=`                <img src="${getImageURL(e.image)}" class="img-circle emp-image" />`,t+="            </figure>",t+='            <div class="text">',t+=`                <h4>${e.first_name} ${e.last_name} </h4>`,t+=`                <p>${remakeEmployeeName(e,!1)}</p>`,t+=`                <p><a href="${baseURL}employee_profile/${e.userId}" target="_blank">Id: ${getEmployeeId(e.userId,e.employee_number)}</a></p>`,t+="            </div>",t+="        </div>",t+=`<p>${i}</p>`,t+=`<p>Action Taken: ${moment(e.created_at).format(timeoffDateFormatWithTime)}</p>`,t+=`<p>${o}</p><hr />`}),$(".jsHistoryBox").html(t)}function r(e,t){if(0==t.length)return"";let a=[];return t.map(t=>{if(0!=a.length)return"";if(t.userId!=e)return"";if("create"==t.action)return"";if("{}"==t.note)return"";let i=JSON.parse(t.note);if(null==i.canApprove)return"";"approved"==i.status?(a[0]=` has approved the time-off at ${moment(t.created_at).format(timeoffDateFormatWithTime)}`,a[1]="approved"):"rejected"==i.status&&(a[0]=` has rejected the time-off at ${moment(t.created_at).format(timeoffDateFormatWithTime)}`,a[1]="rejected")}),a}function l(e){if(0===window.timeoff.cPolicies.length)return[];let t=[];return window.timeoff.cPolicies.map(a=>{a.PolicyId==e&&(t=a)}),t}let m=0,c=0,f=0,p="",u=0,y={policyId:0,startDate:0,endDate:0,dateRows:"",status:0,reason:0,comment:0,sendEmailNotification:0,fromAdmin:1};$(document).on("click",".jsEditTimeOffBTN",function(t){t.preventDefault(),policyOffDays=void 0;let a=l(getField("#jsEditPolicy"));if(0==a.length)return void alertify.alert("WARNING!","You don't have any policies. Please select a different date.",()=>{});if(y.policyId=getField("#jsEditPolicy"),y.startDate=getField("#jsStartDateEdit"),y.endDate=getField("#jsEndDateEdit"),y.status=getField("#jsStatusEdit"),y.reason=CKEDITOR.instances.jsReasonEdit.getData(),y.comment=CKEDITOR.instances.jsCommentEdit.getData(),y.sendEmailNotification=getField(".js-send-emailEdit:checked"),y.dateRows=getRequestedDays(".jsDurationBox","edit"),0==y.policyId)return void alertify.alert("WARNING!","Please select a policy.",()=>{});if(0==y.startDate)return void alertify.alert("WARNING!","Please select the start date.",()=>{});if(0==y.endDate)return void alertify.alert("WARNING!","Please select an end date.",()=>{});if((null==window.timeoff.isMine||0==window.timeoff.isMine)&&"pending"==y.status)return void alertify.alert("WARNING!","Please either approve/reject the time off.ss",()=>{});if(y.dateRows.error)return;let i=getPolicy(y.policyId,window.timeoff.cPolicies);if(null==i.OffDays?policyOffDays=void 0:policyOffDays=i.OffDays.split(","),0==i.IsUnlimited){if(i.RemainingTimeWithNegative.M.minutes<=0)return void alertify.alert("WARNING!","You don't have any time left against this policy.",()=>{});if(y.dateRows.totalTime>i.RemainingTimeWithNegative.M.minutes)return void alertify.alert("WARNING!",`Requested time-off can not be greater than the allowed time i.e. "${i.RemainingTimeWithNegative.text}"`,()=>{})}if(y.fromAdmin=1,null!==window.location.pathname.match(/(dashboard)/gi)&&(y.fromAdmin=0),y.requestId=m,ml(!0,"editModalLoader"),"pending"==p){let t=u,a=y.status;console.log(y.status);let i=handlerURL+"/requests_status/"+companyId+"/"+t+"/"+a;$.ajax({type:"GET",url:i,async:!1,success:function(t){!0===t.Status?1==t.code?alertify.confirm("Please Confirm",t.message,function(){e(y)},function(){ml(!1,"editModalLoader")}).set({labels:{ok:"Yes",cancel:"No"}}):2==t.code&&alertify.alert("CONFLICT!",t.message,function(){return!0}):e(y)},error:function(e){}})}else e(y)}),$(document).on("click",".jsEditTimeOff",function(e){e.preventDefault();let r=$(this).closest("tr").data("id"),l=$(this).closest("tr").data("userid"),p=$(this).closest("tr").data("status"),u=$(this).closest("tr").data("view");m=r,c=l,timeRowsOBJEdit={},Modal({Id:"editModal",Title:`Edit Time off for ${$(this).closest("tr").data("name")}`,Body:"",Buttons:['<button class="btn btn-success jsCreateTimeOffBalanceEdit" style="margin-right: 10px;" title="See employee balance" placement="left"><i class="fa fa-balance-scale" aria-hidden="true"></i>&nbsp;View Balance History</button>','<button class="btn btn-black jsCreateTimeOffBalanceBackEdit dn" style="margin-right: 10px;" ><i class="fa fa-long-arrow-left" aria-hidden="true"></i>&nbsp;Back To Create</button>',`<a class="btn btn-success" target="_blank" style="margin-right: 5px; margin-top: -5px;" href="${baseURL}timeoff/print/requests/${r}"><i class="fa fa-print"></i> Print</a>`,`<a class="btn btn-success" target="_blank" style="margin-right: 5px; margin-top: -5px;" href="${baseURL}timeoff/download/requests/${r}"><i class="fa fa-download"></i> Download</a>`,"cancelled"==p||1==u?"":'<button class="btn btn-success jsEditTimeOffBTN">Update</button>'],Loader:"editModalLoader",Ask:!1},async()=>{"cancelled"!=p&&1!=u||$(".jsModalCancel").removeAttr("data-ask");const e=await a(l),m=e.Data.Policies,h=e.Data.Approvers;if(0===m.length)return $(".jsAddTimeOff").remove(),$("#addModal").find(".csModalBody").append('<div class="alert alert-success text-center">We are unable to find policies against this employee.</div>'),void ml(!1,"editModalLoader");const g=await i(r);y.policyId=g.Data.timeoff_policy_sid,y.startDate=moment(g.Data.request_from_date).format("MM/DD/YYYY"),y.endDate=moment(g.Data.request_to_date).format("MM/DD/YYYY"),y.dateRows=JSON.parse(g.Data.timeoff_days),y.status=g.Data.status,y.reason=g.Data.reason,y.comment="",y.sendEmailNotification=0,y.fromAdmin=1,f=y.dateRows.totalTime;let v={};window.timeoff.cPolicies=m,m.map(e=>{void 0===v[e.Category]&&(v[e.Category]=[]),v[e.Category].push(e)});let D='<option value="0" selected="true">[Select a policy]</option>';$.each(v,(e,t)=>{D+=`<optgroup label="${e}">`,t.map(e=>{D+=`<option value="${e.PolicyId}">${e.Title}  (<strong class="text-${1==e.categoryType?"success":"danger"}">${1==e.categoryType?"Paid":"Unpaid"}</strong>)</option>`}),D+="</optgroup>"});const w=await t("edit");$(".jsAddTimeOff").remove(),$("#editModal").find(".csModalBody").append(w),"cancelled"!=p&&1!=u||($(".jsModalCancel").removeAttr("data-ask"),$(".jsEditTimeOffBTN").remove(),$("#jsStatusEdit").append('<option value="cancelled">Canceled</option>')),$("#jsEditPolicy").html(D),$("#jsEditPolicy").select2(),$("#jsStartDateEdit").datepicker({format:"mm-dd-yyyy",changeYear:!0,changeMonth:!0,beforeShowDay:n,onSelect:()=>{$("#asoffdate").text("AS Of  "+moment($("#jsStartDateEdit").val(),"MM/DD/YYYY").format(timeoffDateFormat)),o(),remakeRangeRows("#jsStartDateEdit","#jsEndDateEdit",".jsDurationBox","edit")}}),$("#jsEndDateEdit").datepicker({format:"mm-dd-yyyy",changeYear:!0,changeMonth:!0,beforeShowDay:n,onSelect:()=>{remakeRangeRows("#jsStartDateEdit","#jsEndDateEdit",".jsDurationBox","edit")}}),$("#js-vacation-return-date").datepicker({format:"mm-dd-yyyy",changeYear:!0,changeMonth:!0,minDate:1,beforeShowDay:n}),$("#js-bereavement-return-date").datepicker({format:"mm-dd-yyyy",changeYear:!0,changeMonth:!0,minDate:1,beforeShowDay:n}),$("#js-compensatory-return-date").datepicker({format:"mm-dd-yyyy",changeYear:!0,changeMonth:!0,minDate:1,beforeShowDay:n}),$("#js-compensatory-start-time").datepicker({format:"g:i A",formatTime:"g:i A",step:15}),$("#js-compensatory-end-time").datepicker({format:"g:i A",formatTime:"g:i A",step:15}),null!==window.location.pathname.match(/(lms)|(employee_management_system)|(dashboard)/gi)&&1==window.timeoff.isMine?($("#jsCommentEdit").parent().hide(),$(".jsEmailBoxEdit").hide(),$("#jsStatusEdit").html('<option value="pending">Pending</option>').parent().hide(0),$("#jsStartDateEdit").datepicker("option","minDate",-1),$("#jsEndDatetEdit").datepicker("option","minDate",-1)):($("#jsStatusEdit").select2({minimumResultsForSearch:5}),$("#jsStatusEdit").select2("val",y.status)),CKEDITOR.config.toolbar=[["Bold","Italic","Underline"]],CKEDITOR.replace("jsReasonEdit"),$("#jsCommentEdit").length>0&&CKEDITOR.replace("jsCommentEdit"),$("#jsEditPolicy").select2("val",y.policyId),$("#jsStartDateEdit").val(y.startDate),$("#jsEndDateEdit").val(y.endDate),CKEDITOR.instances.jsReasonEdit.setData(y.reason),y.dateRows.days.map(e=>{let t=timeConvert(e.time),a=moment(e.date,"MM-DD-YYYY").format("MMDDYYYY");timeRowsOBJEdit[a]={},timeRowsOBJEdit[a].hour=t.hours,timeRowsOBJEdit[a].partial=null==e.partial?"fullday":e.partial,timeRowsOBJEdit[a].minute=t.minutes}),remakeRangeRowsEdit("#jsStartDateEdit","#jsEndDateEdit",".jsDurationBox",y.dateRows),o(l),"cancelled"!=p&&1!=u||($("#editModal").find("select").prop("disabled",!0),$("#editModal").find("input").prop("disabled",!0)),s(h,g.Data.history),d(g.Data.history),setUpcomingTimeOffs(c),ml(!1,"editModalLoader")})}),$(document).on("click",".jsCreateTimeOffBalanceEdit",function(e){e.preventDefault(),null!=c?($(this).hide(0),$(".jsCreateTimeOffBalanceBackEdit").show(0),$(".jsCreateTimeOffBTN").hide(0),$("#editModal").find('[data-page="main"]').hide(0),$("#editModal").find('[data-page="balance-view"]').show(0),$("#editModal").find(".csModalHeaderTitle span:nth-child(1)").text($("#editModal").find(".csModalHeaderTitle span:nth-child(1)").text().trim().replace("Edit Time off","Balance History")),$.post(handlerURL,{action:"get_employee_balance_history",companyId:companyId,employerId:employerId,employeeId:c}).done(function(e){var t="";if(0===e.Data.length)t+="<tr>",t+='   <td colspan="6">',t+='       <p class="alert alert-info text-center">',t+="          No balance history found.",t+="       </p>",t+="   </td>",t+="</tr>";else{var a=0,i={},o={};void 0!==e.Data[0].timeoff_breakdown.active.hour&&(i.hour=0,o.hour=0),void 0!==e.Data[0].timeoff_breakdown.active.minutes&&(i.minutes=0,o.minutes=0),e.Data.map(function(e){var n="",s="",d="",r="";0==e.is_manual&&1==e.is_allowed?(n=moment(e.effective_at,"YYYY-MM-DD").format(timeoffDateFormat),s="",d="-",r=""):1==e.is_manual?(n=moment(e.effective_at,"YYYY-MM-DD").format(timeoffDateFormat),s=moment(e.effective_at,"YYYY-MM-DD").format(timeoffDateFormat),d=e.first_name+" "+e.last_name,r=remakeEmployeeName(e,!1),void 0!==e.timeoff_breakdown.active.hours&&(void 0===o.hours&&(o.hours=0),o.hours+=parseInt(e.timeoff_breakdown.active.hours)),void 0!==e.timeoff_breakdown.active.minutes&&(void 0===o.minutes&&(o.minutes=0),o.minutes+=parseInt(e.timeoff_breakdown.active.minutes))):(a++,n=moment(e.request_from_date,"YYYY-MM-DD").format(timeoffDateFormat),s=moment(e.request_to_date,"YYYY-MM-DD").format(timeoffDateFormat),d=e.approverName,r=e.approverRole,void 0!==e.timeoff_breakdown.active.hours&&(void 0===i.hours&&(i.hours=0),i.hours+=parseInt(e.timeoff_breakdown.active.hours)),void 0!==e.timeoff_breakdown.active.minutes&&(void 0===i.minutes&&(i.minutes=0),i.minutes+=parseInt(e.timeoff_breakdown.active.minutes))),t+="<tr>",t+="   <td>",t+="       <strong>",t+=d+"<br>",t+="       </strong>",t+=r,t+="   </td>",t+="   <td>",t+="       <strong>"+e.title+"</strong>",t+="       <p>"+n+(""!=s?" - "+s:"")+"</p>",t+="   </td>",t+=' <td class="'+(0==e.is_added?"text-danger":"text-success")+'"><i class="fa fa-arrow-'+(0==e.is_added?"down ":"up")+'"></i>&nbsp;'+e.timeoff_breakdown.text+"</td>",t+="   <td>",t+=""!=e.note?e.note:"-",t+="   </td>",t+="   <td>",t+=moment(e.created_at,"YYYY-MM-DD").format(timeoffDateFormatWithTime),t+="   </td>",t+="   <td>",t+='       <strong class="text-'+(1==e.is_manual?"success":"danger")+'">'+(1==e.is_manual?"Yes":"No")+"</strong>",t+="   </td>",t+="</tr>",t+="<tr>",t+='   <td colspan="6">',0==e.is_manual&&1==e.is_allowed?t+="       <p><strong>Note</strong>: A balance of <b>"+e.added_time/60+'</b> hours is available against policy <b>"'+e.title+'"</b> effective from <b>'+moment(e.effective_at,"YYYY-MM-DD").format(timeoffDateFormat)+"</b>":t+="       <p><strong>Note</strong>: <strong>"+d+"</strong> has "+(1==e.is_manual?1==e.is_added?"added balance":"subtracted balance":"approved time off")+' against policy "<strong>'+e.title+'</strong>" on <strong>'+moment(e.created_at,"YYYY-MM-DD").format(timeoffDateFormatWithTime)+"</strong> which will take effect "+(n==s?"on ":" from ")+" <strong>"+n+(n!=s?" to  "+s:"")+"</strong>.</p>",t+="   </td>",t+="</tr>"}),$(".jsCreateTimeOffNumber").text(a),$(".jsCreateTimeOffTimeTaken").text(getText(i)),$(".jsCreateTimeOffManualAllowedTime").text(getText(o))}$("#jsCreateTimeoffBalanceBody").html(t),ml(!1,"balance-view")})):alertify.alert("Warning!","Please, select an employee.")}),$(document).on("click",".jsCreateTimeOffBalanceBackEdit",function(e){e.preventDefault(),$(this).hide(0),$(".jsCreateTimeOffBalanceEdit").show(0),$(".jsCreateTimeOffBTN").show(0),$("#editModal").find('[data-page="balance-view"]').hide(0),$("#editModal").find('[data-page="main"]').show(0),$("#editModal").find(".csModalHeaderTitle span:nth-child(1)").text($("#editModal").find(".csModalHeaderTitle span:nth-child(1)").text().trim().replace("Balance History","Edit Time off"))}),$(document).on("change","#jsEditPolicy",function(){if(null!==$(this).val()){var e=getPolicy($(this).val(),window.timeoff.cPolicies);null==e.OffDays?policyOffDays=void 0:policyOffDays=e.OffDays.split(",")}else policyOffDays=void 0})});