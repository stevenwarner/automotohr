$(function(){function e(e){e.preventDefault(),$("#js-filter-employee").select2("val","all"),$("#js-filter-policies").select2("val","all"),$("#js-filter-status").select2("val","all"),$("#js-filter-sort").select2("val","upcoming"),$("#js-filter-from-date").val(""),$("#js-filter-end-date").val(""),r.Requests.Main.filter.employees="all",r.Requests.Main.filter.policies="all",r.Requests.Main.filter.status="all",r.Requests.Main.filter.order="upcoming",r.Requests.Main.filter.startDate="",r.Requests.Main.filter.endDate="",a()}function t(e){e.preventDefault(),r.Requests.Main.filter.employees=$("#js-filter-employee").val(),r.Requests.Main.filter.policies=$("#js-filter-policies").val(),r.Requests.Main.filter.status=$("#js-filter-status").val(),r.Requests.Main.filter.order=$("#js-filter-sort").val(),r.Requests.Main.filter.startDate=$("#js-filter-from-date").val(),r.Requests.Main.filter.endDate=$("#js-filter-to-date").val(),a()}function a(){void 0!==window.timeoff.employees?null==n&&(ml(!0,"requests"),$(".js-error-row").remove(),n=$.post(handlerURL,r.Requests.Main,function(e){if(n=null,!0!==e.Redirect)return!1===e.Status&&1==r.Balances.Main.page?($(".js-ip-pagination").html(""),$("#js-data-area").html(`<tr class="js-error-row"><td colspan="${$(".js-table-head").find("th").length}"><p class="alert alert-info text-center">${e.Response}</p></td></tr>`),void ml(!1,"requests")):!1===e.Status?($(".js-ip-pagination").html(""),void ml(!1,"requests")):void s(e);alertify.alert("WARNING!","Your session expired. Please, re-login to continue.",()=>{window.location.reload()})})):setTimeout(a,1e3)}function s(e){let t="";if(0==e.Data.length)return $("#js-data-area").html('<tr><td colspan="6"><p class="alert alert-info text-center">No time-offs found.</p></td></tr>'),void ml(!1,"requests");$.each(e.Data,function(e,a){if(a.employee_sid==employeeId)return;let s=a.allow_update,n=getUserById(a.employee_sid,window.timeoff.employees,"user_id");if(0==Object.keys(n).length)return;let l=r.Requests.Main.type,d="";if("pending"==l?($("#request_status_info").show(),"approved"==a.level_status?d="background: rgba(129, 180, 49, .2)":"rejected"==a.level_status&&(d="background: rgba(242, 222, 222, .5)")):$("#request_status_info").hide(),t+=`<tr class="jsBox" data-id="${a.sid}" style="${d}" data-status="${a.status}" data-userid="${a.employee_sid}" data-name="${n.first_name} ${n.last_name}">`,t+='    <td scope="row">',t+='        <div class="employee-info">',t+="            <figure>",t+=`                <img src="${getImageURL(n.image)}" class="img-circle emp-image" />`,t+="            </figure>",t+='            <div class="text">',t+=`                <h4>${n.first_name} ${n.last_name} </h4>`,t+=`                <p>${remakeEmployeeName(n,!1)} </p>`,t+=`                <p><a href="${baseURL}employee_profile/${n.user_id}" target="_blank">Id: ${getEmployeeId(n.user_id,n.employee_number)}</a></p>\n\t\t\t\t${n.anniversary_text}`,t+="            </div>",t+="        </div>",t+="    </td>",t+=`<td>\n                        <div class="upcoming-time-info">            \n                            <div class="icon-image">                   \n                                <img src="${baseURL}assets/images/upcoming-time-off-icon.png" class="emp-image" alt="emp-1">             \n                            </div>             \n                            <div class="text">                  \n                                <h4>${a.request_from_date==a.request_to_date?moment(a.request_from_date).format(timeoffDateFormat):moment(a.request_from_date).format(timeoffDateFormat)+" - "+moment(a.request_to_date).format(timeoffDateFormat)}</h4>                  \n                                <span>${a.title} (<strong class="text-${1==a.categoryType?"success":"danger"}">${1==a.categoryType?"Paid":"Unpaid"}</strong>)</span><br />          \n                                <span>${a.breakdown.text}</span>\n                            </div>       \n                        </div>\n                    </td>`,t+=`<td>\n                        <div class="progress" style="margin-top: 10px;">\n                            <div class="progress-bar progress-bar-success" role="progressbar" style="width: ${"pending"==a.status?"pending"!=a.level_status?50:0:100}%;">\n                                <span class="sr-only"> ${"pending"==a.status?"pending"!=a.level_status?50:0:100} % Complete</span>\n                            </div>\n                            <p>${"pending"==a.status?"pending"!=a.level_status?50:0:100}%</p>\n                        </div>\n                        ${o(a.history)}\n                    </td>`,t+=`<td class="cs-vam">\n                        <p>${""==a.reason||null==a.reason?"-":a.reason}</p>\n                    </td>`,t+=`<td class="cs-vam">\n                        <p>${moment(a.created_at).format(timeoffDateFormatWithTime)}</p>\n                    </td>`,t+="    <td>",t+='    <div class="dropdown" style="margin-top: 10px;">\n                            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">\n                            Action\n                            <span class="caret"></span>\n                            </button>\n                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="right:0; left: auto;">',"yes"==s){t+='<li><a href="#" class="jsEditTimeOff">Edit Time-off</a></li>';let e=i(a.history);-1==$.inArray(employerId,e)&&(t+=`<li><a href="#" class="jsEditNote" title="Edit Comment" data-empSid="${n.user_id}" data-reqSid="${a.sid}">Edit Comment</a></li>`)}"yes"==s&&(t+=` ${"cancelled"==a.status||"cancel"==a.status?"":`<li><a href="#" class="${1==a.archive?"jsActiveTimeOff":"jsArchiveTimeOff"}">${1==a.archive?"Activate":"Archive"}</a></li>`}`),t+=`<li><a href="#" class="jsHistoryTimeOff">View History</a></li>\n                                        <li role="separator" class="divider"></li>\n                                        <li><a href="${baseURL}timeoff/print/requests/${a.sid}" target="_blank">Print</a></li>\n                                                        <li><a href="${baseURL}timeoff/download/requests/${a.sid}" target="_blank">Download</a></li>\n                            </ul>\n                        </div>`,t+="    </td>",t+="</tr>"}),$("#js-data-area").html(t),$(".js-type-popover").popover({html:!0,trigger:"hover"}),$('[data-toggle="tooltip"]').tooltip(),$(".csApproverBox").popover({html:!0,trigger:"hover",placement:"left"}),ml(!1,"requests")}function i(e){if(0==e.length)return"";let t=[];return e.map(e=>{if(-1!==$.inArray(e.userId,t))return"";t.push(e.userId)}),t}function o(e){if(0==e.length)return"";let t="",a=[];return e.map(e=>{if("create"==e.action)return"";if("{}"==e.note)return"";let s=JSON.parse(e.note);if(null==s.canApprove)return"";let i=`${remakeEmployeeName(e)}`,o="";return"pending"==s.status?"":("approved"==s.status?(i+=` has approved the time-off at ${moment(e.created_at).format(timeoffDateFormatWithTime)}`,o='<i class="fa fa-check-circle text-success"></i>'):"rejected"==s.status?(i+=` has rejected the time-off at ${moment(e.created_at).format(timeoffDateFormatWithTime)}`,o='<i class="fa fa-times-circle text-danger"></i>'):"cancelled"!=s.status&&"cancel"!=s.status||(i+=` has cancelled the time-off at ${moment(e.created_at).format(timeoffDateFormatWithTime)}`,o='<i class="fa fa-times-circle text-danger"></i>'),-1!==$.inArray(e.userId,a)?"":(a.push(e.userId),void(t+=`\n                    <div class="csApproverBox" title="Approver" data-content="${i}">\n                        <img src="${null==e.image||""==e.image?awsURL+"test_file_01.png":awsURL+e.image}" style="width: 40px; height: 40px;" />\n                        ${o}\n                    </div>\n                `)))}),t}let r={Requests:{Main:{action:"get_requests",companyId:companyId,employerId:employerId,employeeId:employeeId,level:level,type:"pending",filter:{employees:"all",policies:"all",status:"all",order:"upcoming",startDate:"",endDate:""},public:0}}},n=null;$("#js-filter-status").select2(),$("#js-filter-sort").select2({minimumResultsForSearch:-1}),$("#js-filter-from-date").datepicker({dateFormat:"mm-dd-yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#js-filter-to-date").datepicker("option","minDate",e)}}),$("#js-filter-to-date").datepicker({dateFormat:"mm-dd-yy",changeYear:!0,changeMonth:!0}).datepicker("option","minDate",$("#js-filter-from-date").val()),$(document).on("click",".js-apply-filter-btn",t),$(document).on("click",".js-reset-filter-btn",e),$(document).on("change",".jsEditResetCheckbox",t),$(".jsReportTab").click(function(e){e.preventDefault(),r.Requests.Main.type=$(this).data("key"),$(".jsReportTab").parent().removeClass("active").removeClass("csActiveTab"),$(this).parent().addClass("active").addClass("csActiveTab"),a()}),$('.jsReportTab[data-key="pending"]').trigger("click"),$("#js-filter-sort").change(function(){r.Requests.Main.filter.order=$(this).val(),a()}),$(document).on("click",".jsArchiveTimeOff",function(e){e.preventDefault();let t=$(this).closest("tr").data("id");alertify.confirm("Do you really want to archive this time off?",()=>{ml(!0,"requests"),$.post(handlerURL,Object.assign({action:"archive_request",companyId:companyId,employerId:employerId,employeeId:employeeId},{requestId:t,archive:1}),e=>{alertify.alert("SUCCESS!",e.Response,()=>{window.location.reload()})})},()=>{}).set("labels",{ok:"YES",cancel:"NO"}).setHeader("CONFIRM!")}),$(document).on("click",".jsActiveTimeOff",function(e){e.preventDefault();let t=$(this).closest("tr").data("id");alertify.confirm("Do you really want to activate this time off?",()=>{ml(!0,"requests"),$.post(handlerURL,Object.assign({action:"archive_request",companyId:companyId,employerId:employerId,employeeId:employeeId},{requestId:t,archive:0}),e=>{alertify.alert("SUCCESS!",e.Response,()=>{window.location.reload()})})},()=>{}).set("labels",{ok:"YES",cancel:"NO"}).setHeader("CONFIRM!")}),$(document).on("click",".jsHistoryTimeOff",function(e){e.preventDefault();let t=$(this).closest("tr").data("id");Modal({Id:"jsTimeOffHistory",Title:"Time-off History",Body:' \n                <div id="jsData">\n\n                </div>\n                <div class="tabel-responsive">\n                    <table class="table table-striped csCustomTableHeader">\n                        <thead>\n                            <tr>\n                                <th>Employee</th>\n                                <th>Details</th>\n                                <th>Action</th>\n                                <th>Comment</th>\n                                <th>Action Taken</th>\n                            </tr>\n                        </thead>\n                        <tbody id="jsTimeOffHistoryTable"></tbody>\n                    </table>\n                </div>',Loader:"jsTimeOffHistoryLoader"},()=>{ml(!0,"jsTimeOffHistoryLoader"),$("#jsPolicyHistoryTable").html(""),$.post(handlerURL,Object.assign({action:"get_request_history",companyId:companyId,employerId:employerId,employeeId:employeeId},{requestId:t}),e=>{if(!0===e.Redirect)return void alertify.alert("WARNING!","Your session expired. Please, re-login to continue.",()=>{window.location.reload()});if($("#jsData").html(`<div class="row">\n                            <div class="col-sm-3">\n                                ${$(this).closest("tr").find(".employee-info").parent().html()}\n                            </div>\n                            <div class="col-sm-4">\n                                ${$(this).closest("tr").find(".upcoming-time-info").parent().html()}\n                            </div>\n                            <div class="clearfix"></div>\n                            <hr />\n                        </div>\n                        `),!1===e.Status)return alertify.alert("WARNING!",e.Response,()=>{}),void ml(!1,"jsTimeOffHistoryLoader");let t="";0===e.Data.length?t=`\n                            <tr>\n                                <td colspan="5">\n                                    <p class="alert alert-info text-center">${e.Response}</p>\n                                </td>\n                            </tr>\n                        `:e.Data.map(e=>{let a=JSON.parse(e.note),s="",i="-";"create"==e.action?s="Time-off created.":(void 0!==a.status?("archive"==a.status?s="Time-off marked as archive":"activate"==a.status?s="Time-off marked as active":"approved"==a.status&&1==a.canApprove?s="Time-off approved 100%":"approved"==a.status&&0==a.canApprove?s="Time-off approved 50%":"rejected"==a.status&&1==a.canApprove?s="Time-off rejected 100%":"rejected"==a.status&&0==a.canApprove?s="Time-off rejected 50%":"pending"==a.status&&0==a.canApprove?s="Time-off updated":"cancelled"==a.status&&(s="Time-off cancelled"),null!=a.comment&&""!=a.comment&&(i=a.comment)):s="","update"==e.action&&""==s&&(s="Time-off updated.")),t+="<tr>",t+="<td>",t+='        <div class="employee-info">',t+="            <figure>",t+=`                <img src="${getImageURL(e.image)}" class="img-circle emp-image" />`,t+="            </figure>",t+='            <div class="text">',t+=`                <h4>${e.first_name} ${e.last_name} </h4>`,t+=`                <p>${remakeEmployeeName(e,!1)}</p>`,t+=`                <p><a href="${baseURL}employee_profile/${e.userId}" target="_blank">Id: ${getEmployeeId(e.userId,e.employee_number)}</a></p>`,t+="            </div>",t+="        </div></td>",t+="                <td>",void 0!==a.details&&(t+=`                   <div class="upcoming-time-info">            \n                        <div class="icon-image">                   \n                            <img src="${baseURL}assets/images/upcoming-time-off-icon.png" class="emp-image" alt="emp-1">             \n                        </div>             \n                        <div class="text">                  \n                            <h4>${a.details.startDate==a.details.endDate?moment(a.details.startDate).format(timeoffDateFormat):moment(a.details.startDate).format(timeoffDateFormat)+" - "+moment(a.details.endDate).format(timeoffDateFormat)}</h4>                  \n                            <span>${a.details.policyTitle}</span><br />          \n                            <span>${get_array_from_minutes(a.details.time,e.user_shift_hours,"H:M").text}</span>\n                        </div>       \n                    </div>`),t+="                </td>",t+=`                <td>${s}</td>`,t+=`                <td>${i}</td>`,t+=`                <td>${moment(e.created_at).format(timeoffDateFormatWithTime)}</td>`,t+="            </tr>"}),$("#jsTimeOffHistoryTable").html(t),ml(!1,"jsTimeOffHistoryLoader")})})}),$(document).on("click",".jsEditNote",function(){let e=$(this).closest(".jsBox").data("id"),t=$(this).attr("data-empSid"),a={action:"get_employee_note",companyId:companyId,employerId:employerId,employeeId:t,requestId:e};$.post(handlerURL,a,function(a){$("#jsRequestSid").val(e),$("#jsEmployeeSid").val(t),$("#jsNoteSection").val(a.Comment),$("#jsAddNoteModal").modal("show")})}),$(document).on("click","#jsSaveEmployeeNote",function(){if($("#jsAddNoteModalLoader").show(),0==$("#jsNoteSection").val().trim().length)alertify.alert("Notice","Comment is required!");else{$("#jsSaveEmployeeNote").prop("disabled",!0);let e={action:"update_employee_note",companyId:companyId,employerId:employerId,employeeId:$("#jsEmployeeSid").val(),requestId:$("#jsRequestSid").val(),comment:$("#jsNoteSection").val()};$.post(handlerURL,e,function(e){alertify.alert("SUCCESS!",e.Response,function(){$("#jsAddNoteModal").modal("hide"),a()})})}})});