$((function importHistoricalTimeOffs(){const loader="#jsImportHistoricLoader",loaderText=".jsLoaderText";let fileData={},tableData=[],records=[],hasFalse=!1,fileDataVerificationObj={};var xhr=null;let missingEmployeesObj={},missingPoliciesObj={};var chunkOBJ={current:0,chunkSize:100,loaded:0,records:[],totalChunks:0,recordsLength:0};let firstName=["employeefirstname","firstname"],LastName=["employeelastname","lastname"],approvedBy=["approvedby","approvername"],policyName=["policy","policyName","leavetype"],requestedHours=["requestedhours","requesthours"],leaveFrom=["startdate","leavefrom"],leaveTo=["enddate","leaveto"],status=["status"],submittedDate=["createddate","actiondate","submitteddate"],statusDate=["approveddeclineddate","statusdate","approvedate","declinedate"],employeeComment=["employeecomment","employeecomments","comment"],statusComment=["managercomment","managercomments"];function readFile(f){if($(".js-submit-btn").prop("disabled",!0).addClass("disabled"),0===Object.keys(f).length)return alertify.alert("WARNING!","Please, select a file.",cb);if(!0===f.hasError)return alertify.alert("WARNING!","Invalid file is uploaded.",cb);$(".js-submit-btn").removeAttr("disabled").removeClass("disabled");let fileReader=new FileReader;fileReader.onload=function(uploadedFileReference){fileData=uploadedFileReference.target.result,processFile()},fileReader.readAsText(f)}function processFile(){if(!fileData)return alertify.alert("Warning!","File is empty.",cb);hasFalse=!1,tableData=[];let parsedData=fileData.split(/\n/g),indexes=parsedData[0].split(",");indexes=indexes.map((function(v){let index=checkIndex(v.toLowerCase().replace(/[^a-z]/g,"").trim());return-1===index?"extra":index})),parsedData.splice(0,1);let columnLength=indexes.length;parsedData.map((function(v,rowId){var tmp=v.split(","),record=new Object,i=0,len=tmp.length;if(!v)return!1;for(;i<len;i++)record[indexes[i]]=tmp[i];tmp.length!=columnLength&&(hasFalse=1),tableData.push({row_id:rowId+1,is_faulty:tmp.length==columnLength,data:record}),records.push(record)})),1===hasFalse&&generateTableForMissingData()}function checkIfEmployeeExists(){let employeeNameArray={},policyNameArray={};tableData.map((function(record){let fullName=record.data.employee_first_name+" "+record.data.employee_last_name,fullNameSlug=fullName.toLowerCase().trim().replace(/[^a-z]/gi,""),approverFullName=record.data.approver_full_name,approverFullNameSlug=approverFullName.toLowerCase().trim().replace(/[^a-z]/gi,""),policy=record.data.policy,policySlug=policy.toLowerCase().trim().replace(/[^a-z]/gi,"");employeeNameArray[fullNameSlug]=fullName,employeeNameArray[approverFullNameSlug]=approverFullName,policyNameArray[policySlug]=policy})),$(loader).show(),$(loaderText).text("Please wait while we are process the file."),fileDataVerificationObj.employees=employeeNameArray,fileDataVerificationObj.policies=policyNameArray,verifyData(Object.keys(fileDataVerificationObj.employees),Object.keys(fileDataVerificationObj.policies))}function verifyData(employeeList,policyList){$.post(baseURI+"timeoff/import/historic/verify",{employees:employeeList,policies:policyList}).success((function(resp){$(loader).hide();let missingEmployees=[],me="";for(let index in resp.employees)0===resp.employees[index]?(me+='<tr class="bg-danger">',me+=" <td>"+fileDataVerificationObj.employees[index]+"</td>",me+="</tr>",missingEmployees.push(fileDataVerificationObj.employees[index])):missingEmployeesObj[index]=resp.employees[index];let missingPolicies=[],me2="";for(let index in resp.policies)0===resp.policies[index]?(me2+='<tr class="bg-danger">',me2+=" <td>"+fileDataVerificationObj.policies[index]+"</td>",me2+="</tr>",missingPolicies.push(fileDataVerificationObj.policies[index])):missingPoliciesObj[index]=resp.policies[index];let t1="",t2="";missingEmployees.length&&(t1=getTable("jsEmployeeTable","The following employees are missing.",["Employee Name"]),t1=t1.replace(/{{TABLE_ROWS}}/i,me)),missingPolicies.length&&(t2=getTable("jsEmployeeTable","The following policies are missing.",["Policy Name"]),t2=t2.replace(/{{TABLE_ROWS}}/i,me2)),(missingEmployees.length||missingPolicies.length)&&Modal({Id:"jsModal",Loader:"jsModalLoader",Title:"Missing Employees / Policies",Buttons:['<button class="btn btn-success" id="jsImportForce">Continue</button>'],Body:'<div class="container-fluid"><div id="jsModalBody"></div></div>'},(function(){$("#jsModalBody").html(t1+t2),ml(!1,"jsModalLoader")}))}))}function startImportProcess(){$("#jsModal").remove(),$(loader).show(),$(loaderText).text("Please wait, while we import time offs. It may take several minutes."),chunkOBJ.records=[],chunkOBJ.recordsLength=records.length,chunkOBJ.totalChunks=Math.ceil(chunkOBJ.recordsLength/Math.ceil(chunkOBJ.recordsLength/chunkOBJ.chunkSize)),1!=chunkOBJ.totalChunks?chunkOBJ.records=_.chunk(records,chunkOBJ.totalChunks):chunkOBJ.records.push(records),uploadChunk()}function uploadChunk(){void 0!==chunkOBJ.records[chunkOBJ.current]?startAddProcess(chunkOBJ.records[chunkOBJ.current]):console.log("All chunks are being uploaded..")}function startAddProcess(chunk){if(null===xhr){if(void 0===chunkOBJ.records[chunkOBJ.current])return $(loader).hide(),void alertify.alert("SUCCESS!","You have successfully imported time offs.",(function(){window.location.reload()}));chunkOBJ.loaded+=chunk.length;var messageRow="Please, be patient as we import time offs.<br />";messageRow+="It may take a few minutes<br />",messageRow+="Importing "+chunkOBJ.loaded+" of "+chunkOBJ.recordsLength+" time-offs.",$(loader).show(),$(loaderText).html(messageRow),xhr=$.post(baseURI+"timeoff/import/historic/upload",{chunk:chunk,data:{employees:missingEmployeesObj,policies:missingPoliciesObj}},(function(resp){return xhr=null,!1===resp.Status?(alertify.alert("ERROR!","Something went wrong."),void $(loader).hide()):(chunkOBJ.current++,chunkOBJ.current>=chunkOBJ.records.length?($(loader).hide(),void alertify.alert("SUCCESS!","You have successfully imported time offs.",(function(){window.location.reload()}))):void setTimeout((function(){uploadChunk()}),1e3))}))}}function generateTableForMissingData(){let table=getTable("jsMDTable",'Please fix the "," issue in order to proceed with the import.',["Row #","Employee Name"]),rows="";tableData.map((function(v){!1===v.is_faulty&&(rows+='<tr class="bg-danger">',rows+="   <td>"+(v.row_id+1)+"</td>",rows+="   <td>"+v.data.employee_first_name+" "+v.data.employee_last_name+"</td>",rows+="</tr>")})),Modal({Id:"jsMDModel",Title:'Improper Data (fix "," issue)',Body:'<div class="container-fluid"><div id="jsMDModelBody"></div></div>',Loader:"jsMDModelLoader"},(function(){$("#jsMDModelBody").html(table.replace(/{{TABLE_ROWS}}/gi,rows)),ml(!1,"jsMDModelLoader")}))}function getTable(tableId,tableMessage,columns){let table="";return table+='<p class="alert alert-danger"><strong><em>'+tableMessage+"</em></strong></p>",table+='<div class="table-responsive">',table+='  <table class="table table-condensed table-bordered" id="'+tableId+'">',table+="      <thead>",table+="          <tr>",columns.map((function(column){table+='              <th scope="col">'+column+"</th>"})),table+="          </tr>",table+="      </thead>",table+="      <tbody>{{TABLE_ROWS}}</tbody>",table+="  </table>",table+="</div>",table}function checkIndex(index){let i,len,array;for(i=0,len=firstName.length,array=firstName;i<len;i++)if(index==array[i])return"employee_first_name";for(i=0,len=LastName.length,array=LastName;i<len;i++)if(index==array[i])return"employee_last_name";for(i=0,len=approvedBy.length,array=approvedBy;i<len;i++)if(index==array[i])return"approver_full_name";for(i=0,len=policyName.length,array=policyName;i<len;i++)if(index==array[i])return"policy";for(i=0,len=requestedHours.length,array=requestedHours;i<len;i++)if(index==array[i])return"requested_hours";for(i=0,len=leaveFrom.length,array=leaveFrom;i<len;i++)if(index==array[i])return"leave_from";for(i=0,len=leaveTo.length,array=leaveTo;i<len;i++)if(index==array[i])return"leave_to";for(i=0,len=status.length,array=status;i<len;i++)if(index==array[i])return"status";for(i=0,len=submittedDate.length,array=submittedDate;i<len;i++)if(index==array[i])return"submitted_date";for(i=0,len=statusDate.length,array=statusDate;i<len;i++)if(index==array[i])return"status_date";for(i=0,len=employeeComment.length,array=employeeComment;i<len;i++)if(index==array[i])return"employee_comment";for(i=0,len=statusComment.length,array=statusComment;i<len;i++)if(index==array[i])return"status_comment";return-1}function cb(){}$("#jsFileInput").mFileUploader({fileLimit:-1,allowedTypes:["csv"],onSuccess:readFile,onError:function(){fileData="",$(".js-submit-btn").prop("disabled",!0).addClass("disabled")},onClear:function(){fileData="",$(".js-submit-btn").prop("disabled",!0).addClass("disabled")}}),$("#jsImportBtn").click((function(e){return e.preventDefault(),1===hasFalse?generateTableForMissingData():checkIfEmployeeExists()})),$(document).on("click","#jsImportForce",(function(event){return event.preventDefault(),alertify.confirm("This action will skip rows whose record doesn't exists. <br> Do you want to continue?",startImportProcess,cb)}))}));