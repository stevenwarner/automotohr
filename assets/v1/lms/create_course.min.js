$(function(){function e(e){let s=[];$(".jsScormCourseItem").each(function(e){let o=$(this).data("row_no");0==e?s.push($("#jsAddCourseLanguage").val()):s.push($("#jsAddCourseLanguage"+o).val())}),$(".jsScormCourseItem").each(function(o){let r=$(this).data("row_no");var t="",a="";0==o?t=$("#jsAddCourseLanguage").val():(t=$("#jsAddCourseLanguage"+r).val(),a=r);var d="";e.map(function(e){s.includes(e)&&e!=t?d+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:d+=`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),$("#jsAddCourseLanguage"+a).html(d)})}function s(e){m=e,Modal({Id:g,Title:"Create Course",Loader:h,Cl:"container",Ask:!0,Body:'<div id="'+g+'Body"></div>'},o)}function o(){C=[],null!==p&&p.abort(),p=$.ajax({url:apiURL+"lms/course/view",method:"GET"}).success(function(e){p=null,$("#"+g+"Body").html(e),$("#jsAddCourseLanguage").select2({minimumResultsForSearch:-1}),$("#jsAddCourseVersion").select2({minimumResultsForSearch:-1}),$("#jsAddCourseJobTitles").select2({closeOnSelect:!1}),$("#jsAddCourseReassignType").val("year"),$("#jsAddCourseBanner").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"]}),$("#jsAddCourseFile").msFileUploader({fileLimit:"200mb",allowedTypes:["zip"]}),$("#jsAddCourseVideoFile").msFileUploader({fileLimit:"200mb",allowedTypes:["mp4","ppt","pptx","mov","wav"]}),$("input[name=jsAddCourseType][value=scorm]").attr("checked","checked"),$("#jsAddCourseLanguage").select2("val","english"),$(".jsAddCourseScormBox").removeClass("hidden"),$(".jsPartnershipLogoSection").addClass("hidden"),$("input[name=jsAddSecondaryLogo][value=no]").attr("checked","checked"),$("#jsPartnershipLogo").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"]}),$("#jsAddCourseStartPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsAddCourseEndPeriod").datepicker("option","minDate",e)}}).datepicker("option","maxDate",$("#jsAddCourseEndPeriod").val()),$("#jsAddCourseEndPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsAddCourseStartPeriod").datepicker("option","maxDate",e),$(".jsAddIndefiniteCourse").prop("checked",!1),$(".jsRecurringCourses").show()}}).datepicker("option","minDate",$("#jsAddCourseStartPeriod").val()),$('.jsAddCourseFileType[value="'+j+'"]').trigger("click"),ml(!1,h)}).fail(handleErrorResponse).done(function(){p=null,ml(!1,"jsPageLoader")})}async function r(e){const s=[];e.course_title||s.push("Course title is required."),e.job_titles.length||s.push("Select at least one job title."),e.course_recurring_in?e.course_recurring_in.isValidInteger()||s.push("Please enter valid integer value."):s.push("Course recurring number is required."),e.course_start_period||s.push("Course start date is required."),$(".jsAddIndefiniteCourse").is(":checked")?e.course_end_period=null:e.course_end_period.length||s.push("Course end date is required."),e.course_sort_order||s.push("Course sort order is required."),e.course_recurring_type.length||s.push("Course recurring type is required."),e.course_type||s.push("Course type is required."),Object.keys(e.course_banner).length?e.course_banner.errorCode&&s.push(e.course_banner.errorCode):s.push("Please upload the Course banner."),"scorm"==e.course_type&&"yes"==e.course_secondary_logo_type&&(Object.keys(e.course_secondary_logo).length?e.course_secondary_logo.errorCode&&s.push(e.course_secondary_logo.errorCode):s.push("Please upload the Course Secondary Logo.")),e.course_questions=C,"link"===e.course_file_type&&"manual"===e.course_type?e.course_file_link?e.course_file_link.isValidYoutubeLink()||e.course_file_link.isValidVimeoLink()||s.push("Invalid YouTube / Vimeo link."):s.push("YouTube / Vimeo link is required."):"manual"===e.course_type&&(Object.keys(e.course_file).length?e.course_file.errorCode&&s.push(e.course_file.errorCode):s.push("Please upload the Course file."));let o=[];if("scorm"==e.course_type&&$(".jsScormCourseItem").each(function(e){var r=$(this).data("row_no"),t="",a="";0==e?(t="jsAddCourseFile",a="jsAddCourseLanguage"):(t="jsAddCourseFile"+r,a="jsAddCourseLanguage"+r);var d=$("#"+t).msFileUploader("get"),n=$("#"+a).val();Object.keys(d).length?d.errorCode?s.push(d.errorCode):o.push({key:n,value:d}):s.push("Please upload the scorm "+n+" file.")}),"manual"!==e.course_type||C.length||s.push("At least one question is required for manual course."),s.length)return alertify.alert("ERROR!",getErrorsStringFromArray(s),CB);if(ml(!0,h),Object.keys(e.course_file).length&&"manual"===e.course_type){let s=await uploadFile(e.course_file);if(s=JSON.parse(s),!s.data)return alertify.alert("ERROR","Failed to upload the file.",function(){ml(!1,h)});e.course_file=s.data}else Object.keys(o).length&&"scorm"===e.course_type?(await Promise.all(o.map(async e=>{let s=await uploadFile(e.value);return s=JSON.parse(s),e.filePath=s.data,e})),delete e.course_file):e.course_file=e.course_file_link;delete e.course_file_link,e.company_code=m;let r=await uploadFile(e.course_banner);if(r=JSON.parse(r),!r.data)return alertify.alert("ERROR","Failed to upload the course banner.",function(){ml(!1,h)});if(e.course_banner=r.data,"yes"==e.course_secondary_logo_type){let s=await uploadFile(e.course_secondary_logo);if(s=JSON.parse(s),!s.data)return alertify.alert("ERROR","Failed to upload the course secondary logo.",function(){ml(!1,h)});e.course_secondary_logo=s.data}try{const s=await t(e);return"scorm"===e.course_type&&await Promise.all(o.map(async e=>{await a(s.courseId,e.filePath,e.key)})),alertify.alert("SUCCESS!",s.data,function(){getLMSDefaultCourses(),$("#"+g).remove()})}catch(e){return ml(!1,h),alertify.alert("ERROR!",getErrorsStringFromArray(e.errors,"Errors!!"),CB)}}function t(e){return new Promise(function(s,o){$.ajax({url:apiURL+"lms/course",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(e)}).success(s).fail(function(e){o(e.responseJSON)})})}function a(e,s,o){return new Promise(function(r,t){const a={scorm_file:s,scorm_language:o};$.ajax({url:baseURI+"lms/course/scorm/parse/"+e,method:"POST",data:a}).success(r).fail(function(e){t(e.responseJSON)})})}function d(e){ml(!1,h),C.push(e),i(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}function n(){$(".jsAddUploadFile").addClass("hidden"),$(".jsAddLinkFile").addClass("hidden"),"file"==j?$(".jsAddUploadFile").removeClass("hidden"):$(".jsAddLinkFile").removeClass("hidden")}function i(){if(!C.length)return $("#jsAddCourseQuestionsList").html('<tr><th colspan="3"><p class="alert alert-info text-center">No questions found yet.</p></th></tr>');let e="";C.map(function(s){e+='<tr data-key="'+s.question_id+'">',e+='\t<td class="vam">'+s.question_title+"</td>",e+='\t<td class="vam text-center">'+s.question_type.replace(/_/gi," ").toUpperCase()+"</td>",e+='\t<td class="vam text-center">',e+='\t\t<button type="button" class="btn btn-warning jsEditQuestion" title="Edit question" placement="top">',e+='\t\t\t<i class="fa fa-edit" aria-hidden="true"></i>',e+="\t\t</button>",e+='\t\t<button type="button" class="btn btn-danger jsDeleteQuestion" title="Delete question" placement="top">',e+='\t\t\t<i class="fa fa-times-circle" aria-hidden="true"></i>',e+="\t\t</button>",e+="\t</td>",e+="</tr>"}),$("#jsAddCourseQuestionsList").html(e)}function u(e){C=C.filter(function(s){return s.question_id!=e}),i()}function l(e){let s=C.filter(function(s){return s.question_id==e});return s[0]}function c(){var e=1e4,s=99999;return Math.floor(Math.random()*(s-e+1))+e}let p=null,m=0,g="jsCreateCourseModel",h="jsCreateCourseModelLoader",C=[],j="file";$(document).on("click",".jsAddCourseCreateBtn",function(e){e.preventDefault();const s={course_title:$("#jsAddCourseTitle").val().trim(),course_content:$("#jsAddCourseAbout").val().trim(),job_titles:$("#jsAddCourseJobTitles").val()||[],course_type:$(".jsAddCourseType:checked").val(),course_recurring_in:$("#jsAddCourseReassignIn").val(),course_recurring_type:$("#jsAddCourseReassignType").val(),course_start_period:$("#jsAddCourseStartPeriod").val().trim(),course_end_period:$("#jsAddCourseEndPeriod").val().trim(),course_sort_order:$("#jsAddCourseSortOrder").val().trim(),course_version:$("#jsAddCourseVersion").val(),course_file_type:$(".jsAddCourseFileType:checked").val(),course_secondary_logo_type:$(".jsAddSecondaryLogo:checked").val(),course_secondary_logo:$("#jsPartnershipLogo").msFileUploader("get"),course_file_link:$("#jsAddCourseLink").val(),course_file:$("#"+("scorm"===$(".jsAddCourseType:checked").val()?"jsAddCourseFile":"jsAddCourseVideoFile")).msFileUploader("get")||{},course_banner:$("#jsAddCourseBanner").msFileUploader("get"),course_questions:C};r(s)}),$(document).on("click",".jsAddCourseType",function(){$(".jsAddCourseScormBox").addClass("hidden"),$(".jsAddManualCourseBox").addClass("hidden"),"scorm"===$(this).val()?$(".jsAddCourseScormBox").removeClass("hidden"):($(".jsAddManualCourseBox").removeClass("hidden"),n(),i())}),$(document).on("click",".jsAddSecondaryLogo",function(){"yes"===$(this).val()?$(".jsPartnershipLogoSection").removeClass("hidden"):$(".jsPartnershipLogoSection").addClass("hidden")}),$(document).on("click",".jsAddCourseFileType",function(){j=$(this).val(),n()}),$(document).on("click",".jsAddQuestionBtn",function(e){e.preventDefault(),loadAddQuestionView(h,d)}),$(document).on("click",".jsBackToAddCoursePage",function(e){e.preventDefault(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}),$(document).on("click",".jsDeleteQuestion",function(e){e.preventDefault();let s=$(this).closest("tr").data("key");return alertify.confirm("Are you certain about deleting the chosen question?",function(){u(s)},CB)}),$(document).on("click",".jsEditQuestion",function(e){e.preventDefault();let s=$(this).closest("tr").data("key");loadEditQuestionView(l(s),h,function(e){$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden");let o=[];C.map(function(r){r.question_id===s?o.push(e):o.push(r)}),C=o,i(),ml(!1,h)})}),$(document).on("click",".jsAddIndefiniteCourse",function(e){$(".jsAddIndefiniteCourse").is(":checked")?($("#jsAddCourseEndPeriod").val(""),$(".jsAddCourseEndPeriodLabel").hide()):$(".jsAddCourseEndPeriodLabel").show()}),$(document).on("click",".jsAddNewScormCourse",function(s){var o=$(this).data("language_count"),r=$(this).data("languages").split(","),t=$(".jsScormCourseItem").length,a=[];if($(".jsScormCourseItem").each(function(e){let s=$(this).data("row_no");0==e?a.push($("#jsAddCourseLanguage").val()):a.push($("#jsAddCourseLanguage"+s).val())}),o>t){let s="",t=c();s+=`<article class="article-sec jsScormCourseItem" id="jsScormCourseItem${t}" data-row_no="${t}">`,s+='<div class="row">',s+='<div class="col-md-12">',s+=`<button class="btn btn-danger js-dropzone-delete-btn pull-right jsRemoveLanguageSection" data-section_id="jsScormCourseItem${t}" data-language_count="${o}"><i class="fa fa-trash"></i></button>`,s+="</div>",s+="</div>",s+='<div class="form-group">',s+='<label>SCORM Language <strong class="text-danger">*</strong></label>',s+='<p class="text-danger"><strong><em>The language of the SCORM.</strong></em></p>',s+=`<select style="width: 100%" class="jsScormLanguage" id="jsAddCourseLanguage${t}">`,r.map(function(e){a.includes(e)?s+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:s+=`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),s+="</select>",s+="</div>",s+="<br>",s+='<div class="form-group">',s+='<label>Course <strong class="text-danger">*</strong></label>',s+='<p class="text-danger"><strong><em>Upload the "SCORM" course.</strong></em></p>',s+=`<input type="file" class="hidden" id="jsAddCourseFile${t}" />`,s+="</div>",s+="</article>",$("#jsScormLanguageCourses").append(s),$("#jsAddCourseLanguage"+t).select2({closeOnSelect:!1}),$("#jsAddCourseFile"+t).msFileUploader({fileLimit:"200mb",allowedTypes:["zip"]}),e(r)}o==t+1&&$(".jsAddNewScormCourse").prop("disabled",!0)}),$(document).on("click",".jsRemoveLanguageSection",function(s){var o=$(this).data("section_id"),r=$(this).data("language_count"),t=$(".jsScormCourseItem").length;r==t&&$(".jsAddNewScormCourse").prop("disabled",!1),$("#"+o).remove(),e($(".jsAddNewScormCourse").data("languages").split(","))}),window.startCreateCourseProcess=s});