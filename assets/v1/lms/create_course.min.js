$((function(){let e=null,s=0,o="jsCreateCourseModel",t="jsCreateCourseModelLoader",r=[],a="file";function d(e){let s=[];$(".jsScormCourseItem").each((function(e){let o=$(this).data("row_no");0==e?s.push($("#jsAddCourseLanguage").val()):s.push($("#jsAddCourseLanguage"+o).val())})),$(".jsScormCourseItem").each((function(o){let t=$(this).data("row_no");var r="",a="";0==o?r=$("#jsAddCourseLanguage").val():(r=$("#jsAddCourseLanguage"+t).val(),a=t);var d="";e.map((function(e){s.includes(e)&&e!=r?d+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:d+=`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`})),$("#jsAddCourseLanguage"+a).html(d)}))}function n(){r=[],null!==e&&e.abort(),e=$.ajax({url:apiURL+"lms/course/view",method:"GET"}).success((function(s){e=null,$("#"+o+"Body").html(s),$("#jsAddCourseLanguage").select2({minimumResultsForSearch:-1}),$("#jsAddCourseVersion").select2({minimumResultsForSearch:-1}),$("#jsAddCourseJobTitles").select2({closeOnSelect:!1}),$("#jsAddCourseReassignType").val("year"),$("#jsAddCourseBanner").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"]}),$("#jsAddCourseFile").msFileUploader({fileLimit:"200mb",allowedTypes:["zip"]}),$("#jsAddCourseVideoFile").msFileUploader({fileLimit:"200mb",allowedTypes:["mp4","ppt","pptx","mov","wav"]}),$("input[name=jsAddCourseType][value=scorm]").attr("checked","checked"),$("#jsAddCourseLanguage").select2("val","english"),$(".jsAddCourseScormBox").removeClass("hidden"),$(".jsPartnershipLogoSection").addClass("hidden"),$("input[name=jsAddSecondaryLogo][value=no]").attr("checked","checked"),$("#jsPartnershipLogo").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"]}),$("#jsAddCourseStartPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsAddCourseEndPeriod").datepicker("option","minDate",e)}}).datepicker("option","maxDate",$("#jsAddCourseEndPeriod").val()),$("#jsAddCourseEndPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsAddCourseStartPeriod").datepicker("option","maxDate",e),$(".jsAddIndefiniteCourse").prop("checked",!1),$(".jsRecurringCourses").show()}}).datepicker("option","minDate",$("#jsAddCourseStartPeriod").val()),$('.jsAddCourseFileType[value="'+a+'"]').trigger("click"),ml(!1,t)})).fail(handleErrorResponse).done((function(){e=null,ml(!1,"jsPageLoader")}))}function i(e){ml(!1,t),r.push(e),l(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}function u(){$(".jsAddUploadFile").addClass("hidden"),$(".jsAddLinkFile").addClass("hidden"),"file"==a?$(".jsAddUploadFile").removeClass("hidden"):$(".jsAddLinkFile").removeClass("hidden")}function l(){if(!r.length)return $("#jsAddCourseQuestionsList").html('<tr><th colspan="3"><p class="alert alert-info text-center">No questions found yet.</p></th></tr>');let e="";r.map((function(s){e+='<tr data-key="'+s.question_id+'">',e+='\t<td class="vam">'+s.question_title+"</td>",e+='\t<td class="vam text-center">'+s.question_type.replace(/_/gi," ").toUpperCase()+"</td>",e+='\t<td class="vam text-center">',e+='\t\t<button type="button" class="btn btn-warning jsEditQuestion" title="Edit question" placement="top">',e+='\t\t\t<i class="fa fa-edit" aria-hidden="true"></i>',e+="\t\t</button>",e+='\t\t<button type="button" class="btn btn-danger jsDeleteQuestion" title="Delete question" placement="top">',e+='\t\t\t<i class="fa fa-times-circle" aria-hidden="true"></i>',e+="\t\t</button>",e+="\t</td>",e+="</tr>"})),$("#jsAddCourseQuestionsList").html(e)}$(document).on("click",".jsAddCourseCreateBtn",(function(e){e.preventDefault();const a={course_title:$("#jsAddCourseTitle").val().trim(),course_content:$("#jsAddCourseAbout").val().trim(),job_titles:$("#jsAddCourseJobTitles").val()||[],course_type:$(".jsAddCourseType:checked").val(),course_recurring_in:$("#jsAddCourseReassignIn").val(),course_recurring_type:$("#jsAddCourseReassignType").val(),course_start_period:$("#jsAddCourseStartPeriod").val().trim(),course_end_period:$("#jsAddCourseEndPeriod").val().trim(),course_sort_order:$("#jsAddCourseSortOrder").val().trim(),course_version:$("#jsAddCourseVersion").val(),course_file_type:$(".jsAddCourseFileType:checked").val(),course_secondary_logo_type:$(".jsAddSecondaryLogo:checked").val(),course_secondary_logo:$("#jsPartnershipLogo").msFileUploader("get"),course_file_link:$("#jsAddCourseLink").val(),course_file:$("#"+("scorm"===$(".jsAddCourseType:checked").val()?"jsAddCourseFile":"jsAddCourseVideoFile")).msFileUploader("get")||{},course_banner:$("#jsAddCourseBanner").msFileUploader("get"),course_questions:r};$(".jsAddIndefiniteCourse").is(":checked")&&(a.course_end_period=null),async function(e){const a=[];e.course_title||a.push("Course title is required.");e.job_titles.length||a.push("Select at least one job title.");e.course_recurring_in?e.course_recurring_in.isValidInteger()||a.push("Please enter valid integer value."):a.push("Course recurring number is required.");e.course_start_period||a.push("Course start date is required.");e.course_sort_order||a.push("Course sort order is required.");e.course_recurring_type.length||a.push("Course recurring type is required.");e.course_type||a.push("Course type is required.");Object.keys(e.course_banner).length?e.course_banner.errorCode&&a.push(e.course_banner.errorCode):a.push("Please upload the Course banner.");"yes"==e.course_secondary_logo_type&&(Object.keys(e.course_secondary_logo).length?e.course_secondary_logo.errorCode&&a.push(e.course_secondary_logo.errorCode):a.push("Please upload the Course Secondary Logo."));e.course_questions=r,"link"===e.course_file_type&&"manual"===e.course_type?e.course_file_link?e.course_file_link.isValidYoutubeLink()||e.course_file_link.isValidVimeoLink()||a.push("Invalid YouTube / Vimeo link."):a.push("YouTube / Vimeo link is required."):"manual"===e.course_type&&(Object.keys(e.course_file).length?e.course_file.errorCode&&a.push(e.course_file.errorCode):a.push("Please upload the Course file."));let d=[];"scorm"==e.course_type&&$(".jsScormCourseItem").each((function(e){var s=$(this).data("row_no"),o="",t="";0==e?(o="jsAddCourseFile",t="jsAddCourseLanguage"):(o="jsAddCourseFile"+s,t="jsAddCourseLanguage"+s);var r=$("#"+o).msFileUploader("get"),n=$("#"+t).val();Object.keys(r).length?r.errorCode?a.push(r.errorCode):d.push({key:n,value:r}):a.push("Please upload the scorm "+n+" file.")}));"manual"!==e.course_type||r.length||a.push("At least one question is required for manual course.");if(a.length)return alertify.alert("ERROR!",getErrorsStringFromArray(a),CB);if(ml(!0,t),Object.keys(e.course_file).length&&"manual"===e.course_type){let s=await uploadFile(e.course_file);if(s=JSON.parse(s),!s.data)return alertify.alert("ERROR","Failed to upload the file.",(function(){ml(!1,t)}));e.course_file=s.data}else Object.keys(d).length&&"scorm"===e.course_type?(await Promise.all(d.map((async e=>{let s=await uploadFile(e.value);return s=JSON.parse(s),e.filePath=s.data,e}))),delete e.course_file):e.course_file=e.course_file_link;delete e.course_file_link,e.company_code=s;let n=await uploadFile(e.course_banner);if(n=JSON.parse(n),!n.data)return alertify.alert("ERROR","Failed to upload the course banner.",(function(){ml(!1,t)}));if(e.course_banner=n.data,"yes"==e.course_secondary_logo_type){let s=await uploadFile(e.course_secondary_logo);if(s=JSON.parse(s),!s.data)return alertify.alert("ERROR","Failed to upload the course secondary logo.",(function(){ml(!1,t)}));e.course_secondary_logo=s.data}try{const s=await function(e){return new Promise((function(s,o){$.ajax({url:apiURL+"lms/course",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(e)}).success(s).fail((function(e){o(e.responseJSON)}))}))}(e);"scorm"===e.course_type&&await Promise.all(d.map((async e=>{var o,t,r;await(o=s.courseId,t=e.filePath,r=e.key,new Promise((function(e,s){const a={scorm_file:t,scorm_language:r};$.ajax({url:baseURI+"lms/course/scorm/parse/"+o,method:"POST",data:a}).success(e).fail((function(e){s(e.responseJSON)}))})))}))),alertify.alert("SUCCESS!",s.data,(function(){getLMSDefaultCourses(),$("#"+o).remove()}))}catch(e){return ml(!1,t),alertify.alert("ERROR!",getErrorsStringFromArray(e.errors,"Errors!!"),CB)}}(a)})),$(document).on("click",".jsAddCourseType",(function(){$(".jsAddCourseScormBox").addClass("hidden"),$(".jsAddManualCourseBox").addClass("hidden"),"scorm"===$(this).val()?$(".jsAddCourseScormBox").removeClass("hidden"):($(".jsAddManualCourseBox").removeClass("hidden"),u(),l())})),$(document).on("click",".jsAddSecondaryLogo",(function(){"yes"===$(this).val()?$(".jsPartnershipLogoSection").removeClass("hidden"):$(".jsPartnershipLogoSection").addClass("hidden")})),$(document).on("click",".jsAddCourseFileType",(function(){a=$(this).val(),u()})),$(document).on("click",".jsAddQuestionBtn",(function(e){e.preventDefault(),loadAddQuestionView(t,i)})),$(document).on("click",".jsBackToAddCoursePage",(function(e){e.preventDefault(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")})),$(document).on("click",".jsDeleteQuestion",(function(e){e.preventDefault();let s=$(this).closest("tr").data("key");return alertify.confirm("Are you certain about deleting the chosen question?",(function(){!function(e){r=r.filter((function(s){return s.question_id!=e})),l()}(s)}),CB)})),$(document).on("click",".jsEditQuestion",(function(e){e.preventDefault();let s=$(this).closest("tr").data("key");loadEditQuestionView(function(e){return r.filter((function(s){return s.question_id==e}))[0]}(s),t,(function(e){$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden");let o=[];r.map((function(t){t.question_id===s?o.push(e):o.push(t)})),r=o,l(),ml(!1,t)}))})),$(document).on("click",".jsAddIndefiniteCourse",(function(e){$(".jsAddIndefiniteCourse").is(":checked")?($("#jsAddCourseEndPeriod").val(""),$(".jsRecurringCourses").hide()):$(".jsRecurringCourses").show()})),$(document).on("click",".jsAddNewScormCourse",(function(e){var s,o,t=$(this).data("language_count"),r=$(this).data("languages").split(","),a=$(".jsScormCourseItem").length,n=[];if($(".jsScormCourseItem").each((function(e){let s=$(this).data("row_no");0==e?n.push($("#jsAddCourseLanguage").val()):n.push($("#jsAddCourseLanguage"+s).val())})),t>a){let e="",a=(s=1e4,o=99999,Math.floor(Math.random()*(o-s+1))+s);e+=`<article class="article-sec jsScormCourseItem" id="jsScormCourseItem${a}" data-row_no="${a}">`,e+='<div class="row">',e+='<div class="col-md-12">',e+=`<button class="btn btn-danger js-dropzone-delete-btn pull-right jsRemoveLanguageSection" data-section_id="jsScormCourseItem${a}" data-language_count="${t}"><i class="fa fa-trash"></i></button>`,e+="</div>",e+="</div>",e+='<div class="form-group">',e+='<label>SCORM Language <strong class="text-danger">*</strong></label>',e+='<p class="text-danger"><strong><em>The language of the SCORM.</strong></em></p>',e+=`<select style="width: 100%" class="jsScormLanguage" id="jsAddCourseLanguage${a}">`,r.map((function(s){n.includes(s)?e+=`<option disabled="disabled" value="${s}">${s.charAt(0).toUpperCase()+s.slice(1)}</option>`:e+=`<option value="${s}">${s.charAt(0).toUpperCase()+s.slice(1)}</option>`})),e+="</select>",e+="</div>",e+="<br>",e+='<div class="form-group">',e+='<label>Course <strong class="text-danger">*</strong></label>',e+='<p class="text-danger"><strong><em>Upload the "SCORM" course.</strong></em></p>',e+=`<input type="file" class="hidden" id="jsAddCourseFile${a}" />`,e+="</div>",e+="</article>",$("#jsScormLanguageCourses").append(e),$("#jsAddCourseLanguage"+a).select2({closeOnSelect:!1}),$("#jsAddCourseFile"+a).msFileUploader({fileLimit:"200mb",allowedTypes:["zip"]}),d(r)}t==a+1&&$(".jsAddNewScormCourse").prop("disabled",!0)})),$(document).on("click",".jsRemoveLanguageSection",(function(e){var s=$(this).data("section_id");$(this).data("language_count")==$(".jsScormCourseItem").length&&$(".jsAddNewScormCourse").prop("disabled",!1),$("#"+s).remove(),d($(".jsAddNewScormCourse").data("languages").split(","))})),window.startCreateCourseProcess=function(e){s=e,Modal({Id:o,Title:"Create Course",Loader:t,Cl:"container",Ask:!0,Body:'<div id="'+o+'Body"></div>'},n)}}));