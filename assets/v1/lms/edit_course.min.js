$(function(){function e(e,s){C=e,j=s,Modal({Id:_,Title:'Update Course <span id="jsEditCourseTitleHeader"></span>',Loader:E,Cl:"container",Ask:!0,Body:'<div id="'+_+'Body"></div>'},t)}function t(){null!==g&&g.abort(),g=$.ajax({url:apiURL+"lms/course/view/edit",method:"GET"}).success(function(e){g=null,$("#"+_+"Body").html(e),$("#jsEditCourseVersion").select2({minimumResultsForSearch:-1}),$("#jsEditCourseJobTitles").select2({closeOnSelect:!1}),d()}).fail(handleErrorResponse).done(function(){g=null})}async function s(e){const t=[];e.course_title||t.push("Course title is required."),e.job_titles.length||t.push("Select at least one job title."),e.course_type||t.push("Course type is required."),e.course_recurring_in?e.course_recurring_in.isValidInteger()||t.push("Please enter valid integer value."):t.push("Course recurring number is required."),e.course_recurring_type.length||t.push("Course recurring type is required."),e.course_questions=v;"link"===e.course_file_type&&"manual"===e.course_type?e.course_file_link?e.course_file_link.isValidYoutubeLink()||e.course_file_link.isValidVimeoLink()||t.push("Invalid YouTube / Vimeo link."):t.push("YouTube / Vimeo link is required."):"manual"===e.course_type&&(Object.keys(e.course_file).length?e.course_file.errorCode&&t.push(e.course_file.errorCode):t.push("Please upload the Course file."));let s=[];if("scorm"==e.course_type&&$(".jsScormCourseItem").each(function(e){var o=$(this).data("row_no"),i="",r="";0==e?(i="jsEditCourseFile",r="jsEditCourseLanguage"):(i="jsEditCourseFile"+o,r="jsEditCourseLanguage"+o);var a=$("#"+i).msFileUploader("get"),n=$("#"+r).val();Object.keys(a).length?a.errorCode?t.push(a.errorCode):s.push({key:n,value:a}):t.push("Please upload the scorm "+n+" file.")}),"manual"!==e.course_type||v.length||t.push("At least one question is required for manual course."),t.length)return alertify.alert("ERROR!",getErrorsStringFromArray(t),CB);if(ml(!0,E),Object.keys(e.course_file).length&&"manual"===e.course_type){let t=await uploadFile(e.course_file);if(t=JSON.parse(t),!t.data)return alertify.alert("ERROR","Failed to upload the file.",function(){ml(!1,E)});e.course_file=t.data}else Object.keys(s).length&&"scorm"===e.course_type?(await Promise.all(s.map(async e=>{if(e.value.size&&e.value.type){let t=await uploadFile(e.value);return t=JSON.parse(t),e.filePath=t.data,e}return e.filePath=e.value.link,e})),delete e.course_file):e.course_file=e.course_file_link;e.course_file||(e.course_file=e.course_file_name),delete e.course_file_link,e.company_code=C;try{await r(e);return"scorm"===e.course_type&&(await i(),await Promise.all(s.map(async e=>{await o(j,e.filePath,e.key)}))),alertify.alert("SUCCESS!",createCourseResponse.data,function(){getLMSDefaultCourses(),$("#"+_).remove()})}catch(e){return ml(!1,E),alertify.alert("ERROR!",getErrorsStringFromArray(e.errors,"Errors!!"),CB)}}function o(e){return new Promise(function(t,s){const o={scorm_file:e};$.ajax({url:baseURI+"lms/course/scorm/parse/"+j,method:"POST",data:o}).success(t).fail(function(e){s(e.responseJSON)})})}function i(){return new Promise(function(e,t){$.ajax({url:baseURI+"lms/course/delete_language/"+j,method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"}}).success(e).fail(function(e){t(e)})})}function r(e){return new Promise(function(t,s){$.ajax({url:apiURL+"lms/course/"+j,method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(e)}).success(t).fail(function(e){s(e.responseJSON)})})}function a(e){ml(!1,E),v.push(e),l(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}function n(){$(".jsEditUploadFile").addClass("hidden"),$(".jsEditLinkFile").addClass("hidden"),"file"==y?$(".jsEditUploadFile").removeClass("hidden"):($(".jsEditLinkFile").removeClass("hidden"),$("#jsEditCourseLink").val(k))}function l(){if(!v.length)return $("#jsEditCourseQuestionsList").html('<tr><th colspan="3"><p class="alert alert-info text-center">No questions found yet.</p></th></tr>');let e="";v.map(function(t){e+='<tr data-key="'+t.question_id+'">',e+='\t<td class="vam">'+t.question_title+"</td>",e+='\t<td class="vam text-center">'+t.question_type.replace(/_/gi," ").toUpperCase()+"</td>",e+='\t<td class="vam text-center">',e+='\t\t<button type="button" class="btn btn-warning jsEditQuestionEdit" title="Edit question" placement="top">',e+='\t\t\t<i class="fa fa-edit" aria-hidden="true"></i>',e+="\t\t</button>",e+='\t\t<button type="button" class="btn btn-danger jsDeleteQuestionEdit" title="Delete question" placement="top">',e+='\t\t\t<i class="fa fa-times-circle" aria-hidden="true"></i>',e+="\t\t</button>",e+="\t</td>",e+="</tr>"}),$("#jsEditCourseQuestionsList").html(e)}function u(e){v=v.filter(function(t){return t.question_id!=e}),l()}function c(e){let t=v.filter(function(t){return t.question_id==e});return t[0]}function d(){g=$.ajax({url:apiURL+"lms/course/"+j,method:"GET",headers:{accept:"application/json","content-type":"application/json"}}).success(function(e){g=null,p(e.data)}).fail(function(e){return g=null,ml(!1,"jsPageLoader"),alertify.alert("Errors!",e.responseJSON.errors.join("<br />"),CB)})}function p(e){if(v=[],$("#jsEditCourseTitleHeader").html(" - "+e.course_title),$("#jsEditCourseTitle").val(e.course_title),$("#jsEditCourseAbout").val(e.course_content),$("#jsEditCourseJobTitles").select2("val",e.job_titles),$("#jsEditCourseStartPeriod").val(e.course_start_period),$("#jsEditCourseEndPeriod").val(e.course_end_period),null==e.course_end_period&&($(".jsEditIndefiniteCourse").prop("checked",!0),$(".jsRecurringCourses").hide()),$("#jsEditCourseStartPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseEndPeriod").datepicker("option","minDate",e)}}).datepicker("option","maxDate",$("#jsEditCourseEndPeriod").val()),$("#jsEditCourseEndPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseStartPeriod").datepicker("option","maxDate",e),$(".jsEditIndefiniteCourse").prop("checked",!1),$(".jsRecurringCourses").show()}}).datepicker("option","minDate",$("#jsEditCourseStartPeriod").val()),$("#jsEditCourseReassignIn").val(e.course_recurring_value),$("#jsEditCourseReassignType").val(e.course_recurring_type),$('.jsEditCourseType[value="'+e.course_type+'"]').prop("checked",!0),$('.jsEditCourseFileType[value="'+e.course_file_type+'"]').trigger("click"),$('.jsEditCourseType[value="'+e.course_type+'"]').trigger("click"),"scorm"===e.course_type){var t=$(".jsEditNewScormCourse").data("languages").split(",");e.courseLanguages.map(function(e,s){if(0==s)b.placeholderImage=e.course_file_name,$("#jsEditCourseFile").msFileUploader(b),$("#jsEditCourseLanguage").select2({closeOnSelect:!1}),$("#jsEditCourseLanguage").select2("val",e.course_file_language);else{let s=f();var o=[];$(".jsScormCourseItem").each(function(e){let t=$(this).data("row_no");0==e?o.push($("#jsEditCourseLanguage").val()):o.push($("#jsEditCourseLanguage"+t).val())});let i=m(t,o,s);$("#jsScormLanguageCourses").append(i),$("#jsEditCourseLanguage"+s).select2({closeOnSelect:!1}),$("#jsEditCourseLanguage"+s).select2("val",e.course_file_language),b.placeholderImage=e.course_file_name,$("#jsEditCourseFile"+s).msFileUploader(b)}}),h(t),$("#jsEditCourseVersion").select2("val",e.course_version)}else S.placeholderImage=e.course_file_name,v=e.course_questions,y=e.course_file_type,k=e.course_file_name,n(),l();$("#jsEditCourseVideoFile").msFileUploader(S),L.course_file_name=e.course_file_name,ml(!1,E)}function m(e,t,s){return html="",html+=`<article class="article-sec jsScormCourseItem" id="jsScormCourseItem${s}" data-row_no="${s}">`,html+='<div class="row">',html+='<div class="col-md-12">',html+=`<button class="btn btn-danger js-dropzone-delete-btn pull-right jsEditRemoveLanguageSection" data-section_id="jsScormCourseItem${s}" data-language_count="${e.length}"><i class="fa fa-trash"></i></button>`,html+="</div>",html+="</div>",html+='<div class="form-group">',html+='<label>SCORM Language <strong class="text-danger">*</strong></label>',html+='<p class="text-danger"><strong><em>The language of the SCORM.</strong></em></p>',html+=`<select style="width: 100%" class="jsScormLanguage" id="jsEditCourseLanguage${s}">`,e.map(function(e){t.includes(e)?html+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:html+=`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),html+="</select>",html+="</div>",html+="<br>",html+='<div class="form-group">',html+='<label>Course <strong class="text-danger">*</strong></label>',html+='<p class="text-danger"><strong><em>Upload the "SCORM" course.</strong></em></p>',html+=`<input type="file" class="hidden" id="jsEditCourseFile${s}" />`,html+="</div>",html+="</article>",html}function h(e){let t=[];$(".jsScormCourseItem").each(function(e){let s=$(this).data("row_no");0==e?t.push($("#jsEditCourseLanguage").val()):t.push($("#jsEditCourseLanguage"+s).val())}),$(".jsScormCourseItem").each(function(s){let o=$(this).data("row_no");var i="",r="";0==s?i=$("#jsEditCourseLanguage").val():(i=$("#jsEditCourseLanguage"+o).val(),r=o);var a="";e.map(function(e){t.includes(e)&&e!=i?a+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:a+=e==i?`<option selected="selected" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),$("#jsEditCourseLanguage"+r).html(a)})}function f(){var e=1e4,t=99999;return Math.floor(Math.random()*(t-e+1))+e}let g=null,C=0,j=0,_="jsEditCourseModel",E="jsEditCourseModelLoader",v=[],y="file",k="",b={fileLimit:"100mb",allowedTypes:["zip"]},S={fileLimit:"100mb",allowedTypes:["mp4","ppt","pptx","mov"]},L={course_title:"",course_content:"",job_titles:[],course_type:"",course_file_type:"",course_file_link:"",course_version:"",course_file_name:"",course_file:{},course_questions:[]};$(document).on("click",".jsEditCourseCreateBtn",function(e){e.preventDefault(),L={course_title:$("#jsEditCourseTitle").val().trim(),course_content:$("#jsEditCourseAbout").val().trim(),course_start_period:$("#jsEditCourseStartPeriod").val().trim(),course_end_period:$("#jsEditCourseEndPeriod").val().trim(),job_titles:$("#jsEditCourseJobTitles").val()||[],course_type:$(".jsEditCourseType:checked").val(),course_recurring_in:$("#jsEditCourseReassignIn").val(),course_recurring_type:$("#jsEditCourseReassignType").val(),course_version:$("#jsEditCourseVersion").val(),course_file_name:L.course_file_name,course_file_type:$(".jsEditCourseFileType:checked").val(),course_file_link:$("#jsEditCourseLink").val(),course_file:$("#"+("scorm"===$(".jsEditCourseType:checked").val()?"jsEditCourseFile":"jsEditCourseVideoFile")).msFileUploader("get")||{},course_questions:v},$(".jsEditIndefiniteCourse").is(":checked")&&(L.course_end_period=null),s(L)}),$(document).on("click",".jsEditCourseType",function(){$(".jsEditCourseScormBox").addClass("hidden"),$(".jsEditManualCourseBox").addClass("hidden"),"scorm"===$(this).val()?$(".jsEditCourseScormBox").removeClass("hidden"):($(".jsEditManualCourseBox").removeClass("hidden"),n(),l())}),$(document).on("click",".jsEditCourseFileType",function(){y=$(this).val(),n()}),$(document).on("click",".jsEditQuestionBtn",function(e){e.preventDefault(),loadAddQuestionView(E,a)}),$(document).on("click",".jsBackToAddCoursePage",function(e){e.preventDefault(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}),$(document).on("click",".jsDeleteQuestionEdit",function(e){e.preventDefault();let t=$(this).closest("tr").data("key");return alertify.confirm("Are you certain about deleting the chosen question?",function(){u(t)},CB)}),$(document).on("click",".jsEditQuestionEdit",function(e){e.preventDefault();let t=$(this).closest("tr").data("key");loadEditQuestionView(c(t),E,function(e){$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden");let s=[];v.map(function(o){o.question_id===t?s.push(e):s.push(o)}),v=s,l(),ml(!1,E)})}),$(document).on("click",".jsEditIndefiniteCourse",function(e){$(".jsEditIndefiniteCourse").is(":checked")?($("#jsEditCourseEndPeriod").val(""),$(".jsRecurringCourses").hide()):$(".jsRecurringCourses").show()}),$(document).on("click",".jsEditNewScormCourse",function(e){var t=$(this).data("language_count"),s=$(this).data("languages").split(","),o=$(".jsScormCourseItem").length,i=[];if($(".jsScormCourseItem").each(function(e){let t=$(this).data("row_no");0==e?i.push($("#jsEditCourseLanguage").val()):i.push($("#jsEditCourseLanguage"+t).val())}),t>o){let e=f(),t=m(s,i,e);$("#jsScormLanguageCourses").append(t),$("#jsEditCourseLanguage"+e).select2({closeOnSelect:!1}),$("#jsEditCourseFile"+e).msFileUploader({fileLimit:"100mb",allowedTypes:["zip"]}),h(s)}t==o+1&&$(".jsEditNewScormCourse").prop("disabled",!0)}),$(document).on("click",".jsEditRemoveLanguageSection",function(e){var t=$(this).data("section_id"),s=$(this).data("language_count"),o=$(".jsScormCourseItem").length;s==o&&$(".jsEditNewScormCourse").prop("disabled",!1),$("#"+t).remove(),h($(".jsEditNewScormCourse").data("languages").split(","))}),window.startEditCourseProcess=e});