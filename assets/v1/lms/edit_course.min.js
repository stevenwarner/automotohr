$(function(){function e(e,s){_=e,f=s,Modal({Id:m,Title:'Update Course <span id="jsEditCourseTitleHeader"></span>',Loader:C,Cl:"container",Ask:!0,Body:'<div id="'+m+'Body"></div>'},t)}function t(){null!==p&&p.abort(),p=$.ajax({url:apiURL+"lms/course/view/edit",method:"GET"}).success(function(e){p=null,$("#"+m+"Body").html(e),$("#jsEditCourseVersion").select2({minimumResultsForSearch:-1}),$("#jsEditCourseJobTitles").select2({closeOnSelect:!1}),c()}).fail(handleErrorResponse).done(function(){p=null})}async function s(e){const t=[];e.course_title||t.push("Course title is required."),e.job_titles.length||t.push("Select at least one job title."),e.course_type||t.push("Course type is required."),e.course_recurring_in?e.course_recurring_in.isValidInteger()||t.push("Please enter valid integer value."):t.push("Course recurring number is required."),e.course_recurring_type.length||t.push("Course recurring type is required."),e.course_questions=j;let s=!1;if("link"===e.course_file_type&&"manual"===e.course_type?e.course_file_link?e.course_file_link.isValidYoutubeLink()||e.course_file_link.isValidVimeoLink()||t.push("Invalid YouTube / Vimeo link."):t.push("YouTube / Vimeo link is required."):Object.keys(e.course_file).length&&e.course_file.hasError?t.push("Please upload the "+("manual"===e.course_type?"Course":"SCORM")+" file."):Object.keys(e.course_file).length||("scorm"===e.course_type&&null===e.course_file_name.match(/.zip/gi)&&t.push("Please use the right SCORM file."),"manual"===e.course_type&&null!==e.course_file_name.match(/.zip/gi)&&t.push("Please use the right file.")),"manual"!==e.course_type||j.length||t.push("At least one question is required for manual course."),t.length)return alertify.alert("ERROR!",getErrorsStringFromArray(t),CB);if(ml(!0,C),!e.course_file.link&&Object.keys(e.course_file).length&&"link"!==e.course_file_type)if(s)e.course_file=e.course_file_name;else{s=!0;let t=await uploadFile(e.course_file);if(t=JSON.parse(t),!t.data)return alertify.alert("ERROR","Failed to upload the file.",function(){ml(!1,C)});e.course_file=t.data}else e.course_file=e.course_file_link;e.course_file||(e.course_file=e.course_file_name),delete e.course_file_link,e.company_code=_;try{const t=await o(e);return"scorm"===e.course_type&&s&&await i(e.course_file),alertify.alert("SUCCESS!",t.data,function(){getLMSDefaultCourses(),$("#"+m).remove()})}catch(e){return ml(!1,C),alertify.alert("ERROR!",getErrorsStringFromArray(e.errors,"Errors!!"),CB)}}function i(e){return new Promise(function(t,s){const i={scorm_file:e};$.ajax({url:baseURI+"lms/course/scorm/parse/"+f,method:"POST",data:i}).success(t).fail(function(e){s(e.responseJSON)})})}function o(e){return new Promise(function(t,s){$.ajax({url:apiURL+"lms/course/"+f,method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(e)}).success(t).fail(function(e){s(e.responseJSON)})})}function r(e){ml(!1,C),j.push(e),u(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}function n(){$(".jsEditUploadFile").addClass("hidden"),$(".jsEditLinkFile").addClass("hidden"),"file"==h?$(".jsEditUploadFile").removeClass("hidden"):($(".jsEditLinkFile").removeClass("hidden"),$("#jsEditCourseLink").val(E))}function u(){if(!j.length)return $("#jsEditCourseQuestionsList").html('<tr><th colspan="3"><p class="alert alert-info text-center">No questions found yet.</p></th></tr>');let e="";j.map(function(t){e+='<tr data-key="'+t.question_id+'">',e+='\t<td class="vam">'+t.question_title+"</td>",e+='\t<td class="vam text-center">'+t.question_type.replace(/_/gi," ").toUpperCase()+"</td>",e+='\t<td class="vam text-center">',e+='\t\t<button type="button" class="btn btn-warning jsEditQuestionEdit" title="Edit question" placement="top">',e+='\t\t\t<i class="fa fa-edit" aria-hidden="true"></i>',e+="\t\t</button>",e+='\t\t<button type="button" class="btn btn-danger jsDeleteQuestionEdit" title="Delete question" placement="top">',e+='\t\t\t<i class="fa fa-times-circle" aria-hidden="true"></i>',e+="\t\t</button>",e+="\t</td>",e+="</tr>"}),$("#jsEditCourseQuestionsList").html(e)}function l(e){j=j.filter(function(t){return t.question_id!=e}),u()}function a(e){let t=j.filter(function(t){return t.question_id==e});return t[0]}function c(){p=$.ajax({url:apiURL+"lms/course/"+f,method:"GET",headers:{accept:"application/json","content-type":"application/json"}}).success(function(e){p=null,d(e.data)}).fail(function(e){return p=null,ml(!1,"jsPageLoader"),alertify.alert("Errors!",e.responseJSON.errors.join("<br />"),CB)})}function d(e){j=[],$("#jsEditCourseTitleHeader").html(" - "+e.course_title),$("#jsEditCourseTitle").val(e.course_title),$("#jsEditCourseAbout").val(e.course_content),$("#jsEditCourseJobTitles").select2("val",e.job_titles),$("#jsEditCourseStartPeriod").val(e.course_start_period),$("#jsEditCourseEndPeriod").val(e.course_end_period),null==e.course_end_period&&($(".jsEditIndefiniteCourse").prop("checked",!0),$(".jsRecurringCourses").hide()),$("#jsEditCourseStartPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseEndPeriod").datepicker("option","minDate",e)}}).datepicker("option","maxDate",$("#jsEditCourseEndPeriod").val()),$("#jsEditCourseEndPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseStartPeriod").datepicker("option","maxDate",e),$(".jsEditIndefiniteCourse").prop("checked",!1),$(".jsRecurringCourses").show()}}).datepicker("option","minDate",$("#jsEditCourseStartPeriod").val()),$("#jsEditCourseReassignIn").val(e.course_recurring_value),$("#jsEditCourseReassignType").val(e.course_recurring_type),$('.jsEditCourseType[value="'+e.course_type+'"]').prop("checked",!0),$('.jsEditCourseFileType[value="'+e.course_file_type+'"]').trigger("click"),$('.jsEditCourseType[value="'+e.course_type+'"]').trigger("click"),"scorm"===e.course_type?(y.placeholderImage=e.course_file_name,$("#jsEditCourseVersion").select2("val",e.course_version)):(g.placeholderImage=e.course_file_name,j=e.course_questions,h=e.course_file_type,E=e.course_file_name,n(),u()),$("#jsEditCourseFile").msFileUploader(y),$("#jsEditCourseVideoFile").msFileUploader(g),v.course_file_name=e.course_file_name,ml(!1,C)}let p=null,_=0,f=0,m="jsEditCourseModel",C="jsEditCourseModelLoader",j=[],h="file",E="",y={fileLimit:"50mb",allowedTypes:["zip"]},g={fileLimit:"50mb",allowedTypes:["mp4","ppt","pptx","mov"]},v={course_title:"",course_content:"",job_titles:[],course_type:"",course_file_type:"",course_file_link:"",course_version:"",course_file_name:"",course_file:{},course_questions:[]};$(document).on("click",".jsEditCourseCreateBtn",function(e){e.preventDefault(),v={course_title:$("#jsEditCourseTitle").val().trim(),course_content:$("#jsEditCourseAbout").val().trim(),course_start_period:$("#jsEditCourseStartPeriod").val().trim(),course_end_period:$("#jsEditCourseEndPeriod").val().trim(),job_titles:$("#jsEditCourseJobTitles").val()||[],course_type:$(".jsEditCourseType:checked").val(),course_recurring_in:$("#jsEditCourseReassignIn").val(),course_recurring_type:$("#jsEditCourseReassignType").val(),course_version:$("#jsEditCourseVersion").val(),course_file_name:v.course_file_name,course_file_type:$(".jsEditCourseFileType:checked").val(),course_file_link:$("#jsEditCourseLink").val(),course_file:$("#"+("scorm"===$(".jsEditCourseType:checked").val()?"jsEditCourseFile":"jsEditCourseVideoFile")).msFileUploader("get")||{},course_questions:j},$(".jsEditIndefiniteCourse").is(":checked")&&(v.course_end_period=null),s(v)}),$(document).on("click",".jsEditCourseType",function(){$(".jsEditCourseScormBox").addClass("hidden"),$(".jsEditManualCourseBox").addClass("hidden"),"scorm"===$(this).val()?$(".jsEditCourseScormBox").removeClass("hidden"):($(".jsEditManualCourseBox").removeClass("hidden"),n(),u())}),$(document).on("click",".jsEditCourseFileType",function(){h=$(this).val(),n()}),$(document).on("click",".jsEditQuestionBtn",function(e){e.preventDefault(),loadAddQuestionView(C,r)}),$(document).on("click",".jsBackToAddCoursePage",function(e){e.preventDefault(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}),$(document).on("click",".jsDeleteQuestionEdit",function(e){e.preventDefault();let t=$(this).closest("tr").data("key");return alertify.confirm("Are you certain about deleting the chosen question?",function(){l(t)},CB)}),$(document).on("click",".jsEditQuestionEdit",function(e){e.preventDefault();let t=$(this).closest("tr").data("key");loadEditQuestionView(a(t),C,function(e){$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden");let s=[];j.map(function(i){i.question_id===t?s.push(e):s.push(i)}),j=s,u(),ml(!1,C)})}),$(document).on("click",".jsEditIndefiniteCourse",function(e){$(".jsEditIndefiniteCourse").is(":checked")?($("#jsEditCourseEndPeriod").val(""),$(".jsRecurringCourses").hide()):$(".jsRecurringCourses").show()}),window.startEditCourseProcess=e});