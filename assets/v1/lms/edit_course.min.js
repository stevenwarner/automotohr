$((function(){let e=null,t=0,s=0,o="jsEditCourseModel",i="jsEditCourseModelLoader",r=[],a="file",l="",n={fileLimit:"100mb",allowedTypes:["zip"]},u={fileLimit:"100mb",allowedTypes:["mp4","ppt","pptx","mov"]},d={course_title:"",course_content:"",job_titles:[],course_type:"",course_file_type:"",course_file_link:"",course_version:"",course_file_name:"",course_file:{},course_questions:[]};function c(){null!==e&&e.abort(),e=$.ajax({url:apiURL+"lms/course/view/edit",method:"GET"}).success((function(t){e=null,$("#"+o+"Body").html(t),$("#jsEditCourseVersion").select2({minimumResultsForSearch:-1}),$("#jsEditCourseJobTitles").select2({closeOnSelect:!1}),e=$.ajax({url:apiURL+"lms/course/"+s,method:"GET",headers:{accept:"application/json","content-type":"application/json"}}).success((function(t){e=null,function(e){if(r=[],$("#jsEditCourseTitleHeader").html(" - "+e.course_title),$("#jsEditCourseTitle").val(e.course_title),$("#jsEditCourseAbout").val(e.course_content),$("#jsEditCourseJobTitles").select2("val",e.job_titles),$("#jsEditCourseSortOrder").val(e.course_sort_order),$("#jsEditCourseStartPeriod").val(e.course_start_period),$("#jsEditCourseEndPeriod").val(e.course_end_period),null==e.course_end_period&&($(".jsEditIndefiniteCourse").prop("checked",!0),$(".jsRecurringCourses").hide()),$("#jsEditCourseStartPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseEndPeriod").datepicker("option","minDate",e)}}).datepicker("option","maxDate",$("#jsEditCourseEndPeriod").val()),$("#jsEditCourseEndPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseStartPeriod").datepicker("option","maxDate",e),$(".jsEditIndefiniteCourse").prop("checked",!1),$(".jsRecurringCourses").show()}}).datepicker("option","minDate",$("#jsEditCourseStartPeriod").val()),$("#jsEditCourseReassignIn").val(e.course_recurring_value),$("#jsEditCourseReassignType").val(e.course_recurring_type),$('.jsEditCourseType[value="'+e.course_type+'"]').prop("checked",!0),$('.jsEditCourseFileType[value="'+e.course_file_type+'"]').trigger("click"),$('.jsEditCourseType[value="'+e.course_type+'"]').trigger("click"),"scorm"===e.course_type){var t=$(".jsEditNewScormCourse").data("languages").split(",");e.courseLanguages.map((function(e,s){if(0==s)n.placeholderImage=e.course_file_name,$("#jsEditCourseFile").msFileUploader(n),$("#jsEditCourseLanguage").select2({closeOnSelect:!1}),$("#jsEditCourseLanguage").select2("val",e.course_file_language);else{let s=e.sid;var o=[];$(".jsScormCourseItem").each((function(e){let t=$(this).data("row_no");0==e?o.push($("#jsEditCourseLanguage").val()):o.push($("#jsEditCourseLanguage"+t).val())}));let i=f(t,o,s,0,e.updated_at);$("#jsScormLanguageCourses").append(i),$("#jsEditCourseLanguage"+s).select2({closeOnSelect:!1}),$("#jsEditCourseLanguage"+s).select2("val",e.course_file_language),n.placeholderImage=e.course_file_name,$("#jsEditCourseFile"+s).msFileUploader(n)}})),g(t),$("#jsEditCourseVersion").select2("val",e.course_version)}else u.placeholderImage=e.course_file_name,r=e.course_questions,a=e.course_file_type,l=e.course_file_name,m(),h();$("#jsEditCourseVideoFile").msFileUploader(u),d.course_file_name=e.course_file_name,ml(!1,i)}(t.data)})).fail((function(t){return e=null,ml(!1,"jsPageLoader"),alertify.alert("Errors!",t.responseJSON.errors.join("<br />"),CB)}))})).fail(handleErrorResponse).done((function(){e=null}))}function p(e){ml(!1,i),r.push(e),h(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}function m(){$(".jsEditUploadFile").addClass("hidden"),$(".jsEditLinkFile").addClass("hidden"),"file"==a?$(".jsEditUploadFile").removeClass("hidden"):($(".jsEditLinkFile").removeClass("hidden"),$("#jsEditCourseLink").val(l))}function h(){if(!r.length)return $("#jsEditCourseQuestionsList").html('<tr><th colspan="3"><p class="alert alert-info text-center">No questions found yet.</p></th></tr>');let e="";r.map((function(t){e+='<tr data-key="'+t.question_id+'">',e+='\t<td class="vam">'+t.question_title+"</td>",e+='\t<td class="vam text-center">'+t.question_type.replace(/_/gi," ").toUpperCase()+"</td>",e+='\t<td class="vam text-center">',e+='\t\t<button type="button" class="btn btn-warning jsEditQuestionEdit" title="Edit question" placement="top">',e+='\t\t\t<i class="fa fa-edit" aria-hidden="true"></i>',e+="\t\t</button>",e+='\t\t<button type="button" class="btn btn-danger jsDeleteQuestionEdit" title="Delete question" placement="top">',e+='\t\t\t<i class="fa fa-times-circle" aria-hidden="true"></i>',e+="\t\t</button>",e+="\t</td>",e+="</tr>"})),$("#jsEditCourseQuestionsList").html(e)}function f(e,t,s,o=1,i){return html="",html+=`<article class="article-sec jsScormCourseItem" id="jsScormCourseItem${s}" data-row_no="${s}" data-israndom="${o}">`,html+='<div class="row">',html+='<div class="col-md-12">',html+=`<button class="btn btn-danger js-dropzone-delete-btn pull-right jsEditRemoveLanguageSection" data-section_id="jsScormCourseItem${s}" data-row_no="${s}" data-language_count="${e.length}"><i class="fa fa-trash"></i></button>`,html+="</div>",html+="</div>",html+='<div class="form-group">',html+='<label>SCORM Language <strong class="text-danger">*</strong>',html+="</label>",void 0!==typeof i&&(html+=`<p>Uploaded at: ${moment(i).format("MMM DD YYYY, ddd hh:mm a")}</p>`),html+='<p class="text-danger"><strong><em>The language of the SCORM.</strong></em></p>',html+=`<select style="width: 100%" class="jsScormLanguage" id="jsEditCourseLanguage${s}">`,e.map((function(e){t.includes(e)?html+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:html+=`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`})),html+="</select>",html+="</div>",html+="<br>",html+='<div class="form-group">',html+='<label>Course <strong class="text-danger">*</strong></label>',html+='<p class="text-danger"><strong><em>Upload the "SCORM" course.</strong></em></p>',html+=`<input type="file" class="hidden" id="jsEditCourseFile${s}" />`,html+="</div>",html+="</article>",html}function g(e){let t=[];$(".jsScormCourseItem").each((function(e){let s=$(this).data("row_no");0==e?t.push($("#jsEditCourseLanguage").val()):t.push($("#jsEditCourseLanguage"+s).val())})),$(".jsScormCourseItem").each((function(s){let o=$(this).data("row_no");var i="",r="";0==s?i=$("#jsEditCourseLanguage").val():(i=$("#jsEditCourseLanguage"+o).val(),r=o);var a="";e.map((function(e){t.includes(e)&&e!=i?a+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:a+=e==i?`<option selected="selected" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`})),$("#jsEditCourseLanguage"+r).html(a)}))}$(document).on("click",".jsEditCourseCreateBtn",(function(e){e.preventDefault(),d={course_title:$("#jsEditCourseTitle").val().trim(),course_content:$("#jsEditCourseAbout").val().trim(),course_start_period:$("#jsEditCourseStartPeriod").val().trim(),course_end_period:$("#jsEditCourseEndPeriod").val().trim(),course_sort_order:$("#jsEditCourseSortOrder").val().trim(),job_titles:$("#jsEditCourseJobTitles").val()||[],course_type:$(".jsEditCourseType:checked").val(),course_recurring_in:$("#jsEditCourseReassignIn").val(),course_recurring_type:$("#jsEditCourseReassignType").val(),course_version:$("#jsEditCourseVersion").val(),course_file_name:d.course_file_name,course_file_type:$(".jsEditCourseFileType:checked").val(),course_file_link:$("#jsEditCourseLink").val(),course_file:$("#"+("scorm"===$(".jsEditCourseType:checked").val()?"jsEditCourseFile":"jsEditCourseVideoFile")).msFileUploader("get")||{},course_questions:r},$(".jsEditIndefiniteCourse").is(":checked")&&(d.course_end_period=null),async function(e){const a=[];e.course_title||a.push("Course title is required.");e.job_titles.length||a.push("Select at least one job title.");e.course_sort_order||a.push("Course sort order is required.");e.course_type||a.push("Course type is required.");e.course_recurring_in?e.course_recurring_in.isValidInteger()||a.push("Please enter valid integer value."):a.push("Course recurring number is required.");e.course_recurring_type.length||a.push("Course recurring type is required.");e.course_questions=r;"link"===e.course_file_type&&"manual"===e.course_type?e.course_file_link?e.course_file_link.isValidYoutubeLink()||e.course_file_link.isValidVimeoLink()||a.push("Invalid YouTube / Vimeo link."):a.push("YouTube / Vimeo link is required."):"manual"===e.course_type&&(Object.keys(e.course_file).length?e.course_file.errorCode&&a.push(e.course_file.errorCode):a.push("Please upload the Course file."));let l=[];"scorm"==e.course_type&&$(".jsScormCourseItem").each((function(e){var t="",s="";if(0==e)t="jsEditCourseFile",s="jsEditCourseLanguage";else{var o=$(this).data("row_no");t="jsEditCourseFile"+o,s="jsEditCourseLanguage"+o}var i=$("#"+t).msFileUploader("get"),r=$("#"+s).val();Object.keys(i).length?i.errorCode?a.push(i.errorCode):l.push({key:r,value:i}):a.push("Please upload the scorm "+r+" file.")}));"manual"!==e.course_type||r.length||a.push("At least one question is required for manual course.");if(a.length)return alertify.alert("ERROR!",getErrorsStringFromArray(a),CB);if(ml(!0,i),Object.keys(e.course_file).length&&"manual"===e.course_type){let t=await uploadFile(e.course_file);if(t=JSON.parse(t),!t.data)return alertify.alert("ERROR","Failed to upload the file.",(function(){ml(!1,i)}));e.course_file=t.data}else Object.keys(l).length&&"scorm"===e.course_type?(await Promise.all(l.map((async(e,t)=>{if(e.value.size&&e.value.type){let s=await uploadFile(e.value);s=JSON.parse(s),s.data&&(l[t]={filePath:s.data,key:e.key,value:{hasErrors:!1,link:s.data,type:"upload"}})}else l[t].filePath=e.value.link}))),delete e.course_file):e.course_file=e.course_file_link;e.course_file||(e.course_file=e.course_file_name);delete e.course_file_link,e.company_code=t;try{const t=await function(e){return new Promise((function(t,o){$.ajax({url:apiURL+"lms/course/"+s,method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(e)}).success(t).fail((function(e){o(e.responseJSON)}))}))}(e);if("scorm"===e.course_type&&l.length){let e=[];e[0]={},l.map((t=>{"english"===t.key?e[0]=t:e.push(t)})),l=e,await Promise.all(l.map((async e=>{var t,o,i;await(t=s,o=e.filePath,i=e.key,new Promise((function(e,s){const r={scorm_file:o,scorm_language:i};$.ajax({url:baseURI+"lms/course/scorm/parse/"+t,method:"POST",data:r}).success(e).fail((function(e){s(e.responseJSON)}))})))})))}alertify.alert("SUCCESS!",t.data,(function(){getLMSDefaultCourses(),$("#"+o).remove()}))}catch(e){return ml(!1,i),alertify.alert("ERROR!",getErrorsStringFromArray(e.errors,"Errors!!"),CB)}}(d)})),$(document).on("click",".jsEditCourseType",(function(){$(".jsEditCourseScormBox").addClass("hidden"),$(".jsEditManualCourseBox").addClass("hidden"),"scorm"===$(this).val()?$(".jsEditCourseScormBox").removeClass("hidden"):($(".jsEditManualCourseBox").removeClass("hidden"),m(),h())})),$(document).on("click",".jsEditCourseFileType",(function(){a=$(this).val(),m()})),$(document).on("click",".jsEditQuestionBtn",(function(e){e.preventDefault(),loadAddQuestionView(i,p)})),$(document).on("click",".jsBackToAddCoursePage",(function(e){e.preventDefault(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")})),$(document).on("click",".jsDeleteQuestionEdit",(function(e){e.preventDefault();let t=$(this).closest("tr").data("key");return alertify.confirm("Are you certain about deleting the chosen question?",(function(){!function(e){r=r.filter((function(t){return t.question_id!=e})),h()}(t)}),CB)})),$(document).on("click",".jsEditQuestionEdit",(function(e){e.preventDefault();let t=$(this).closest("tr").data("key");loadEditQuestionView(function(e){return r.filter((function(t){return t.question_id==e}))[0]}(t),i,(function(e){$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden");let s=[];r.map((function(o){o.question_id===t?s.push(e):s.push(o)})),r=s,h(),ml(!1,i)}))})),$(document).on("click",".jsEditIndefiniteCourse",(function(e){$(".jsEditIndefiniteCourse").is(":checked")?($("#jsEditCourseEndPeriod").val(""),$(".jsRecurringCourses").hide()):$(".jsRecurringCourses").show()})),$(document).on("click",".jsEditNewScormCourse",(function(e){var t,s,o=$(this).data("language_count"),i=$(this).data("languages").split(","),r=$(".jsScormCourseItem").length,a=[];if($(".jsScormCourseItem").each((function(e){let t=$(this).data("row_no");0==e?a.push($("#jsEditCourseLanguage").val()):a.push($("#jsEditCourseLanguage"+t).val())})),o>r){let e=(t=1e4,s=99999,Math.floor(Math.random()*(s-t+1))+t),o=f(i,a,e);$("#jsScormLanguageCourses").append(o),$("#jsEditCourseLanguage"+e).select2({closeOnSelect:!1}),$("#jsEditCourseFile"+e).msFileUploader({fileLimit:"100mb",allowedTypes:["zip"]}),g(i)}o==r+1&&$(".jsEditNewScormCourse").prop("disabled",!0)})),$(document).on("click",".jsEditRemoveLanguageSection",(function(e){var t=$(this).data("section_id"),s=$(this).data("row_no"),o=$(this).data("language_count"),i=$(".jsScormCourseItem").length;let r=$(this).closest(".jsScormCourseItem").data("israndom");if(o==i&&$(".jsEditNewScormCourse").prop("disabled",!1),g($(".jsEditNewScormCourse").data("languages").split(",")),0===r)return _confirm("<p>This action will permanently delete the SCORM course, and it cannot be undone. However, you can re-upload the SCORM file if needed.</p><br /><p>Are you sure you want to delete it?</p>",(function(){var e;e=s,$.ajax({url:apiURL+"lms/course/language/"+e,method:"DELETE"}).always((function(){})).fail(handleErrorResponse).success((function(e){})),$("#"+t).remove()}));$("#"+t).remove()})),window.startEditCourseProcess=function(e,r){t=e,s=r,Modal({Id:o,Title:'Update Course <span id="jsEditCourseTitleHeader"></span>',Loader:i,Cl:"container",Ask:!0,Body:'<div id="'+o+'Body"></div>'},c)}}));