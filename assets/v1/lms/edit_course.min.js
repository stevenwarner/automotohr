$(function(){function e(e,s){f=e,j=s,Modal({Id:C,Title:'Update Course <span id="jsEditCourseTitleHeader"></span>',Loader:E,Cl:"container",Ask:!0,Body:'<div id="'+C+'Body"></div>'},t)}function t(){null!==_&&_.abort(),_=$.ajax({url:apiURL+"lms/course/view/edit",method:"GET"}).success(function(e){_=null,$("#"+C+"Body").html(e),$("#jsEditCourseVersion").select2({minimumResultsForSearch:-1}),$("#jsEditCourseJobTitles").select2({closeOnSelect:!1}),d()}).fail(handleErrorResponse).done(function(){_=null})}async function s(e){const t=[];e.course_title||t.push("Course title is required."),e.job_titles.length||t.push("Select at least one job title."),e.course_sort_order||t.push("Course sort order is required."),e.course_type||t.push("Course type is required."),e.course_recurring_in?e.course_recurring_in.isValidInteger()||t.push("Please enter valid integer value."):t.push("Course recurring number is required."),e.course_recurring_type.length||t.push("Course recurring type is required."),void 0===e.course_banner.link&&(Object.keys(e.course_banner).length?e.course_banner.errorCode&&t.push(e.course_banner.errorCode):t.push("Please upload the Course banner.")),"yes"==e.course_secondary_logo_type&&(Object.keys(e.course_secondary_logo).length?e.course_secondary_logo.errorCode&&t.push(e.course_secondary_logo.errorCode):t.push("Please upload the Course Secondary Logo.")),e.course_questions=y;"link"===e.course_file_type&&"manual"===e.course_type?e.course_file_link?e.course_file_link.isValidYoutubeLink()||e.course_file_link.isValidVimeoLink()||t.push("Invalid YouTube / Vimeo link."):t.push("YouTube / Vimeo link is required."):"manual"===e.course_type&&(Object.keys(e.course_file).length?e.course_file.errorCode&&t.push(e.course_file.errorCode):t.push("Please upload the Course file."));let s=[];if("scorm"==e.course_type&&$(".jsScormCourseItem").each(function(e){var o="",r="";if(0==e)o="jsEditCourseFile",r="jsEditCourseLanguage";else{var i=$(this).data("row_no");o="jsEditCourseFile"+i,r="jsEditCourseLanguage"+i}var a=$("#"+o).msFileUploader("get"),n=$("#"+r).val();Object.keys(a).length?a.errorCode?t.push(a.errorCode):s.push({key:n,value:a}):t.push("Please upload the scorm "+n+" file.")}),"manual"!==e.course_type||y.length||t.push("At least one question is required for manual course."),t.length)return alertify.alert("ERROR!",getErrorsStringFromArray(t),CB);if(ml(!0,E),Object.keys(e.course_file).length&&"manual"===e.course_type){let t=await uploadFile(e.course_file);if(t=JSON.parse(t),!t.data)return alertify.alert("ERROR","Failed to upload the file.",function(){ml(!1,E)});e.course_file=t.data}else Object.keys(s).length&&"scorm"===e.course_type?(await Promise.all(s.map(async(e,t)=>{if(e.value.size&&e.value.type){let o=await uploadFile(e.value);o=JSON.parse(o),o.data&&(s[t]={filePath:o.data,key:e.key,value:{hasErrors:!1,link:o.data,type:"upload"}})}else s[t].filePath=e.value.link})),delete e.course_file):e.course_file=e.course_file_link;if(e.course_file||(e.course_file=e.course_file_name),delete e.course_file_link,void 0===e.course_banner.link){let t=await uploadFile(e.course_banner);if(t=JSON.parse(t),!t.data)return alertify.alert("ERROR","Failed to upload the course banner.",function(){ml(!1,E)});e.course_banner={},e.course_banner.link=t.data}if("yes"==e.course_secondary_logo_type)if(void 0===e.course_secondary_logo.link){let t=await uploadFile(e.course_secondary_logo);if(t=JSON.parse(t),!t.data)return alertify.alert("ERROR","Failed to upload the course secondary logo.",function(){ml(!1,E)});e.course_secondary_logo=t.data}else e.course_secondary_logo=e.course_secondary_logo.link;e.company_code=f;try{const t=await r(e);if("scorm"===e.course_type&&s.length){let e=[];e[0]={},s.map(t=>{"english"===t.key?e[0]=t:e.push(t)}),s=e,await Promise.all(s.map(async e=>{await o(j,e.filePath,e.key)}))}return alertify.alert("SUCCESS!",t.data,function(){getLMSDefaultCourses(),$("#"+C).remove()})}catch(e){return ml(!1,E),alertify.alert("ERROR!",getErrorsStringFromArray(e.errors,"Errors!!"),CB)}}function o(e,t,s){return new Promise(function(o,r){const i={scorm_file:t,scorm_language:s};$.ajax({url:baseURI+"lms/course/scorm/parse/"+e,method:"POST",data:i}).success(o).fail(function(e){r(e.responseJSON)})})}function r(e){return new Promise(function(t,s){$.ajax({url:apiURL+"lms/course/"+j,method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify(e)}).success(t).fail(function(e){s(e.responseJSON)})})}function i(e){ml(!1,E),y.push(e),n(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}function a(){$(".jsEditUploadFile").addClass("hidden"),$(".jsEditLinkFile").addClass("hidden"),"file"==v?$(".jsEditUploadFile").removeClass("hidden"):($(".jsEditLinkFile").removeClass("hidden"),$("#jsEditCourseLink").val(b))}function n(){if(!y.length)return $("#jsEditCourseQuestionsList").html('<tr><th colspan="3"><p class="alert alert-info text-center">No questions found yet.</p></th></tr>');let e="";y.map(function(t){e+='<tr data-key="'+t.question_id+'">',e+='\t<td class="vam">'+t.question_title+"</td>",e+='\t<td class="vam text-center">'+t.question_type.replace(/_/gi," ").toUpperCase()+"</td>",e+='\t<td class="vam text-center">',e+='\t\t<button type="button" class="btn btn-warning jsEditQuestionEdit" title="Edit question" placement="top">',e+='\t\t\t<i class="fa fa-edit" aria-hidden="true"></i>',e+="\t\t</button>",e+='\t\t<button type="button" class="btn btn-danger jsDeleteQuestionEdit" title="Delete question" placement="top">',e+='\t\t\t<i class="fa fa-times-circle" aria-hidden="true"></i>',e+="\t\t</button>",e+="\t</td>",e+="</tr>"}),$("#jsEditCourseQuestionsList").html(e)}function l(e){y=y.filter(function(t){return t.question_id!=e}),n()}function u(e){let t=y.filter(function(t){return t.question_id==e});return t[0]}function d(){_=$.ajax({url:apiURL+"lms/course/"+j,method:"GET",headers:{accept:"application/json","content-type":"application/json"}}).success(function(e){_=null,c(e.data)}).fail(function(e){return _=null,ml(!1,"jsPageLoader"),alertify.alert("Errors!",e.responseJSON.errors.join("<br />"),CB)})}function c(e){if(y=[],$("#jsEditCourseTitleHeader").html(" - "+e.course_title),$("#jsEditCourseTitle").val(e.course_title),$("#jsEditCourseAbout").val(e.course_content),$("#jsEditCourseJobTitles").select2("val",e.job_titles),$("#jsEditCourseSortOrder").val(e.course_sort_order),$("#jsEditCourseStartPeriod").val(e.course_start_period),$("#jsEditCourseEndPeriod").val(e.course_end_period),null==e.course_end_period&&($(".jsEditIndefiniteCourse").prop("checked",!0),$(".jsRecurringCourses").hide()),$("#jsEditCourseStartPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseEndPeriod").datepicker("option","minDate",e)}}).datepicker("option","maxDate",$("#jsEditCourseEndPeriod").val()),$("#jsEditCourseEndPeriod").datepicker({dateFormat:"mm/dd/yy",changeYear:!0,changeMonth:!0,onSelect:function(e){$("#jsEditCourseStartPeriod").datepicker("option","maxDate",e),$(".jsEditIndefiniteCourse").prop("checked",!1),$(".jsRecurringCourses").show()}}).datepicker("option","minDate",$("#jsEditCourseStartPeriod").val()),$("#jsEditCourseReassignIn").val(e.course_recurring_value),$("#jsEditCourseReassignType").val(e.course_recurring_type),$('.jsEditCourseType[value="'+e.course_type+'"]').prop("checked",!0),e.secondary_logo?($("input[name=jsEditSecondaryLogo][value=yes]").attr("checked","checked"),$("#jsPartnershipLogo").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"],placeholderImage:e.secondary_logo})):($(".jsPartnershipLogoSection").addClass("hidden"),$("input[name=jsEditSecondaryLogo][value=no]").attr("checked","checked"),$("#jsPartnershipLogo").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"]})),$('.jsEditCourseFileType[value="'+e.course_file_type+'"]').trigger("click"),$('.jsEditCourseType[value="'+e.course_type+'"]').trigger("click"),$("#jsEditCourseBanner").msFileUploader({fileLimit:"15mb",allowedTypes:["jpg","jpeg","png","webp"],placeholderImage:e.course_banner}),"scorm"===e.course_type){var t=$(".jsEditNewScormCourse").data("languages").split(",");e.courseLanguages.map(function(e,s){if(0==s)k.placeholderImage=e.course_file_name,$("#jsEditCourseFile").msFileUploader(k),$("#jsEditCourseLanguage").select2({closeOnSelect:!1}),$("#jsEditCourseLanguage").select2("val",e.course_file_language);else{let s=e.sid;var o=[];$(".jsScormCourseItem").each(function(e){let t=$(this).data("row_no");0==e?o.push($("#jsEditCourseLanguage").val()):o.push($("#jsEditCourseLanguage"+t).val())});let r=p(t,o,s,0,e.updated_at);$("#jsScormLanguageCourses").append(r),$("#jsEditCourseLanguage"+s).select2({closeOnSelect:!1}),$("#jsEditCourseLanguage"+s).select2("val",e.course_file_language),k.placeholderImage=e.course_file_name,$("#jsEditCourseFile"+s).msFileUploader(k)}}),m(t),$("#jsEditCourseVersion").select2("val",e.course_version)}else S.placeholderImage=e.course_file_name,y=e.course_questions,v=e.course_file_type,b=e.course_file_name,a(),n();$("#jsEditCourseVideoFile").msFileUploader(S),L.course_file_name=e.course_file_name,ml(!1,E)}function p(e,t,s,o=1,r){return html="",html+=`<article class="article-sec jsScormCourseItem" id="jsScormCourseItem${s}" data-row_no="${s}" data-israndom="${o}">`,html+='<div class="row">',html+='<div class="col-md-12">',html+=`<button class="btn btn-danger js-dropzone-delete-btn pull-right jsEditRemoveLanguageSection" data-section_id="jsScormCourseItem${s}" data-row_no="${s}" data-language_count="${e.length}"><i class="fa fa-trash"></i></button>`,html+="</div>",html+="</div>",html+='<div class="form-group">',html+='<label>SCORM Language <strong class="text-danger">*</strong>',html+="</label>",void 0!==typeof r&&(html+=`<p>Uploaded at: ${moment(r).format("MMM DD YYYY, ddd hh:mm a")}</p>`),html+='<p class="text-danger"><strong><em>The language of the SCORM.</strong></em></p>',html+=`<select style="width: 100%" class="jsScormLanguage" id="jsEditCourseLanguage${s}">`,e.map(function(e){t.includes(e)?html+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:html+=`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),html+="</select>",html+="</div>",html+="<br>",html+='<div class="form-group">',html+='<label>Course <strong class="text-danger">*</strong></label>',html+='<p class="text-danger"><strong><em>Upload the "SCORM" course.</strong></em></p>',html+=`<input type="file" class="hidden" id="jsEditCourseFile${s}" />`,html+="</div>",html+="</article>",html}function m(e){let t=[];$(".jsScormCourseItem").each(function(e){let s=$(this).data("row_no");0==e?t.push($("#jsEditCourseLanguage").val()):t.push($("#jsEditCourseLanguage"+s).val())}),$(".jsScormCourseItem").each(function(s){let o=$(this).data("row_no");var r="",i="";0==s?r=$("#jsEditCourseLanguage").val():(r=$("#jsEditCourseLanguage"+o).val(),i=o);var a="";e.map(function(e){t.includes(e)&&e!=r?a+=`<option disabled="disabled" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:a+=e==r?`<option selected="selected" value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`:`<option value="${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`}),$("#jsEditCourseLanguage"+i).html(a)})}function h(e){$.ajax({url:apiURL+"lms/course/language/"+e,method:"DELETE"}).always(function(){}).fail(handleErrorResponse).success(function(e){console.log(e)})}function g(){var e=1e4,t=99999;return Math.floor(Math.random()*(t-e+1))+e}let _=null,f=0,j=0,C="jsEditCourseModel",E="jsEditCourseModelLoader",y=[],v="file",b="",k={fileLimit:"200mb",allowedTypes:["zip"]},S={fileLimit:"200mb",allowedTypes:["mp4","ppt","pptx","mov"]},L={course_title:"",course_content:"",job_titles:[],course_type:"",course_file_type:"",course_file_link:"",course_version:"",course_file_name:"",course_file:{},course_questions:[]};$(document).on("click",".jsEditCourseCreateBtn",function(e){e.preventDefault(),L={course_title:$("#jsEditCourseTitle").val().trim(),course_content:$("#jsEditCourseAbout").val().trim(),course_start_period:$("#jsEditCourseStartPeriod").val().trim(),course_end_period:$("#jsEditCourseEndPeriod").val().trim(),course_sort_order:$("#jsEditCourseSortOrder").val().trim(),job_titles:$("#jsEditCourseJobTitles").val()||[],course_type:$(".jsEditCourseType:checked").val(),course_recurring_in:$("#jsEditCourseReassignIn").val(),course_recurring_type:$("#jsEditCourseReassignType").val(),course_version:$("#jsEditCourseVersion").val(),course_file_name:L.course_file_name,course_file_type:$(".jsEditCourseFileType:checked").val(),course_file_link:$("#jsEditCourseLink").val(),course_file:$("#"+("scorm"===$(".jsEditCourseType:checked").val()?"jsEditCourseFile":"jsEditCourseVideoFile")).msFileUploader("get")||{},course_banner:$("#jsEditCourseBanner").msFileUploader("get"),course_secondary_logo_type:$(".jsEditSecondaryLogo:checked").val(),course_secondary_logo:$("#jsPartnershipLogo").msFileUploader("get"),course_questions:y},$(".jsEditIndefiniteCourse").is(":checked")&&(L.course_end_period=null),s(L)}),$(document).on("click",".jsEditCourseType",function(){$(".jsEditCourseScormBox").addClass("hidden"),$(".jsEditManualCourseBox").addClass("hidden"),"scorm"===$(this).val()?$(".jsEditCourseScormBox").removeClass("hidden"):($(".jsEditManualCourseBox").removeClass("hidden"),a(),n())}),$(document).on("click",".jsEditSecondaryLogo",function(){"yes"===$(this).val()?$(".jsPartnershipLogoSection").removeClass("hidden"):$(".jsPartnershipLogoSection").addClass("hidden")}),$(document).on("click",".jsEditCourseFileType",function(){v=$(this).val(),a()}),$(document).on("click",".jsEditQuestionBtn",function(e){e.preventDefault(),loadAddQuestionView(E,i)}),$(document).on("click",".jsBackToAddCoursePage",function(e){e.preventDefault(),$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden")}),$(document).on("click",".jsDeleteQuestionEdit",function(e){e.preventDefault();let t=$(this).closest("tr").data("key");return alertify.confirm("Are you certain about deleting the chosen question?",function(){l(t)},CB)}),$(document).on("click",".jsEditQuestionEdit",function(e){e.preventDefault();let t=$(this).closest("tr").data("key");loadEditQuestionView(u(t),E,function(e){$(".jsPageBox").addClass("hidden"),$('.jsPageBox[data-id="main"]').removeClass("hidden");let s=[];y.map(function(o){o.question_id===t?s.push(e):s.push(o)}),y=s,n(),ml(!1,E)})}),$(document).on("click",".jsEditIndefiniteCourse",function(e){$(".jsEditIndefiniteCourse").is(":checked")?($("#jsEditCourseEndPeriod").val(""),$(".jsRecurringCourses").hide()):$(".jsRecurringCourses").show()}),$(document).on("click",".jsEditNewScormCourse",function(e){var t=$(this).data("language_count"),s=$(this).data("languages").split(","),o=$(".jsScormCourseItem").length,r=[];if($(".jsScormCourseItem").each(function(e){let t=$(this).data("row_no");0==e?r.push($("#jsEditCourseLanguage").val()):r.push($("#jsEditCourseLanguage"+t).val())}),t>o){let e=g(),t=p(s,r,e);$("#jsScormLanguageCourses").append(t),$("#jsEditCourseLanguage"+e).select2({closeOnSelect:!1}),$("#jsEditCourseFile"+e).msFileUploader({fileLimit:"200mb",allowedTypes:["zip"]}),m(s)}t==o+1&&$(".jsEditNewScormCourse").prop("disabled",!0)}),$(document).on("click",".jsEditRemoveLanguageSection",function(e){var t=$(this).data("section_id"),s=$(this).data("row_no"),o=$(this).data("language_count"),r=$(".jsScormCourseItem").length;let i=$(this).closest(".jsScormCourseItem"),a=i.data("israndom");if(o==r&&$(".jsEditNewScormCourse").prop("disabled",!1),m($(".jsEditNewScormCourse").data("languages").split(",")),0===a)return _confirm("<p>This action will permanently delete the SCORM course, and it cannot be undone. However, you can re-upload the SCORM file if needed.</p><br /><p>Are you sure you want to delete it?</p>",function(){h(s),$("#"+t).remove()});$("#"+t).remove()}),window.startEditCourseProcess=e});