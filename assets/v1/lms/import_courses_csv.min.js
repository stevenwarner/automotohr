$((function(){var e=[],t=["employeeid","employeesid","employeeId"],r=["employeenumber","employeeno"],s=["employee_ssn","socialsecurity","socialsecuritynumber","socialsecurity#","ssn","ss","ss#"],o=["employeeemail","email","emailaddress","personalemail","e-mail"],n=["employeephonenumber","phonenumber","contactnumber","contact","employeetelephonenumber","telephonenumber","primarynumber"],i=["coursetitle","title"],l=["coursetype","type"],a=["lessonstatus","progress"],d=["coursestatus","status"],u=["coursetaken","attemptcount","coursetakencount"],c=["start","startdate","startduration","startperiod","coursestartdate"],m=["end","enddate","endduration","endperiod","courseenddate"];function p(t){e=t}j("hide"),$("#js-import-form").submit((function(p){p.preventDefault();var f=e.target.result.split(/\r\n|\n/g),h=f[0].toLowerCase().replace(/[^a-z]/g,"").trim();if(!h.includes("coursetitle")&&!h.includes("title"))return alertify.alert("Not a valid format Debit Amount"),!1;if(!h.includes("lessonstatus")&&!h.includes("progress"))return alertify.alert("Not a valid format Credit Amount  is missing"),!1;if(!h.includes("coursestatus")&&!h.includes("status"))return alertify.alert("Not a valid format Start Period is missing"),!1;if(!h.includes("coursetaken")&&!h.includes("attemptcount"))return alertify.alert("Not a valid format Start Period is missing"),!1;if(!h.includes("startdate")&&!h.includes("startperiod")&&!h.includes("startduration"))return alertify.alert("Not a valid format  Transaction Date is missing"),!1;if(!h.includes("enddate")&&!h.includes("endperiod")&&!h.includes("endduration"))return alertify.alert("Not a valid format End Period is missing"),!1;var b=f[0].split(",");b=b.map((function(e,p){var f=function(e){var p,f,h;for(f=t.length,h=t,p=0;p<f;p++)if(e==h[p].trim())return"employee_id";for(f=r.length,h=r,p=0;p<f;p++)if(e==h[p].trim())return"employee_number";for(f=s.length,h=s,p=0;p<f;p++)if(e==h[p].trim())return"employee_ssn";for(f=o.length,h=o,p=0;p<f;p++)if(e==h[p].trim())return"employee_email";for(f=n.length,h=n,p=0;p<f;p++)if(e==h[p].trim())return"employee_phone";for(f=i.length,h=i,p=0;p<f;p++)if(e==h[p].trim())return"title";for(f=l.length,h=l,p=0;p<f;p++)if(e==h[p].trim())return"type";for(f=a.length,h=a,p=0;p<f;p++)if(e==h[p].trim())return"progress";for(f=d.length,h=d,p=0;p<f;p++)if(e==h[p].trim())return"status";for(f=u.length,h=u,p=0;p<f;p++)if(e==h[p].trim())return"count";for(f=c.length,h=c,p=0;p<f;p++)if(e==h[p].trim())return"start_date";for(f=m.length,h=m,p=0;p<f;p++)if(e==h[p].trim())return"end_date";return-1}(e.toLowerCase().replace(/[^a-z]/g,"").trim());return-1===f?"extra":f})),f.splice(0,1);var y="";if(f.map(((e,t)=>{var r=e.split(",");r.length!=b.length&&1!==r.length&&(y+="<p>",y+="  <strong>Row #: </strong>"+(t+2)+"<br />",y+="  <strong>Name: </strong>"+(r[0]+r[1]),y+="</p>")})),y.length)return alertify.alert("Error!","<p>Please make sure there are no <strong>','</strong> in values.</p><br /><p><strong>For instance </strong>422 Street, 3rd floor -> 422 Street 3rd floor</p><br />"+y,(function(){}));var g=[];const C=[];if(f.map((function(e,t){var r=e.split(","),s=new Object,o=0,n=r.length;if(n>2){for(;o<n;o++)s[b[o]]=r[o].trim();var i=!0,l=!0,a=!0,d=!0,u=!0,c=!0,m=!0,p=!0,f=!0;s.employee_id||(i=!1),s.employee_number||(l=!1),s.employee_ssn||(a=!1),s.employee_email||(d=!1),s.employee_phone||(u=!1),s.title||(c=!1),s.type||(m=!1),k(s.start_date)||(p=!1,C.push("The course start date is not valid for row "+(t+1)+".")),k(s.end_date)||(p=!1,C.push("The course end date is not valid for row "+(t+1)+".")),function(e){var t=new RegExp(/^\+?[0-9(),.-]+$/);if(e.match(t))return!0;return!1}(s.count)||(f=!1,C.push("The course attempted count is not valid for row "+(t+1)+".")),i||l||a||d||u?p&&f&&g.push(s):c?m?C.push("The employee identity is missing for row "+(t+1)+"."):C.push("The course type is missing for row "+(t+1)+"."):C.push("The course title is missing for row "+(t+1)+".")}})),C.length){if(0==g.length)return void alertify.alert(I(C,"Uploaded file doesn't contain any valid courses info."),(function(){})).set("title","Warning!");alertify.confirm(I(C,"Are you sure you want to continue, or would you prefer to fix the issue first?"),(()=>{v(g)})).set("labels",{ok:"Continue",cancel:"Cancel"}).set("title","Notice!")}else v(g)})),$("#userfile").mFileUploader({fileLimit:-1,allowedTypes:["csv"],onSuccess:function(e){if($(".js-submit-btn").prop("disabled",!0).addClass("disabled"),0!==Object.keys(e).length)if(!0!==e.hasError){$(".js-submit-btn").removeAttr("disabled").removeClass("disabled");var t=new FileReader;t.onload=p,t.readAsText(e)}else alertify.alert("WARNING!","Invalid file is uploaded.",(()=>{}));else alertify.alert("WARNING!","Please, select a file.",(()=>{}))},onError:()=>{$(".js-submit-btn").prop("disabled",!0).addClass("disabled")},onClear:()=>{$(".js-submit-btn").prop("disabled",!0).addClass("disabled")}});var f={current:0,chunkSize:8,loaded:0,records:[],totalChunks:0,recordsLength:0},h=0,b=0,y=0;let g=[];function v(e){g=e,Modal({Id:"jsCheckCourseTitleModal",Loader:"jsCheckCourseTitleLoader",Title:"Employees Course Titles Selection",Body:'<div id="jsCheckCourseTitleModalBody"></div>'},(function(){let e={},t="",r="";$.get(baseURI+"lms/courses/company_courses_list",(function(s){e=s.company_courses,e.map((function(e,r){t+='<option value="'+e.sid+'" >'+e.course_title+"</option>"})),g.map((function(e,s){r+='<tr class="jsCourseRow" data-index="'+s+'" >',r+="<td>"+e.title+"</td>",r+='<td><select name="companycourses[]" class="jscompanycourses invoice-fields"><option value="">Please Select</option>'+t+"</select></td>",r+="</tr>"}));let o='<br><br><div class="table-responsive">';o+='<table class="table table-striped ">',o+="<thead>",o+="<tr>",o+="<th>Import Data Course Title</th>",o+="<th>Company Course Title</th>",o+="</tr>",o+="</thead>",o+="<tbody>",o+=r,o+="</tbody>",o+="</table>",o+="</div>",o+='<br><div class="row"><div class="col-sm-9"></div><div class="col-sm-3 text-right"><button class="btn btn-success jsCourseImportBTN">Import</button></div></div>',$("#jsCheckCourseTitleModalBody").html(o),ml(!1,"jsCheckCourseTitleLoader")}))}))}function C(){void 0!==f.records[f.current]&&function(e){if(null!==w)return;if(void 0===f.records[f.current])return j("hide"),alertify.alert("SUCCESS!","You have successfully imported  courses.<br>Inserted records: <b>"+b+"</b><br>Duplicated records: <b>"+y+"</b> <br> Failed records: <b>"+h+"</b>"),void(h=y=b=f.loaded=f.current=f.totalChunks=f.recordsLength=0);f.loaded+=e.length;var t="Please, be patient as we import courses.<br />";t+="It may take a few minutes<br />",j("show",t+="Importing "+f.loaded+" of "+f.recordsLength+" courses."),w=$.post(baseURI+"lms/courses/import_course_csv_handler",{action:"add_courses",courses:e},(function(e){return w=null,!1===e.Status?(alertify.alert("ERROR!","Something went wrong"),void j("hide")):(h+=parseInt(e.Failed),y+=parseInt(e.Existed),b+=parseInt(e.Inserted),f.current++,f.current>=f.records.length?(j("hide"),alertify.alert("SUCCESS!","You have successfully imported  courses.<br>Inserted records: <b>"+b+"</b><br>Duplicated records: <b>"+y+"</b> <br> Failed records: <b>"+h+"</b>",(function(){window.location=baseURI+"lms/courses/import_course_csv"})),void(h=y=b=f.loaded=f.current=f.totalChunks=f.recordsLength=0)):void C())}))}(f.records[f.current])}var w=null;function j(e,t){show=void 0===e||!0===e||"show"===e?"show":e,t=void 0===t?"":t,"show"==e?($(".js-loader-text").html(t),$(".js-loader").show()):($(".js-loader-text").html(""),$(".js-loader").fadeOut(150))}function k(e){return null!=e.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)}function I(e,t){return"<strong><p>"+(t||"Please, resolve the following errors")+"</p></strong><br >"+e.join("<br />")}$(document).on("click",".jsCourseImportBTN",(function(e){e.preventDefault(),$(".jsCourseRow").map((function(){g[$(this).data("index")].course_sid=$(this).find("select option:selected").val()})),function(){f.records=[],f.recordsLength=g.length,f.totalChunks=Math.ceil(f.recordsLength/Math.ceil(f.recordsLength/f.chunkSize)),1!=f.totalChunks?f.records=_.chunk(g,f.totalChunks):f.records.push(g);C()}()}))}));